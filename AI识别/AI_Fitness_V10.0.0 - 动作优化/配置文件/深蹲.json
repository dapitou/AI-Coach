{
  "meta": {
    "action_name": "深蹲 (压缩率生物力学版)",
    "version": "V24.3.1",
    "description": "基于动态压缩率(Ratio)的深蹲分析，包含膝内扣与下蹲幅度检测"
  },
  
  "styles": {
    "default": "#AAFFFFFF",
    "good": "#00E676",
    "bad": "#FF1744",
    "guide": "#FFFF00",
    "text_dim": "#AAAAAA"
  },

  // ========================================================================
  // [扩展配置 1] 虚拟关键点定义
  // ========================================================================
  "virtual_points": [
    {
      "id": 101,
      "name": "hip_mid",
      "comment": "髋部几何中心",
      "calc": "midpoint",
      "sources": [23, 24]
    },
    {
      "id": 102,
      "name": "knee_mid",
      "comment": "膝盖几何中心",
      "calc": "midpoint",
      "sources": [25, 26]
    },
    {
      "id": 103,
      "name": "left_valgus_target",
      "comment": "左膝理想外展目标点 (基于左踝 27 垂直向上投影)",
      "calc": "projection_vertical",
      "source": 27,
      "offset_y": -150
    },
    {
      "id": 104,
      "name": "right_valgus_target",
      "comment": "右膝理想外展目标点 (基于右踝 28 垂直向上投影)",
      "calc": "projection_vertical",
      "source": 28,
      "offset_y": -150
    },
    {
      "id": 105,
      "name": "knee_mid_left_ext",
      "comment": "双膝中点水平线左端点",
      "calc": "offset",
      "source": 102,
      "offset_x": -60, "offset_y": 0
    },
    {
      "id": 106,
      "name": "knee_mid_right_ext",
      "comment": "双膝中点水平线右端点",
      "calc": "offset",
      "source": 102,
      "offset_x": 60, "offset_y": 0
    }
  ],

  // ========================================================================
  // [扩展配置 2] 动态变量定义
  // ========================================================================
  "dynamic_vars": [
    {
      "name": "standing_baseline",
      "comment": "站立状态下的髋膝垂直距离基准",
      "source_type": "distance_y",
      "points": [101, 102],
      "update_mode": "max_hold_damped",
      "damping": 0.01, // 极低权重，防止瞬间噪声干扰基准
      "decay": 0.9995, // 全局微衰减，防止基准值虚高卡死
      "active_state": "START"
    }
  ],

  // ========================================================================
  // 视觉元素定义
  // ========================================================================
  "elements": [
    // --- 膝内扣辅助线 (始终显示) ---
    {
      "comment": "左腿垂直参考线",
      "type": "line",
      "from": 27, "to": 103, "width": 2, "is_dashed": true, "style_key": "good"
    },
    {
      "comment": "右腿垂直参考线",
      "type": "line",
      "from": 28, "to": 104, "width": 2, "is_dashed": true, "style_key": "good"
    },

    // --- 膝内扣纠错 (P1 级) ---
    {
      "comment": "左膝状态指示",
      "condition_ref": "valgus",
      "on_good": { "type": "icon", "icon_name": "check", "center": 25, "style_key": "good" },
      "on_bad": { "type": "arrow", "start": 25, "direction": [1, 0], "width": 4, "style_key": "bad", "gap": 35 }
    },
    {
      "comment": "右膝状态指示",
      "condition_ref": "valgus",
      "on_good": { "type": "icon", "icon_name": "check", "center": 26, "style_key": "good" },
      "on_bad": { "type": "arrow", "start": 26, "direction": [-1, 0], "style_key": "bad", "gap": 35 }
    },

    // --- 下蹲幅度纠错 (P2 级) ---
    // [逻辑补全] 只有当 valgus_check 通过或未触发时，这些元素才会被渲染
    {
      "comment": "髋部节点",
      "type": "circle",
      "center": 101, "radius": 12, "style_key": "depth_state_color"
    },
    {
      "comment": "膝部节点",
      "type": "circle",
      "center": 102, "radius": 12, "style_key": "depth_state_color"
    },
    {
      "comment": "下蹲深度引导箭头",
      "condition_ref": "depth",
      "on_bad": {
        "type": "arrow", "from": 101, "to": 102, "width": 4, "style_key": "bad", "anim": "pulse", "gap": 25
      }
    },
    {
      "comment": "下蹲幅度目标线 (双膝中点水平线)",
      "condition_ref": "depth",
      "on_good": {"type": "line", "from": 105, "to": 106, "width": 2, "is_dashed": true, "style_key": "good"
      },
      "on_bad": {"type": "line", "from": 105, "to": 106, "width": 4, "style_key": "bad", "anim": "pulse"
      }
    }
  ],

  // ========================================================================
  // 评估逻辑 (Evaluation Logic)
  // ========================================================================
  "evaluation": {
    "default_state": "bad",
    "success_state": "good",
    
    // [逻辑补全 1] 全局逻辑控制
    "logic_control": {
      "display_mode": "exclusive", // 互斥模式：同一时间只显示一个最高优先级的错误
      "sort_order": "priority_asc", // 优先级数值越小，越优先显示
      "suppress_lower_priority": true // [Fix] 开启优先级压制，复刻原版互斥逻辑
    },

    // 状态机定义
    "state_machine": {
      "trigger_down": {
        "metric": "compression_ratio",
        "threshold": 0.85,
        "operator": "<"
      },
      "trigger_up": {
        "metric": "compression_ratio",
        "threshold": 0.92,
        "operator": ">"
      },
      // [逻辑补全 2] 僵尸状态熔断机制 (Zombie Breaker)
      "zombie_breaker": {
        "timeout_sec": 6.0, // 对应代码: current_time - down_start_time > 6.0
        "reset_condition": {
          "metric": "compression_ratio",
          "threshold": 0.75, // 对应代码: compression_ratio > 0.75
          "operator": ">"
        },
        "action": "force_reset_start" // 强制重置为 Start 状态
      }
    },

    "conditions": [
      {
        "id": "valgus",
        "comment": "膝内扣检测 (安全类错误)",
        "priority": 1, // [逻辑补全 3] 最高优先级
        "type": "ratio_width",
        "numerator_points": [25, 26],
        "denominator_points": [23, 24],
        "min": 1.2,
        "correction_mode": "strict_pass",
        // [逻辑补全 4] 有效纠错区间约束
        "correction_constraint": {
          "metric": "compression_ratio",
          "max": 0.30, // 对应代码: IN_FIX_RANGE_RATIO = 0.30
          "comment": "只有蹲得够深(Ratio<0.3)时的修正才被认可"
        }
      },
      {
        "id": "depth",
        "comment": "下蹲深度检测 (效果类错误)",
        "priority": 2, // [逻辑补全 3] 次级优先级
        "type": "ratio_vertical_dynamic",
        "points": [101, 102],
        "baseline_var": "standing_baseline",
        "max": 0.15,
        "correction_mode": "latch_pass" // [Fix] 达成即通过模式 (蹲下去一次就算过)
      }
    ]
  }
}
