<!-- d:\AEKE Projects\AI Coach\AI识别\AI_Fitness_V10.0.0 - 动作优化\算法配置_深蹲.md -->

# 算法配置：深蹲 (Squat)

## 1. 基本信息
- **动作ID**：`squat`
- **动作名称**：深蹲 (压缩率生物力学版)
- **版本**：V24.3.1
- **描述**：基于`动态压缩率`的深蹲分析，包含膝内扣与下蹲幅度检测。

## 2. 全局逻辑控制
- **优先级排序**：`升序` —— P1 > P2。
- **同时触发**：`互斥` —— 同时触发仅显示优先级最高的纠错交互。
- **优先级压制**：`开启` —— 当 P1 (膝内扣) 触发时，强制忽略 P2 (深度) 的错误显示。
- **优先级挤占**：`关闭` —— 纠错中，另一种纠错不可挤占（无论优先级），直到上一个纠错解除。
- **纠错交互触发频率**：`2` —— 每2次错误触发纠错交互。

## 3. 虚拟计算点
我们需要定义一些骨骼模型中不存在的几何中心点，用于后续计算：
- **髋部中点**：
   - 算法：`中点`
   - 输入：左髋, 右髋
- **膝盖中点**：
   - 算法：`中点`
   - 输入：左膝, 右膝
- **左脚底中心**：
   - 算法：`中点`
   - 输入：左踝, 左脚尖
- **右脚底中心**：
   - 算法：`中点`
   - 输入：右踝, 右脚尖

## 4. 动态基准
我们需要采集用户的身体数据作为参考基准：
- **条件**：`复位`状态
- **变量名**：`站立基准高度`
- **采集源**：`点对距离` —— 髋部中点 到 膝盖中点 的垂直距离。
- **采集策略**：`智能基准校准`
  - 激活状态：`准备`
  - 阻尼系数：`0.01` (极强抗噪，防止瞬间抖动干扰)
  - 衰减系数：`0.9995` (防止基准值虚高卡死)

## 5. 状态机配置
定义动作的生命周期流转：
- **准备**：
  - 说明：动作就绪状态，**允许采集动态基准值**。
  - 逻辑：系统初始化或从复位状态判定稳定后进入。
  - 指标：`复位状态停留时长`
  - 阈值：`> 0.5s`
- **向心**：下蹲
  - 指标：`压缩率`
  - 阈值：`< 0.85` (大腿垂直投影缩短至站立时的 85%)
- **离心**：站起
  - 指标：`压缩率`
  - 阈值：`> 0.92` (恢复至 92%)
- **进入纠错区间**：
  - 指标：`压缩率`
  - 阈值：`< 0.30` (进入深蹲底部核心判定区)
- **离开纠错区间**：
  - 指标：`压缩率`
  - 阈值：`> 0.30` (离开深蹲底部核心判定区)
- **复位**：
  - 说明：动作结束后的过渡状态，**暂停基准采集**，防止动作惯性干扰。
  - 逻辑：完成起立后进入，稳定后转回准备状态。
  - 指标：`压缩率`
  - 阈值：`> 0.92` (即触发起立的条件)
- **僵尸熔断**：
  - 目的：防止用户卡在下蹲状态。
  - 条件：停留时长 `> 6.0秒` **且** 压缩率 `> 0.75` (说明人其实站得挺高)。
  - 动作：强制重置为 `准备` 状态。

## 6. 错误标准配置

### 错误项 A：膝内扣
- **ID**：`valgus`
- **优先级**：`P1`
- **算法类型**：`比例`
- **核心逻辑**：
  - 分子：`双膝间距`
  - 分母：`双髋间距`
  - 阈值：`最小 1.2` (膝宽必须大于髋宽的 1.2 倍)
  - 容忍度：`严格±0.05 / 标准±0.1 / 宽松±0.15`
  - 时序防抖：`5帧`
  - 单双侧：`整体`
- **判定模式**：`过程修正`
  - 逻辑：进入纠错区间后，必须修正动作并保持正确，方可判合格。
- **纠错区间**：
  - 约束指标：`压缩率`
  - 约束阈值：`< 0.30` (只有蹲得够深时，才检测膝内扣)

### 错误项 B：下蹲深度
- **ID**：`depth`
- **优先级**：`P2`
- **算法类型**：`动态垂直压缩率`
- **核心逻辑**：
  - 测量：`髋部中点` 到 `膝盖中点` 的垂直距离
  - 基准：`站立基准高度`
  - 阈值：`最大 0.15` (距离缩短至站立时的 15% 以内，即接近大腿水平)
  - 容忍度：`严格±0.02 / 标准±0.05 / 宽松±0.08`
  - 时序防抖：`3帧`
  - 单双侧：`整体`
- **判定模式**：`达成即过`
  - 逻辑：只要在动作过程中有几帧达到了标准，本次动作即判合格。

## 7. 纠错交互配置

### 7.1 膝内扣反馈
- **绑定条件**：`valgus`
- **状态：正确**
  - 左膝：
    - 类型：`对勾`
    - 位置：`左膝`
    - 样式：绿色
  - 右膝：
    - 类型：`对勾`
    - 位置：`右膝`
    - 样式：绿色
- **状态：错误**
  - 左膝：
    - 类型：`箭头`
    - 定义：起点 `左膝`，方向 `向外`
    - 样式：红色
    - 动效：`弹性`
  - 右膝：
    - 类型：`箭头`
    - 定义：起点 `右膝`，方向 `向外`
    - 样式：红色
    - 动效：`弹性`
  - 左腿参考线：
    - 类型：`参考线`
    - 定义：`左脚底中心` -> `左膝理想投影`，方向：`垂直`
    - 样式：绿色、虚线
  - 右腿参考线：
    - 类型：`参考线`
    - 定义：`右脚底中心` -> `右膝理想投影`，方向：`垂直`
    - 样式：绿色、虚线
  - 纠错提示：
    - 内容：注意膝关节不要内扣！
    - 样式：红色

### 7.2 深度反馈
- **绑定条件**：`depth`
- **状态：正确**
  - 髋部：
    - 类型：`圆点`
    - 位置：`髋中点`
    - 样式：绿色、实心
  - 膝部：
    - 类型：`圆点`
    - 位置：`膝中点`
    - 样式：绿色、实心
  - 目标线：
    - 类型：`目标线`
    - 定义：`双膝水平连线`
    - 样式：绿色、虚线
  - 确认图标：
    - 类型：`对勾`
    - 位置：`髋中点`
    - 样式：绿色
  - 提示词：
    - 内容：完美动作！
    - 样式：绿色
- **状态：错误**
  - 髋部：
    - 类型：`圆点`
    - 位置：`髋中点`
    - 样式：红色、实心
  - 膝部：
    - 类型：`圆点`
    - 位置：`膝中点`
    - 样式：红色、实心
  - 引导：
    - 类型：`箭头`
    - 定义：起点 `髋中点` -> 终点 `膝中点`
    - 样式：红色
    - 动效：`弹性`
  - 目标线：
    - 类型：`目标线`
    - 定义：`双膝水平连线`
    - 方向：`水平`
    - 样式：红色、虚线
  - 纠错提示：
    - 内容：蹲至大腿平行地面效果更好！
    - 样式：红色
