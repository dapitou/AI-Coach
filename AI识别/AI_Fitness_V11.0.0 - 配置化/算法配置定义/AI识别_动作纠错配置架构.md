# AI识别_动作纠错配置架构

## 全局逻辑控制
- **显示模式**：
  - 互斥（默认）：同一时刻仅显示一个最高优先级的纠错项。
  - 并行：同时显示所有触发的纠错项。
- **优先级排序**：
  - 升序（默认）：数值越小优先级越高 (P1 > P2)。
  - 降序：数值越大优先级越高。
- **优先级压制**：
  - 开启（默认）：当高优先级错误触发时，强制屏蔽低优先级错误的检测与显示。
  - 关闭：高优先级错误触发时，不影响低优先级错误的检测状态。
- **优先级挤占**：
  - 开启：允许新触发的错误挤占当前的纠错状态。
  - 关闭（默认）：一旦进入某种纠错状态，触发其他任何优先级的纠错都不挤占当前纠错，直到该纠错状态解除。
- **纠错交互触发频率**：
  - 配置数字（默认2）：决定几次错误触发纠错交互。

## 错误项逻辑配置：
- **基本信息**：
- **标识**：
  - ID：唯一标识符 (如 `valgus`)
  - 名称：显示名称 (如 `膝内扣`)
  - 描述：详细说明 (如 `检测下蹲过程中双膝是否内扣`)
- **属性**：
  - 优先级：P0 (阻断) | P1 (核心) | P2 (优化)
  - 算法类型：关联的判定算法类型 (如 `ratio_width`, `angle_vertical`)

## 虚拟计算点配置：
- **类型**：原生骨骼点 | 虚拟计算点
- **原生骨骼点**：
  - ID：模型原始ID
  - 名称：标准骨骼名称（如 `nose`, `left_shoulder`）
- **虚拟计算点**：
  - ID：自定义唯一ID (>100)
  - 名称：自定义名称 (如 `hip_mid`)
  - **运算器**：
    - **中点**：
      - 逻辑：`计算 点A, 点B... 的几何中心`
      - 示例：`hip_mid = 中点(左髋, 右髋)`
    - **投影**：
      - 逻辑：`计算 源点 在垂直方向上的投影点 + 垂直偏移`
      - 示例：`knee_target = 投影(踝关节, 偏移Y=-150)`
    - **偏移**：
      - 逻辑：`计算 源点 在 X/Y 轴上的相对位移点`
      - 示例：`knee_ext = 偏移(膝中点, X=-60, Y=0)`
    - **组合**：
      - 逻辑：`组合 点A 的 X坐标 与 点B 的 Y坐标`
      - 示例：`wrist_proj = 组合(X=肘关节, Y=腕关节)`

## 动态基准配置（可选）：
- **说明**：定义用于计算压缩率或相对位置的参考基准值
- **基本属性**：
  - 名称：变量名
  - 采集源：点对距离 | 点坐标
- **采集逻辑**：
  - 算法：`智能基准校准`
  - 机制：自动在`准备`状态下采集最大值，并应用阻尼抗噪和微量衰减
  - 参数：
    - 阻尼：默认 0.05 (抗噪)
    - 衰减：默认 0.9995 (防止虚高)

## 判定指标配置：
- **枚举**：角度 | 比例 | 距离 | 共线
- **角度**：
  - 说明：计算关键点构成的几何夹角
  - 定义：2-4个点（如 3点求夹角，2点求与水平/垂直夹角）
  - 属性：内角 | 外角
  - 示例：`小臂垂直偏离角 = 夹角(肘, 腕, 垂直线)`
- **比例**：
  - 说明：计算两组线段长度的比值（如膝宽/髋宽）
  - 定义：分子线段（点A-点B） / 分母线段（点C-点D）
  - 示例：`膝髋宽度比 = 水平距离(左膝, 右膝) / 水平距离(左髋, 右髋)`
- **距离/压缩率**：
  - 说明：计算动态距离相对于基准值的变化率
  - 定义：测量点对（点A-点B）
  - 公式：压缩率 = 当前距离 / 动态基准值
  - 示例：`下蹲深度压缩率 = 垂直距离(髋, 膝) / 站立基准值`
- **共线/偏移**：
  - 说明：检测关键点是否偏离基准直线（如弓背、侧倾）
  - 定义：基准线（起点-终点），目标点
  - 公式：偏移率 = 点到直线距离 / 基准线长度
  - 示例：`背部弓曲率 = 点到直线距离(胸椎, 颈-髋连线) / 躯干长度`

## 状态机配置：
- **准备**：
  - 说明：动作就绪状态，**允许采集动态基准值**
  - 逻辑：系统初始化或从复位状态判定稳定后进入
  - 属性：基准校准开关
  - 示例：`进入: 复位状态保持 > 0.5s`
- **向心**：
  - 说明：动作开始发力或下放的阶段
  - 定义：触发条件（判定指标 + 运算器 + 阈值）
  - 示例：`下蹲深度压缩率 ≤ 85%` (深蹲开始)
- **进入纠错区间（可选）**：
  - 说明：进入核心判定区域，开始激活“过程修正”或“达成即过”逻辑
  - 定义：触发条件（判定指标 + 运算器 + 阈值）
  - 示例：`下蹲深度压缩率 ≤ 30%` (进入深蹲底部)
- **离开纠错区间（可选）**：
  - 说明：离开核心判定区域，锁定“过程修正”结果
  - 定义：触发条件（判定指标 + 运算器 + 阈值）
  - 示例：`下蹲深度压缩率 ＞ 30%` (离开深蹲底部)
- **离心**：
  - 说明：动作还原或起身的运动过程
  - 定义：触发条件（判定指标 + 运算器 + 阈值）
  - 示例：`下蹲深度压缩率 ＞ 30%` (开始起身)
- **复位**：
  - 说明：动作结束后的过渡状态，**暂停基准采集**，防止动作惯性干扰
  - 定义：触发条件（判定指标 + 运算器 + 阈值）
  - 示例：`进入: 下蹲深度压缩率 ≥ 92% (动作完成)`
- **保持（可选）**：
  - 说明：动作过程中的静力保持阶段
  - 定义：进入条件 + 退出条件 + 最小保持时长
  - 示例：`进入: 下蹲深度压缩率 < 15%; 退出: 下蹲深度压缩率 > 20%; 时长: 1s`
- **超时熔断（可选）**：
  - 说明：异常状态下的强制复位机制
  - 定义：超时阈值（秒） + 状态校验指标
  - 逻辑：若 (当前状态时长 > 超时阈值) 且 (指标满足复位条件) 则 强制转为准备态
  - 示例：`时长 > 6s AND 下蹲深度压缩率 > 75%` (深蹲卡死复位)

## 错误标准配置：
- 通用参数：
  - **逻辑关系**：AND | OR （支持多指标组合触发）
  - **时序防抖**：触发帧数（连续N帧满足条件触发）、释放帧数（连续N帧不满足解除）
  - **单双侧**：定义触发与解除的逻辑（如：触发 任一侧 / 解除 双侧）
- **角度**：
  - 说明：检测关节夹角或肢体垂直度
  - 定义：运算器 + 阈值（°）
  - 容忍度：支持分级配置（如：严格±5° / 标准±10° / 宽松±15°）
  - 示例：`小臂垂直偏离角 ＞ 20° (容忍度: ±5°)`
- **比例**：
  - 说明：检测肢体间距或长度的相对比例
  - 定义：运算器 + 阈值（无量纲）
  - 容忍度：支持分级配置（如：严格±0.05 / 标准±0.1 / 宽松±0.2）
  - 示例：`膝髋宽度比 ＜ 1.2 (容忍度: ±0.1)`
- **距离/压缩率**：
  - 说明：检测动态距离相对于基准值的变化率
  - 定义：运算器 + 阈值（%）
  - 容忍度：支持分级配置（如：严格±5% / 标准±10% / 宽松±15%）
  - 示例：`下蹲深度压缩率 ＞ 15% (容忍度: ±5%)`
- **共线/偏移**：
  - 说明：检测关键点偏离基准直线的程度
  - 定义：运算器 + 阈值（%）
  - 容忍度：支持分级配置（如：严格±2% / 标准±5% / 宽松±8%）
  - 示例：`背部弓曲率 ＞ 5% (容忍度: ±2%)`

## 动力链配置（可选）：
- **枚举**：同步型 | 顺序型
- 说明：用于检测复合动作中多个关节/部位的协同运动关系（非必填）
- **同步型**：
  - 说明：检测两个指标是否保持特定的线性协同关系
  - 定义：`|指标A - (指标B * 系数 + 偏移)| ≤ 阈值`
  - 容忍度：支持分级配置（如：严格±5° / 标准±10° / 宽松±15°）
  - 示例：`|伸膝角度 - (伸髋角度 * 1.0 + 0)| ≤ 15° (容忍度: ±5°)`
- **顺序型**：
  - 说明：检测动作发生的先后顺序
  - 定义：当 `指标B` 触发时，`指标A` 必须已满足条件
  - 容忍度：支持时间窗口配置（如：允许 0.2s 内的并发误差）
  - 示例：`当 膝屈曲角＞30° 时，髋屈曲角 必须 ＞15° (容忍度: 0.1s)`

## 单双侧定义：
- 说明：定义左右肢体检测结果如何合并为最终判定结果
- **触发模式**：
  - **任一侧**：
    - 逻辑：`左侧不达标 OR 右侧不达标`
    - 说明：只要有一侧不达标，即触发错误（严判，适用于安全类指标）
    - 示例：`左膝内扣 OR 右膝内扣 → 触发错误`
  - **双侧同时**：
    - 逻辑：`左侧不达标 AND 右侧不达标`
    - 说明：两侧同时不达标时，才触发错误（宽判）
- **解除模式**：
  - **双侧达标**：
    - 逻辑：`左侧达标 AND 右侧达标`
    - 说明：必须两侧都达标，错误才解除（严进严出，推荐）
    - 示例：`左膝正常 AND 右膝正常 → 解除错误`
  - **任一侧达标**：
    - 逻辑：`左侧达标 OR 右侧达标`
    - 说明：只要有一侧达标，错误即解除（宽进宽出）

## 错误判定配置：
- **说明**：定义动作评价的时间维度判定逻辑
- **枚举**：一票否决 | 达成即过 | 过程修正 | 实时跟随
- **一票否决**：
  - 逻辑：`最终结果 = 合格 IF (动作全程 无 任何帧不达标)`
  - 触发：初始默认为合格，一旦检测到错误（满足防抖），即刻锁定为不合格。
  - 解除：本轮不可解除，需等待下一轮动作重置。
  - 场景：动作标准类，需要全程保持正确的动作
  - 示例：小臂不垂直（推肩）；耸肩（推肩）
- **达成即过**：
  - 逻辑：`最终结果 = 合格 IF (纠错区间内 存在 任意帧达标)`
  - 触发：初始默认为不合格，只要在关键区间（如最低点）达标一次，即刻锁定为合格。
  - 解除：达标即解除错误，保持合格直至本轮结束。
  - 场景：动作幅度类，需要特定关键帧区间动作幅度达标的动作
  - 示例：下蹲深度不足（深蹲）、抬肘高度不足（侧平举）
- **过程修正**：
  - 逻辑：`最终结果 = 合格 IF (区间内已修正 AND 修正后保持至离开区间)`
  - 触发：进入纠错区间时若不达标，判为不合格。
  - 解除：必须在区间内修正动作（达标），且后续保持正确姿态直到离开纠错区间。
  - 场景：动作标准类，需要特定关键帧区间保持正确动作
  - 示例：膝内扣（深蹲）；膝内扣（弓步）
- **实时跟随**：
  - 逻辑：`最终结果 = 当前帧状态` (无状态记忆)
  - 触发/解除：所见即所得，状态随每一帧检测结果实时跳变。
  - 场景：辅助参考线、非关键性的软性提示
  - 示例：脊柱曲率实时显示、重心投影点跟随

## 纠错交互配置：
- **交互组名称**：
  - **绑定条件**：关联的错误项ID（如 `valgus`）
  - **状态：正确**：
    - **元素名称**：
      - 类型：`对勾` | `圆点` | `线` | `提示词`
      - 位置/定义：关键点ID | 起点 -> 终点
      - 样式：颜色（如绿色）、实心/虚线
      - 内容：（仅提示词有效）
  - **状态：错误**：
    - **元素名称**：
      - 类型：`箭头` | `参考线` | `目标线` | `圆点` | `提示词`
      - 定义：起点 -> 终点 | 起点 + 方向
      - 方向：`垂直` | `水平` | `向外` | `向内`
      - 样式：颜色（如红色）、实心/虚线
      - 动效：`弹性` | `呼吸`
      - 内容：（仅提示词有效）

指引箭头配置：
锚点：起点 | 终点 （2选1）
起点：接近起点，从起点发出
终点：接近终点，指向终点
方向：水平 | 竖直 | 起终
水平：水平向左 | 水平向右 | 水平向目标
水平：竖直向左 | 竖直向右 | 竖直向目标
起终：锚点为起点就指向终点；锚点为终点就指向起点
