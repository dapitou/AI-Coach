动作识别纠错系统 PRD (V2.4.0)
1. 基础概述
本系统是一个基于RGB摄像头的实时 AI 健身教练 Demo。通过计算机视觉技术捕捉用户动作，提供实时计数、错误检测、语音反馈及可视化交互特效。系统需保证在 Windows 10 环境下流畅运行，且代码结构清晰、无 Bug

1.1 核心能力
动作捕捉：实时捕捉全身 33 个关键骨骼点（高精度模式）
多动作切换：支持“推举”、“深蹲”、“前平举”等动作的无缝切换
智能纠错：基于生物力学与几何差分模型，提供高精度的动作错误检测（如弓背、膝内扣）
数据看板：实时展示计数、正确率及各类错误统计
双屏交互：左侧实时画面，右侧 3D 火柴人同步映射，支持视窗自适应缩放

2. 版本适配与工程要求
环境：Windows 10, Python 3.10。
依赖：
- numpy == 1.26.4
- mediapipe == 0.10.9
- opencv-python == 4.10.0
- pygame (用于音效)
- pillow (用于 UI 渲染)
性能：在主流 PC 上保持 30 FPS 以上，无明显卡顿或闪退
视窗：1920x1080 自适应，支持中心裁剪与拖拽缩放。关闭按钮功能正常

3. 全局通用逻辑：

3.1 状态机：
所有动作遵循统一的生命周期管理：
- START：动作未开始或静止状态。
- UP / DOWN：动作过程中的向心/离心阶段（根据具体动作定义）

3.2 计数逻辑：
仅当用户姿态通过“相似度门控”（Gatekeeper）判定为当前选择的动作时，才进行计数
完成一次完整的 UP-DOWN 循环：计数 +1

3.3 纠错逻辑 ：
错误统计：零容忍。只要单次动作判定为错误，立即计入“错误统计”并更新“正确率”
纠错反馈：有容忍。只有连续 2 次动作判定为同一类型错误，才触发纠错交互（特效+音效）；错误解除后立即消失

3.2 脊柱拟合算法 (Geometric Spine V2.4)
采用“高响应差分驱动模型”，在 2D 画面中模拟 3D 脊柱形态：
- 直背：颈部中点与髋部中点连线为基准直线
- 侧屈 ：基于 (左侧躯干长 - 右侧躯干长) 的差值驱动，脊柱向较长一侧凸起
弓背/反弓：基于 (最大躯干长 - 当前躯干长) 的压缩率驱动
Hinge 补偿：根据躯干倾角动态扣除视差导致的压缩
方向判定：若躯干前倾（俯身），压缩 = 弓背（向后凸）；若躯干直立，压缩 = 挺胸（向前凸）
高感响应：放大微小的压缩信号，确保视觉反馈清晰可见

3.3 数据与正确率
正确率公式：Max(0, (总动作次数 - 有效错误次数) / 总动作次数) * 100%
UI 表现：
- 次数/统计值为空时，显示为 0 或不显示
- 正确率为 NaN 时，显示 -

4. UI 与交互设计：

4.1 布局规范
整体结构：16:9 宽屏，左右 1:1 分屏
- 左侧：摄像头实景 + 骨骼点 + 交互特效
- 右侧：纯黑背景 + 3D 风格虚拟人（Avatar）同步动作
顶部数据栏（纯文字+阴影，无边框，从右向左排列）：
- 计数 ：最右侧，黄色大号字体
- 正确率：紧邻计数左侧，根据数值变色（≥80% 绿；≥60% 橙；否则红）
- 纠错统计：动态显示已触发的错误项（如“耸肩: 5”），未触发不显示
左上角：动作选择下拉框 + 身高输入框（带边框背景）
左下角：实时 FPS
左下角：支持切换视频源为摄像头（默认）还是本地视频文件

4.2 纠错交互规范：
所有纠错交互需遵循“物理引导”原则：
- 错误状态（红色）：关键线：实线；目标线：虚线；关键点：圆点；目标点：红色圆圈
- 引导修正（红色）：
 · 样式1 - 箭头：方向按定义；弹性动画；与点线保持一定距离；自适应大小；确保清晰可见又不过大
- 正确状态（绿色）：动作修正时，相关元素实时变色，箭头变为“√”

5. 动作定义详解：
【耸肩 - 通用】
错误触发：肩部与耳垂距离显著缩短（< 阈值）
错误解除：肩部与耳垂距离恢复（≥ 阈值）
纠错交互：
- 文案：“动作中耸肩影响训练效果！”

【弓背 - 通用】
触发：仅侧身；俯身角 > 15° 且 躯干有效压缩率 > 2%（扣除视差补偿后）
文案：“背部挺直，不要弓腰！”
特效：
红色实线：描绘弯曲的脊柱形态（颈-胸-腰-髋）
绿色虚线：连接颈髋的理想直背线
橙色箭头：从脊柱弯曲最远点（通常是腰）垂直指向理想线，暗示“顶腰”

【推举】
相似度门控：
判定：手腕 Y 坐标 < 肩膀 Y 坐标 + 200px
提示：红色常显“请做‘推举’动作”

错误 1：小臂不垂直
错误触发：小臂偏离垂直线 > 25°
错误解除：小臂偏离垂直线 ≤ 25°
纠错交互：
- 关键线：小臂（肘到手腕）
- 目标线：肘部垂直向上长出；与小臂实时等长
- 关键点：手腕
- 目标点：目标线上端点
- 引导：
 · 样式：箭头
 · 起点：肘部
 · 方向：指向目标线方向（水平）
 · 功能：引导小臂垂直
- 文案：“小臂全程垂直于地面效果更好！”

错误 2：耸肩 - 通用


【深蹲】
相似度门控：
判定：双髋水平距离 > 20px（排除侧身）
提示：红色常显“请做‘深蹲’动作”
错误 1：膝关节内扣
开启膝内扣检测：下蹲幅度至髋膝高度约1/3距离时开启膝内扣检测（仅下蹲过程至最低点检测，从最低点向上站起全程不要检测）
错误触发：下蹲过程中，双膝间距 < 脚踝间距 × 0.95
错误解除：下蹲过程中，双膝间距 ≥ 脚踝间距 × 0.95
纠错交互：
- 关键点：双膝
- 引导样式：错误：箭头；正确：√
  · 起点：膝
  · 方向：指向身体外侧（水平；背向身体中轴线）
  · 功能：引导膝外展
- 文案：“注意膝关节不要内扣！”
错误 2：深蹲幅度
错误触发：下蹲最低点时，双髋中点相对双脚中点垂直高度 ＞ 双膝中点相对双脚中点垂直高度（未蹲够深度）
错误解除：下蹲最低点时，双髋中点相对双脚中点垂直高度 ≤ 双膝中点相对双脚中点垂直高度（蹲够深度）
纠错交互：
- 关键点：双髋连线中点
- 目标点：双膝连线中点
- 引导样式：连线（起点→终点）
  · 起点：关键点
  · 终点：目标点
- 文案：“蹲至大腿平行地面效果更好！”
纠错 3：弓背 - 通用

【前平举】
相似度门控：
判定：双手间距 ≤ 肩宽 × 2.5（排除侧平举）
提示：红色常显“请做‘前平举’动作”

错误 1：抬臂幅度
错误触发：抬臂至最高点时，肘部高度＜肩部水平高度（3D 空间换算）
错误解除：抬臂至最高点时，肘部高度 ≥ 肩部水平高度（ 3D 空间换算）
纠错交互：
- 关键点：肘
- 目标点：目标线末端点
- 关键线：大臂（肩到肘）
- 目标线：从肩部向身体正前方（3D空间）发出的水平虚线（肘抬高理想高度）
- 引导：
 · 引导样式：错误：箭头；正确：√
 · 起点：手
 · 方向：指向目标线方向（垂直向上）
 · 功能：引导抬肘过肩高
- 文案：“肘部抬至与肩等高效果更好”

纠错 2：耸肩 - 通用

【弓步蹲】 
相似度门控： 判定：双脚 X 轴间距 ＞ 肩宽 × 0.5（确保分腿站立） 
提示：红色常显“请做‘弓步蹲’动作”

错误 1：膝关节内扣
开启膝内扣检测：下蹲幅度至髋膝高度约1/3距离时开启膝内扣检测（仅下蹲过程至最低点检测，从最低点向上站起全程不要检测）
前腿判断：脚踝在屏幕中高度最低的腿为前腿
错误触发：下蹲过程中，前腿膝与双髋中点垂线的水平间距 < 前腿脚踝与双髋中点垂线的水平间距 × 0.95
错误解除：下蹲过程中，前腿膝与双髋中点垂线的水平间距 ≥ 前腿脚踝与双髋中点垂线的水平间距 × 0.95
纠错交互：
- 关键点：前腿膝
 · 引导样式：错误：箭头；正确：√
 · 起点：前腿膝
 · 方向：指向身体外侧（水平；背向身体中轴线）
 · 功能：引导膝外展
- 文案：“注意前腿膝关节不要内扣！”

错误 2：弓步幅度
错误触发：下蹲最低点时，双髋中点相对双脚中点垂直高度 ＞ 前腿膝相对双脚中点垂直高度（未蹲够深度）
错误解除：下蹲最低点时，双髋中点相对双脚中点垂直高度 ≤ 前腿膝相对双脚中点垂直高度（蹲够深度）
纠错交互：
- 关键点：双髋连线中点
- 目标点：双髋连线中点竖直向下做垂线，垂线上与前腿膝等高的点
- 目标线：关键点与目标点连线
- 文案：“蹲至前腿平行地面效果更好！”

已锁定的核心逻辑基准(V2.20.0Baseline)
1.深蹲(Squat)-绝对稳定流
计次核心:绝对像素问值。
Down:髋部低于膝盖80px。
Up:髋部高于膝盖120px。
状态机:严格遵循START  DOWN 闭环,杜绝中间态反复跳变导致的计次漂移
内扣判定:双膝vs双髋。
阈值:膝宽<赣宽*1.2(宽容度高,符合人体工学)。
触发时机:仅在DOWN状态+正在下降+进入深层区域时触发发
特效:基于双膝,红色箭头水平向外。

2.弓步蹲(Lunge)-相对位移流
计次核心:相对躯干比例(因为弓步蹲绝对高度变化小)。
Down:髋部较站立点下降>15%躯干长。
Up:髋部回升至<10%躯干长。
内扣判定:前膝vs髋中线。
阈值:前膝偏离中线<(1/2 髋宽)
*0.95
触发时机:仅在 DOWN 状态+正在下降幅度足够时触发
特效:基于前腿膝盖,红色箭头动态指向外侧,辅助线为足中点向上垂线



