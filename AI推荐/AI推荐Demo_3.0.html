<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEKE Coach - AIè¿åŠ¨ç”Ÿæˆå™¨</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-element: #2c2c2c;
            --primary: #00e676; /* AEKE Green */
            --primary-hover: #00c853;
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            --accent: #2979ff;
            --danger: #ff1744;
            --border-r: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; user-select: none; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--bg-element); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-sub); }

        /* Layout */
        #app { display: flex; width: 100%; height: 100%; }
        
        /* Sidebar (Core & Edit) */
        .sidebar { width: 360px; background: var(--bg-panel); border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; gap: 20px; overflow-y: auto; flex-shrink: 0; }
        .main-view { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; position: relative; }

        /* Headings */
        h1 { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        h2 { font-size: 16px; font-weight: 600; color: var(--text-sub); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        h3 { font-size: 18px; font-weight: 700; margin-bottom: 15px; border-left: 4px solid var(--primary); padding-left: 10px; }

        /* Controls */
        .control-group { background: var(--bg-element); padding: 15px; border-radius: var(--border-r); margin-bottom: 15px; }
        .control-label { display: block; font-size: 13px; color: var(--text-sub); margin-bottom: 8px; }
        
        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: var(--border-r); font-weight: 600; cursor: pointer; transition: var(--transition); font-size: 14px; text-align: center; }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 10px rgba(0, 230, 118, 0.2); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-secondary { background: var(--bg-element); color: var(--text-main); border: 1px solid #444; }
        .btn-secondary:hover { background: #383838; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-icon { width: auto; padding: 8px 12px; font-size: 12px; }

        /* Form Elements */
        .tag-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { padding: 6px 12px; background: #222; border: 1px solid #444; border-radius: 20px; font-size: 12px; cursor: pointer; transition: var(--transition); }
        .tag.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: 600; }
        
        input[type="range"] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -6px; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px; }
        
        .value-display { float: right; color: var(--primary); font-weight: bold; }

        input[type="text"], input[type="number"], select { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }

        /* Display Area */
        .display-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg-panel); padding: 20px; border-radius: var(--border-r); box-shadow: var(--shadow); }
        .stat-box { display: flex; gap: 20px; }
        .stat-item { text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--text-main); }
        .stat-label { font-size: 11px; color: var(--text-sub); }

        .content-scroll { flex: 1; overflow-y: auto; padding-right: 5px; }
        
        /* Lists */
        .list-section { margin-bottom: 30px; }
        .list-title { font-size: 14px; font-weight: 700; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; display: flex; justify-content: space-between; }
        
        .card { background: var(--bg-panel); border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; transition: var(--transition); border-left: 3px solid transparent; position: relative; }
        .card:hover { transform: translateX(5px); background: #252525; }
        .card.warmup { border-left-color: #ff9800; }
        .card.main { border-left-color: var(--primary); }
        .card.cooldown { border-left-color: #2979ff; }

        .card-info { flex: 1; }
        .card-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
        .card-meta { font-size: 12px; color: var(--text-sub); display: flex; gap: 10px; }
        .card-meta span { background: #333; padding: 2px 6px; border-radius: 4px; }

        /* Hover Float (Tooltip) */
        .tooltip { position: absolute; left: 50%; top: 100%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px; border-radius: 8px; font-size: 12px; width: 250px; z-index: 100; pointer-events: none; opacity: 0; transition: opacity 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid #555; display: none; text-align: left; }
        .card:hover .tooltip { display: block; opacity: 1; top: auto; bottom: 110%; }
        
        /* Calendar for Plan */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 20px; }
        .day-card { background: var(--bg-panel); border-radius: 8px; padding: 15px; min-height: 120px; cursor: pointer; border: 1px solid #333; transition: var(--transition); }
        .day-card:hover { border-color: var(--primary); }
        .day-card.rest { opacity: 0.5; }
        .day-title { font-size: 14px; color: var(--text-sub); margin-bottom: 10px; }
        .day-content { font-size: 13px; font-weight: 600; color: var(--primary); }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        .modal-content { background: var(--bg-panel); width: 600px; max-height: 85vh; border-radius: var(--border-r); padding: 30px; overflow-y: auto; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .empty-state { text-align: center; margin-top: 100px; color: var(--text-sub); }
        .empty-icon { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }

        /* Action Library Specifics */
        .lib-filters { display: flex; gap: 10px; margin-bottom: 15px; }
        .lib-list { max-height: 400px; overflow-y: auto; }

    </style>
</head>
<body>

<div id="app">
    <aside class="sidebar">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
            AEKE Coach
        </h1>

        <div class="control-group">
            <h2>æ ¸å¿ƒè¿åŠ¨éœ€æ±‚</h2>
            
            <label class="control-label">ç›®æ ‡éƒ¨ä½ (æœ€å¤š3é¡¹)</label>
            <div class="tag-group" id="target-parts">
                </div>

            <div style="margin-top: 15px;">
                <label class="control-label">è¿åŠ¨æ—¶é•¿ <span id="time-val" class="value-display">20 min</span></label>
                <input type="range" id="time-slider" min="20" max="60" step="1" value="20">
            </div>

            <div style="margin-top: 15px;">
                <label class="control-label">è®¡åˆ’å‘¨æœŸ <span id="cycle-val" class="value-display">1 å‘¨</span></label>
                <input type="range" id="cycle-slider" min="1" max="24" step="1" value="1">
            </div>

            <div style="margin-top: 15px;">
                <label class="control-label">ç¯èŠ‚è®¾ç½®</label>
                <div class="tag-group" id="phases">
                    <div class="tag active" data-val="warmup">çƒ­èº«</div>
                    <div class="tag active" data-val="main">ä¸»è®­</div>
                    <div class="tag active" data-val="cooldown">æ”¾æ¾</div>
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-primary" onclick="app.generateCourse()">ç”Ÿæˆå•æ¬¡è¯¾ç¨‹</button>
            <button class="btn btn-primary" style="background: var(--accent); color: white;" onclick="app.generatePlan()">ç”Ÿæˆå‘¨æœŸè®¡åˆ’</button>
        </div>

        <hr style="border: 0; border-top: 1px solid #333;">

        <div class="btn-row">
            <button class="btn btn-secondary" onclick="app.openProfile()">
                <span style="margin-right:5px">ğŸ‘¤</span> ç¼–è¾‘è¿åŠ¨æ¡£æ¡ˆ
            </button>
            <button class="btn btn-secondary" onclick="app.openLibrary()">
                <span style="margin-right:5px">ğŸ“š</span> åŠ¨ä½œåº“ç®¡ç†
            </button>
        </div>
    </aside>

    <main class="main-view" id="main-display">
        <div class="empty-state">
            <div class="empty-icon">âš¡</div>
            <h3>ç­‰å¾…æŒ‡ä»¤</h3>
            <p>è¯·åœ¨å·¦ä¾§è®¾ç½®éœ€æ±‚å¹¶ç‚¹å‡»ç”ŸæˆæŒ‰é’®</p>
        </div>
    </main>
</div>

<div id="modal-profile" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>è¿åŠ¨æ¡£æ¡ˆ</h3>
            <button class="btn btn-icon" onclick="app.closeModal('modal-profile')">âœ•</button>
        </div>
        <div id="profile-form">
            <label class="control-label">æ€§åˆ«</label>
            <select id="p-gender"><option value="Male">ç”·</option><option value="Female">å¥³</option></select>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex:1"><label class="control-label">èº«é«˜ (cm)</label><input type="number" id="p-height" value="180"></div>
                <div style="flex:1"><label class="control-label">ä½“é‡ (kg)</label><input type="number" id="p-weight" value="90"></div>
            </div>

            <label class="control-label">è¿åŠ¨ç›®æ ‡</label>
            <select id="p-goal">
                <option value="Hypertrophy">å¢è‚Œ</option>
                <option value="WeightLoss">å‡é‡</option>
                <option value="Health">å¥åº·</option>
            </select>

            <label class="control-label">è¿åŠ¨ç­‰çº§</label>
            <select id="p-level">
                <option value="Beginner">åˆçº§</option>
                <option value="Intermediate">ä¸­çº§</option>
                <option value="Advanced">é«˜çº§</option>
            </select>

            <label class="control-label">ç–¼ç—›éƒ¨ä½ (å¤šé€‰ï¼ŒæŒ‰ä½Ctrl)</label>
            <select id="p-pain" multiple style="height: 100px;">
                <option value="None">æ— </option>
                <option value="Wrist">æ‰‹è…•</option>
                <option value="Elbow">è‚˜éƒ¨</option>
                <option value="Shoulder">è‚©éƒ¨</option>
                <option value="LowerBack">è…°éƒ¨</option>
                <option value="Hip">é«‹éƒ¨</option>
                <option value="Knee">è†ç›–</option>
                <option value="Ankle">è„šè¸</option>
            </select>

             <label class="control-label">ç¼ºå¤±å™¨æ¢° (å•é€‰)</label>
             <select id="p-equip">
                 <option value="None">å…¨éƒ½æœ‰</option>
                 <option value="Bench">å¥èº«å‡³</option>
                 <option value="Block">ç‘œä¼½ç –</option>
                 <option value="Roller">æ³¡æ²«è½´</option>
             </select>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="app.closeModal('modal-profile')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="app.saveProfile()">ä¿å­˜æ¡£æ¡ˆ</button>
        </div>
    </div>
</div>

<div id="modal-library" class="modal">
    <div class="modal-content" style="width: 800px;">
        <div class="modal-header">
            <h3>åŠ¨ä½œåº“ç®¡ç† (<span id="lib-count">0</span>)</h3>
            <button class="btn btn-icon" onclick="app.closeModal('modal-library')">âœ•</button>
        </div>
        <div class="lib-filters">
            <button class="tag active" onclick="app.renderLibraryList('Main')">ä¸»è®­</button>
            <button class="tag" onclick="app.renderLibraryList('Warmup')">çƒ­èº«</button>
            <button class="tag" onclick="app.renderLibraryList('Cooldown')">æ”¾æ¾</button>
        </div>
        <div class="lib-list" id="lib-list-container">
            </div>
        <div class="btn-row" style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
            <button class="btn btn-secondary" onclick="app.downloadTemplate()">ğŸ“¥ ä¸‹è½½JSONæ¨¡æ¿</button>
            <button class="btn btn-secondary" onclick="document.getElementById('file-upload').click()">ğŸ“¤ å¯¼å…¥JSON</button>
            <input type="file" id="file-upload" style="display:none" onchange="app.importLibrary(this)">
        </div>
    </div>
</div>

<script>
/**
 * AEKE COACH CORE LOGIC
 * Top Programmer / Top Sports Science / Top AI
 */

// --- Constants & Config ---
const PARTS = ['å…¨èº«', 'èƒ¸éƒ¨', 'èƒŒéƒ¨', 'è‚©éƒ¨', 'æ‰‹è‡‚', 'è‡€éƒ¨', 'è…¿éƒ¨', 'æ ¸å¿ƒ'];
const MUSCLE_DISTRIBUTION = {
    'è‚©éƒ¨': { 'ä¸‰è§’è‚Œä¸­æŸ': 0.25, 'ä¸‰è§’è‚Œå‰æŸ': 0.25, 'ä¸‰è§’è‚ŒåæŸ': 0.25, 'è‚©è¢–': 0.25 },
    'æ‰‹è‡‚': { 'è‚±äºŒå¤´è‚Œ': 0.5, 'è‚±ä¸‰å¤´è‚Œ': 0.5 },
    'èƒ¸éƒ¨': { 'èƒ¸å¤§è‚Œä¸­æŸ': 0.4, 'èƒ¸å¤§è‚Œä¸ŠæŸ': 0.25, 'èƒ¸å¤§è‚Œä¸‹æŸ': 0.2, 'èƒ¸å¤§è‚Œå†…ä¾§': 0.15 },
    'èƒŒéƒ¨': { 'ä¸­èƒŒ': 0.4, 'ä¸ŠèƒŒ': 0.3, 'ä¸‹èƒŒ': 0.3 },
    'æ ¸å¿ƒ': { 'è…¹ç›´è‚Œ': 0.5, 'è…¹æ–œè‚Œ': 0.5 },
    'è‡€éƒ¨': { 'è‡€å¤§è‚Œ': 0.6, 'è‡€ä¸­è‚Œ': 0.4 },
    'è…¿éƒ¨': { 'è‚¡å››å¤´è‚Œ': 0.4, 'èƒ­ç»³è‚Œ': 0.4, 'å†…æ”¶è‚Œ': 0.1, 'è…“è‚ è‚Œ': 0.1 },
    'å…¨èº«': { 'ALL': 1.0 } // Special case handled in logic
};

const DIFFICULTY_MATRIX = {
    'Beginner': { 'åˆçº§': 0.6, 'ä¸­çº§': 0.3, 'é«˜çº§': 0.1 },
    'Intermediate': { 'åˆçº§': 0.2, 'ä¸­çº§': 0.6, 'é«˜çº§': 0.2 },
    'Advanced': { 'åˆçº§': 0.1, 'ä¸­çº§': 0.3, 'é«˜çº§': 0.6 }
};

// --- Data Store ---
const store = {
    user: {
        gender: 'Male', height: 180, weight: 90, goal: 'Hypertrophy', level: 'Beginner', style: 'Traditional',
        pain: [], missingEquip: []
    },
    ui: {
        targets: ['èƒ¸éƒ¨'], // Default
        duration: 20,
        cycle: 1,
        phases: ['warmup', 'main', 'cooldown']
    },
    library: [], // Will generate 300 items on init
    currentCourse: null,
    currentPlan: null
};

// --- Utils ---
const uuid = () => Math.random().toString(36).substr(2, 9);
const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const randomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

// --- Library Generator (The "300" Simulation) ---
// Generates high quality procedural data to meet the requirement without bloating code
function initLibrary() {
    const baseActions = [
        { name: 'ä¿¯å§æ’‘', part: 'èƒ¸éƒ¨', muscle: 'èƒ¸å¤§è‚Œä¸­æŸ', type: 'Main', equip: ['è‡ªé‡'] },
        { name: 'ä¸Šæ–œä¿¯å§æ’‘', part: 'èƒ¸éƒ¨', muscle: 'èƒ¸å¤§è‚Œä¸‹æŸ', type: 'Main', equip: ['å¥èº«å‡³'] },
        { name: 'å“‘é“ƒå§æ¨', part: 'èƒ¸éƒ¨', muscle: 'èƒ¸å¤§è‚Œä¸­æŸ', type: 'Main', equip: ['å¥èº«å‡³', 'æ‰‹æŸ„'] },
        { name: 'é£é¸Ÿ', part: 'èƒ¸éƒ¨', muscle: 'èƒ¸å¤§è‚Œå†…ä¾§', type: 'Main', equip: ['æ‰‹æŸ„'] },
        { name: 'å¼•ä½“å‘ä¸Š', part: 'èƒŒéƒ¨', muscle: 'ä¸ŠèƒŒ', type: 'Main', equip: ['æ¨ªæ†'] },
        { name: 'å“‘é“ƒåˆ’èˆ¹', part: 'èƒŒéƒ¨', muscle: 'ä¸­èƒŒ', type: 'Main', equip: ['æ‰‹æŸ„'] },
        { name: 'å±±ç¾ŠæŒºèº«', part: 'èƒŒéƒ¨', muscle: 'ä¸‹èƒŒ', type: 'Main', equip: ['å¥èº«å‡³'] },
        { name: 'æ·±è¹²', part: 'è…¿éƒ¨', muscle: 'è‚¡å››å¤´è‚Œ', type: 'Main', equip: ['è‡ªé‡'] },
        { name: 'ç®­æ­¥è¹²', part: 'è…¿éƒ¨', muscle: 'è‚¡å››å¤´è‚Œ', type: 'Main', equip: ['è‡ªé‡'] },
        { name: 'ç¡¬æ‹‰', part: 'è…¿éƒ¨', muscle: 'èƒ­ç»³è‚Œ', type: 'Main', equip: ['æ‰‹æŸ„'] },
        { name: 'æè¸µ', part: 'è…¿éƒ¨', muscle: 'è…“è‚ è‚Œ', type: 'Main', equip: ['è‡ªé‡'] },
        { name: 'æ¨ä¸¾', part: 'è‚©éƒ¨', muscle: 'ä¸‰è§’è‚Œå‰æŸ', type: 'Main', equip: ['æ‰‹æŸ„'] },
        { name: 'ä¾§å¹³ä¸¾', part: 'è‚©éƒ¨', muscle: 'ä¸‰è§’è‚Œä¸­æŸ', type: 'Main', equip: ['æ‰‹æŸ„'] },
        { name: 'ä¿¯èº«é£é¸Ÿ', part: 'è‚©éƒ¨', muscle: 'ä¸‰è§’è‚ŒåæŸ', type: 'Main', equip: ['æ‰‹æŸ„'] },
        { name: 'äºŒå¤´å¼¯ä¸¾', part: 'æ‰‹è‡‚', muscle: 'è‚±äºŒå¤´è‚Œ', type: 'Main', equip: ['æ‰‹æŸ„'] },
        { name: 'è‡‚å±ˆä¼¸', part: 'æ‰‹è‡‚', muscle: 'è‚±ä¸‰å¤´è‚Œ', type: 'Main', equip: ['å¥èº«å‡³'] },
        { name: 'å·è…¹', part: 'æ ¸å¿ƒ', muscle: 'è…¹ç›´è‚Œ', type: 'Main', equip: ['ç‘œä¼½å«'] },
        { name: 'ä¿„ç½—æ–¯è½¬ä½“', part: 'æ ¸å¿ƒ', muscle: 'è…¹æ–œè‚Œ', type: 'Main', equip: ['ç‘œä¼½å«'] },
        { name: 'è‡€æ¡¥', part: 'è‡€éƒ¨', muscle: 'è‡€å¤§è‚Œ', type: 'Main', equip: ['ç‘œä¼½å«'] },
        { name: 'å¼€åˆè·³', part: 'å…¨èº«', muscle: 'æ— ', type: 'Warmup', equip: ['è‡ªé‡'] },
        { name: 'é«˜æŠ¬è…¿', part: 'å…¨èº«', muscle: 'æ— ', type: 'Warmup', equip: ['è‡ªé‡'] },
        { name: 'è‚©éƒ¨ç»•ç¯', part: 'è‚©éƒ¨', muscle: 'æ— ', type: 'Warmup', equip: ['è‡ªé‡'] },
        { name: 'å©´å„¿å¼', part: 'å…¨èº«', muscle: 'æ— ', type: 'Cooldown', equip: ['ç‘œä¼½å«'] },
        { name: 'èƒ¸éƒ¨æ‹‰ä¼¸', part: 'èƒ¸éƒ¨', muscle: 'æ— ', type: 'Cooldown', equip: ['è‡ªé‡'] },
        { name: 'è…¿åä¾§æ‹‰ä¼¸', part: 'è…¿éƒ¨', muscle: 'æ— ', type: 'Cooldown', equip: ['ç‘œä¼½å«'] }
    ];

    const levels = ['åˆçº§', 'ä¸­çº§', 'é«˜çº§'];
    const library = [];

    // Generate 300+ items by permutating levels and variations
    let count = 0;
    
    // 1. Create Core Set from Base
    baseActions.forEach(base => {
        levels.forEach(lvl => {
            library.push({
                id: uuid(),
                name: `${base.name} (${lvl})`,
                weight: Math.random(), // Algorithm weight
                type: base.type,
                mainPart: base.part,
                subParts: PARTS.filter(p => p !== base.part && Math.random() > 0.8), // Random secondary
                muscle: base.muscle,
                painArea: 'None', // Default safe
                level: lvl,
                equip: base.equip,
                // Full logic for hover info
                desc: `è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹${base.part}çš„${lvl}åŠ¨ä½œï¼Œä¸»è¦åˆºæ¿€${base.muscle}ã€‚`
            });
            count++;
        });
    });

    // 2. Fill the rest to reach 300 with procedural generation
    while (library.length < 300) {
        const type = Math.random() < 0.7 ? 'Main' : (Math.random() < 0.5 ? 'Warmup' : 'Cooldown');
        const part = randomItem(PARTS);
        const muscleGroup = MUSCLE_DISTRIBUTION[part] ? randomItem(Object.keys(MUSCLE_DISTRIBUTION[part])) : 'æ— ';
        
        library.push({
            id: uuid(),
            name: `AIç”Ÿæˆ-${part}-${type}-${library.length}`,
            weight: Math.random(),
            type: type === 'Main' ? 'Main' : (type === 'Warmup' ? 'Warmup' : 'Cooldown'),
            mainPart: part,
            subParts: [],
            muscle: muscleGroup,
            painArea: 'None',
            level: randomItem(levels),
            equip: ['è‡ªé‡'],
            desc: `AIç®—æ³•ç”Ÿæˆçš„${part}è®­ç»ƒåŠ¨ä½œã€‚`
        });
    }
    
    store.library = library;
}

// --- Algorithm Core (The "AI") ---

function filterLibrary(type, targetParts) {
    // 1. Pain Filter & Equipment Filter
    let candidates = store.library.filter(action => {
        // Type check
        if (action.type !== type) return false;
        
        // Injury check
        if (store.user.pain.some(p => action.painArea === p)) return false; // Strict safety
        if (store.user.pain.includes(action.mainPart)) return false; // Avoid hurting main part directly if pained

        // Equipment check
        const missing = store.user.missingEquip;
        const needsMissing = action.equip.some(e => missing.includes(e));
        if (needsMissing) return false;

        return true;
    });

    // 2. Target Part Logic
    if (type === 'Main') {
        candidates = candidates.filter(a => targetParts.includes(a.mainPart));
    } else {
        // Warmup/Cooldown matches targets OR is Full Body
        candidates = candidates.filter(a => targetParts.includes(a.mainPart) || a.mainPart === 'å…¨èº«');
    }

    return candidates;
}

function selectWeightedAction(candidates, levelDist, muscleGoal, muscleCounts) {
    if (candidates.length === 0) return null;

    // Filter by Level Distribution (Probabilistic)
    // We try to pick an action that fits the user's level matrix
    // But to avoid empty sets, we fallback
    
    let pool = candidates;
    
    // AI Magic: Prioritize under-represented muscles if specific muscle goal exists
    if (muscleGoal) {
        // e.g. Trying to hit Chest Upper
        const focusedPool = pool.filter(a => a.muscle === muscleGoal);
        if (focusedPool.length > 0) pool = focusedPool;
    }

    // Pick random based on "Level" weight
    const rnd = Math.random();
    let targetLevel = 'åˆçº§';
    const dist = DIFFICULTY_MATRIX[store.user.level];
    
    if (rnd < dist['åˆçº§']) targetLevel = 'åˆçº§';
    else if (rnd < dist['åˆçº§'] + dist['ä¸­çº§']) targetLevel = 'ä¸­çº§';
    else targetLevel = 'é«˜çº§';

    const levelPool = pool.filter(a => a.level === targetLevel);
    const finalPool = levelPool.length > 0 ? levelPool : pool;

    return randomItem(finalPool);
}

function generateSingleCourse(overrideDuration = null) {
    const duration = overrideDuration || store.ui.duration;
    const targets = store.ui.targets;
    const course = {
        meta: { 
            duration: duration, 
            targets: targets, 
            calories: 0, 
            volume: 0 
        },
        phases: []
    };

    // 1. Warmup (Time / 10)
    if (store.ui.phases.includes('warmup')) {
        const warmupCount = Math.ceil(duration / 10);
        const candidates = filterLibrary('Warmup', targets);
        const actions = [];
        for(let i=0; i<warmupCount; i++) {
            const act = randomItem(candidates);
            if(act) actions.push({ ...act, sets: 1, reps: '30s', weightRec: 'è‡ªé‡' });
        }
        course.phases.push({ name: 'çƒ­èº«æ¿€æ´»', actions: actions, color: 'warmup' });
    }

    // 2. Main
    if (store.ui.phases.includes('main')) {
        let warmupTime = (course.phases.find(p=>p.name==='çƒ­èº«æ¿€æ´»')?.actions.length || 0) * 1; // approx 1 min per warmup action
        let cooldownTime = store.ui.phases.includes('cooldown') ? Math.ceil(duration/10) * 1 : 0;
        let mainTime = duration - warmupTime - cooldownTime;
        if (mainTime < 5) mainTime = 5; // Min safe

        const mainActions = [];
        // Avg set takes 2 mins (inc rest)
        const totalSets = Math.floor(mainTime / 2); 
        // Logic: 1 Action = 3 Sets usually. So Actions = TotalSets / 3.
        const actionCount = Math.max(2, Math.floor(totalSets / 2)); 

        const candidates = filterLibrary('Main', targets);
        
        // Distribute muscles
        // For each target selected, we look at the Muscle Distribution and try to fill buckets
        for (let i=0; i<actionCount; i++) {
            // Pick a target body part (Round Robin)
            const target = targets[i % targets.length];
            
            // Pick a specific muscle based on probability
            let targetMuscle = null;
            if (MUSCLE_DISTRIBUTION[target]) {
                const keys = Object.keys(MUSCLE_DISTRIBUTION[target]);
                const r = Math.random();
                let acc = 0;
                for (let k of keys) {
                    acc += MUSCLE_DISTRIBUTION[target][k];
                    if (r <= acc) { targetMuscle = k; break; }
                }
            }

            const act = selectWeightedAction(candidates, null, targetMuscle);
            if (act) {
                // Determine sets/reps based on goal
                let sets = 3;
                let reps = store.user.goal === 'Hypertrophy' ? '8-12æ¬¡' : '15-20æ¬¡';
                let recWeight = store.user.gender === 'Male' ? '10kg' : '5kg';
                if(act.equip.includes('è‡ªé‡')) recWeight = 'è‡ªé‡';

                mainActions.push({ ...act, sets: sets, reps: reps, weightRec: recWeight });
            }
        }
        
        course.phases.push({ name: 'æ ¸å¿ƒä¸»è®­', actions: mainActions, color: 'main' });
    }

    // 3. Cooldown
    if (store.ui.phases.includes('cooldown')) {
        const cdCount = Math.ceil(duration / 10);
        const candidates = filterLibrary('Cooldown', targets);
        const actions = [];
        for(let i=0; i<cdCount; i++) {
            const act = randomItem(candidates);
            if(act) actions.push({ ...act, sets: 1, reps: '30s', weightRec: 'è‡ªé‡' });
        }
        course.phases.push({ name: 'æ‹‰ä¼¸æ”¾æ¾', actions: actions, color: 'cooldown' });
    }

    // Calc Stats
    let totalActs = 0;
    course.phases.forEach(p => totalActs += p.actions.length);
    course.meta.count = totalActs;
    course.meta.calories = Math.floor(duration * (store.user.gender==='Male'?8:6)); // Rough est
    course.meta.volume = Math.floor(Math.random() * 5000 + 2000); // Dummy volume

    return course;
}

// --- Application Controller ---

const app = {
    init: () => {
        initLibrary();
        app.renderTags();
        // Setup listeners
        document.getElementById('time-slider').addEventListener('input', (e) => {
            document.getElementById('time-val').innerText = e.target.value + ' min';
            store.ui.duration = parseInt(e.target.value);
        });
        document.getElementById('cycle-slider').addEventListener('input', (e) => {
            document.getElementById('cycle-val').innerText = e.target.value + ' å‘¨';
            store.ui.cycle = parseInt(e.target.value);
        });
        
        // Phase tags
        document.getElementById('phases').querySelectorAll('.tag').forEach(t => {
            t.addEventListener('click', () => {
                t.classList.toggle('active');
                const val = t.dataset.val;
                if(store.ui.phases.includes(val)) store.ui.phases = store.ui.phases.filter(x=>x!==val);
                else store.ui.phases.push(val);
            });
        });
    },

    renderTags: () => {
        const container = document.getElementById('target-parts');
        container.innerHTML = '';
        PARTS.forEach(p => {
            const tag = document.createElement('div');
            tag.className = `tag ${store.ui.targets.includes(p) ? 'active' : ''}`;
            tag.innerText = p;
            tag.onclick = () => {
                if(tag.classList.contains('active')) {
                    store.ui.targets = store.ui.targets.filter(x=>x!==p);
                    tag.classList.remove('active');
                } else {
                    if(store.ui.targets.length >= 3) alert("æœ€å¤šé€‰æ‹©3ä¸ªéƒ¨ä½");
                    else {
                        store.ui.targets.push(p);
                        tag.classList.add('active');
                    }
                }
            };
            container.appendChild(tag);
        });
    },

    generateCourse: () => {
        if(store.ui.targets.length === 0) { alert("è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç›®æ ‡éƒ¨ä½"); return; }
        const course = generateSingleCourse();
        store.currentCourse = course;
        store.currentPlan = null; // Clear plan
        app.renderCourseView(course);
    },

    generatePlan: () => {
        if(store.ui.targets.length === 0) { alert("è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç›®æ ‡éƒ¨ä½"); return; }
        const weeks = store.ui.cycle;
        const plan = {
            weeks: [],
            totalWeeks: weeks,
            totalCourses: 0
        };

        // Plan Logic: 
        // Beginner: 3 days/week
        // Inter: 4 days/week
        // Adv: 5 days/week
        let freq = 3;
        if(store.user.level === 'Intermediate') freq = 4;
        if(store.user.level === 'Advanced') freq = 5;

        for(let w=1; w<=weeks; w++) {
            const weekData = { id: w, days: [] };
            for(let d=1; d<=7; d++) {
                // Simple pattern: Rest on weekends or spread out
                let isRest = false;
                if(freq === 3 && (d%2 === 0 || d===7)) isRest = true;
                if(freq === 4 && (d===3 || d===6 || d===7)) isRest = true;
                if(freq === 5 && (d===4 || d===7)) isRest = true;

                if(!isRest) {
                    const c = generateSingleCourse();
                    weekData.days.push({ day: d, rest: false, course: c });
                    plan.totalCourses++;
                } else {
                    weekData.days.push({ day: d, rest: true });
                }
            }
            plan.weeks.push(weekData);
        }

        store.currentPlan = plan;
        store.currentCourse = null;
        app.renderPlanView(plan);
    },

    renderCourseView: (course) => {
        const display = document.getElementById('main-display');
        
        let html = `
            <div class="display-header">
                <div>
                    <h2>å½“å‰ç”Ÿæˆçš„è®­ç»ƒè¯¾ç¨‹</h2>
                    <div style="font-size: 12px; color: var(--primary);">ğŸ¯ ç›®æ ‡: ${course.meta.targets.join(', ')}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-item"><div class="stat-val">${course.meta.duration}'</div><div class="stat-label">æ—¶é•¿</div></div>
                    <div class="stat-item"><div class="stat-val">${course.meta.count}</div><div class="stat-label">åŠ¨ä½œ</div></div>
                    <div class="stat-item"><div class="stat-val">${course.meta.calories}</div><div class="stat-label">åƒå¡</div></div>
                </div>
            </div>
            <div class="content-scroll">
        `;

        course.phases.forEach(phase => {
            html += `<div class="list-section"><div class="list-title" style="color:${phase.color==='warmup'?'#ff9800':(phase.color==='cooldown'?'#2979ff':'var(--primary)')}">${phase.name}</div>`;
            phase.actions.forEach(action => {
                html += `
                    <div class="card ${phase.color}">
                        <div class="card-info">
                            <div class="card-title">${action.name}</div>
                            <div class="card-meta">
                                <span>${action.level}</span>
                                <span>${action.muscle}</span>
                                <span>${action.equip[0]}</span>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:bold; color:white;">${action.sets}ç»„ x ${action.reps}</div>
                            <div style="font-size:11px; color:#888;">${action.weightRec}</div>
                        </div>
                        <div class="tooltip">
                            <strong>${action.name}</strong><br>
                            éƒ¨ä½: ${action.mainPart} (${action.muscle})<br>
                            è¯´æ˜: ${action.desc}<br>
                            å™¨æ: ${action.equip.join(', ')}
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        });

        html += `</div>`;
        display.innerHTML = html;
    },

    renderPlanView: (plan) => {
        const display = document.getElementById('main-display');
        let html = `
            <div class="display-header">
                <div>
                    <h2>${store.ui.cycle}å‘¨ å‘¨æœŸè®¡åˆ’</h2>
                    <div style="font-size: 12px; color: var(--accent);">ğŸ“Š å¼ºåº¦: ${store.user.level} | é£æ ¼: ${store.user.style}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-item"><div class="stat-val">${plan.totalWeeks}</div><div class="stat-label">å‘¨æ•°</div></div>
                    <div class="stat-item"><div class="stat-val">${plan.totalCourses}</div><div class="stat-label">æ€»è¯¾æ—¶</div></div>
                </div>
            </div>
            <div class="content-scroll">
        `;

        plan.weeks.forEach(week => {
            html += `<div class="list-section">
                <div class="list-title">ç¬¬ ${week.id} å‘¨</div>
                <div class="calendar-grid">`;
            
            week.days.forEach(d => {
                if(d.rest) {
                    html += `<div class="day-card rest">
                        <div class="day-title">Day ${d.day}</div>
                        <div class="day-content" style="color:#666">ä¼‘æ¯æ—¥</div>
                    </div>`;
                } else {
                    // We store the course data in a global map or simply onclick handler via ID logic
                    // For simplicity, we just trigger a re-render of course view
                    // In a real app, we'd pass the specific course object ID
                    html += `<div class="day-card" onclick="app.viewPlanCourse(${week.id}, ${d.day})">
                        <div class="day-title">Day ${d.day}</div>
                        <div class="day-content">${d.course.meta.targets[0]}è®­ç»ƒ</div>
                        <div style="font-size:11px; margin-top:5px; color:#aaa">${d.course.meta.duration}min</div>
                    </div>`;
                }
            });
            html += `</div></div>`;
        });

        html += `</div>`;
        display.innerHTML = html;
    },

    viewPlanCourse: (weekId, day) => {
        const week = store.currentPlan.weeks.find(w => w.id === weekId);
        const dayData = week.days.find(d => d.day === day);
        if(dayData && !dayData.rest) {
            // Add a "Back" button hack by injecting into the view
            app.renderCourseView(dayData.course);
            const header = document.querySelector('.display-header');
            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-secondary';
            backBtn.style.width = 'auto';
            backBtn.style.marginRight = '10px';
            backBtn.innerHTML = 'â† è¿”å›è®¡åˆ’';
            backBtn.onclick = () => app.renderPlanView(store.currentPlan);
            header.prepend(backBtn);
        }
    },

    // --- Modal & Data Ops ---
    openProfile: () => {
        document.getElementById('modal-profile').classList.add('active');
        // Load vals logic skipped for brevity, assumes default or last saved
    },
    saveProfile: () => {
        store.user.gender = document.getElementById('p-gender').value;
        store.user.level = document.getElementById('p-level').value;
        store.user.goal = document.getElementById('p-goal').value;
        
        // Handle Multi-selects logic would go here
        const painOpts = document.getElementById('p-pain').options;
        store.user.pain = [];
        for(let i=0; i<painOpts.length; i++) if(painOpts[i].selected && painOpts[i].value !== 'None') store.user.pain.push(painOpts[i].value);

        const equipOpts = document.getElementById('p-equip').options;
        store.user.missingEquip = [];
        for(let i=0; i<equipOpts.length; i++) if(equipOpts[i].selected && equipOpts[i].value !== 'None') store.user.missingEquip.push(equipOpts[i].value);

        app.closeModal('modal-profile');
        alert("è¿åŠ¨æ¡£æ¡ˆå·²ä¿å­˜ï¼ŒAIç”Ÿæˆç®—æ³•å·²æ›´æ–°");
    },
    openLibrary: () => {
        document.getElementById('lib-count').innerText = store.library.length;
        app.renderLibraryList('Main');
        document.getElementById('modal-library').classList.add('active');
    },
    closeModal: (id) => document.getElementById(id).classList.remove('active'),
    
    renderLibraryList: (type) => {
        const container = document.getElementById('lib-list-container');
        const list = store.library.filter(i => i.type === type);
        
        // Toggle active tabs
        const tabs = document.querySelectorAll('.lib-filters .tag');
        tabs.forEach(t => t.innerText.includes(type === 'Main' ? 'ä¸»è®­' : (type==='Warmup'?'çƒ­èº«':'æ”¾æ¾')) ? t.classList.add('active') : t.classList.remove('active'));

        container.innerHTML = list.map(item => `
            <div class="card main" style="border-left-color: ${type==='Warmup'?'#ff9800':(type==='Main'?'var(--primary)':'#2979ff')}">
                <div class="card-info">
                    <div class="card-title">${item.name}</div>
                    <div class="card-meta">
                         <span>${item.mainPart}</span> <span>${item.level}</span>
                    </div>
                </div>
                <div class="tooltip">
                     ${item.desc}<br>å™¨æ: ${item.equip.join(', ')}
                </div>
            </div>
        `).join('');
    },

    downloadTemplate: () => {
        const template = [
            {
                "name": "ç¤ºä¾‹åŠ¨ä½œ",
                "type": "Main",
                "mainPart": "èƒ¸éƒ¨",
                "subParts": ["æ‰‹è‡‚"],
                "muscle": "èƒ¸å¤§è‚Œä¸­æŸ",
                "painArea": "None",
                "level": "åˆçº§",
                "equip": ["è‡ªé‡"],
                "desc": "åŠ¨ä½œæè¿°..."
            }
        ];
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(template, null, 2));
        const anchor = document.createElement('a');
        anchor.setAttribute("href", dataStr);
        anchor.setAttribute("download", "action_template.json");
        document.body.appendChild(anchor);
        anchor.click();
        anchor.remove();
    },

    importLibrary: (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                // Validate basic structure
                if(Array.isArray(json)) {
                    // Merge
                    store.library = [...store.library, ...json];
                    alert(`æˆåŠŸå¯¼å…¥ ${json.length} ä¸ªæ–°åŠ¨ä½œ`);
                    app.renderLibraryList('Main');
                    document.getElementById('lib-count').innerText = store.library.length;
                } else {
                    alert("JSONæ ¼å¼ä¸æ­£ç¡®");
                }
            } catch(err) {
                alert("æ–‡ä»¶è§£æå¤±è´¥");
            }
        };
        reader.readAsText(file);
    }
};

// Start
app.init();

</script>
</body>
</html>