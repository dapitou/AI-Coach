<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEKE AI Operations Backend</title>
    <title>AEKE AI 运营后台</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f1012;
            --bg-panel: #1a1c20;
            --bg-element: #25282e;
            --primary: #00e676;
            --text-main: #ffffff;
            --text-sub: #9ca3af;
            --border: 1px solid #333;
            --radius: 4px;
            --font: "PingFang SC", "Microsoft YaHei", sans-serif;
            --danger: #ff4081;
            --new-tag: #2979ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: var(--font); background-color: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; font-size: 13px; overflow: hidden; }
        
        /* LAYOUT */
        .sidebar { width: 220px; background: var(--bg-panel); border-right: var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .logo { padding: 20px; font-size: 16px; font-weight: 800; color: var(--primary); border-bottom: var(--border); }
        .nav-item { padding: 12px 20px; cursor: pointer; color: var(--text-sub); transition: 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: var(--bg-element); color: #fff; }
        .nav-item.active { background: rgba(0, 230, 118, 0.1); color: var(--primary); border-left-color: var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 50px; border-bottom: var(--border); background: var(--bg-panel); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        .breadcrumb { color: var(--text-sub); }
        
        .content-body { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* TABLES */
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .data-table th { text-align: left; padding: 10px; background: var(--bg-element); color: var(--text-sub); font-weight: normal; }
        .data-table td { padding: 10px; border-bottom: 1px solid #333; color: #eee; }
        .data-table tr:hover td { background: #222; }
        .status-badge { padding: 2px 6px; border-radius: 2px; font-size: 10px; background: #333; color: #aaa; }
        .status-badge.new { background: rgba(41, 121, 255, 0.2); color: var(--new-tag); }

        /* FORMS */
        .form-section { background: var(--bg-panel); border: var(--border); border-radius: var(--radius); margin-bottom: 20px; }
        .section-header { padding: 12px 20px; background: var(--bg-element); font-weight: 700; border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; padding: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: 1 / -1; }
        
        label { font-size: 12px; color: var(--text-sub); display: flex; align-items: center; gap: 6px; }
        .tag-new { font-size: 10px; color: var(--new-tag); background: rgba(41, 121, 255, 0.1); padding: 1px 4px; border-radius: 2px; }
        .tag-rename { font-size: 10px; color: #ffab00; background: rgba(255, 171, 0, 0.1); padding: 1px 4px; border-radius: 2px; }
        .tag-exist { font-size: 10px; color: #666; background: #222; padding: 1px 4px; border-radius: 2px; }
        
        input, select, textarea { background: #111; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; font-family: var(--font); font-size: 12px; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        
        /* DEPRECATED */
        .deprecated-box { padding: 20px; background: #151515; border-top: var(--border); color: #666; font-size: 12px; }
        .deprecated-title { font-weight: 700; margin-bottom: 10px; color: #888; }
        .deprecated-list { display: flex; flex-wrap: wrap; gap: 15px; }
        .deprecated-item { text-decoration: line-through; }

        /* BUTTONS */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #000; font-weight: 600; }
        .btn-primary:hover { background: #00c853; }
        .btn-secondary { background: #333; color: #fff; border: 1px solid #444; }
        .btn-secondary:hover { background: #444; border-color: #666; }
        .btn-text { background: transparent; color: var(--primary); padding: 0; }
        .btn-danger { background: transparent; color: var(--danger); padding: 0; }
        .btn-warn { background: transparent; color: #ffab00; padding: 0; }
        
        /* TABS */
        .tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; background: var(--bg-panel); }
        .tab-item { padding: 12px 20px; cursor: pointer; color: var(--text-sub); font-weight: 600; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab-item:hover { color: #fff; background: var(--bg-element); }
        .tab-item.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(0, 230, 118, 0.05); }
        
        /* SUB-LISTS (Segments/Stages) */
        .sub-list { display: flex; flex-direction: column; gap: 10px; }
        .sub-item { background: #222; border: 1px solid #444; padding: 10px; border-radius: 4px; }
        .sub-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; color: #ddd; }

        /* MULTI-SELECT */
        .multi-select { position: relative; width: 100%; outline: none; }
        .ms-trigger { background: #111; border: 1px solid #444; padding: 8px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 12px; min-height: 32px; box-sizing: border-box; }
        .ms-trigger:hover { border-color: #666; }
        .ms-value { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; margin-right: 8px; }
        .ms-arrow { font-size: 10px; color: #666; }
        .ms-options { position: absolute; top: 100%; left: 0; width: 100%; background: #1a1c20; border: 1px solid #444; border-radius: 4px; z-index: 1000; display: none; max-height: 240px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.5); margin-top: 4px; }
        .multi-select.open .ms-options { display: block; }
        .ms-option { padding: 8px 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #25282e; color: #ccc; }
        .ms-option:hover { background: #25282e; color: #fff; }
        .ms-option:last-child { border-bottom: none; }
        .ms-option input { margin: 0; width: 14px; height: 14px; accent-color: var(--primary); pointer-events: none; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* ACTION PICKER MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: var(--bg-panel); width: 800px; max-height: 80vh; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 14px; }
        .modal-body { flex: 1; overflow-y: auto; padding: 0; }
        .picker-search { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; gap: 10px; }
        .picker-list { width: 100%; border-collapse: collapse; font-size: 12px; }
        .picker-list th { text-align: left; padding: 10px 20px; background: var(--bg-element); color: var(--text-sub); position: sticky; top: 0; }
        .picker-list td { padding: 8px 20px; border-bottom: 1px solid #333; color: #eee; }
        .picker-list tr:hover td { background: #222; cursor: pointer; }
        .picker-row.selected td { background: rgba(0, 230, 118, 0.1); color: var(--primary); }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; }
        .video-only { display: none; } /* Hidden by default */
        .picker-filters { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }

        /* TREE VIEW */
        .tree-node { margin-left: 20px; border-left: 1px solid #444; padding-left: 10px; margin-top: 5px; }
        .tree-header { display: flex; align-items: center; gap: 10px; padding: 5px 0; }
        .tree-label { font-weight: 600; color: #ddd; font-size: 12px; }

        /* TOOLTIPS */
        .field-label-wrapper { display: flex; align-items: center; gap: 6px; position: relative; cursor: help; width: fit-content; }
        .field-tooltip-icon { width: 14px; height: 14px; background: #333; color: #aaa; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: help; }
        .field-tooltip-content { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.95); border: 1px solid #444; padding: 8px 12px; border-radius: 4px; width: max-content; max-width: 240px; color: #ddd; font-size: 12px; display: none; z-index: 1000; white-space: normal; line-height: 1.5; box-shadow: 0 4px 12px rgba(0,0,0,0.5); margin-bottom: 8px; text-align: left; pointer-events: none; font-weight: normal; }
        .field-label-wrapper:hover .field-tooltip-content { display: block; }
        .field-tooltip-content::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #444 transparent transparent transparent; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">AEKE OPS <span style="font-size:10px; opacity:0.6;">v1.0</span></div>
        <nav id="nav-menu">
            <div class="nav-item active" onclick="app.navigate('action')">动作管理</div>
            <div class="nav-item" onclick="app.navigate('course')">课程管理</div>
            <div class="nav-item" onclick="app.navigate('plan')">计划管理</div>
            <div class="nav-item" onclick="app.navigate('segment')">课程环节模板管理</div>
            <div class="nav-item" onclick="app.navigate('template')">计划阶段模板管理</div>
            <div class="nav-item" onclick="app.navigate('mapping')">数据映射管理</div>
            <div class="nav-item" onclick="app.navigate('ai')">AI推荐管理</div>
        </nav>
    </aside>

    <main class="main-content">
        <header class="header">
            <div class="breadcrumb" id="page-title">动作管理</div>
            <div>
                <button class="btn btn-primary" id="header-btn" onclick="app.save()">新建</button>
            </div>
        </header>
        <div class="content-body" id="app-view">
            <!-- Content rendered by JS -->
        </div>
    </main>

    <!-- Action Picker Modal -->
    <div class="modal-overlay" id="action-picker-modal">
        <div class="modal-box">
            <div class="modal-header">
                <span>选择动作</span>
                <button class="btn-text" onclick="app.closeActionPicker()">✕</button>
            </div>
            <div class="picker-search" style="display:block;">
                <input type="text" id="picker-search-input" placeholder="搜索动作名称、部位..." style="flex:1;" oninput="app.renderPickerList()">
                <div class="picker-filters">
                    <select id="picker-filter-part" onchange="app.renderPickerList()"><option value="">全部部位</option><option>胸部</option><option>背部</option><option>腿部</option><option>臀部</option><option>肩部</option><option>手臂</option><option>核心</option><option>全身</option></select>
                    <select id="picker-filter-diff" onchange="app.renderPickerList()"><option value="">全部难度</option><option>L1</option><option>L2</option><option>L3</option><option>L4</option><option>L5</option></select>
                    <select id="picker-filter-mode" onchange="app.renderPickerList()"><option value="">全部模式</option><option>水平推</option><option>垂直推</option><option>水平拉</option><option>垂直拉</option><option>髋主导</option><option>膝主导</option><option>弓步</option><option>旋转</option><option>核心稳定</option><option>步态</option></select>
                    <select id="picker-filter-func" onchange="app.renderPickerList()"><option value="">全部功能</option><option>增肌</option><option>力量</option><option>耐力</option><option>爆发</option><option>减脂</option><option>心肺</option><option>恢复</option><option>柔韧</option><option>协调</option><option>体态</option><option>专项</option><option>激活</option><option>平衡</option><option>呼吸</option></select>
                    <select id="picker-filter-cons" onchange="app.renderPickerList()"><option value="">全部构造</option><option>复合动作</option><option>孤立动作</option></select>
                    <select id="picker-filter-imp" onchange="app.renderPickerList()"><option value="">全部冲击</option><option>无冲击</option><option>低冲击</option><option>高冲击</option></select>
                    <select id="picker-filter-pain" onchange="app.renderPickerList()"><option value="">全部疼痛</option><option>无</option><option>手腕</option><option>肘部</option><option>肩部</option><option>腰部</option><option>髋部</option><option>膝盖</option><option>脚踝</option></select>
                    <select id="picker-filter-equip" onchange="app.renderPickerList()"><option value="">全部配件</option><option>自重</option><option>手柄</option><option>横杆</option><option>踝带</option><option>健身凳</option><option>瑜伽垫</option><option>瑜伽砖</option><option>泡沫轴</option></select>
                </div>
            </div>
            <div class="modal-body">
                <table class="picker-list" id="picker-table-body">
                    <!-- Rendered by JS -->
                </table>
            </div>
            <div class="modal-footer">
                <div style="flex:1; color:#666; font-size:12px; display:flex; align-items:center;">已选: <span id="picker-count" style="color:#fff; margin:0 4px;">0</span> 个</div>
                <button class="btn btn-primary" onclick="app.confirmPickerSelection()">确认添加</button>
            </div>
        </div>
    </div>

<script>
const MUSCLES = ['胸大肌','背阔肌','斜方肌','竖脊肌','三角肌','肱二头肌','肱三头肌','臀大肌','臀中肌','股四头肌','腘绳肌','腹直肌','腹斜肌'];
const OPTS_HELPER = (arr) => arr.map(x => `<option>${x}</option>`).join('');

const MOCK_DATA = {
    actions: [],
    courses: [
        { id: 'CRS_001', opsId: 'OPS_CRS_001', name: '胸部增肌入门', type: '力量', level: 'L1', duration: 30, target: '胸部', paradigm: '抗阻', equip: '横杆', cal: 120, status: '上架' },
        { id: 'CRS_002', opsId: 'OPS_CRS_002', name: '全身燃脂HIIT', type: 'HIIT', level: 'L3', duration: 20, target: '全身', paradigm: '间歇', equip: '自重', cal: 180, status: '上架' }
    ],
    plans: [
        { 
            id: 'PLN_HYP_01', opsId: 'OPS_HYP_001', name: '4周全身增肌入门', goal: '增肌', funcGoal: '增肌', cycle: '4', level: 'L1', freq: 3, type: '官方模板', status: '上架',
            phases: [
                { name: '适应期', type: '适应期', duration: '1周', tpl: 'TPL_HYP_1', i: 0.70, v: 1.0 },
                { name: '基础期', type: '进阶期', duration: '3周', tpl: 'TPL_HYP_1', i: 0.80, v: 1.1 }
            ]
        },
        { 
            id: 'PLN_HYP_02', opsId: 'OPS_HYP_002', name: '8周分化增肌进阶', goal: '增肌', funcGoal: '增肌', cycle: '8', level: 'L3', freq: 4, type: '官方模板', status: '上架',
            phases: [
                { name: '适应期', type: '适应期', duration: '2周', tpl: 'TPL_HYP_2', i: 0.80, v: 1.0 },
                { name: '肥大期', type: '进阶期', duration: '4周', tpl: 'TPL_HYP_4', i: 0.90, v: 1.2 },
                { name: '突破期', type: '突破期', duration: '2周', tpl: 'TPL_HYP_4', i: 1.00, v: 1.0 }
            ]
        },
        { 
            id: 'PLN_STR_01', opsId: 'OPS_STR_001', name: '12周力量举基础', goal: '增肌', funcGoal: '力量', cycle: '12', level: 'L4', freq: 4, type: '官方模板', status: '上架',
            phases: [
                { name: '解剖适应', type: '适应期', duration: '4周', tpl: 'TPL_HYP_2', i: 0.75, v: 1.2 },
                { name: '最大力量', type: '进阶期', duration: '6周', tpl: 'TPL_HYP_2', i: 0.90, v: 0.8 },
                { name: '巅峰转化', type: '突破期', duration: '2周', tpl: 'TPL_HYP_2', i: 1.10, v: 0.6 }
            ]
        },
        { 
            id: 'PLN_FAT_01', opsId: 'OPS_FAT_001', name: '4周HIIT燃脂挑战', goal: '减重', funcGoal: '减脂', cycle: '4', level: 'L2', freq: 3, type: '官方模板', status: '上架',
            phases: [
                { name: '启动期', type: '适应期', duration: '1周', tpl: 'TPL_FAT_3', i: 0.60, v: 1.0 },
                { name: '燃脂期', type: '进阶期', duration: '3周', tpl: 'TPL_FAT_3', i: 0.75, v: 1.2 }
            ]
        },
        { 
            id: 'PLN_CAR_01', opsId: 'OPS_CAR_001', name: '8周心肺耐力提升', goal: '健康', funcGoal: '心肺', cycle: '8', level: 'L2', freq: 4, type: '官方模板', status: '上架',
            phases: [
                { name: '基础有氧', type: '适应期', duration: '3周', tpl: 'TPL_CAR_4', i: 0.60, v: 1.0 },
                { name: '间歇强化', type: '进阶期', duration: '5周', tpl: 'TPL_CAR_4', i: 0.75, v: 1.1 }
            ]
        },
        { 
            id: 'PLN_POS_01', opsId: 'OPS_POS_001', name: '4周办公室体态改善', goal: '健康', funcGoal: '体态', cycle: '4', level: 'L1', freq: 2, type: '官方模板', status: '上架',
            phases: [
                { name: '改善期', type: '适应期', duration: '4周', tpl: 'TPL_POS_2', i: 0.50, v: 1.0 }
            ]
        },
        { 
            id: 'PLN_POW_01', opsId: 'OPS_POW_001', name: '6周运动表现爆发', goal: '增肌', funcGoal: '爆发', cycle: '6', level: 'L4', freq: 4, type: '官方模板', status: '上架',
            phases: [
                { name: '基础力量', type: '适应期', duration: '2周', tpl: 'TPL_POW_4', i: 0.80, v: 1.0 },
                { name: '爆发转化', type: '进阶期', duration: '4周', tpl: 'TPL_POW_4', i: 0.90, v: 0.8 }
            ]
        },
        { 
            id: 'PLN_FLX_01', opsId: 'OPS_FLX_001', name: '4周柔韧性与恢复', goal: '健康', funcGoal: '柔韧', cycle: '4', level: 'L1', freq: 3, type: '官方模板', status: '上架',
            phases: [
                { name: '舒展期', type: '适应期', duration: '4周', tpl: 'TPL_FLX_3', i: 0.40, v: 1.0 }
            ]
        }
    ],
    templates: [
        // Hypertrophy / Strength Templates
        { 
            id: 'TPL_HYP_1', name: '一分化 (全身综合)', goal: '增肌', freq: 1, level: 'All', slots: 1, status: '上架',
            basicSlots: [{name:'全身综合', type:'力量', focusDim:'部位', focusTarget:'全身'}]
        },
        { 
            id: 'TPL_HYP_2', name: '二分化 (上下肢)', goal: '增肌', freq: 2, level: 'All', slots: 2, status: '上架',
            basicSlots: [{name:'上肢日', type:'力量', focusDim:'部位', focusTarget:'胸部'}, {name:'下肢日', type:'力量', focusDim:'部位', focusTarget:'腿部'}]
        },
        { 
            id: 'TPL_HYP_3', name: '三分化 (推拉腿)', goal: '增肌', freq: 3, level: 'All', slots: 3, status: '上架',
            basicSlots: [{name:'推力日', type:'力量', focusDim:'动作模式', focusTarget:'水平推'}, {name:'拉力日', type:'力量', focusDim:'动作模式', focusTarget:'垂直拉'}, {name:'腿部日', type:'力量', focusDim:'动作模式', focusTarget:'膝主导'}]
        },
        { 
            id: 'TPL_HYP_4', name: '四分化 (非线性)', goal: '增肌', freq: 4, level: 'All', slots: 4, status: '上架',
            basicSlots: [{name:'胸臂雕刻', type:'力量', focusDim:'部位', focusTarget:'胸部'}, {name:'臀腿轰炸', type:'力量', focusDim:'部位', focusTarget:'腿部'}, {name:'背肩强化', type:'力量', focusDim:'部位', focusTarget:'背部'}, {name:'核心全身', type:'力量', focusDim:'部位', focusTarget:'核心'}]
        },
        { 
            id: 'TPL_HYP_5', name: '五分化 (单部位)', goal: '增肌', freq: 5, level: 'All', slots: 5, status: '上架',
            basicSlots: [{name:'胸部专项', type:'力量', focusDim:'部位', focusTarget:'胸部'}, {name:'背部专项', type:'力量', focusDim:'部位', focusTarget:'背部'}, {name:'肩部专项', type:'力量', focusDim:'部位', focusTarget:'肩部'}, {name:'手臂专项', type:'力量', focusDim:'部位', focusTarget:'手臂'}, {name:'臀腿专项', type:'力量', focusDim:'部位', focusTarget:'腿部'}]
        },
        // Fat Loss Templates
        { 
            id: 'TPL_FAT_3', name: '减脂循环 (3天)', goal: '减脂', freq: 3, level: 'All', slots: 3, status: '上架',
            basicSlots: [
                {name:'全身HIIT', type:'HIIT', focusDim:'部位', focusTarget:'全身'},
                {name:'有氧耐力', type:'有氧', focusDim:'部位', focusTarget:'全身'},
                {name:'核心强化', type:'力量', focusDim:'部位', focusTarget:'核心'}
            ]
        },
        { 
            id: 'TPL_FAT_5', name: '高频燃脂循环 (5天)', goal: '减脂', freq: 5, level: 'L3', slots: 5, status: '上架',
            basicSlots: [
                {name:'全身HIIT', type:'HIIT', focusDim:'部位', focusTarget:'全身'},
                {name:'上肢塑形', type:'力量', focusDim:'部位', focusTarget:'胸部'},
                {name:'有氧耐力', type:'有氧', focusDim:'部位', focusTarget:'全身'},
                {name:'下肢塑形', type:'力量', focusDim:'部位', focusTarget:'腿部'},
                {name:'核心燃脂', type:'HIIT', focusDim:'部位', focusTarget:'核心'}
            ]
        },
        // Health / Wellness Templates (Renamed from Split)
        { 
            id: 'TPL_CAR_4', name: '心肺耐力循环 (4天)', goal: '健康', freq: 4, level: 'All', slots: 4, status: '上架',
            basicSlots: [
                {name:'LISS有氧', type:'有氧', focusDim:'部位', focusTarget:'全身'},
                {name:'HIIT燃脂', type:'HIIT', focusDim:'部位', focusTarget:'全身'},
                {name:'核心强化', type:'力量', focusDim:'部位', focusTarget:'核心'},
                {name:'LISS有氧', type:'有氧', focusDim:'部位', focusTarget:'全身'}
            ]
        },
        { 
            id: 'TPL_POS_2', name: '体态矫正方案 (2天)', goal: '健康', freq: 2, level: 'L1', slots: 2, status: '上架',
            basicSlots: [
                {name:'上肢体态', type:'力量', focusDim:'动作功能', focusTarget:'体态'},
                {name:'下肢稳定', type:'力量', focusDim:'动作功能', focusTarget:'平衡'}
            ]
        },
        { 
            id: 'TPL_FLX_3', name: '柔韧与恢复方案 (3天)', goal: '健康', freq: 3, level: 'All', slots: 3, status: '上架',
            basicSlots: [
                {name:'全身拉伸', type:'拉伸', focusDim:'动作功能', focusTarget:'柔韧'},
                {name:'瑜伽流', type:'瑜伽', focusDim:'动作功能', focusTarget:'恢复'},
                {name:'泡沫轴放松', type:'康复', focusDim:'动作功能', focusTarget:'恢复'}
            ]
        },
        // Performance Templates
        { 
            id: 'TPL_POW_4', name: '爆发力专项分化 (4天)', goal: '增肌', freq: 4, level: 'L4', slots: 4, status: '上架',
            basicSlots: [
                {name:'下肢爆发', type:'力量', focusDim:'动作功能', focusTarget:'爆发'},
                {name:'上肢力量', type:'力量', focusDim:'动作模式', focusTarget:'水平推'},
                {name:'全身爆发', type:'HIIT', focusDim:'动作功能', focusTarget:'爆发'},
                {name:'核心稳定', type:'力量', focusDim:'动作模式', focusTarget:'核心稳定'}
            ]
        }
    ]
};

const MAPPING_DATA = {
    anatomy: [
        { region: '上肢', parts: [
            { name: '胸部', label: '推力主导', muscles: ['胸大肌上束', '胸大肌中束', '胸大肌下束', '胸大肌内侧'] },
            { name: '背部', label: '拉力主导', muscles: ['背阔肌', '斜方肌', '竖脊肌'] },
            { name: '肩部', label: '推/拉辅助', muscles: ['三角肌前束', '三角肌中束', '三角肌后束', '肩袖肌群'] },
            { name: '手臂', label: '辅助肌群', muscles: ['肱二头肌', '肱三头肌', '前臂肌群'] }
        ]},
        { region: '下肢', parts: [
            { name: '臀部', label: '髋主导', muscles: ['臀大肌', '臀中肌'] },
            { name: '腿部', label: '膝/踝主导', muscles: ['股四头肌', '腘绳肌', '内收肌群', '腓肠肌', '比目鱼肌'] }
        ]},
        { region: '核心', parts: [
            { name: '核心', label: '稳定/旋转', muscles: ['腹直肌', '腹外斜肌', '腹横肌'] }
        ]},
        { region: '全身', parts: [
            { name: '全身', label: '综合体能', muscles: ['涉及上述多个部位的组合'] }
        ]}
    ],
    warmup: [
        { mode: '水平推/垂直推', func: ['柔韧(肩部)', '柔韧(胸部)', '激活(肩部)', '协调(背部)'] },
        { mode: '水平拉/垂直拉', func: ['柔韧(背部)', '柔韧(肩部)', '激活(背部)', '协调(背部)'] },
        { mode: '膝主导/髋主导', func: ['柔韧(臀部)', '柔韧(腿部)', '激活(臀部)', '协调(核心)'] },
        { mode: '弓步/步态', func: ['平衡(腿部)', '激活(腿部)', '柔韧(臀部)'] },
        { mode: '旋转/核心稳定', func: ['激活(核心)', '柔韧(背部)', '协调(全身)'] }
    ],
    antagonist: [
        { agonist: '胸大肌', antagonist: '背阔肌 / 斜方肌', example: '卧推 vs 划船' },
        { agonist: '三角肌前束', antagonist: '三角肌后束', example: '前平举 vs 俯身飞鸟' },
        { agonist: '肱二头肌', antagonist: '肱三头肌', example: '弯举 vs 臂屈伸' },
        { agonist: '股四头肌', antagonist: '腘绳肌', example: '深蹲/腿屈伸 vs 腿弯举' },
        { agonist: '臀中肌', antagonist: '内收肌群', example: '髋外展 vs 髋内收' },
        { agonist: '腹直肌', antagonist: '竖脊肌', example: '卷腹 vs 山羊挺身' }
    ],
    mode: [
        { mode: '水平推', main: '胸部', sub: ['肩部', '手臂'] },
        { mode: '垂直推', main: '肩部', sub: ['胸部', '手臂'] },
        { mode: '水平拉', main: '背部', sub: ['肩部', '手臂'] },
        { mode: '垂直拉', main: '背部', sub: ['手臂'] },
        { mode: '膝主导', main: '腿部', sub: ['臀部'] },
        { mode: '髋主导', main: '臀部、腿部', sub: ['背部'] },
        { mode: '弓步', main: '腿部、臀部', sub: [] },
        { mode: '旋转', main: '核心', sub: [] },
        { mode: '核心稳定', main: '核心', sub: ['臀部'] },
        { mode: '步态', main: '腿部、臀部', sub: ['核心'] }
    ],
    intensity: [
        { level: 'L1 (低强度)', load: '< 60% 1RM', reps: '8-10', hr: '50-60%', rest: '30-60s', time: '30s' },
        { level: 'L2 (中低强度)', load: '60-70% 1RM', reps: '10-12', hr: '60-70%', rest: '60-90s', time: '30s' },
        { level: 'L3 (中等强度)', load: '70-80% 1RM', reps: '12-15', hr: '70-80%', rest: '90-120s', time: '45s' },
        { level: 'L4 (高强度)', load: '80-90% 1RM', reps: '15-20', hr: '80-90%', rest: '2-3min', time: '45s' },
        { level: 'L5 (极限强度)', load: '> 90% 1RM', reps: '20+ (力竭)', hr: '> 90%', rest: '3-5min', time: '60s' }
    ]
};

const AI_CONFIG = {
    strategy: [
        { target: '增肌', level: 'L1,L2', sets: 3, rest: 60, intensity: 0.65, mode: '常规', strategy: '推荐', diff: '标准' },
        { target: '增肌', level: 'L3,L4', sets: 4, rest: 90, intensity: 0.75, mode: '常规', strategy: '递增', diff: '进阶' },
        { target: '增肌', level: 'L5', sets: 5, rest: 90, intensity: 0.80, mode: '常规', strategy: '递增', diff: '挑战' },
        { target: '力量', level: 'L1,L2', sets: 3, rest: 90, intensity: 0.75, mode: '常规', strategy: '恒定', diff: '标准' },
        { target: '力量', level: 'L3,L4', sets: 5, rest: 120, intensity: 0.85, mode: '常规', strategy: '恒定', diff: '进阶' },
        { target: '力量', level: 'L5', sets: 5, rest: 180, intensity: 0.90, mode: '常规', strategy: '递增', diff: '挑战' },
        { target: '减脂', level: 'L1,L2', sets: 3, rest: 30, intensity: 0.55, mode: '循环', strategy: '计时', diff: '保守' },
        { target: '减脂', level: 'L3,L4', sets: 4, rest: 30, intensity: 0.65, mode: '循环', strategy: '计时', diff: '标准' },
        { target: '减脂', level: 'L5', sets: 5, rest: 20, intensity: 0.75, mode: '循环', strategy: '计时', diff: '挑战' },
        { target: '耐力', level: 'L1,L2', sets: 3, rest: 45, intensity: 0.40, mode: '超级', strategy: '计时', diff: '保守' },
        { target: '耐力', level: 'L3,L4,L5', sets: 4, rest: 30, intensity: 0.50, mode: '超级', strategy: '计时', diff: '标准' },
        { target: '爆发', level: 'L1,L2', sets: 3, rest: 120, intensity: 0.50, mode: '常规', strategy: '恒定', diff: '保守' },
        { target: '爆发', level: 'L3,L4', sets: 4, rest: 150, intensity: 0.70, mode: '常规', strategy: '递增', diff: '进阶' },
        { target: '爆发', level: 'L5', sets: 5, rest: 180, intensity: 0.85, mode: '常规', strategy: '递增', diff: '挑战' },
        { target: '心肺', level: 'L1,L2', sets: 3, rest: 30, intensity: 0.50, mode: '循环', strategy: '计时', diff: '保守' },
        { target: '心肺', level: 'L3,L4', sets: 4, rest: 20, intensity: 0.65, mode: '循环', strategy: '计时', diff: '标准' },
        { target: '心肺', level: 'L5', sets: 5, rest: 15, intensity: 0.80, mode: '循环', strategy: '计时', diff: '挑战' },
        { target: 'HIIT', level: 'All', sets: 6, rest: 30, intensity: 0.75, mode: '循环', strategy: '计时', diff: '标准' },
        { target: '有氧', level: 'All', sets: 4, rest: 15, intensity: 0.60, mode: '循环', strategy: '计时', diff: '标准' },
        { target: '瑜伽', level: 'All', sets: 1, rest: 0, intensity: 0.40, mode: '常规', strategy: '计时', diff: '标准' },
        { target: '普拉提', level: 'All', sets: 3, rest: 30, intensity: 0.50, mode: '常规', strategy: '恒定', diff: '标准' },
        { target: '拉伸', level: 'All', sets: 1, rest: 0, intensity: 0.20, mode: '常规', strategy: '计时', diff: '保守' },
        { target: '恢复', level: 'All', sets: 2, rest: 0, intensity: 0.30, mode: '常规', strategy: '恒定', diff: '保守' },
        { target: '柔韧', level: 'All', sets: 2, rest: 0, intensity: 0.30, mode: '常规', strategy: '计时', diff: '标准' },
        { target: '协调', level: 'All', sets: 3, rest: 60, intensity: 0.50, mode: '常规', strategy: '恒定', diff: '标准' },
        { target: '体态', level: 'All', sets: 3, rest: 45, intensity: 0.50, mode: '常规', strategy: '计时', diff: '标准' },
        { target: '激活', level: 'All', sets: 2, rest: 0, intensity: 0.40, mode: '常规', strategy: '恒定', diff: '标准' },
        { target: '平衡', level: 'All', sets: 3, rest: 60, intensity: 0.50, mode: '常规', strategy: '恒定', diff: '标准' },
        { target: '专项', level: 'All', sets: 3, rest: 90, intensity: 0.70, mode: '常规', strategy: '推荐', diff: '标准' }
    ],
    templates: [
        // --- 热身 (Warmup) ---
        { id: 'TPL_SEG_001', name: '热身_全身', dim: '部位', target: '全身', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.5}, {focusDim:'动作功能',focusTarget:'柔韧',w:0.3}, {focusDim:'动作功能',focusTarget:'协调',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_002', name: '热身_上肢', dim: '部位', target: '上肢', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.5}, {focusDim:'部位',focusTarget:'肩部',w:0.3}, {focusDim:'部位',focusTarget:'胸部',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_003', name: '热身_下肢', dim: '部位', target: '下肢', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.5}, {focusDim:'部位',focusTarget:'臀部',w:0.3}, {focusDim:'部位',focusTarget:'腿部',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_004', name: '热身_胸部', dim: '部位', target: '胸部', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.4}, {focusDim:'部位',focusTarget:'肩部',w:0.4}, {focusDim:'部位',focusTarget:'胸部',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_005', name: '热身_背部', dim: '部位', target: '背部', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.4}, {focusDim:'部位',focusTarget:'肩部',w:0.4}, {focusDim:'部位',focusTarget:'背部',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_006', name: '热身_肩部', dim: '部位', target: '肩部', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.4}, {focusDim:'部位',focusTarget:'肩部',w:0.4}, {focusDim:'部位',focusTarget:'胸部',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_007', name: '热身_手臂', dim: '部位', target: '手臂', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.4}, {focusDim:'部位',focusTarget:'肩部',w:0.4}, {focusDim:'部位',focusTarget:'手臂',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_008', name: '热身_臀部', dim: '部位', target: '臀部', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.4}, {focusDim:'部位',focusTarget:'臀部',w:0.4}, {focusDim:'部位',focusTarget:'腿部',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_009', name: '热身_腿部', dim: '部位', target: '腿部', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.4}, {focusDim:'部位',focusTarget:'臀部',w:0.3}, {focusDim:'部位',focusTarget:'腿部',w:0.3}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },
        { id: 'TPL_SEG_010', name: '热身_核心', dim: '部位', target: '核心', type: '热身', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'激活',w:0.5}, {focusDim:'部位',focusTarget:'核心',w:0.3}, {focusDim:'部位',focusTarget:'臀部',w:0.2}], sort: [{dim:'动作难度',order:'升序'}, {dim:'MET值',order:'升序'}] },

        // --- 放松 (Cooldown) ---
        { id: 'TPL_SEG_011', name: '放松_全身', dim: '部位', target: '全身', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'恢复',w:0.6}, {focusDim:'动作功能',focusTarget:'柔韧',w:0.4}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_012', name: '放松_上肢', dim: '部位', target: '上肢', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'肩部',w:0.4}, {focusDim:'部位',focusTarget:'背部',w:0.3}, {focusDim:'部位',focusTarget:'胸部',w:0.3}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_013', name: '放松_下肢', dim: '部位', target: '下肢', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'腿部',w:0.5}, {focusDim:'部位',focusTarget:'臀部',w:0.3}, {focusDim:'部位',focusTarget:'下背',w:0.2}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_014', name: '放松_胸部', dim: '部位', target: '胸部', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'胸部',w:0.6}, {focusDim:'部位',focusTarget:'肩部',w:0.4}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_015', name: '放松_背部', dim: '部位', target: '背部', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'背部',w:0.6}, {focusDim:'部位',focusTarget:'肩部',w:0.2}, {focusDim:'部位',focusTarget:'下背',w:0.2}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_016', name: '放松_肩部', dim: '部位', target: '肩部', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'肩部',w:0.7}, {focusDim:'部位',focusTarget:'颈部',w:0.3}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_017', name: '放松_手臂', dim: '部位', target: '手臂', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'手臂',w:0.7}, {focusDim:'部位',focusTarget:'肩部',w:0.3}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_018', name: '放松_臀部', dim: '部位', target: '臀部', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'臀部',w:0.7}, {focusDim:'部位',focusTarget:'下背',w:0.3}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_019', name: '放松_腿部', dim: '部位', target: '腿部', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'腿部',w:0.7}, {focusDim:'部位',focusTarget:'臀部',w:0.3}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },
        { id: 'TPL_SEG_020', name: '放松_核心', dim: '部位', target: '核心', type: '放松', levels: ['All'], gender: 'All', slots: [{focusDim:'部位',focusTarget:'核心',w:0.5}, {focusDim:'部位',focusTarget:'下背',w:0.5}], sort: [{dim:'动作体位',order:'自定义',seq:'站姿,坐姿,跪姿,仰卧,俯卧'}, {dim:'MET值',order:'降序'}] },

        // --- 全身 (Full Body) ---
        { id: 'TPL_SEG_021', name: '全身_初级', dim: '部位', target: '全身', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作构造',focusTarget:'复合动作',w:0.5}, {focusDim:'动作构造',focusTarget:'复合动作',w:0.3}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_022', name: '全身_中级', dim: '部位', target: '全身', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'膝主导',w:0.2}, {focusDim:'动作模式',focusTarget:'髋主导',w:0.2}, {focusDim:'动作模式',focusTarget:'水平推',w:0.2}, {focusDim:'动作模式',focusTarget:'水平拉',w:0.2}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_023', name: '全身_高级', dim: '部位', target: '全身', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直推',w:0.2}, {focusDim:'动作模式',focusTarget:'垂直拉',w:0.2}, {focusDim:'动作模式',focusTarget:'弓步',w:0.2}, {focusDim:'动作模式',focusTarget:'旋转',w:0.2}, {focusDim:'动作功能',focusTarget:'爆发',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },

        // --- 上下肢分化 (Upper/Lower) ---
        { id: 'TPL_SEG_030', name: '推力_中级', dim: '动作模式', target: '水平推', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'水平推',w:0.4}, {focusDim:'动作模式',focusTarget:'垂直推',w:0.4}, {focusDim:'主动肌',focusTarget:'肱三头肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_031', name: '推力_高级', dim: '动作模式', target: '水平推', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'水平推',w:0.4}, {focusDim:'动作模式',focusTarget:'垂直推',w:0.4}, {focusDim:'主动肌',focusTarget:'肱三头肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_032', name: '拉力_中级', dim: '动作模式', target: '垂直拉', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直拉',w:0.4}, {focusDim:'动作模式',focusTarget:'水平拉',w:0.4}, {focusDim:'主动肌',focusTarget:'肱二头肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_033', name: '拉力_高级', dim: '动作模式', target: '垂直拉', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直拉',w:0.4}, {focusDim:'动作模式',focusTarget:'水平拉',w:0.4}, {focusDim:'主动肌',focusTarget:'肱二头肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_034', name: 'PPL_腿部_中级', dim: '动作模式', target: '膝主导', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'膝主导',w:0.4}, {focusDim:'动作模式',focusTarget:'髋主导',w:0.4}, {focusDim:'主动肌',focusTarget:'腓肠肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_035', name: 'PPL_腿部_高级', dim: '动作模式', target: '膝主导', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'膝主导',w:0.4}, {focusDim:'动作模式',focusTarget:'髋主导',w:0.4}, {focusDim:'主动肌',focusTarget:'腓肠肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },

        // --- 推拉腿 (PPL) ---
        { id: 'TPL_SEG_030', name: '推力_中级', dim: '动作模式', target: '水平推', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'水平推',w:0.4}, {focusDim:'动作模式',focusTarget:'垂直推',w:0.4}, {focusDim:'主动肌',focusTarget:'肱三头肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_031', name: '推力_高级', dim: '动作模式', target: '水平推', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'水平推',w:0.4}, {focusDim:'动作模式',focusTarget:'垂直推',w:0.4}, {focusDim:'主动肌',focusTarget:'肱三头肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_032', name: '拉力_中级', dim: '动作模式', target: '垂直拉', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直拉',w:0.4}, {focusDim:'动作模式',focusTarget:'水平拉',w:0.4}, {focusDim:'主动肌',focusTarget:'肱二头肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_033', name: '拉力_高级', dim: '动作模式', target: '垂直拉', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直拉',w:0.4}, {focusDim:'动作模式',focusTarget:'水平拉',w:0.4}, {focusDim:'主动肌',focusTarget:'肱二头肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_034', name: 'PPL_腿部_中级', dim: '动作模式', target: '膝主导', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'膝主导',w:0.4}, {focusDim:'动作模式',focusTarget:'髋主导',w:0.4}, {focusDim:'主动肌',focusTarget:'腓肠肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_035', name: 'PPL_腿部_高级', dim: '动作模式', target: '膝主导', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'膝主导',w:0.4}, {focusDim:'动作模式',focusTarget:'髋主导',w:0.4}, {focusDim:'主动肌',focusTarget:'腓肠肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },

        // --- 部位分化 (Body Parts) ---
        // 胸部
        { id: 'TPL_SEG_036', name: '胸部_初级', dim: '部位', target: '胸部', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作构造',focusTarget:'复合动作',w:0.6}, {focusDim:'动作构造',focusTarget:'孤立动作',w:0.4}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_037', name: '胸部_中级', dim: '部位', target: '胸部', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'水平推',w:0.5}, {focusDim:'主动肌',focusTarget:'胸大肌上束',w:0.3}, {focusDim:'主动肌',focusTarget:'胸大肌内侧',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_038', name: '胸部_高级', dim: '部位', target: '胸部', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'水平推',w:0.4}, {focusDim:'主动肌',focusTarget:'胸大肌上束',w:0.3}, {focusDim:'主动肌',focusTarget:'胸大肌下束',w:0.2}, {focusDim:'主动肌',focusTarget:'胸大肌内侧',w:0.1}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        
        // 背部
        { id: 'TPL_SEG_039', name: '背部_初级', dim: '部位', target: '背部', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作构造',focusTarget:'复合动作',w:0.6}, {focusDim:'动作模式',focusTarget:'水平拉',w:0.4}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_040', name: '背部_中级', dim: '部位', target: '背部', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直拉',w:0.4}, {focusDim:'动作模式',focusTarget:'水平拉',w:0.4}, {focusDim:'主动肌',focusTarget:'竖脊肌',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_041', name: '背部_高级', dim: '部位', target: '背部', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直拉',w:0.4}, {focusDim:'动作模式',focusTarget:'水平拉',w:0.3}, {focusDim:'主动肌',focusTarget:'斜方肌',w:0.2}, {focusDim:'主动肌',focusTarget:'三角肌后束',w:0.1}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },

        // 肩部
        { id: 'TPL_SEG_042', name: '肩部_初级', dim: '部位', target: '肩部', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'主动肌',focusTarget:'三角肌中束',w:0.6}, {focusDim:'主动肌',focusTarget:'三角肌前束',w:0.4}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_043', name: '肩部_中级', dim: '部位', target: '肩部', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直推',w:0.4}, {focusDim:'主动肌',focusTarget:'三角肌中束',w:0.4}, {focusDim:'主动肌',focusTarget:'三角肌后束',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_044', name: '肩部_高级', dim: '部位', target: '肩部', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'垂直推',w:0.3}, {focusDim:'主动肌',focusTarget:'三角肌中束',w:0.3}, {focusDim:'主动肌',focusTarget:'三角肌后束',w:0.2}, {focusDim:'主动肌',focusTarget:'肩袖肌群',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },

        // 手臂
        { id: 'TPL_SEG_045', name: '手臂_初级', dim: '部位', target: '手臂', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作构造',focusTarget:'孤立动作',w:1.0}], sort: [{dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_046', name: '手臂_中级', dim: '部位', target: '手臂', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'主动肌',focusTarget:'肱二头肌',w:0.5}, {focusDim:'主动肌',focusTarget:'肱三头肌',w:0.5}], sort: [{dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_047', name: '手臂_高级', dim: '部位', target: '手臂', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'主动肌',focusTarget:'肱二头肌',w:0.5}, {focusDim:'主动肌',focusTarget:'肱三头肌',w:0.5}], sort: [{dim:'推荐权重',order:'降序'}] },

        // 臀部
        { id: 'TPL_SEG_048', name: '臀部_初级', dim: '部位', target: '臀部', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'髋主导',w:0.6}, {focusDim:'主动肌',focusTarget:'臀大肌',w:0.4}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_049', name: '臀部_中级', dim: '部位', target: '臀部', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'髋主导',w:0.5}, {focusDim:'主动肌',focusTarget:'臀中肌',w:0.3}, {focusDim:'动作模式',focusTarget:'弓步',w:0.2}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_050', name: '臀部_高级', dim: '部位', target: '臀部', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'髋主导',w:0.4}, {focusDim:'主动肌',focusTarget:'臀中肌',w:0.3}, {focusDim:'动作模式',focusTarget:'弓步',w:0.3}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },

        // 腿部
        { id: 'TPL_SEG_051', name: '腿部_初级', dim: '部位', target: '腿部', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作构造',focusTarget:'复合动作',w:0.6}, {focusDim:'动作模式',focusTarget:'膝主导',w:0.4}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_052', name: '腿部_中级', dim: '部位', target: '腿部', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'膝主导',w:0.4}, {focusDim:'动作模式',focusTarget:'髋主导',w:0.3}, {focusDim:'动作模式',focusTarget:'弓步',w:0.2}, {focusDim:'部位',focusTarget:'核心',w:0.1}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_053', name: '腿部_高级', dim: '部位', target: '腿部', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'膝主导',w:0.4}, {focusDim:'动作模式',focusTarget:'髋主导',w:0.3}, {focusDim:'动作模式',focusTarget:'弓步',w:0.2}, {focusDim:'动作功能',focusTarget:'爆发',w:0.1}], sort: [{dim:'动作构造',order:'自定义',seq:'复合动作,孤立动作'}, {dim:'推荐权重',order:'降序'}] },

        // 核心
        { id: 'TPL_SEG_054', name: '核心_初级', dim: '部位', target: '核心', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作模式',focusTarget:'核心稳定',w:0.7}, {focusDim:'动作模式',focusTarget:'旋转',w:0.3}], sort: [{dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_055', name: '核心_中级', dim: '部位', target: '核心', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'主动肌',focusTarget:'腹直肌',w:0.4}, {focusDim:'主动肌',focusTarget:'腹外斜肌',w:0.3}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.3}], sort: [{dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_056', name: '核心_高级', dim: '部位', target: '核心', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'主动肌',focusTarget:'腹直肌',w:0.4}, {focusDim:'主动肌',focusTarget:'腹外斜肌',w:0.3}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.2}, {focusDim:'动作功能',focusTarget:'爆发',w:0.1}], sort: [{dim:'推荐权重',order:'降序'}] },

        // --- 功能性 (Functional) ---
        { id: 'TPL_SEG_057', name: '减脂_初级', dim: '动作功能', target: '减脂', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'心肺',w:0.6}, {focusDim:'动作构造',focusTarget:'复合动作',w:0.4}], sort: [{dim:'MET值',order:'降序'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_058', name: '减脂_中级', dim: '动作功能', target: '减脂', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'心肺',w:0.5}, {focusDim:'动作构造',focusTarget:'复合动作',w:0.3}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.2}], sort: [{dim:'MET值',order:'降序'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_059', name: '减脂_高级', dim: '动作功能', target: '减脂', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'心肺',w:0.5}, {focusDim:'动作构造',focusTarget:'复合动作',w:0.3}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.2}], sort: [{dim:'MET值',order:'降序'}, {dim:'推荐权重',order:'降序'}] },
        
        { id: 'TPL_SEG_060', name: 'HIIT_初级', dim: '动作功能', target: '心肺', type: '主训', levels: ['L1','L2'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'心肺',w:0.7}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.3}], sort: [{dim:'MET值',order:'降序'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_061', name: 'HIIT_中级', dim: '动作功能', target: '心肺', type: '主训', levels: ['L3','L4'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'爆发',w:0.4}, {focusDim:'动作功能',focusTarget:'心肺',w:0.4}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.2}], sort: [{dim:'MET值',order:'降序'}, {dim:'推荐权重',order:'降序'}] },
        { id: 'TPL_SEG_062', name: 'HIIT_高级', dim: '动作功能', target: '心肺', type: '主训', levels: ['L5'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'爆发',w:0.5}, {focusDim:'动作功能',focusTarget:'心肺',w:0.4}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.1}], sort: [{dim:'MET值',order:'降序'}, {dim:'推荐权重',order:'降序'}] },

        { id: 'TPL_SEG_063', name: '体态_L1', dim: '动作功能', target: '体态', type: '主训', levels: ['All'], gender: 'All', slots: [{focusDim:'动作功能',focusTarget:'体态',w:0.6}, {focusDim:'动作功能',focusTarget:'柔韧',w:0.2}, {focusDim:'动作模式',focusTarget:'核心稳定',w:0.2}], sort: [{dim:'动作难度',order:'升序'}] }
    ],
    structure: [
        { type: '热身', ratio: '15%', max: '5 min', count: '4 - 6' },
        { type: '主训', ratio: '70% - 80%', max: '-', count: '-' },
        { type: '放松', ratio: '15%', max: '5 min', count: '3 - 5' }
    ],
    levels: [
        { level: 'L1 (入门)', coeff: 0.5 },
        { level: 'L2 (初级)', coeff: 0.8 },
        { level: 'L3 (中级)', coeff: 1.0 },
        { level: 'L4 (进阶)', coeff: 1.2 },
        { level: 'L5 (专业)', coeff: 1.5 }
    ],
    paradigms: [
        { name: '抗阻范式', types: '力量, 康复, 高尔夫', feature: '关注负荷(Weight/Reps)', sets: '3-5', strategy: '推荐' },
        { name: '间歇范式', types: 'HIIT, 有氧, 搏击', feature: '关注心率/工休比', sets: '3-5', strategy: '计时' },
        { name: '流式范式', types: '瑜伽, 普拉提, 拉伸, 冥想, 气功', feature: '关注体位流动', sets: '1', strategy: '计时' }
    ],
    load: [
        { name: '恒定', index: 'All', coeff: 1.0, inc: 0, desc: '保持基准' },
        { name: '递增', index: '1', coeff: 0.85, inc: '+2', desc: '正金字塔' },
        { name: '递增', index: '2', coeff: 0.90, inc: '+1', desc: '-' },
        { name: '递增', index: '3+', coeff: 1.00, inc: 0, desc: '-' },
        { name: '递减', index: '1', coeff: 1.0, inc: 0, desc: '倒金字塔' },
        { name: '计时', index: 'All', coeff: '-', inc: '-', desc: 'AMRAP' }
    ],
    diff: [
        { name: '保守 (L1)', range: '[0, 2]', prob: '{0: 60, 1: 30, 2: 10}' },
        { name: '标准 (L2/3)', range: '[-1, 1]', prob: '{0: 60, -1: 20, 1: 20}' },
        { name: '进阶 (L4)', range: '[-1, 1]', prob: '{0: 40, -1: 30, 1: 30}' },
        { name: '挑战 (L5)', range: '[-2, 0]', prob: '{0: 30, -1: 40, -2: 30}' }
    ],
    phase: [
        { cycle: '1周', structure: '进阶期', alloc: '100%' },
        { cycle: '2周', structure: '适应期 -> 进阶期', alloc: '1:1' },
        { cycle: '3周', structure: '适应期 -> 进阶期 -> 突破期', alloc: '1:1:1' },
        { cycle: '4周 (标准)', structure: '适应期 -> 进阶期 -> 突破期 -> 减载期', alloc: '1:1:1:1' },
        { cycle: '> 4周', structure: '适应期 -> 进阶期 -> 突破期 -> 减载期', alloc: '25%:40%:25%:10%' }
    ],
    factors: [
        { key: '新鲜奖励', weight: 60, rule: '未练天数 > 7' },
        { key: '收藏奖励', weight: 50, rule: '是否收藏 = True' },
        { key: '探索奖励', weight: 30, rule: '历史训练次数 == 0' },
        { key: '厌倦惩罚', weight: -80, rule: '连续出现次数 ≥ 3' },
        { key: '冷宫惩罚', weight: -50, rule: '移除日期 ≤ 30天' },
        { key: '疲劳惩罚', weight: -50, rule: '辅助肌状态 < 55' },
        { key: '完赛信心奖励', weight: 20, rule: '连续缺勤天数 > 7 && 历史平均完成度 > 0.95' }
    ],
    status: [
        { range: '[85, 100]', label: '已恢复', intensity: 1.0, volume: 1.0, constraint: '-' },
        { range: '[55, 84]', label: '恢复中', intensity: 0.9, volume: 1.0, constraint: '-' },
        { range: '[30, 54]', label: '疲劳中', intensity: 0.8, volume: 0.8, constraint: '剔除高冲击' },
        { range: '[0, 29]', label: '已力竭', intensity: '-', volume: '-', constraint: '推荐主动恢复' }
    ],
    feedback: [
        { cond: '平台期判定次数', action: '3', desc: '连续 3 次负荷未提升' },
        { cond: '有效训练完成度', action: '0.90', desc: '判定平台期时，要求课程完成度 > 90%' },
        { cond: '厌恶判定次数', action: '3', desc: '主动替换同一动作 > 3 次' },
        { cond: '平台期干预策略', action: '负荷策略="波浪"', desc: '通过波动强度打破适应' },
        { cond: '平台期干预策略', action: '动作组数*1.2', desc: '增加容量积累代谢压力' }
    ]
};

const SLOT_OPTS = {
    types: ['力量','有氧','HIIT','搏击','普拉提','瑜伽','拉伸','气功','康复','冥想','高尔夫'],
    dims: ['部位', '动作模式', '动作功能'],
    targets: {
        '部位': ['全身','胸部','背部','肩部','手臂','臀部','腿部','核心'],
        '动作模式': ['水平推','垂直推','水平拉','垂直拉','髋主导','膝主导','弓步','旋转','核心稳定','步态'],
        '动作功能': ['增肌','力量','耐力','爆发','减脂','心肺','恢复','柔韧','协调','体态','专项','激活','平衡','呼吸']
    }
};

const RULE_OPTS = {
    '动作构造': ['复合动作', '孤立动作'],
    '动作模式': ['水平推', '垂直推', '水平拉', '垂直拉', '膝主导', '髋主导', '弓步', '旋转', '核心稳定', '步态'],
    '主动肌': ['胸大肌', '背阔肌', '斜方肌', '竖脊肌', '三角肌', '肱二头肌', '肱三头肌', '臀大肌', '股四头肌', '腘绳肌', '腹直肌'],
    '部位': ['胸部', '背部', '肩部', '手臂', '臀部', '腿部', '核心', '全身'],
    '动作功能': ['增肌', '力量', '耐力', '减脂', '心肺', '恢复', '柔韧', '协调', '体态', '激活', '平衡'],
};

const SORT_DIM_OPTS = {
    ...RULE_OPTS,
    '动作体位': ['站姿', '坐姿', '仰卧', '俯卧', '侧卧', '跪姿', '悬挂', '支撑'],
    '动作难度': ['L1', 'L2', 'L3', 'L4', 'L5'],
    'MET值': [],
    '推荐权重': [],
    '随机': []
};

const SCHEMA = {
    '动作': {
        id: '动作ID', opsId: '动作运营ID', name: '动作名称', intro: '动作介绍',
        products: '关联产品', packages: '关联销售套餐',
        courseType: '适合课程类型', weight: '动作权重', level: '动作难度', mode: '动作模式', func: '动作功能',
        construct: '动作构造', constructCount: '复合次数', measure: '默认计量维度', impact: '冲击等级',
        pain: '疼痛部位', met: '动作MET值', coach: '动作教练', equip: '动作配件',
        part: '主要部位', subPart: '次要部位', muscle: '主动肌', antagonist: '拮抗肌', synergist: '辅助肌', stabilizer: '稳定肌',
        orientation: '动作朝向', posture: '动作体位', unilateral: '单侧/双侧', mirror: '镜像动作',
        powerModule: '力量模组', leverArm: '力臂位置', stroke: '行程类型', benchAngle: '健身凳角度',
        focus: '动作重点', feedback: '纠错反馈', algoFile: '算法文件',
        cover: '封面图', thumb: '缩略图', video: '动作视频', videoDur: '动作视频时长', demoCount: '动作演示次数',
        singleDur: '单次动作时长', mirrorVideo: '动作镜像视频', teachVideo: '动作教学视频', teachDur: '教学视频时长',
        status: '状态'
    },
    '课程': {
        id: '课程ID', opsId: '课程运营ID', name: '课程名称', intro: '课程介绍',
        products: '关联产品', packages: '关联销售套餐', form: '课程形态', isPk: 'PK课程',
        weight: '推荐权重', type: '课程类型', goal: '课程目标', target: '目标部位', level: '课程难度', duration: '课程时长',
        equip: '课程配件', coach: '课程教练', pain: '疼痛部位', impact: '冲击等级', met: '课程MET值', cal: '预估卡路里',
        segments: '环节配置',
        cover: '课程封面图', thumb: '课程缩略图', preview: '预览视频', video: '课程视频',
        style: '课程风格', rpe: '预估RPE', rhythm: '动作节奏', hr: '目标心率',
        status: '状态', paradigm: '训练范式'
    },
    '计划': {
        id: '计划ID', opsId: '计划运营ID', name: '计划名称', intro: '计划介绍',
        products: '关联产品', packages: '关联销售套餐', type: '计划类型',
        goal: '计划目标', funcGoal: '计划功能目标', level: '计划难度', cycle: '计划周期', freq: '计划周频',
        phases: '阶段配置',
        status: '状态'
    }
};

const RENDERERS = {
    // ============================================================
    // 1. 动作管理 (Action Management)
    // ============================================================
    action_list: () => `
        ${BatchControls('动作')}
        ${FilterBar([
            {label:'动作名称/ID', type:'text', placeholder:'输入名称/ID/运营ID'},
            {label:'部位', type:'select', opts:['胸部','背部','腿部','肩部','手臂','核心']},
            {label:'难度', type:'select', opts:['L1','L2','L3','L4','L5']},
            {label:'状态', type:'select', opts:['上架','下架']}
        ])}
        <table class="data-table">
            <thead><tr>${ThWithTooltip('动作ID')}${ThWithTooltip('动作运营ID')}${ThWithTooltip('动作名称')}${ThWithTooltip('主要部位')}${ThWithTooltip('主动肌')}${ThWithTooltip('动作模式')}${ThWithTooltip('动作器械')}${ThWithTooltip('动作功能')}${ThWithTooltip('动作难度')}${ThWithTooltip('状态')}<th>操作</th></tr></thead>
            <tbody>
                ${MOCK_DATA.actions.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.opsId}</td>
                    <td>${item.name}</td>
                    <td>${item.part}</td>
                    <td>${item.muscle || '-'}</td>
                    <td>${item.mode}</td>
                    <td>${item.equip}</td>
                    <td>${item.func}</td>
                    <td><span class="status-badge">${item.level}</span></td>
                    <td><span class="status-badge ${item.status==='上架'?'new':''}">${item.status}</span></td>
                    <td>
                        <button class="btn-text" onclick="app.toDetail('${item.id}')">编辑</button>
                        <button class="btn-warn" onclick="app.toggleStatus(this)">${item.status==='上架'?'下架':'上架'}</button>
                        <button class="btn-danger" onclick="app.deleteItem(this)">删除</button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    `,
    action_detail: () => `
        <div class="form-section">
            <div class="section-header">产品关联</div>
            <div class="form-grid">
                ${Field('关联产品', 'select', ['K1', 'S1'], '已有', false, '', true)}
                ${Field('关联销售套餐', 'select', ['标准版', '青春版', '豪华版'], '新增', false, '', true)}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">基础信息</div>
            <div class="form-grid">
                ${Field('动作ID', 'text', 'ACT_001', '已有', true)}
                ${Field('动作运营ID', 'text', 'SFBw029', '已有')}
                ${Field('动作名称', 'text', '杠铃卧推', '已有')}
                ${Field('动作介绍', 'textarea', '经典胸部训练动作...', '已有', false, 'full')}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">推荐标签</div>
            <div class="form-grid">
                ${Field('适合课程类型', 'select', ['力量','有氧','HIIT','搏击','普拉提','瑜伽','拉伸','气功','康复','冥想','高尔夫'], '新增', false, '', true)}
                ${Field('动作权重', 'number', '10', '原“推荐值”', true)}
                ${Field('动作难度', 'select', ['L1','L2','L3','L4','L5'], '已有')}
                ${Field('动作模式', 'select', ['水平推','垂直推','水平拉','垂直拉','髋主导','膝主导','弓步','旋转','核心稳定','步态'], '已有')}
                ${Field('动作功能', 'select', ['增肌','力量','耐力','爆发','减脂','心肺','恢复','柔韧','协调','体态','专项','激活','平衡','呼吸'], '原“功能标签”', false, '', true)}
                ${Field('动作构造', 'select', ['复合动作','孤立动作'], '新增').replace('select', 'select onchange="app.toggleSub(\'construct\', this.value)"')}
                ${Field('└─ 复合次数', 'number', '1', '原“计次逻辑”', false, 'sub-construct', false, '次')}
                ${Field('默认计量维度', 'select', ['计次','计时'], '新增')}
                ${Field('冲击等级', 'select', ['无冲击','低冲击','高冲击'], '新增')}
                ${Field('疼痛部位', 'select', ['无','手腕','肘部','肩部','腰部','髋部','膝盖','脚踝'], '新增', false, '', true)}
                ${Field('动作MET值', 'number', '4.5', '已有', false, '', false, 'MET')}
                ${Field('动作教练', 'select', ['Coach A', 'Coach B'], '新增', false, '', true)}
                ${Field('动作配件', 'select', ['横杆','手柄','自重'], '原“动作器械”', false, '', true)}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">运动解剖</div>
            <div class="form-grid">
                ${Field('主要部位', 'select', ['全身','胸部','背部','肩部','手臂','臀部','腿部','核心'], '已有')}
                ${Field('次要部位', 'select', ['手臂','肩部'], '已有', false, '', true)}
                ${Field('主动肌', 'select', ['胸大肌中束'], '原“主要肌肉”')}
                ${Field('拮抗肌', 'text', '背阔肌', '新增', true)}
                ${Field('辅助肌', 'select', ['肱三头肌'], '新增', false, '', true)}
                ${Field('稳定肌', 'select', ['腹直肌'], '新增', false, '', true)}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">交互配置</div>
            <div class="form-grid">
                ${Field('动作朝向', 'select', ['正身','侧身'], '已有')}
                ${Field('动作体位', 'select', ['站姿','坐姿','仰卧','俯卧','侧卧','跪姿','悬挂','支撑'], '新增')}
                ${Field('单侧/双侧', 'select', ['单侧','双侧'], '原“计次方式”').replace('select', 'select onchange="app.toggleSub(\'unilateral\', this.value)"')}
                ${Field('└─ 镜像动作', 'select', ['是','否'], '已有', false, 'sub-unilateral')}
                ${Field('力量模组', 'select', ['是','否'], '已有').replace('select', 'select onchange="app.togglePowerModule(this)"')}
                
                <div class="form-group full power-module-field" style="display:none; background:#1a1a1a; padding:15px; border:1px dashed #444; border-radius:4px; margin-top:10px;">
                    <label style="margin-bottom:10px; color:var(--primary);">力量模组配置 (必填)</label>
                    <div style="display:flex; flex-direction:column; gap:15px;">
                        <div class="form-group full">
                            <label>力臂位置 <span class="tag-new">新增</span></label>
                            <div style="display:flex; gap:20px; background:#111; border:1px solid #444; padding:10px; border-radius:4px; flex-wrap:wrap;">
                                <div style="min-width: 180px;">
                                    <div style="font-size:11px; color:#888; margin-bottom:5px;">左力臂</div>
                                    <div style="display:flex; gap:8px;">
                                        <div style="display:flex; align-items:center;"><span style="color:#666; margin-right:4px; font-size:10px; width:10px;">L</span><input type="number" min="1" max="9" value="1" style="width:40px; text-align:center; padding:4px;"></div>
                                        <div style="display:flex; align-items:center;"><span style="color:#666; margin-right:4px; font-size:10px; width:10px;">V</span><input type="number" min="1" max="7" value="3" style="width:40px; text-align:center; padding:4px;"></div>
                                        <div style="display:flex; align-items:center;"><span style="color:#666; margin-right:4px; font-size:10px; width:10px;">L</span><input type="number" min="1" max="3" value="2" style="width:40px; text-align:center; padding:4px;"></div>
                                    </div>
                                </div>
                                <div style="min-width: 180px;">
                                    <div style="font-size:11px; color:#888; margin-bottom:5px;">右力臂</div>
                                    <div style="display:flex; gap:8px;">
                                        <div style="display:flex; align-items:center;"><span style="color:#666; margin-right:4px; font-size:10px; width:10px;">R</span><input type="number" min="1" max="9" value="1" style="width:40px; text-align:center; padding:4px;"></div>
                                        <div style="display:flex; align-items:center;"><span style="color:#666; margin-right:4px; font-size:10px; width:10px;">V</span><input type="number" min="1" max="7" value="3" style="width:40px; text-align:center; padding:4px;"></div>
                                        <div style="display:flex; align-items:center;"><span style="color:#666; margin-right:4px; font-size:10px; width:10px;">L</span><input type="number" min="1" max="3" value="2" style="width:40px; text-align:center; padding:4px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${Field('行程类型', 'select', ['长行程','中行程','短行程','超短行程'], '已有')}
                    </div>
                </div>

                ${Field('健身凳角度', 'select', ['30°','35°','40°','45°','50°','55°','60°','65°','70°','75°','80°','85°','90°'], '新增')}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">动作教学</div>
            <div class="form-grid">
                <div class="form-group full">
                    <label>动作重点 <span class="tag-exist">非必填</span></label>
                    <div class="sub-list" style="gap:8px;">
                        <div style="display:flex; gap:8px;">
                            <input type="text" value="保持核心收紧，背部挺直" style="flex:1">
                            <button class="btn-danger" onclick="if(this.closest('.sub-list').children.length > 1) this.parentElement.remove()">删除</button>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <input type="text" value="下放时吸气，推起时呼气" style="flex:1">
                            <button class="btn-danger" onclick="if(this.closest('.sub-list').children.length > 1) this.parentElement.remove()">删除</button>
                        </div>
                    </div>
                    <button class="btn-primary" style="margin-top:8px; width:100px;" onclick="app.addFocusRow(this)">+ 添加重点</button>
                </div>

                ${Field('纠错反馈', 'select', ['膝盖内扣','腰背拱起'], '原“CV配置”', false, 'full', true)}
                ${Field('算法文件', 'file', '', '非必填')}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">动作素材</div>
            <div class="form-grid">
                ${Field('封面图', 'file', '', '原“设备端封面图”')}
                ${Field('缩略图', 'file', '', '原“设备端缩略图”')}
                ${Field('动作视频', 'file', '', '已有')}
                ${Field('└─ 动作视频时长', 'number', '15.0', '已有', false, '', false, 's')}
                ${Field('└─ 动作演示次数', 'number', '1', '原“教学次数”', false, '', false, '次 (有视频必填)')}
                ${Field('单次动作时长', 'number', '3.5', '已有', true, '', false, 's')}
                ${Field('动作镜像视频', 'file', '', '已有')}
                ${Field('动作教学视频', 'file', '', '原“教学视频”')}
                ${Field('└─ 教学视频时长', 'number', '45.0', '已有', false, '', false, 's')}
             </div>
        </div>

        <div class="deprecated-box">
            <div class="deprecated-title">废弃字段 (仅展示)</div>
            <div class="deprecated-list">
                <span class="deprecated-item">AI配置</span>
                <span class="deprecated-item">动作描述</span>
                <span class="deprecated-item">动作目标</span>
                <span class="deprecated-item">└─ 目标次数</span>
                <span class="deprecated-item">└─ 目标时长</span>
                <span class="deprecated-item">└─ 目标保持时长</span>
                <span class="deprecated-item">动作目的</span>
                <span class="deprecated-item">算法类型</span>
                <span class="deprecated-item">打点开始时间</span>
                <span class="deprecated-item">打点结束时间</span>
                <span class="deprecated-item">电机识别</span>
                <span class="deprecated-item">默认发力模式</span>
                <span class="deprecated-item">行程基准</span>
                <span class="deprecated-item">动作方向</span>
                <span class="deprecated-item">配件模式</span>
                <span class="deprecated-item">默认重量</span>
                <span class="deprecated-item">推荐系数上限</span>
                <span class="deprecated-item">推荐系数下限</span>
                <span class="deprecated-item">移动端封面图</span>
                <span class="deprecated-item">移动端缩略图</span>
            </div>
        </div>
    `,

    // ============================================================
    // 2. 课程管理 (Course Management)
    // ============================================================
    course_list: () => `
        ${BatchControls('课程')}
        ${FilterBar([
            {label:'课程名称/ID', type:'text', placeholder:'输入名称/ID/运营ID'},
            {label:'类型', type:'select', opts:['力量','HIIT','有氧','瑜伽']},
            {label:'难度', type:'select', opts:['L1','L2','L3','L4','L5']},
            {label:'状态', type:'select', opts:['上架','下架']}
        ])}
        <table class="data-table">
            <thead><tr>${ThWithTooltip('课程ID')}${ThWithTooltip('课程运营ID')}${ThWithTooltip('课程名称')}${ThWithTooltip('课程类型')}${ThWithTooltip('目标部位')}${ThWithTooltip('训练范式')}${ThWithTooltip('课程配件')}${ThWithTooltip('课程难度')}${ThWithTooltip('课程时长')}${ThWithTooltip('状态')}<th>操作</th></tr></thead>
            <tbody>
                ${MOCK_DATA.courses.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.opsId}</td>
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td>${item.target}</td>
                    <td>${item.paradigm}</td>
                    <td>${item.equip}</td>
                    <td><span class="status-badge">${item.level}</span></td>
                    <td>${item.duration}</td>
                    <td><span class="status-badge ${item.status==='上架'?'new':''}">${item.status}</span></td>
                    <td>
                        <button class="btn-text" onclick="app.toDetail('${item.id}')">编辑</button>
                        <button class="btn-warn" onclick="app.toggleStatus(this)">${item.status==='上架'?'下架':'上架'}</button>
                        <button class="btn-danger" onclick="app.deleteItem(this)">删除</button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    `,
    course_detail: () => `
        <div class="form-section">
            <div class="section-header">产品关联</div>
            <div class="form-grid">
                ${Field('关联产品', 'select', ['K1', 'S1'], '已有', false, '', true)}
                ${Field('关联销售套餐', 'select', ['标准版', '青春版', '豪华版'], '新增', false, '', true)}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">基础信息</div>
            <div class="form-grid">
                ${Field('课程形态', 'select', ['视频课程','模板课程','AI推荐课程'], '新增').replace('select', 'select onchange="app.toggleCourseTypeFields(this)"')}
                ${Field('课程ID', 'text', 'CRS_001', '已有', true)}
                ${Field('课程运营ID', 'text', '', '原“课程运营”')}
                ${Field('课程名称', 'text', '胸部增肌入门', '原“组合标题”')}
                ${Field('PK课程', 'select', ['是','否'], '已有')}
                ${Field('课程介绍', 'textarea', '...', '原“组合介绍”', false, 'full')}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">推荐标签</div>
            <div class="form-grid">
                ${Field('推荐权重', 'number', '1', '原“推荐值”', true)}
                ${Field('课程类型', 'select', ['力量','有氧','HIIT','搏击','普拉提','瑜伽','拉伸','气功','康复','冥想','高尔夫'], '原“组合类别”')}
                ${Field('课程目标', 'select', ['增肌','力量','耐力','爆发','减脂','心肺','恢复','柔韧','协调','体态','专项','激活','平衡'], '已有')}
                ${Field('目标部位', 'select', ['全身','胸部','背部','肩部','手臂','臀部','腿部','核心'], '原“训练部位”', false, '', true)}
                ${Field('课程难度', 'select', ['L1','L2','L3','L4','L5'], '原“组合难度”')}
                ${Field('课程时长', 'number', '30', '已有', true, '', false, 'min')}
                ${Field('课程配件', 'select', ['自重','手柄','横杆','踝带','健身凳','瑜伽垫','瑜伽砖','泡沫轴'], '原“配件要求”', false, 'template-auto', true)}
                ${Field('课程教练', 'select', ['Coach A'], '新增', false, '', true)}
                ${Field('疼痛部位', 'select', ['无','手腕','肘部','肩部','腰部','髋部','膝盖','脚踝'], '原“课程特点”', false, 'template-auto', true)}
                ${Field('冲击等级', 'select', ['无冲击','低冲击','高冲击'], '新增', false, 'template-auto')}
                ${Field('课程MET值', 'number', '4.0', '原“课程MET值”', false, 'template-auto', false, 'MET')}
                ${Field('预估卡路里', 'number', '120', '原“卡路里”', false, 'template-auto', false, 'kcal')}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">环节配置 (Segments)</div>
            <div class="section-header">环节配置</div>
            <div style="padding:20px;">
                <div class="sub-list">
                    ${SegmentItem('热身', '热身', '5', '流式范式')}
                    ${SegmentItem('主训', '主训', '20', '抗阻范式')}
                    ${SegmentItem('放松', '放松', '5', '流式范式')}
                </div>
                <button class="btn btn-primary" style="margin-top:10px; width:100%;">+ 添加环节</button>
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">课程素材</div>
            <div class="form-grid">
                ${Field('课程封面图', 'file', '', '原“设备端封面图”')}
                ${Field('课程缩略图', 'file', '', '原“设备端缩略图”')}
                ${Field('预览视频', 'file', '', '已有')}
                ${Field('课程视频', 'file', '', '已有')}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">课程需求池</div>
            <div class="form-grid">
                ${Field('课程风格', 'select', ['沉浸型','教学型'], '新增')}
                ${Field('预估RPE', 'number', '5', '新增', false, '', false, '级')}
                ${Field('动作节奏', 'text', '2-0-2-0', '新增')}
                ${Field('目标心率', 'text', '', '待定')}
            </div>
        </div>

        <div class="deprecated-box">
            <div class="deprecated-title">废弃字段</div>
            <div class="deprecated-list">
                <span class="deprecated-item">一级分类</span>
                <span class="deprecated-item">二级分类</span>
                <span class="deprecated-item">课程强度</span>
                <span class="deprecated-item">是否专属定制</span>
                <span class="deprecated-item">电机模式</span>
                <span class="deprecated-item">氛围灯模式</span>
                <span class="deprecated-item">背景音频</span>
                <span class="deprecated-item">音乐风格</span>
                <span class="deprecated-item">缩放比例</span>
                <span class="deprecated-item">视频宽/高比例</span>
                <span class="deprecated-item">关联酷狗音乐</span>
                <span class="deprecated-item">推荐描述</span>
                <span class="deprecated-item">注意事项</span>
                <span class="deprecated-item">移动端封面/缩略图</span>
            </div>
        </div>
    `,

    // ============================================================
    // 3. 计划管理 (Plan Management)
    // ============================================================
    plan_list: () => `
        ${BatchControls('计划')}
        ${FilterBar([
            {label:'计划名称/ID', type:'text', placeholder:'输入名称/ID/运营ID'},
            {label:'目标', type:'select', opts:['增肌','减脂','力量']},
            {label:'难度', type:'select', opts:['L1','L2','L3','L4','L5']},
            {label:'状态', type:'select', opts:['上架','下架']}
        ])}
        <table class="data-table">
            <thead><tr>${ThWithTooltip('计划ID')}${ThWithTooltip('计划运营ID')}${ThWithTooltip('计划名称')}${ThWithTooltip('计划类型')}${ThWithTooltip('计划目标')}${ThWithTooltip('计划难度')}${ThWithTooltip('计划周期')}${ThWithTooltip('计划周频')}${ThWithTooltip('状态')}<th>操作</th></tr></thead>
            <tbody>
                ${MOCK_DATA.plans.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.opsId}</td>
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td>${item.goal}</td>
                    <td><span class="status-badge">${item.level || 'L1'}</span></td>
                    <td>${item.cycle}</td>
                    <td>${item.freq}</td>
                    <td><span class="status-badge ${item.status==='上架'?'new':''}">${item.status}</span></td>
                    <td>
                        <button class="btn-text" onclick="app.toDetail('${item.id}')">编辑</button>
                        <button class="btn-warn" onclick="app.toggleStatus(this)">${item.status==='上架'?'下架':'上架'}</button>
                        <button class="btn-danger" onclick="app.deleteItem(this)">删除</button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    `,
    plan_detail: () => {
        const id = app.state.id;
        const plan = MOCK_DATA.plans.find(p => p.id === id) || {
            id: 'NEW', opsId: '', name: '', goal: '增肌', funcGoal: '增肌', cycle: '4', level: 'L1', freq: 3, type: '官方模板', phases: []
        };
        
        const phasesHtml = (plan.phases || []).map((p, idx) => StageItem(idx+1, p.name, p.type, p.duration, p.tpl, p.i, p.v)).join('');

        return `
        <div class="form-section">
            <div class="section-header">产品关联</div>
            <div class="form-grid">
                ${Field('关联产品', 'select', ['K1', 'S1'], '已有', false, '', true)}
                ${Field('关联销售套餐', 'select', ['标准版', '青春版', '豪华版'], '新增', false, '', true)}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">基础信息</div>
            <div class="form-grid">
                ${Field('计划ID', 'text', plan.id, '已有', true)}
                ${Field('计划运营ID', 'text', plan.opsId, '原“计划运营”')}
                ${Field('计划类型', 'select', ['官方模板','用户生成'], '新增').replace(`>${plan.type}<`, ` selected>${plan.type}<`)}
                ${Field('计划名称', 'text', plan.name, '已有')}
                ${Field('计划介绍', 'textarea', '...', '已有', false, 'full')}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">推荐标签</div>
            <div class="form-grid">
                ${Field('计划目标', 'select', ['增肌','减重','健康'], '已有').replace(`>${plan.goal}<`, ` selected>${plan.goal}<`)}
                ${Field('计划功能目标', 'select', ['增肌','力量','耐力','爆发','减脂','心肺','恢复','柔韧','协调','体态','专项','激活','平衡'], '新增').replace(`>${plan.funcGoal}<`, ` selected>${plan.funcGoal}<`)}
                ${Field('计划难度', 'select', ['L1','L2','L3','L4','L5'], '已有').replace(`>${plan.level}<`, ` selected>${plan.level}<`)}
                ${Field('计划周期', 'number', plan.cycle, '新增', false, '', false, '周')}
                ${Field('计划周频', 'number', plan.freq, '新增', false, '', false, '天')}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">阶段配置 (Stages)</div>
            <div class="section-header">阶段配置</div>
            <div style="padding:20px;">
                <div class="sub-list">
                    ${phasesHtml || '<div style="color:#666; text-align:center; padding:20px;">暂无阶段配置</div>'}
                </div>
                <button class="btn btn-primary" style="margin-top:10px; width:100%;" onclick="app.addStage()">+ 添加阶段</button>
            </div>
        </div>
    `},

    // ============================================================
    // 3.5 课程环节模板管理 (Course Segment Template Management)
    // ============================================================
    segment_list: () => `
        ${BatchControls('环节模板')}
        <table class="data-table">
            <thead>
                <tr>
                    <th>环节模板ID</th>
                    <th>环节模板名称</th>
                    <th>动作配比</th>
                    <th>环节维度</th>
                    <th>环节目标</th>
                    <th>环节类型</th>
                    <th>适用等级</th>
                    <th>适用性别</th>
                    <th>动作槽位</th>
                    <th>排序规则 (多级)</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                ${AI_CONFIG.templates.map((item, idx) => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.slots.map(s=>s.w).join(':')}</td>
                    <td>${item.dim || '-'}</td>
                    <td>${item.target || '-'}</td>
                    <td><span class="status-badge">${item.type || '主训'}</span></td>
                    <td>${(item.levels||[]).join(', ')}</td>
                    <td>${item.gender}</td>
                    <td>${(item.slots||[]).length}</td>
                    <td>${Array.isArray(item.sort) ? item.sort.map(s=>s.dim).join(' > ') : item.sort}</td>
                    <td>
                        <button class="btn-text" onclick="app.toDetail(${idx})">编辑</button>
                        <button class="btn-danger" onclick="app.deleteSegment(${idx})">删除</button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    `,
    segment_detail: () => {
        const id = app.state.id;
        // id is index in AI_CONFIG.templates
        const tpl = AI_CONFIG.templates[id];
        if (!tpl) return '<div style="padding:20px;">模板不存在</div>';

        const dimOpts = SLOT_OPTS.dims;
        const targetOpts = SLOT_OPTS.targets[tpl.dim || '部位'] || [];

        return `
        <div class="form-section">
            <div class="section-header">基础信息</div>
            <div class="form-grid">
                ${Field('环节模板ID', 'text', tpl.id, '自动生成', true)}
                ${Field('环节模板名称', 'text', tpl.name, '必填').replace('input', `input onchange="app.updateSegmentField(${id}, 'name', this.value)"`)}
                ${Field('环节维度', 'select', dimOpts, '必填').replace('select', `select onchange="app.updateSegmentDim(${id}, this.value)"`).replace(`>${tpl.dim}<`, ` selected>${tpl.dim}<`)}
                ${Field('环节目标', 'select', targetOpts, '必填').replace('select', `select onchange="app.updateSegmentField(${id}, 'target', this.value)"`).replace(`>${tpl.target}<`, ` selected>${tpl.target}<`)}
                ${Field('环节类型', 'select', ['热身','主训','放松'], '必填').replace('select', `select onchange="app.updateSegmentField(${id}, 'type', this.value)"`).replace(`>${tpl.type||'主训'}<`, ` selected>${tpl.type||'主训'}<`)}
                <div class="form-group">
                    <label>适用等级</label>
                    ${renderMultiSelect(`seg-lvl-${id}`, ['L1','L2','L3','L4','L5'], tpl.levels||[], `app.updateSegmentLevel(${id}`)}
                </div>
                ${Field('适用性别', 'select', ['All','男','女'], '必填').replace('select', `select onchange="app.updateSegmentField(${id}, 'gender', this.value)"`).replace(`>${tpl.gender}<`, ` selected>${tpl.gender}<`)}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">动作槽位</div>
            <div style="padding:20px;">
                ${SegmentSlotEditor(tpl.slots, id)}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">排序策略 (多级排序规则)</div>
            <div style="padding:20px;">
                ${SegmentSortEditor(tpl.sort, id)}
            </div>
        </div>
        `;
    },

    // ============================================================
    // 4. 阶段模板管理 (Phase Template Management)
    // ============================================================
    template_list: () => `
        ${FilterBar([
            {label:'模板名称', type:'text', placeholder:'输入名称/ID'},
            {label:'目标', type:'select', opts:['增肌','减脂','力量']},
            {label:'周频', type:'select', opts:['1','2','3','4','5']}
        ])}
        <table class="data-table">
            <thead><tr><th>模板ID</th><th>名称</th><th>目标</th><th>难度</th><th>周频</th><th>槽位数</th><th>状态</th><th>操作</th></tr></thead>
            <tbody>
                ${MOCK_DATA.templates.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.goal}</td>
                    <td><span class="status-badge">${item.level}</span></td>
                    <td>${item.freq}</td>
                    <td>${item.basicSlots ? item.basicSlots.length : item.slots}</td>
                    <td><span class="status-badge ${item.status==='上架'?'new':''}">${item.status || '上架'}</span></td>
                    <td>
                        <button class="btn-text" onclick="app.toDetail('${item.id}')">编辑</button>
                        <button class="btn-warn" onclick="app.toggleStatus(this)">${item.status==='上架'?'下架':'上架'}</button>
                        <button class="btn-danger" onclick="app.deleteItem(this)">删除</button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    `,
    template_detail: () => {
        const id = app.state.id;
        const tpl = MOCK_DATA.templates.find(t => t.id === id) || {
            id: 'NEW', name: '', goal: '增肌', level: 'L1', freq: 3, slots: 0, status: '上架'
        };
        
        const basicSlots = tpl.basicSlots || [];
        const freq = basicSlots.length;
        const suppSlots = tpl.suppSlots || [];
        const restSlots = tpl.restSlots || [];

        return `
        <div class="form-section">
            <div class="section-header">基础信息</div>
            <div class="form-grid">
                ${Field('单周模板ID', 'text', tpl.id, '新增', true)}
                ${Field('单周模板名称', 'text', tpl.name, '新增')}
                ${Field('单周模板目标', 'select', ['增肌','力量','耐力','爆发','减脂','心肺','恢复','柔韧','协调','体态','专项','激活','平衡'], '新增').replace(`>${tpl.goal}<`, ` selected>${tpl.goal}<`)}
                ${Field('模板难度', 'select', ['L1','L2','L3','L4','L5'], '新增').replace(`>${tpl.level}<`, ` selected>${tpl.level}<`)}
            </div>
        </div>

        <div class="form-section">
            <div class="section-header">结构配置</div>
            <div class="form-grid">
                ${Field('模板周频', 'number', freq, '自动计算', true, '', false, '天').replace('input', 'input id="tpl-freq"')}
                ${Field('模板环节', 'select', ['热身','主训','放松'], '新增', false, '', true)}
                ${Field('补充策略', 'select', ['循环','补充','随机'], '新增')}
                ${Field('休息日策略', 'select', ['完全休息','主动恢复'], '新增')}
            </div>
            ${SlotTable('基础槽位配置', 'tbl-basic', basicSlots)}
            ${SlotTable('补充槽位配置', 'tbl-supp', suppSlots)}
            ${SlotTable('休息槽位配置', 'tbl-rest', restSlots)}
        </div>
    `},

    // ============================================================
    // 5. 数据映射管理 (Data Mapping)
    // ============================================================
    mapping_list: () => {
        const tab = app.state.tab || 'anatomy';
        // Helper for options
        const opts = OPTS_HELPER;
        return `
        ${Tabs([
            {key:'anatomy', label:'解剖学层级'},
            {key:'antagonist', label:'主动肌-拮抗肌'},
            {key:'warmup', label:'动作模式-热身'},
            {key:'intensity', label:'强度指标换算'},
            {key:'mode', label:'动作模式-部位'}
        ], tab, 'app.setTab')}

        ${tab === 'anatomy' ? `
        <div class="form-section">
            <div class="section-header">解剖学层级映射 (区域-部位-肌肉)</div>
            <div style="padding:20px; background:#151515;">
                ${MAPPING_DATA.anatomy.map((region, rIdx) => `
                    <div class="tree-node" style="margin-left:0; border-left:none; margin-bottom:15px;">
                        <div class="tree-header" style="background:#222; padding:8px 10px; border-radius:4px;">
                            <span style="color:var(--primary); font-weight:700;">${region.region}</span>
                            <button class="btn-text" style="font-size:10px;">+ 添加部位</button>
                        </div>
                        ${region.parts.map((part, pIdx) => `
                            <div class="tree-node">
                                <div class="tree-header">
                                    <span class="tree-label">${part.name}</span>
                                    <span class="status-badge">${part.label}</span>
                                    <button class="btn-text" style="font-size:10px;">+ 添加肌肉</button>
                                </div>
                                <div class="tree-node" style="display:flex; flex-wrap:wrap; gap:8px; padding:5px 0;">
                                    ${part.muscles.map(m => `<span class="tag-exist">${m}</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
                <button class="btn-primary" style="width:100%; margin-top:10px;">+ 添加区域</button>
            </div>
        </div>` : ''}
        ${tab === 'antagonist' ? `
        <div class="form-section">
            <div class="section-header">主动肌-拮抗肌映射</div>
            <div style="padding:20px;">
                <table class="data-table">
                    <thead><tr>${ThWithTooltip('主动肌')}${ThWithTooltip('拮抗肌 (多选)')}${ThWithTooltip('示例')}<th>操作</th></tr></thead>
                    <tbody>
                        ${MAPPING_DATA.antagonist.map(item => `
                        <tr>
                            <td>${item.agonist}</td>
                            <td>${item.antagonist}</td>
                            <td>${item.example}</td>
                            <td><button class="btn-danger" onclick="app.deleteItem(this)">删除</button></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>` : ''}
        ${tab === 'warmup' ? `
        <div class="form-section">
            <div class="section-header">动作模式-热身功能映射</div>
            <div style="padding:20px;">
                <table class="data-table">
                    <thead><tr>${ThWithTooltip('主训模式')}${ThWithTooltip('推荐热身功能 (主要部位)')}<th>操作</th></tr></thead>
                    <tbody>
                        ${MAPPING_DATA.warmup.map(item => `
                        <tr>
                            <td>${item.mode}</td>
                            <td>${item.func.join(', ')}</td>
                            <td><button class="btn-danger" onclick="app.deleteItem(this)">删除</button></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>` : ''}
        ${tab === 'intensity' ? `
        <div class="form-section">
            <div class="section-header">强度指标换算映射</div>
            <div style="padding:20px;">
                <table class="data-table">
                    <thead><tr>${ThWithTooltip('等级')}${ThWithTooltip('力量负荷')}${ThWithTooltip('自重次数')}${ThWithTooltip('心率(MHR)')}${ThWithTooltip('组间休息')}${ThWithTooltip('计时时长')}</tr></thead>
                    <tbody>
                        ${MAPPING_DATA.intensity.map(item => `
                        <tr>
                            <td>${item.level}</td>
                            <td>${item.load}</td>
                            <td>${item.reps}</td>
                            <td>${item.hr}</td>
                            <td>${item.rest}</td>
                            <td>${item.time}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>` : ''}
        ${tab === 'mode' ? `
        <div class="form-section">
            <div class="section-header">动作模式与主练部位映射</div>
            <div style="padding:20px;">
                <table class="data-table">
                    <thead><tr>${ThWithTooltip('模式名称')}${ThWithTooltip('主要部位')}${ThWithTooltip('次要部位 (多选)')}<th>操作</th></tr></thead>
                    <tbody>
                        ${MAPPING_DATA.mode.map(item => `
                        <tr>
                            <td>${item.mode}</td>
                            <td>${item.main}</td>
                            <td>${item.sub.join('、')}</td>
                            <td><button class="btn-danger" onclick="app.deleteItem(this)">删除</button></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>` : ''}
    `},

    // ============================================================
    // 6. AI推荐管理 (AI Config)
    // ============================================================
    ai_list: () => {
        const tab = app.state.tab || 'global';
        return `
        ${Tabs([
            {key:'global', label:'1. 全局基准配置'},
            {key:'strategy', label:'2. 策略定义配置'},
            {key:'rec', label:'3. 推荐与筛选'},
            {key:'status', label:'4. 状态与反馈'}
        ], tab, 'app.setTab')}

        ${tab === 'global' ? `
        <div class="form-section">
            <div class="section-header">1.1 策略矩阵配置 (Strategy Matrix)</div>
            <div class="section-header">1.1 策略矩阵配置</div>
            <div style="padding:20px; overflow-x:auto;">
                ${ConfigTable('strategy', [
                    {label:'目标', key:'target', type:'select', opts:['增肌','力量','减脂','HIIT','耐力','爆发','心肺','有氧','瑜伽','普拉提','拉伸','恢复','柔韧','协调','体态','激活','平衡','专项']},
                    {label:'等级 (多选)', key:'level', type:'multiselect', opts:['L1','L2','L3','L4','L5']},
                    {label:'组数', key:'sets', type:'number', suffix:'组'},
                    {label:'间歇', key:'rest', type:'number', suffix:'s'},
                    {label:'强度', key:'intensity', type:'number', step:0.05},
                    {label:'模式', key:'mode', type:'select', opts:['常规','循环','超级','复合','巨型']},
                    {label:'策略', key:'strategy', type:'select', opts:['推荐','恒定','递增','递减','波浪','计时']},
                    {label:'难度', key:'diff', type:'select', opts:['保守','标准','进阶','挑战']}
                ])}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">1.3 结构与组装配置</div>
            <div style="padding:20px;">
                ${ConfigTable('structure', [
                    {label:'环节类型', key:'type', type:'select', opts:['热身','主训','放松']},
                    {label:'推荐占比', key:'ratio', type:'number', suffix:'%'},
                    {label:'最大时长(Cap)', key:'max', type:'number', suffix:'min'},
                    {label:'动作数量限制', key:'count', type:'number', suffix:'个'}
                ])}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">1.4 等级强度系数配置</div>
            <div style="padding:20px;">
                ${ConfigTable('levels', [
                    {label:'运动等级', key:'level', type:'text'},
                    {label:'强度系数', key:'coeff', type:'number', step:0.1}
                ])}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">1.5 训练范式配置</div>
            <div style="padding:20px;">
                ${ConfigTable('paradigms', [
                    {label:'训练范式', key:'name', type:'select', opts:['抗阻范式','间歇范式','流式范式']},
                    {label:'包含类型 (多选)', key:'types', type:'multiselect', opts:['力量','HIIT','有氧','瑜伽','普拉提','拉伸','康复','冥想','高尔夫','搏击']},
                    {label:'默认组数', key:'sets', type:'text'},
                    {label:'负荷策略', key:'strategy', type:'select', opts:['推荐','恒定','递增','递减','波浪','计时']},
                    {label:'核心特征 (选填)', key:'feature', type:'textarea'}
                ])}
            </div>
        </div>` : ''}

        ${tab === 'strategy' ? `
        <div class="form-section">
            <div class="section-header">2.1 负荷与组间策略配置</div>
            <div style="padding:20px;">
                ${ConfigTable('load', [
                    {label:'策略名称', key:'name', type:'select', opts:['恒定','递增','递减','计时','波浪']},
                    {label:'组序号', key:'index', type:'text'},
                    {label:'负荷系数', key:'coeff', type:'text'},
                    {label:'次数增量', key:'inc', type:'text'},
                    {label:'说明', key:'desc', type:'text'}
                ])}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">2.2 难度兼容策略配置</div>
            <div style="padding:20px;">
                ${ConfigTable('diff', [
                    {label:'策略名称', key:'name', type:'text'},
                    {label:'范围偏移', key:'range', type:'text'},
                    {label:'概率分布 (偏移:权重)', key:'prob', width:'300px', type:'text'}
                ])}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">2.3 阶段周期分配配置</div>
            <div style="padding:20px;">
                ${ConfigTable('phase', [
                    {label:'计划周期', key:'cycle', type:'select', opts:['1周','2周','3周','4周','>4周']},
                    {label:'阶段结构 (按序多选)', key:'structure', type:'multiselect', opts:['适应期','进阶期','突破期','减载期'], width:'350px'},
                    {label:'时长分配逻辑', key:'alloc', type:'text', width:'200px'}
                ])}
            </div>
        </div>` : ''}

        ${tab === 'rec' ? `
        <div class="form-section">
            <div class="section-header">3.1 推荐影响因子配置</div>
            <div style="padding:20px;">
                ${ConfigTable('factors', [
                    {label:'因子键', key:'key', type:'select', opts:['新鲜奖励','收藏奖励','探索奖励','厌倦惩罚','冷宫惩罚','疲劳惩罚','完赛信心奖励']},
                    {label:'权重/分值', key:'weight', type:'number', suffix:'分'},
                    {label:'触发规则', key:'rule', width:'300px', type:'text'}
                ])}
            </div>
        </div>` : ''}

        ${tab === 'status' ? `
        <div class="form-section">
            <div class="section-header">4.1 状态适配配置 (疲劳干预)</div>
            <div style="padding:20px;">
                ${ConfigTable('status', [
                    {label:'状态值区间', key:'range', type:'text'},
                    {label:'标签', key:'label', type:'select', opts:['已恢复','恢复中','疲劳中','已力竭']},
                    {label:'强度系数', key:'intensity', type:'text'},
                    {label:'容量系数', key:'volume', type:'text'},
                    {label:'强制约束', key:'constraint', type:'text'}
                ])}
            </div>
        </div>
        <div class="form-section">
            <div class="section-header">4.2 反馈与自适应配置</div>
            <div style="padding:20px;">
                ${ConfigTable('feedback', [
                    {label:'参数/条件', key:'cond', type:'text'},
                    {label:'阈值/动作', key:'action', type:'text'},
                    {label:'说明', key:'desc', width:'300px', type:'text'}
                ])}
            </div>
        </div>` : ''}
    `},
};

// --- HELPER FUNCTIONS ---

const FIELD_DESCRIPTIONS = {
    // 动作
    '关联产品': '指定该内容适用的硬件产品型号（如K1、S1），未选中的产品端将不可见。',
    '关联销售套餐': '指定该内容绑定的销售权益（如标准版、豪华版），用于会员权益控制。',
    '动作ID': '系统自动生成的唯一标识符，用于数据库索引和关联，不可修改。',
    '动作运营ID': '运营人员自定义的业务编码，用于跨系统对齐或内部管理。',
    '动作名称': '展示给用户的标准动作名称，需简洁准确，支持语音播报。',
    '动作介绍': '动作的详细图文/文本描述，用于详情页展示，包含动作要领和功效。',
    '适合课程类型': '定义该动作适用的课程场景（如力量、有氧），影响AI排课时的筛选逻辑。',
    '动作权重': '推荐算法的优先级系数，数值越高，在同类动作中被推荐的概率越大。',
    '动作难度': '动作的执行门槛（L1-L5），用于匹配用户的运动等级。',
    '动作模式': '动作的生物力学分类（如水平推、膝主导），用于确保训练计划的动作模式平衡。',
    '动作功能': '动作的主要训练效果（如增肌、爆发），用于匹配用户的具体训练目标。',
    '动作构造': '区分复合动作（多关节）和孤立动作（单关节），影响排课顺序（通常复合优先）。',
    '复合次数': '复合动作的计次逻辑系数，例如“硬拉+划船”做完一套算1次还是2次。',
    '默认计量维度': '动作的默认结算方式，计次（Rep）或计时（Time），影响训练界面的显示。',
    '冲击等级': '动作对关节的冲击力大小，用于为大体重或伤病用户规避高风险动作。',
    '疼痛部位': '该动作可能加剧疼痛的身体部位，用于伤病用户的智能规避（黑名单）。',
    '动作MET值': '代谢当量值，用于科学计算该动作单位时间内的卡路里消耗。',
    '动作教练': '演示该动作的教练IP，用于前端展示和用户偏好匹配。',
    '动作配件': '执行该动作所需的辅助器械（如横杆、手柄），用于根据用户拥有的器械进行筛选。',
    '主要部位': '动作训练的核心目标肌群所在的身体区域，用于排课时的部位匹配。',
    '次要部位': '动作涉及的协同发力部位，用于计算全身疲劳度和辅助肌群状态。',
    '主动肌': '动作主要发力的具体肌肉（如胸大肌中束），用于精准的塑形和负荷计算。',
    '拮抗肌': '与主动肌功能相反的肌肉，用于超级组编排（如胸背对抗）和肌肉平衡分析。',
    '辅助肌': '协助完成动作的肌肉群，用于评估继发性疲劳。',
    '稳定肌': '维持身体姿态的肌肉群，用于核心稳定性评估和康复训练推荐。',
    '动作朝向': '用户执行动作时相对于设备屏幕的朝向，用于视觉算法的骨骼点识别校准。',
    '动作体位': '执行动作时的身体姿态（如站姿、仰卧），用于流式训练的体位衔接优化。',
    '单侧/双侧': '区分动作是单侧轮流进行还是双侧同时进行，影响总组数和时长的计算。',
    '镜像动作': '若为单侧动作，是否需要左右对称各做一组（如单臂划船），影响排课逻辑。',
    '力量模组': '是否启用智能设备的电机阻力功能，选“是”则需配置力臂和行程。',
    '力臂位置': '智能设备力臂的调节档位（高度/角度），指导用户调整设备。',
    '行程类型': '动作的运动幅度范围，影响电机的发力行程判定。',
    '健身凳角度': '执行动作时健身凳靠背的调节角度，指导用户调整设备。',
    '动作重点': '教学视频中需要用户特别关注的技术细节，用于生成语音提示或重点字幕。',
    '纠错反馈': '视觉算法检测的常见错误类型（如膝盖内扣），用于实时语音纠错。',
    '算法文件': '配套的运动算法模型文件，用于动作识别和计数。',
    '封面图': '动作在列表页或卡片展示的静态预览图。',
    '缩略图': '动作的小尺寸预览图，用于快速浏览。',
    '动作视频': '标准的动作演示视频，用于循环播放展示动作轨迹。',
    '动作视频时长': '演示视频的长度，用于前端循环播放控制。',
    '动作演示次数': '视频中动作重复的次数，用于辅助用户理解节奏。',
    '单次动作时长': '完成一次标准动作所需的平均时间，用于估算课程总时长。',
    '动作镜像视频': '单侧动作另一侧的演示视频（如有）。',
    '动作教学视频': '详细的动作讲解视频，包含口播和要点拆解。',
    '教学视频时长': '教学视频的长度。',
    
    // 课程
    '课程形态': '区分视频跟练课、结构化模板课或AI实时生成课，决定数据来源和交互方式。',
    '课程ID': '课程的唯一系统标识。',
    '课程运营ID': '运营自定义的课程编码。',
    '课程名称': '展示给用户的课程标题，需具有吸引力。',
    'PK课程': '是否支持多人在线竞技模式。',
    '课程介绍': '课程的详细文案描述。',
    '推荐权重': '课程在推荐列表中的优先级。',
    '课程类型': '课程的运动种类（如HIIT、瑜伽），决定训练范式和心率区间。',
    '课程目标': '课程的主要训练目的（如减脂、增肌）。',
    '目标部位': '课程重点训练的身体区域。',
    '课程难度': '课程的整体难度等级，匹配用户能力。',
    '课程时长': '课程的总持续时间（包含热身放松）。',
    '课程配件': '完成该课程所需的所有器械集合。',
    '课程教练': '带领该课程的教练。',
    '课程MET值': '课程整体的代谢当量，用于估算热量。',
    '预估卡路里': '完成该课程预计消耗的热量。',
    '课程封面图': '课程的大图展示。',
    '课程缩略图': '课程的小图展示。',
    '预览视频': '课程的精彩片段剪辑，用于用户预览。',
    '课程视频': '完整的跟练视频文件（仅视频课）。',
    '课程风格': '课程的氛围风格（如沉浸式、教学型）。',
    '预估RPE': '预期的主观疲劳度（1-10），帮助用户选择适合状态的课程。',
    '动作节奏': '动作执行的向心/离心/顶峰收缩时间比例（如2-0-2-0）。',
    '目标心率': '建议用户在训练中保持的心率区间。',
    
    // 环节
    '环节开始点': '视频课程中该环节的起始时间戳。',
    '环节结束点': '视频课程中该环节的结束时间戳。',
    '循环模式': '环节内动作的执行顺序（如常规组、循环组）。',
    '负荷策略': '环节内动作的负荷变化逻辑（如恒定、递增）。',
    '休息配置': '是否启用组间休息。',
    '组间休息': '动作组与组之间的休息时间。',
    '轮间休息': '循环组大轮次之间的休息时间。',
    '发力模式': '电机输出的阻力模式（如恒力、弹力）。',
    
    // 计划
    '计划ID': '计划的唯一标识。',
    '计划运营ID': '运营自定义的计划编码。',
    '计划类型': '计划的生成方式（官方模板或用户生成）。',
    '计划名称': '计划的标题。',
    '计划介绍': '计划的详细描述。',
    '计划目标': '计划的宏观目标（如减重）。',
    '计划功能目标': '计划的具体功能侧重（如心肺提升）。',
    '计划难度': '计划的整体难度等级。',
    '计划周期': '计划持续的总周数。',
    '计划周频': '建议每周训练的天数。',
    '阶段周期': '该阶段持续的时间长度。',
    '计划阶段模板': '该阶段采用的周循环排课逻辑（如三分化）。',
    '强度系数': '该阶段相对于基准强度的倍率，用于周期化负荷调整。',
    '容量系数': '该阶段相对于基准容量（组数）的倍率。',
    '阶段类型': '阶段在周期中的角色（如适应期、突破期）。',
    '阶段名称': '阶段的显示名称。',
    
    // 模板
    '单周模板ID': '模板的唯一标识。',
    '单周模板名称': '模板的名称。',
    '单周模板目标': '模板侧重的训练目标。',
    '模板难度': '模板适用的用户等级。',
    '模板周频': '该模板设计的每周训练天数。',
    '模板环节': '该模板包含的课程环节结构。',
    '补充策略': '当训练日多于模板槽位时的填充逻辑。',
    '休息日策略': '休息日的建议活动（如完全休息或主动恢复）。',
    
    // AI配置
    '目标': '策略适用的训练目标。',
    '等级': '策略适用的用户等级。',
    '组数': '推荐的训练组数。',
    '间歇': '推荐的组间休息时间（秒）。',
    '强度': '推荐的负荷强度系数（%1RM）。',
    '模式': '推荐的训练循环模式。',
    '策略': '推荐的负荷变化策略。',
    '难度': '策略的难度偏向。',
    '环节类型': '课程环节的分类（热身/主训/放松）。',
    '推荐占比': '该环节在总时长中的推荐占比。',
    '最大时长': '该环节允许的最大时长限制。',
    '动作数量限制': '该环节允许的最大动作数量。',
    '运动等级': '用户的运动能力等级。',
    '训练范式': '训练的底层逻辑框架（如抗阻、间歇）。',
    '包含类型': '该范式涵盖的具体课程类型。',
    '默认组数': '该范式下的默认训练组数。',
    '核心特征': '该范式的主要训练特点描述。',
    '策略名称': '策略的唯一标识名。',
    '组序号': '策略应用到的具体组别序号。',
    '负荷系数': '相对于1RM或基准负荷的乘数。',
    '次数增量': '相对于基准次数的增减量。',
    '说明': '配置项的备注说明。',
    '范围偏移': '难度等级相对于基准的偏移量。',
    '概率分布': '不同难度偏移值的出现概率。',
    '阶段结构': '计划包含的阶段类型序列。',
    '时长分配逻辑': '各阶段时长的分配比例。',
    '因子键': '推荐算法的影响因子名称。',
    '权重/分值': '该因子对推荐分数的贡献值。',
    '触发规则': '该因子生效的逻辑条件。',
    '状态值区间': '用户身体状态分数的范围。',
    '标签': '状态对应的显示标签。',
    '强制约束': '该状态下强制执行的排课规则（如剔除高冲击）。',
    '参数/条件': '触发反馈调整的监控指标。',
    '阈值/动作': '触发调整的阈值或具体的调整动作。',
    '槽位名称': '该训练槽位的显示名称，如“上肢日”。',
    '侧重维度': '该槽位筛选动作的主要维度，如“部位”或“动作模式”。',
    '侧重目标': '该槽位具体的筛选目标，如“胸部”或“水平推”。',
    '模板键(Key)': '模板的唯一标识键。',
    '适用等级 (多选)': '该模板适用的用户运动等级。',
    '动作槽位配置 (维度 | 枚举 | 权重)': '定义该模板包含的动作槽位及其筛选规则和权重。',
    '排序策略': '该模板生成课程时的动作排序逻辑。',
    '主动肌': '动作主要发力的肌肉。',
    '拮抗肌 (多选)': '与主动肌功能相反的肌肉集合。',
    '环节模板ID': '环节模板的唯一标识符。',
    '环节模板名称': '环节模板的显示名称。',
    '环节维度': '该模板适用的匹配维度（如部位、动作模式）。',
    '环节目标': '该模板适用的具体匹配目标（如胸部、水平推）。',
    '动作槽位': '定义环节内动作的筛选规则与权重。',
    '动作配比': '环节内各动作槽位的权重比例概览。',
    '示例': '该映射关系的具体动作示例。',
    '主训模式': '主训环节的动作模式分类。',
    '推荐热身功能 (主要部位)': '针对该主训模式推荐的热身功能和部位。',
    '力量负荷': '该等级对应的力量训练负荷范围。',
    '自重次数': '该等级对应的自重动作重复次数。',
    '心率(MHR)': '该等级对应的目标心率区间。',
    '计时时长': '该等级对应的计时动作时长。',
    '模式名称': '动作模式的名称。',
    '次要部位 (多选)': '该模式涉及的次要发力部位。',
    '状态': '内容的上架/下架状态，决定是否在前端可见。'
};

function LabelWithTooltip(label, status) {
    let tagClass = 'tag-exist';
    if (status === '新增') tagClass = 'tag-new';
    else if (status && status.includes('原')) tagClass = 'tag-rename';
    
    const cleanLabel = label.replace(/└─\s*/, '');
    const desc = FIELD_DESCRIPTIONS[cleanLabel] || FIELD_DESCRIPTIONS[label] || '暂无详细说明';
    
    return `
        <label class="field-label-wrapper">
            <span class="field-label-text">${label}</span>
            <div class="field-tooltip-icon">?
                <div class="field-tooltip-content">${desc}</div>
            </div>
            ${status ? `<span class="${tagClass}">${status}</span>` : ''}
        </label>
    `;
}

function ThWithTooltip(label, width) {
    const cleanLabel = label.split(' (')[0];
    const desc = FIELD_DESCRIPTIONS[cleanLabel] || FIELD_DESCRIPTIONS[label] || '暂无详细说明';
    return `<th style="${width?'width:'+width:''}"><div class="field-label-wrapper" style="justify-content:flex-start;"><span class="field-label-text">${label}</span><div class="field-tooltip-icon">?<div class="field-tooltip-content">${desc}</div></div></div></th>`;
}

function BatchControls(type) {
    return `
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:10px;">
        <button class="btn btn-secondary" onclick="app.exportConfig('${type}')">⬇ 下载最新配置 (Excel)</button>
        <button class="btn btn-secondary" onclick="document.getElementById('import-${type}').click()">⬆ 批量导入配置 (Excel)</button>
        <input type="file" id="import-${type}" accept=".xlsx, .xls, .csv" style="display:none;" onchange="app.importConfig('${type}', this)">
    </div>
    `;
}

function FilterBar(fields) {
    return `
    <div style="display:flex; gap:10px; margin-bottom:15px; background:var(--bg-element); padding:15px; border-radius:4px; border:var(--border);">
        ${fields.map(f => `
            <div style="flex:1;">
                <label style="margin-bottom:5px; display:block; color:var(--text-sub); font-size:11px;">${f.label}</label>
                ${f.type === 'select' 
                    ? `<select style="width:100%;"><option value="">全部</option>${f.opts.map(o=>`<option>${o}</option>`).join('')}</select>`
                    : `<input type="text" placeholder="${f.placeholder||''}" style="width:100%;">`
                }
            </div>
        `).join('')}
        <div style="display:flex; align-items:flex-end;">
            <button class="btn btn-primary" style="height:32px;">查询</button>
            <button class="btn-text" style="height:32px; margin-left:10px;">重置</button>
        </div>
    </div>
    `;
}

function Tabs(items, activeKey, onSelect) {
    return `<div class="tabs">
        ${items.map(i => `<div class="tab-item ${i.key === activeKey ? 'active' : ''}" onclick="${onSelect}('${i.key}')">${i.label}</div>`).join('')}
    </div>`;
}

function SlotTable(title, id, initialData = []) {
    const opts = (arr, selected) => arr.map(x => `<option ${x===selected?'selected':''}>${x}</option>`).join('');
    
    const renderRow = (data) => {
        const dim = data.focusDim || '部位';
        const targetOpts = SLOT_OPTS.targets[dim] || [];
        return `
        <tr>
            <td><input type="text" value="${data.name||''}" placeholder="如: 上肢日"></td>
            <td><select>${opts(SLOT_OPTS.types, data.type)}</select></td>
            <td><select onchange="app.updateSlotTargets(this)">${opts(SLOT_OPTS.dims, dim)}</select></td>
            <td><select>${opts(targetOpts, data.focusTarget)}</select></td>
            <td><button class="btn-danger" onclick="app.deleteSlotItem(this)">删除</button></td>
        </tr>`;
    };

    return `
    <div style="padding:0 20px 20px 20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <label style="margin:0; font-weight:700; color:#ddd;">${title}</label>
            <button class="btn-primary" style="padding:4px 10px; font-size:11px;" onclick="app.addSlotRow('${id}')">+ 添加槽位</button>
        </div>
        <table class="data-table" id="${id}">
            <thead><tr>${ThWithTooltip('槽位名称')}${ThWithTooltip('课程类型')}${ThWithTooltip('侧重维度')}${ThWithTooltip('侧重目标')}<th>操作</th></tr></thead>
            <tbody>
                ${initialData.map(renderRow).join('')}
            </tbody>
        </table>
    </div>
    `;
}

function SegmentSlotEditor(slots, tplIdx) {
    const dims = Object.keys(RULE_OPTS);
    const slotList = Array.isArray(slots) ? slots : [];

    const rows = slotList.map((s, sIdx) => `
        <div style="display:flex; gap:10px; align-items:center; background:#222; padding:8px; border-radius:4px; border:1px solid #444; margin-bottom:8px;">
            <span style="color:#888; font-size:12px; width:20px;">${sIdx+1}.</span>
            <select style="width:100px; padding:4px; background:#111; border:1px solid #444; color:#fff;" onchange="app.updateSegmentSlot(${tplIdx}, ${sIdx}, 'focusDim', this.value)">
                ${dims.map(d => `<option ${d===s.focusDim?'selected':''}>${d}</option>`).join('')}
            </select>
            <select style="flex:1; padding:4px; background:#111; border:1px solid #444; color:#fff;" onchange="app.updateSegmentSlot(${tplIdx}, ${sIdx}, 'focusTarget', this.value)">
                ${(RULE_OPTS[s.focusDim]||[]).map(o => `<option ${o===s.focusTarget?'selected':''}>${o}</option>`).join('')}
            </select>
            <div style="display:flex; align-items:center; gap:4px;">
                <span style="color:#666; font-size:11px;">权重</span>
                <input type="number" value="${s.w}" step="0.1" style="width:50px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;" onchange="app.updateSegmentSlot(${tplIdx}, ${sIdx}, 'w', this.value)">
            </div>
            <button class="btn-danger" onclick="app.removeSegmentSlot(${tplIdx}, ${sIdx})">删除</button>
        </div>
    `).join('');

    return `<div>${rows}<button class="btn btn-primary" style="margin-top:10px; width:100%;" onclick="app.addSegmentSlot(${tplIdx})">+ 添加槽位</button></div>`;
}

function SegmentSortEditor(sorts, tplIdx) {
    // Migration for old string format
    if (typeof sorts === 'string') {
        sorts = [{ dim: '默认', order: '默认', seq: sorts }]; // Placeholder migration
    }
    const sortList = Array.isArray(sorts) ? sorts : [];
    const dims = ['动作构造', '动作模式', '主动肌', '主要配件', '力臂挡位', '动作体位', '动作难度', 'MET值', '推荐权重', '随机'];
    const orders = ['升序', '降序', '自定义', '随机'];

    const rows = sortList.map((s, sIdx) => {
        const showSeq = s.order === '自定义';
        const dimOpts = SORT_DIM_OPTS[s.dim] || [];
        
        let helperHtml = '';
        if (showSeq && dimOpts.length > 0) {
            helperHtml = `<div style="width:100%; margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; padding-top:8px; border-top:1px dashed #333;">
                <span style="color:#666; font-size:10px; margin-right:4px;">点击添加:</span>
                ${dimOpts.map(opt => `<span class="tag-exist" style="cursor:pointer; border:1px solid #444;" onclick="app.appendToSortSeq(${tplIdx}, ${sIdx}, '${opt}')">${opt}</span>`).join('')}
                <span class="tag-new" style="cursor:pointer; border:1px solid var(--new-tag);" onclick="app.clearSortSeq(${tplIdx}, ${sIdx})">清空</span>
            </div>`;
        }

        return `
        <div style="display:flex; flex-direction:column; background:#222; padding:8px; border-radius:4px; border:1px solid #444; margin-bottom:8px;">
            <div style="display:flex; gap:10px; align-items:center;">
            <span style="color:#var(--primary); font-size:12px; font-weight:bold; width:60px;">第 ${sIdx+1} 级</span>
            
            <div style="display:flex; align-items:center; gap:4px;">
                <span style="color:#666; font-size:11px;">维度</span>
                <select style="width:100px; padding:4px; background:#111; border:1px solid #444; color:#fff;" onchange="app.updateSortRule(${tplIdx}, ${sIdx}, 'dim', this.value)">
                    ${dims.map(d => `<option ${d===s.dim?'selected':''}>${d}</option>`).join('')}
                </select>
            </div>

            <div style="display:flex; align-items:center; gap:4px;">
                <span style="color:#666; font-size:11px;">方式</span>
                <select style="width:80px; padding:4px; background:#111; border:1px solid #444; color:#fff;" onchange="app.updateSortRule(${tplIdx}, ${sIdx}, 'order', this.value)">
                    ${orders.map(o => `<option ${o===s.order?'selected':''}>${o}</option>`).join('')}
                </select>
            </div>

            <input type="text" value="${s.seq||''}" placeholder="自定义序列 (如: 复合,孤立)" style="flex:1; display:${showSeq?'block':'none'}; background:#111; border:1px solid #444; color:#fff; padding:4px;" onchange="app.updateSortRule(${tplIdx}, ${sIdx}, 'seq', this.value)">
            
            <button class="btn-danger" onclick="app.removeSortRule(${tplIdx}, ${sIdx})">删除</button>
            </div>
            ${helperHtml}
        </div>
    `}).join('');

    return `<div>${rows}<button class="btn btn-primary" style="margin-top:10px; width:100%;" onclick="app.addSortRule(${tplIdx})">+ 添加排序规则</button></div>`;
}

function TemplateConfigTable() {
    const data = AI_CONFIG.templates || [];
    const dims = Object.keys(RULE_OPTS);
    
    const renderEditor = (val, idx, field) => {
        // val is now an array of objects: [{dim, val, w}, ...]
        const slots = Array.isArray(val) ? val : [];
        
        const slotRows = slots.map((s, sIdx) => `
            <div style="display:inline-flex; gap:2px; align-items:center; background:#222; padding:2px 4px; border-radius:4px; border:1px solid #444; margin-right:4px; margin-bottom:4px;">
                <select style="width:70px; font-size:10px; padding:2px; height:20px; border:none; background:transparent;" onchange="app.updateTemplateSlot(${idx}, ${sIdx}, 'dim', this.value)">
                    ${dims.map(d => `<option ${d===s.dim?'selected':''}>${d}</option>`).join('')}
                </select>
                <span style="color:#666">:</span>
                <select style="width:70px; font-size:10px; padding:2px; height:20px; border:none; background:transparent;" onchange="app.updateTemplateSlot(${idx}, ${sIdx}, 'val', this.value)">
                    ${(RULE_OPTS[s.dim]||[]).map(o => `<option ${o===s.val?'selected':''}>${o}</option>`).join('')}
                </select>
                <input type="number" value="${s.w}" step="0.1" style="width:30px; font-size:10px; padding:2px; height:20px; border:none; background:transparent; text-align:center;" onchange="app.updateTemplateSlot(${idx}, ${sIdx}, 'w', this.value)">
                <span style="color:#666; cursor:pointer; margin-left:2px;" onclick="app.removeTemplateSlot(${idx}, ${sIdx})">×</span>
            </div>
        `).join('');

        return `<div class="rule-editor" style="display:flex; flex-wrap:wrap; align-items:center;">
            ${slotRows}
            <button class="btn-primary" style="width:auto; padding:2px 8px; font-size:12px; height:24px; border:none; display:flex; align-items:center; justify-content:center;" onclick="app.addTemplateSlot(${idx})">+</button>
        </div>`;
    };

    const renderLevels = (levels, idx) => {
        const allLevels = ['L1', 'L2', 'L3', 'L4', 'L5'];
        const msId = `tpl-lvl-${idx}`;
        return renderMultiSelect(msId, allLevels, levels, `app.updateTemplateLevel(${idx}`);
    };

    const sortOpts = ['体能分配', '顺序执行', '交替执行', '流式优化', '强度波动'];

    return `
    <table class="data-table" id="cfg-templates">
        <thead>
            <tr>
                ${ThWithTooltip('模板键(Key)', '100px')}
                ${ThWithTooltip('适用等级 (多选)', '140px')}
                ${ThWithTooltip('动作槽位配置 (维度 | 枚举 | 权重)')}
                ${ThWithTooltip('排序策略', '100px')}
                <th style="width:60px">操作</th>
            </tr>
        </thead>
        <tbody>
            ${data.map((row, idx) => `
            <tr>
                <td><input type="text" value="${row.key}" style="width:100%" onchange="app.updateConfig('templates',${idx},'key',this.value)"></td>
                <td>${renderLevels(row.levels || [], idx)}</td>
                <td>${renderEditor(row.slots, idx, 'slots')}</td>
                <td>
                    <select style="width:100%" onchange="app.updateConfig('templates',${idx},'sort',this.value)">
                        ${sortOpts.map(s => `<option ${s===row.sort?'selected':''}>${s}</option>`).join('')}
                    </select>
                </td>
                <td><button class="btn-danger" onclick="app.deleteConfigRow('templates', ${idx})">删除</button></td>
            </tr>`).join('')}
            <tr>
                <td colspan="5"><button class="btn-primary" style="width:100%" onclick="app.addConfigRow('templates')">+ 添加配置项</button></td>
            </tr>
        </tbody>
    </table>`;
}

function ConfigTable(key, columns) {
    const data = AI_CONFIG[key] || [];
    return `
    <table class="data-table" id="cfg-${key}">
        <thead>
            <tr>
                ${columns.map(c => {
                    return ThWithTooltip(c.label, c.width);
                }).join('')}
                <th style="width:60px">操作</th>
            </tr>
        </thead>
        <tbody>
            ${data.map((row, idx) => `
            <tr>
                ${columns.map(c => {
                    let inputHtml = '';
                    if (c.type === 'select') {
                        inputHtml = `<select style="width:100%" onchange="app.updateConfig('${key}',${idx},'${c.key}',this.value)">
                            ${c.opts.map(o => `<option ${o===row[c.key]?'selected':''}>${o}</option>`).join('')}
                        </select>`;
                    } else if (c.type === 'multiselect') {
                        let valStr = row[c.key] || '';
                        if (valStr.includes(' -> ')) valStr = valStr.split(' -> ').join(',');
                        const selected = valStr ? (Array.isArray(valStr) ? valStr : valStr.split(',').map(s=>s.trim())) : [];
                        const msId = `cfg-${key}-${idx}-${c.key}`;
                        inputHtml = renderMultiSelect(msId, c.opts, selected, `app.updateConfigMultiselect('${key}',${idx},'${c.key}'`);
                    } else if (c.type === 'textarea') {
                        inputHtml = `<textarea style="width:100%" rows="2" onchange="app.updateConfig('${key}',${idx},'${c.key}',this.value)">${row[c.key]}</textarea>`;
                    } else if (c.type === 'number') {
                        inputHtml = `<div style="display:flex; align-items:center; gap:2px;">
                            <input type="number" value="${row[c.key]}" step="${c.step||1}" style="width:100%" onchange="app.updateConfig('${key}',${idx},'${c.key}',this.value)">
                            ${c.suffix ? `<span style="color:#666; font-size:10px;">${c.suffix}</span>` : ''}
                        </div>`;
                    } else {
                        inputHtml = `<input type="text" value="${row[c.key]}" style="width:100%" onchange="app.updateConfig('${key}',${idx},'${c.key}',this.value)">`;
                    }
                    return `<td>${inputHtml}</td>`;
                }).join('')}
                <td><button class="btn-danger" onclick="app.deleteConfigRow('${key}', ${idx})">删除</button></td>
            </tr>`).join('')}
            <tr>
                <td colspan="${columns.length + 1}"><button class="btn-primary" style="width:100%" onclick="app.addConfigRow('${key}')">+ 添加配置项</button></td>
            </tr>
        </tbody>
    </table>`;
}

function renderMultiSelect(id, options, selected, onTogglePrefix) {
    const displayVal = selected.length > 0 ? selected.join(', ') : '请选择';
    const isOpen = app.state.openDropdown === id;
    
    return `
    <div class="multi-select ${isOpen ? 'open' : ''}" id="${id}">
        <div class="ms-trigger" onclick="event.stopPropagation(); app.toggleDropdown('${id}')">
            <div class="ms-value" title="${displayVal}">${displayVal}</div>
            <div class="ms-arrow">▼</div>
        </div>
        <div class="ms-options">
            ${options.map(o => {
                const isSel = selected.includes(o);
                // Pass 'this' to allow DOM manipulation for static demos
                return `
                <div class="ms-option" onmousedown="event.preventDefault()" onclick="event.stopPropagation(); ${onTogglePrefix}, '${o}', !${isSel}, this)">
                    <input type="checkbox" ${isSel?'checked':''}>
                    <span>${o}</span>
                </div>`;
            }).join('')}
        </div>
    </div>`;
}

function Field(label, type, value, status, disabled=false, layout='', multi=false, suffix='') {
    const inputAttr = disabled ? 'disabled style="opacity:0.5"' : '';
    let inputHtml = '';
    
    if (type === 'select') {
        const opts = Array.isArray(value) ? value : [];
        if (multi) {
            // Mock selected state for Field (since value is options list in this demo structure)
            const msId = `field-${label}`;
            inputHtml = renderMultiSelect(msId, opts, [], `app.mockFieldToggle('${label}'`);
        } else {
            inputHtml = `<select ${inputAttr}>${opts.map(o => `<option>${o}</option>`).join('')}</select>`;
        }
    } else if (type === 'textarea') {
        inputHtml = `<textarea ${inputAttr}>${value}</textarea>`;
    } else if (type === 'file') {
        inputHtml = `<input type="file" ${inputAttr}>`;
    } else {
        if (suffix) {
            inputHtml = `<div style="display:flex; align-items:center; gap:4px;">
                <input type="${type}" value="${value}" ${inputAttr} style="flex:1">
                <span style="color:#666; font-size:10px; white-space:nowrap;">${suffix}</span>
            </div>`;
        } else {
            inputHtml = `<input type="${type}" value="${value}" ${inputAttr}>`;
        }
    }

    return `
        <div class="form-group ${layout}">
            ${LabelWithTooltip(label, status)}
            ${inputHtml}
        </div>
    `;
}

function SegmentItem(name, type, duration, paradigm) {
    const mockActions = type === '主训' ? [
        {name: '杠铃卧推', sets: 4, reps: '12', measure: '计次'},
        {name: '哑铃飞鸟', sets: 3, reps: '15', measure: '计次'}
    ] : (type === '热身' ? [{name: '开合跳', sets: 1, reps: '30', measure: '计时'}] : [{name: '全身拉伸', sets: 1, reps: '30', measure: '计时'}]);

    let initSets = 0;
    mockActions.forEach(a => initSets += a.sets);

    const actionRows = mockActions.map(a => `
        <div class="action-row" style="display:flex; align-items:center; gap:15px; background:#1a1c20; padding:8px 12px; border-radius:4px; margin-bottom:4px; border:1px solid #333; font-size:12px;">
            <span style="flex:1; font-weight:600; color:#ccc;">${a.name}</span>
            <div style="display:flex; align-items:center; gap:4px;"><input type="number" class="act-sets" value="${a.sets}" onchange="app.recalcSegment(this)" style="width:50px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;"> <span style="color:#666;">组</span></div>
            <div style="display:flex; align-items:center; gap:6px;">
                <select class="act-measure" onchange="app.updateActionUnit(this); app.recalcSegment(this)" style="width:70px; padding:4px; background:#111; border:1px solid #444; color:#fff; font-size:11px;">
                    <option value="计次" ${a.measure==='计次'?'selected':''}>计次</option>
                    <option value="计时" ${a.measure==='计时'?'selected':''}>计时</option>
                </select>
                <input type="number" class="act-reps" value="${a.reps}" onchange="app.recalcSegment(this)" style="width:60px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;">
                <span class="act-unit" style="color:#666; width:14px;">${a.measure==='计次'?'次':'s'}</span>
            </div>
            <div class="video-only" style="display:none; align-items:center; gap:4px;">
                <input type="number" placeholder="始(s)" style="width:60px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;"> - 
                <input type="number" placeholder="终(s)" style="width:60px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;">
            </div>
            <button class="btn-text" style="color:#666; margin-left:5px;" onclick="const s=this.closest('.sub-item'); this.parentElement.remove(); app.recalcSegment(s)">✕</button>
        </div>
    `).join('');

    return `
        <div class="sub-item">
            <div class="sub-header">
                <input type="text" value="${name}" style="background:transparent; border:none; border-bottom:1px solid #444; color:#fff; font-weight:700; width:120px; padding:2px;" placeholder="环节名称">
                <select style="width:80px; padding:2px; font-size:11px; height:24px; background:#111; border:1px solid #444; color:#ccc;">
                    <option ${type==='热身'?'selected':''}>热身</option>
                    <option ${type==='主训'?'selected':''}>主训</option>
                    <option ${type==='放松'?'selected':''}>放松</option>
                </select>
                <div style="flex:1;"></div>
                
                <div style="display:flex; gap:15px; margin-right:20px; font-size:12px; color:#888; align-items:center;">
                    <span>时长 <b class="seg-duration-text" style="color:#fff; font-size:14px;">${duration}</b> min</span>
                    <span>动作 <b class="seg-action-count" style="color:#fff; font-size:14px;">${mockActions.length}</b> 个</span>
                    <span>组数 <b class="seg-total-sets" style="color:#fff; font-size:14px;">${initSets}</b> 组</span>
                </div>

                <button class="btn-text" style="color:#666;" onclick="if(confirm('删除环节?')) this.closest('.sub-item').remove()">删除</button>
            </div>
            <div class="form-grid" style="padding:10px 0; gap:10px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));">
                ${Field('环节开始点', 'number', '', '视频课', false, 'video-only', false, 's').replace('form-group', 'form-group video-only')}
                ${Field('环节结束点', 'number', '', '视频课', false, 'video-only', false, 's').replace('form-group', 'form-group video-only')}
                ${Field('循环模式', 'select', ['常规','循环','超级'], '新增')}
                ${Field('负荷策略', 'select', ['推荐','恒定','递增','计时'], '新增')}
                ${Field('休息配置', 'select', ['是','否'], '新增').replace('select', 'select onchange="app.toggleRestFields(this)"')}
                ${Field('组间休息', 'number', '60', '新增', false, 'rest-field', false, 's').replace('input', 'input class="seg-rest" onchange="app.recalcSegment(this)"')}
                ${Field('轮间休息', 'number', '90', '新增', false, 'rest-field', false, 's')}
                ${Field('发力模式', 'select', ['恒力','向心','离心','划船','弹力'], '新增')}
            </div>
            
            <div style="margin-top:10px; background:#25282e; padding:10px; border-radius:4px;">
                <div style="font-size:11px; color:#888; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>动作列表</span>
                    <button class="btn-primary" style="padding:2px 8px; font-size:10px; height:20px; line-height:1;" onclick="app.openActionPicker(this)">+ 添加动作</button>
                </div>
                <div class="action-list">
                    ${actionRows}
                </div>
            </div>
        </div>
    `;
}

function StageItem(idx, name, type, duration, tplId, intensity, volume) {
    const tplOpts = MOCK_DATA.templates.map(t => `<option value="${t.id}" ${t.id===tplId?'selected':''}>${t.name}</option>`).join('');
    const typeOpts = ['适应期', '进阶期', '突破期', '减载期'].map(t => `<option ${t===type?'selected':''}>${t}</option>`).join('');
    const displayName = name || type;
    return `
        <div class="sub-item">
            <div class="sub-header">
                <span>${idx}. ${displayName} <span class="status-badge new">${type}</span></span>
                <button class="btn-text" onclick="this.closest('.sub-item').remove()">删除</button>
            </div>
            <div class="form-grid" style="padding:0; gap:10px;">
                <div class="form-group">
                    ${LabelWithTooltip('阶段类型', '新增')}
                    <select onchange="app.updateStageName(this)">${typeOpts}</select>
                </div>
                <div class="form-group">
                    ${LabelWithTooltip('阶段名称', '新增')}
                    <input type="text" value="${name || ''}" placeholder="${type}" oninput="app.updateStageHeader(this)">
                </div>
                ${Field('阶段周期', 'text', duration, '新增')}
                <div class="form-group ">
                    ${LabelWithTooltip('计划阶段模板', '新增')}
                    <select>${tplOpts}</select>
                </div>
                ${Field('强度系数', 'number', intensity||'1.0', '新增')}
                ${Field('容量系数', 'number', volume||'1.0', '新增')}
            </div>
        </div>
    `;
}

const app = {
    state: {
        page: 'action',
        view: 'list', // list | detail
        openDropdown: null, // Track open multi-select
        tab: null,    // sub-tab for mapping/ai
        id: null
    },
    navigate: (page) => {
        app.state.page = page;
        app.state.view = 'list';
        app.state.tab = null; // reset sub-tab
        app.state.openDropdown = null;
        app.state.pickerSelection = [];
        app.state.id = null;
        app.render();
    },
    setTab: (key) => {
        app.state.tab = key;
        app.render();
    },
    toDetail: (id) => {
        app.state.view = 'detail';
        app.state.id = id;
        app.render();
        setTimeout(() => app.toggleCourseTypeFields(document.querySelector('select')), 100); // Init fields state
        setTimeout(() => app.initSubVisibility(), 100); // Init sub-fields state
    },
    toggleStatus: (btn) => {
        const isUp = btn.innerText === '下架';
        btn.innerText = isUp ? '上架' : '下架';
        btn.parentElement.previousElementSibling.innerHTML = `<span class="status-badge ${!isUp?'new':''}">${!isUp?'上架':'下架'}</span>`;
    },
    deleteItem: (btn) => {
        if(confirm('确定要删除吗？')) btn.closest('tr').remove();
    },
    deleteSlotItem: (btn) => {
        if(confirm('确定要删除吗？')) {
            const row = btn.closest('tr');
            const tableId = row.closest('table').id;
            row.remove();
            if (tableId === 'tbl-basic') app.updateTemplateFreq();
        }
    },
    addFocusRow: (btn) => {
        const list = btn.previousElementSibling;
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.gap = '8px';
        div.innerHTML = `<input type="text" style="flex:1"><button class="btn-danger" onclick="if(this.closest('.sub-list').children.length > 1) this.parentElement.remove()">删除</button>`;
        list.appendChild(div);
    },
    addMappingRow: (btn) => {
        const row = btn.closest('tr');
        const newRow = row.cloneNode(true);
        // Change button to delete
        const btnCell = newRow.querySelector('td:last-child');
        btnCell.innerHTML = '<button class="btn-danger" onclick="app.deleteItem(this)">删除</button>';
        // Reset values
        newRow.querySelectorAll('input').forEach(i => i.value = '');
        newRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        newRow.classList.remove('add-row');
        row.parentNode.insertBefore(newRow, row);
    },
    updateSlotTargets: (select) => {
        const dim = select.value;
        const targetSelect = select.parentElement.nextElementSibling.querySelector('select');
        const opts = SLOT_OPTS.targets[dim] || [];
        targetSelect.innerHTML = opts.map(x => `<option>${x}</option>`).join('');
    },
    addSlotRow: (tableId) => {
        const tbody = document.querySelector(`#${tableId} tbody`);
        const tr = document.createElement('tr');
        const opts = (arr) => arr.map(x => `<option>${x}</option>`).join('');
        
        tr.innerHTML = `
            <td><input type="text" placeholder="如: 上肢日"></td>
            <td><select>${opts(SLOT_OPTS.types)}</select></td>
            <td><select onchange="app.updateSlotTargets(this)">${opts(SLOT_OPTS.dims)}</select></td>
            <td><select>${opts(SLOT_OPTS.targets['部位'])}</select></td>
            <td><button class="btn-danger" onclick="app.deleteSlotItem(this)">删除</button></td>
        `;
        tbody.appendChild(tr);
        if (tableId === 'tbl-basic') app.updateTemplateFreq();
    },
    addStage: () => {
        const list = document.querySelector('.sub-list');
        if (list.innerText.includes('暂无阶段配置')) list.innerHTML = '';
        const idx = list.children.length + 1;
        list.insertAdjacentHTML('beforeend', StageItem(idx, '', '适应期', '1周', '', '1.0', '1.0'));
    },
    updateStageName: (select) => {
        const row = select.closest('.sub-item');
        const type = select.value;
        const nameInput = row.querySelector('input[oninput*="updateStageHeader"]');
        const headerTitle = row.querySelector('.sub-header span');
        nameInput.placeholder = type;
        if (!nameInput.value.trim()) {
            const idx = headerTitle.innerText.split('.')[0];
            headerTitle.innerHTML = `${idx}. ${type} <span class="status-badge new">${type}</span>`;
        } else {
            const badge = headerTitle.querySelector('.status-badge');
            if(badge) badge.innerText = type;
        }
    },
    updateStageHeader: (input) => {
        const row = input.closest('.sub-item');
        const val = input.value;
        const typeSelect = row.querySelector('select[onchange*="updateStageName"]');
        const type = typeSelect.value;
        const headerTitle = row.querySelector('.sub-header span');
        const idx = headerTitle.innerText.split('.')[0];
        const display = val.trim() || type;
        headerTitle.innerHTML = `${idx}. ${display} <span class="status-badge new">${type}</span>`;
    },
    togglePowerModule: (select) => {
        const container = select.closest('.form-grid');
        const pmField = container.querySelector('.power-module-field');
        if (pmField) {
            pmField.style.display = select.value === '是' ? 'block' : 'none';
        }
    },
    toggleSub: (group, val) => {
        const subs = document.querySelectorAll(`.sub-${group}`);
        let show = false;
        if (group === 'construct') show = val === '复合动作';
        if (group === 'unilateral') show = val === '单侧';
        
        subs.forEach(el => {
            el.style.display = show ? 'flex' : 'none';
        });
    },
    initSubVisibility: () => {
        // 1. Generic Sub-toggles (Auto-detect all select toggleSub calls)
        const triggers = document.querySelectorAll('select[onchange*="app.toggleSub"]');
        triggers.forEach(el => {
            // Extract group name from onchange attribute: app.toggleSub('groupName', ...)
            const match = el.getAttribute('onchange').match(/toggleSub\(['"]([^'"]+)['"]/);
            if (match && match[1]) {
                app.toggleSub(match[1], el.value);
            }
        });
        
        // 2. Power Module (Special case)
        const pmSelect = document.querySelector('select[onchange*="togglePowerModule"]');
        if(pmSelect) app.togglePowerModule(pmSelect);
    },
    exportConfig: (type) => {
        const map = { '动作': 'actions', '课程': 'courses', '计划': 'plans' };
        const key = map[type];
        if (!key || !MOCK_DATA[key]) return alert('暂不支持该类型导出');
        
        const schema = SCHEMA[type];
        if (!schema) return alert('未定义导出模版');
        
        // Deep clone and process for Excel (stringify nested objects)
        const data = MOCK_DATA[key].map(item => {
            const row = {};
            // Map to Chinese headers based on SCHEMA
            Object.keys(schema).forEach(k => {
                let val = item[k];
                if (typeof val === 'object' && val !== null) {
                    val = JSON.stringify(val);
                }
                row[schema[k]] = val !== undefined ? val : '';
            });
            return row;
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, type);
        XLSX.writeFile(wb, `AEKE_${type}配置_${new Date().toISOString().slice(0,10)}.xlsx`);
    },
    importConfig: (type, input) => {
        if(!input.files || !input.files[0]) return;
        
        const map = { '动作': 'actions', '课程': 'courses', '计划': 'plans' };
        const key = map[type];
        if (!key) return alert('暂不支持该类型导入');
        
        const schema = SCHEMA[type];
        if (!schema) return alert('未定义导入模版');

        // Create reverse mapping: Label -> Key
        const reverseSchema = {};
        Object.keys(schema).forEach(k => reverseSchema[schema[k]] = k);

        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const firstSheet = wb.Sheets[wb.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (!jsonData || jsonData.length === 0) return alert('文件为空或格式错误');

                // Parse nested JSON strings
                const parsedData = jsonData.map(row => {
                    const newItem = {};
                    Object.keys(row).forEach(label => {
                        const k = reverseSchema[label];
                        if (k) {
                            let val = row[label];
                            if (typeof val === 'string' && (val.startsWith('[') || val.startsWith('{'))) {
                                try { val = JSON.parse(val); } catch (e) {}
                            }
                            newItem[k] = val;
                        }
                    });
                    return newItem;
                });

                // Merge Logic
                let updated = 0, added = 0;
                parsedData.forEach(newItem => {
                    if (!newItem.id) return;
                    const idx = MOCK_DATA[key].findIndex(old => old.id === newItem.id);
                    if (idx > -1) { MOCK_DATA[key][idx] = { ...MOCK_DATA[key][idx], ...newItem }; updated++; }
                    else { MOCK_DATA[key].push(newItem); added++; }
                });

                alert(`导入成功！\n更新: ${updated} 条\n新增: ${added} 条`);
                app.render();
            } catch (err) {
                console.error(err);
                alert('导入失败，请检查文件格式');
            }
            input.value = '';
        }
        reader.readAsArrayBuffer(file);
    },
    updateTemplateFreq: () => {
        const tbody = document.querySelector('#tbl-basic tbody');
        if (tbody) {
            const count = tbody.children.length;
            const input = document.getElementById('tpl-freq');
            if (input) input.value = count;
        }
    },
    toggleDropdown: (id) => {
        if (app.state.openDropdown && app.state.openDropdown !== id) {
             app.state.openDropdown = null;
        }
        app.state.openDropdown = app.state.openDropdown === id ? null : id;
        app.render();
    },
    closeDropdown: (id) => {
        // Handled by global click listener
    },
    mockFieldToggle: (label, val, checked, el) => {
        // Visual toggle for static demo fields (DOM manipulation)
        const checkbox = el.querySelector('input');
        const newState = !checkbox.checked;
        checkbox.checked = newState;
        
        // Update display value
        const ms = el.closest('.multi-select');
        const allChecked = Array.from(ms.querySelectorAll('.ms-option input:checked')).map(cb => cb.nextElementSibling.innerText);
        const valDiv = ms.querySelector('.ms-value');
        valDiv.innerText = allChecked.length ? allChecked.join(', ') : '请选择';
        valDiv.title = valDiv.innerText;
    },
    updateConfig: (key, idx, field, val) => {
        if(AI_CONFIG[key] && AI_CONFIG[key][idx]) {
            AI_CONFIG[key][idx][field] = val;
        }
    },
    updateConfigMultiselect: (key, idx, field, val, checked) => {
        let currentStr = AI_CONFIG[key][idx][field] || '';
        let separator = ',';
        if (currentStr.includes(' -> ')) separator = ' -> ';
        
        let current = currentStr ? (Array.isArray(currentStr) ? currentStr : currentStr.split(separator).map(s=>s.trim())) : [];
        
        if (checked) { if (!current.includes(val)) current.push(val); } 
        else { current = current.filter(v => v !== val); }
        
        if (key === 'phase' && field === 'structure') separator = ' -> ';
        AI_CONFIG[key][idx][field] = current.join(separator);
        app.render();
    },
    addConfigRow: (key) => {
        if(AI_CONFIG[key]) {
            const newRow = {...AI_CONFIG[key][0]}; // Clone structure
            Object.keys(newRow).forEach(k => newRow[k] = ''); // Clear values
            AI_CONFIG[key].push(newRow);
            app.render();
        }
    },
    deleteConfigRow: (key, idx) => {
        if(confirm('确定删除此配置项吗？')) {
            AI_CONFIG[key].splice(idx, 1);
            app.render();
        }
    },
    updateTemplateSlot: (tplIdx, slotIdx, field, val) => {
        const slot = AI_CONFIG.templates[tplIdx].slots[slotIdx];
        slot[field] = val;
        if (field === 'dim') {
            // Reset val if dim changes
            slot.val = (RULE_OPTS[val] || [])[0] || '';
        }
        app.render();
    },
    addTemplateSlot: (tplIdx) => {
        if (!AI_CONFIG.templates[tplIdx].slots) AI_CONFIG.templates[tplIdx].slots = [];
        AI_CONFIG.templates[tplIdx].slots.push({dim:'动作构造', val:'复合动作', w:0.5});
        app.render();
    },
    removeTemplateSlot: (tplIdx, slotIdx) => {
        AI_CONFIG.templates[tplIdx].slots.splice(slotIdx, 1);
        app.render();
    },
    updateTemplateLevel: (tplIdx, level, checked, el) => {
        let levels = AI_CONFIG.templates[tplIdx].levels || [];
        if (checked) {
            if (!levels.includes(level)) levels.push(level);
        } else {
            levels = levels.filter(l => l !== level);
        }
        // Sort levels for display consistency
        const order = ['L1','L2','L3','L4','L5'];
        levels.sort((a,b) => order.indexOf(a) - order.indexOf(b));
        AI_CONFIG.templates[tplIdx].levels = levels;
        app.render();
    },
    save: () => {
        if (app.state.view === 'list') {
            app.toDetail('NEW');
        } else {
            alert('保存成功');
            app.navigate(app.state.page);
        }
    },
    openActionPicker: (btn) => {
        app.state.pickingTarget = btn.parentElement.nextElementSibling; // .action-list
        document.getElementById('action-picker-modal').classList.add('active');
        app.state.pickerSelection = [];
        app.renderPickerList();
    },
    closeActionPicker: () => {
        document.getElementById('action-picker-modal').classList.remove('active');
        app.state.pickingTarget = null;
    },
    renderPickerList: () => {
        const search = document.getElementById('picker-search-input').value.toLowerCase();
        const part = document.getElementById('picker-filter-part').value;
        const diff = document.getElementById('picker-filter-diff').value;
        const mode = document.getElementById('picker-filter-mode').value;
        const func = document.getElementById('picker-filter-func').value;
        const cons = document.getElementById('picker-filter-cons').value;
        const imp = document.getElementById('picker-filter-imp').value;
        const pain = document.getElementById('picker-filter-pain').value;
        const equip = document.getElementById('picker-filter-equip').value;
        
        let list = ACTION_DB.filter(a => {
            if (part && a.part !== part) return false;
            if (diff && a.difficulty !== diff) return false;
            if (mode && a.mode !== mode) return false;
            if (func && (!a.func || !a.func.includes(func))) return false;
            if (cons && a.construct !== cons) return false;
            if (imp && a.impact !== imp) return false;
            if (pain && (!a.pain || !a.pain.includes(pain))) return false;
            if (equip && (!a.equip || !a.equip.includes(equip))) return false;
            if (search && !a.name.toLowerCase().includes(search) && !a.id.toLowerCase().includes(search)) return false;
            return true;
        });
        
        const tbody = document.getElementById('picker-table-body');
        tbody.innerHTML = list.map(a => `
            <tr onclick="app.pickAction('${a.id}', this)" class="${app.state.pickerSelection.includes(a.id) ? 'selected' : ''}">
                <td><input type="checkbox" ${app.state.pickerSelection.includes(a.id) ? 'checked' : ''} style="pointer-events:none;"></td>
                <td>${a.name}</td>
                <td>${a.part}</td>
                <td>${a.equip.join(',')}</td>
                <td>${a.difficulty}</td>
            </tr>
        `).join('');
        
        // Add checkbox column header if not exists
        const thead = document.querySelector('.picker-list thead tr');
        if(!thead.querySelector('.cb-col')) {
            const th = document.createElement('th');
            th.className = 'cb-col';
            th.style.width = '30px';
            thead.insertBefore(th, thead.firstChild);
        }
        
        document.getElementById('picker-count').innerText = app.state.pickerSelection.length;
    },
    pickAction: (id, tr) => {
        const idx = app.state.pickerSelection.indexOf(id);
        if (idx > -1) {
            app.state.pickerSelection.splice(idx, 1);
            tr.classList.remove('selected');
            tr.querySelector('input').checked = false;
        } else {
            app.state.pickerSelection.push(id);
            tr.classList.add('selected');
            tr.querySelector('input').checked = true;
        }
        document.getElementById('picker-count').innerText = app.state.pickerSelection.length;
    },
    confirmPickerSelection: () => {
        const target = app.state.pickingTarget;
        if (!target) return;
        
        // Check if video course to show/hide start/end points
        const isVideo = document.querySelector('select') && document.querySelector('select').value === '视频课程';
        const videoStyle = isVideo ? 'display:flex;' : 'display:none;';

        app.state.pickerSelection.forEach(id => {
            const action = ACTION_DB.find(a => a.id === id);
            if (!action) return;
            
            const defaultReps = action.measure === '计时' ? '30' : '12';
            
            const div = document.createElement('div');
            div.className = 'action-row';
            div.style.cssText = "display:flex; align-items:center; gap:15px; background:#1a1c20; padding:8px 12px; border-radius:4px; margin-bottom:4px; border:1px solid #333; font-size:12px;";
            div.innerHTML = `
                <span style="flex:1; font-weight:600; color:#ccc;">${action.name}</span>
                <div style="display:flex; align-items:center; gap:4px;"><input type="number" class="act-sets" value="3" onchange="app.recalcSegment(this)" style="width:50px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;"> <span style="color:#666;">组</span></div>
                <div style="display:flex; align-items:center; gap:6px;">
                    <select class="act-measure" onchange="app.updateActionUnit(this); app.recalcSegment(this)" style="width:70px; padding:4px; background:#111; border:1px solid #444; color:#fff; font-size:11px;">
                        <option value="计次" ${action.measure==='计次'?'selected':''}>计次</option>
                        <option value="计时" ${action.measure==='计时'?'selected':''}>计时</option>
                    </select>
                    <input type="number" class="act-reps" value="${defaultReps}" onchange="app.recalcSegment(this)" style="width:60px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;">
                    <span class="act-unit" style="color:#666; width:14px;">${action.measure==='计次'?'次':'s'}</span>
                </div>
                <div class="video-only" style="${videoStyle} align-items:center; gap:4px;">
                    <input type="number" placeholder="始(s)" style="width:60px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;"> - 
                    <input type="number" placeholder="终(s)" style="width:60px; text-align:center; padding:4px; background:#111; border:1px solid #444; color:#fff;">
                </div>
                <button class="btn-text" style="color:#666; margin-left:5px;" onclick="const s=this.closest('.sub-item'); this.parentElement.remove(); app.recalcSegment(s)">✕</button>
            `;
            target.appendChild(div);
        });
        
        if (app.state.pickerSelection.length > 0) {
            app.recalcSegment(app.state.pickingTarget.closest('.sub-item'));
            app.closeActionPicker();
        }
    },
    updateActionUnit: (select) => {
        const unitSpan = select.parentElement.querySelector('.act-unit');
        if(unitSpan) unitSpan.innerText = select.value === '计次' ? '次' : 's';
    },
    recalcSegment: (el) => {
        const segment = el.classList.contains('sub-item') ? el : el.closest('.sub-item');
        if(!segment) return;

        const restInput = segment.querySelector('.seg-rest');
        const rest = restInput ? (parseInt(restInput.value) || 0) : 60;
        
        let totalSeconds = 0;
        let totalSets = 0;
        const rows = segment.querySelectorAll('.action-row');
        
        rows.forEach(row => {
            const setsInput = row.querySelector('.act-sets');
            const repsInput = row.querySelector('.act-reps');
            const measureSelect = row.querySelector('.act-measure');
            
            const sets = setsInput ? (parseInt(setsInput.value) || 0) : 0;
            const val = repsInput ? (parseInt(repsInput.value) || 0) : 0;
            const measure = measureSelect ? measureSelect.value : '计次';
            
            totalSets += sets;

            let singleTime = 0;
            if (measure === '计时') {
                singleTime = val;
            } else {
                // Assume 3s per rep for '次'
                singleTime = val * 3;
            }
            
            if (sets > 0) {
                totalSeconds += sets * (singleTime + rest);
            }
        });
        
        const durationText = segment.querySelector('.seg-duration-text');
        if (durationText) durationText.innerText = Math.ceil(totalSeconds / 60);

        const countText = segment.querySelector('.seg-action-count');
        if (countText) countText.innerText = rows.length;

        const setsText = segment.querySelector('.seg-total-sets');
        if (setsText) setsText.innerText = totalSets;
    },
    toggleRestFields: (select) => {
        const container = select.closest('.form-grid');
        const restFields = container.querySelectorAll('.rest-field');
        const isRest = select.value === '是';
        restFields.forEach(el => el.style.display = isRest ? 'flex' : 'none');
    },
    toggleCourseTypeFields: (select) => {
        if (!select) return;
        const type = select.value;
        const isVideo = type === '视频课程';
        const isTemplate = type === '模板课程';
        
        document.querySelectorAll('.video-only').forEach(el => el.style.display = isVideo ? 'flex' : 'none');
        
        document.querySelectorAll('.template-auto').forEach(el => {
            const inputs = el.querySelectorAll('input, select');
            inputs.forEach(i => {
                i.disabled = isTemplate;
                i.style.opacity = isTemplate ? '0.5' : '1';
            });
        });
    },
    render: () => {
        const { page, view } = app.state;
        
        // Update Nav
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const activeNav = document.querySelector(`.nav-item[onclick*="'${page}'"]`);
        if(activeNav) activeNav.classList.add('active');
        
        // Update Header
        const titles = {
            'action': '动作管理',
            'course': '课程管理',
            'segment': '课程环节模板管理',
            'plan': '计划管理',
            'template': '阶段模板管理',
            'mapping': '数据映射管理',
            'ai': 'AI推荐管理'
        };
        const subTitle = view === 'list' ? '列表' : (app.state.id === 'NEW' ? '新建' : '编辑');
        document.getElementById('page-title').innerText = `${titles[page]} / ${subTitle}`;
        
        const btn = document.getElementById('header-btn');
        btn.innerText = view === 'list' ? '新建' : '保存';
        btn.style.display = (page === 'mapping' || page === 'ai') ? 'none' : 'block';
        
        // Render Content
        const renderer = RENDERERS[`${page}_${view}`] || RENDERERS[`${page}_list`];
        document.getElementById('app-view').innerHTML = renderer ? renderer() : '<div style="padding:20px;color:#666">模块开发中...</div>';
        
        if (page === 'course' && view === 'detail') {
             document.querySelectorAll('.sub-item').forEach(el => app.recalcSegment(el));
             // Init rest fields visibility
             document.querySelectorAll('select[onchange*="toggleRestFields"]').forEach(el => app.toggleRestFields(el));
        }
    },
    
    // Segment Template Helpers
    updateSegmentField: (idx, field, val) => {
        if (AI_CONFIG.templates[idx]) {
            AI_CONFIG.templates[idx][field] = val;
        }
    },
    updateSegmentDim: (idx, val) => {
        if (AI_CONFIG.templates[idx]) {
            AI_CONFIG.templates[idx].dim = val;
            AI_CONFIG.templates[idx].target = (SLOT_OPTS.targets[val] || [])[0] || '';
            app.render();
        }
    },
    updateSegmentLevel: (idx, level, checked) => {
        let levels = AI_CONFIG.templates[idx].levels || [];
        if (checked) {
            if (!levels.includes(level)) levels.push(level);
        } else {
            levels = levels.filter(l => l !== level);
        }
        const order = ['L1','L2','L3','L4','L5'];
        levels.sort((a,b) => order.indexOf(a) - order.indexOf(b));
        AI_CONFIG.templates[idx].levels = levels;
        app.render();
    },
    updateSegmentSlot: (tplIdx, slotIdx, field, val) => {
        const slot = AI_CONFIG.templates[tplIdx].slots[slotIdx];
        slot[field] = val;
        if (field === 'focusDim') {
            slot.focusTarget = (RULE_OPTS[val] || [])[0] || '';
        }
        app.render();
    },
    addSegmentSlot: (tplIdx) => {
        if (!AI_CONFIG.templates[tplIdx].slots) AI_CONFIG.templates[tplIdx].slots = [];
        AI_CONFIG.templates[tplIdx].slots.push({focusDim:'动作构造', focusTarget:'复合动作', w:0.5});
        app.render();
    },
    removeSegmentSlot: (tplIdx, slotIdx) => {
        AI_CONFIG.templates[tplIdx].slots.splice(slotIdx, 1);
        app.render();
    },
    // Sort Rule Helpers
    updateSortRule: (tplIdx, sIdx, field, val) => {
        const rule = AI_CONFIG.templates[tplIdx].sort[sIdx];
        rule[field] = val;
        app.render();
    },
    addSortRule: (tplIdx) => {
        if (!Array.isArray(AI_CONFIG.templates[tplIdx].sort)) AI_CONFIG.templates[tplIdx].sort = [];
        AI_CONFIG.templates[tplIdx].sort.push({dim:'动作难度', order:'降序', seq:''});
        app.render();
    },
    removeSortRule: (tplIdx, sIdx) => {
        AI_CONFIG.templates[tplIdx].sort.splice(sIdx, 1);
        app.render();
    },
    appendToSortSeq: (tplIdx, sIdx, val) => {
        const rule = AI_CONFIG.templates[tplIdx].sort[sIdx];
        let current = rule.seq || '';
        if (current) {
            const arr = current.split(',').map(s=>s.trim());
            if (!arr.includes(val)) current += ',' + val;
        } else {
            current = val;
        }
        rule.seq = current;
        app.render();
    },
    clearSortSeq: (tplIdx, sIdx) => {
        AI_CONFIG.templates[tplIdx].sort[sIdx].seq = '';
        app.render();
    },
    deleteSegment: (idx) => {
        if(confirm('确定删除此模板吗？')) {
            AI_CONFIG.templates.splice(idx, 1);
            app.render();
        }
    },
    save: () => {
        if (app.state.page === 'segment' && app.state.view === 'list') {
            // Create new segment template
            const newTpl = { id: `TPL_SEG_${Date.now()}`, name: 'New Template', dim: '部位', target: '全身', type: '主训', levels: [], gender: 'All', slots: [], sort: [{dim:'动作构造', order:'自定义', seq:'复合动作,孤立动作'}] };
            AI_CONFIG.templates.push(newTpl);
            app.toDetail(AI_CONFIG.templates.length - 1);
            return;
        }

        if (app.state.view === 'list') {
            app.toDetail('NEW');
        } else {
            alert('保存成功');
            app.navigate(app.state.page);
        }
    }
};

// Global click listener for dropdowns
document.addEventListener('click', (e) => {
    if (app.state.openDropdown) {
        app.state.openDropdown = null;
        app.render();
    }
});

// Init
fetch('AI推荐_智能版 [Demo]/js/data/动作库.json')
    .then(res => res.json())
    .then(data => {
        MOCK_DATA.actions = data;
        // Also update global ACTION_DB for picker if needed, though picker uses ACTION_DB variable
        window.ACTION_DB = data; 
        app.render();
    })
    .catch(err => console.error('Failed to load actions:', err));

app.navigate('action');
document.querySelector('.nav-item').classList.add('active');

</script>
</body>
</html>