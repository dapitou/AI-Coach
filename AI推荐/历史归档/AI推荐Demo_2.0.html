<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEKE Coach - AI Sports Generator</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-card: #2c2c2c;
            --primary: #00e5ff; /* ç§‘æŠ€è“ */
            --primary-hover: #00b8cc;
            --accent: #ff4081;
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            --border: #333;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 80px;
            background: var(--bg-panel);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            border-right: 1px solid var(--border);
            z-index: 100;
            transition: width 0.3s;
        }
        .sidebar:hover { width: 200px; }
        .logo { font-weight: 900; font-size: 24px; color: var(--primary); margin-bottom: 40px; letter-spacing: 2px; text-align: center; }
        .nav-item {
            width: 100%;
            padding: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center; /* Initial center for icon */
            cursor: pointer;
            color: var(--text-sub);
            transition: 0.2s;
            position: relative;
        }
        .sidebar:hover .nav-item { justify-content: flex-start; padding-left: 30px; }
        .nav-item:hover, .nav-item.active { color: var(--primary); background: rgba(0,229,255,0.05); }
        .nav-item.active::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary);
        }
        .nav-icon { font-size: 20px; min-width: 40px; text-align: center; }
        .nav-text { display: none; white-space: nowrap; font-size: 14px; font-weight: 500; }
        .sidebar:hover .nav-text { display: block; }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            position: relative;
            overflow-y: auto;
            padding: 30px;
        }

        /* --- Sections --- */
        .section { display: none; animation: fadeIn 0.4s ease; max-width: 1400px; margin: 0 auto; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { margin: 0 0 20px 0; font-weight: 300; letter-spacing: 1px; }
        h1 { color: var(--primary); font-size: 32px; border-left: 5px solid var(--primary); padding-left: 15px; }
        h2 { font-size: 20px; color: var(--text-main); margin-top: 30px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        /* --- Components --- */
        .card { background: var(--bg-panel); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        
        .btn {
            background: var(--primary); color: #000; border: none; padding: 12px 30px; border-radius: 30px;
            font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,229,255,0.3); }
        .btn.secondary { background: transparent; border: 1px solid var(--text-sub); color: var(--text-sub); }
        .btn.secondary:hover { border-color: var(--text-main); color: var(--text-main); transform: none; box-shadow: none; }
        .btn-group { display: flex; gap: 15px; margin-top: 20px; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: var(--text-sub); margin-bottom: 8px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Selectors & Inputs */
        .pill-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .pill {
            background: var(--bg-card); border: 1px solid var(--border); color: var(--text-sub); padding: 8px 16px;
            border-radius: 20px; cursor: pointer; transition: 0.2s; font-size: 13px; user-select: none;
        }
        .pill:hover { border-color: var(--primary); }
        .pill.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: 600; }
        
        input[type="number"], select, input[type="text"] {
            background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main);
            padding: 10px 15px; border-radius: 8px; width: 100%; font-size: 14px;
        }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: var(--bg-card); border-radius: 3px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; cursor: pointer; }

        /* --- Dashboard Specific --- */
        .dash-layout { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        @media(max-width: 1024px) { .dash-layout { grid-template-columns: 1fr; } }
        
        .duration-display { font-size: 48px; font-weight: 200; color: var(--primary); text-align: center; margin: 20px 0; }
        .duration-unit { font-size: 14px; color: var(--text-sub); }

        /* --- Workout Details --- */
        .workout-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--bg-card); padding: 15px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: bold; color: var(--text-main); }
        .stat-label { font-size: 11px; color: var(--text-sub); margin-top: 5px; }

        .phase-header { 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 8px; margin: 20px 0 10px 0; 
        }
        .phase-title { font-weight: 700; color: var(--primary); }
        
        .action-list { display: flex; flex-direction: column; gap: 10px; }
        .action-item {
            background: var(--bg-card); padding: 15px; border-radius: 8px; display: grid;
            grid-template-columns: 1fr auto auto auto; gap: 20px; align-items: center;
            transition: transform 0.2s; position: relative; border-left: 3px solid transparent;
        }
        .action-item:hover { transform: translateX(5px); border-left-color: var(--primary); background: #333; }
        
        /* Floating Tooltip */
        .tooltip {
            position: absolute; display: none; background: rgba(0,0,0,0.95); border: 1px solid var(--border);
            padding: 15px; border-radius: 8px; z-index: 1000; width: 280px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            pointer-events: none; backdrop-filter: blur(5px);
        }
        .tooltip h4 { color: var(--primary); margin: 0 0 5px 0; font-size: 15px; }
        .tooltip p { margin: 3px 0; font-size: 12px; color: #ccc; }
        .tooltip .tag { display: inline-block; background: #333; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; color: #fff; }

        /* --- Library Table --- */
        .lib-filters { display: flex; gap: 10px; margin-bottom: 20px; }
        .lib-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .lib-item { background: var(--bg-card); padding: 15px; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .lib-item:hover { background: #333; color: var(--primary); }
        
        /* --- Plan Week View --- */
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 20px; }
        .day-col { background: var(--bg-card); border-radius: 8px; min-height: 200px; padding: 10px; }
        .day-header { text-align: center; color: var(--text-sub); margin-bottom: 10px; font-size: 12px; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .plan-card { background: var(--bg-panel); padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 11px; border-left: 2px solid var(--primary); cursor: pointer; }
        .plan-card:hover { background: #333; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">AEKE</div>
        <div class="nav-item active" onclick="app.nav('dashboard')">
            <div class="nav-icon">âš¡</div><div class="nav-text">æ™ºèƒ½ç”Ÿæˆ</div>
        </div>
        <div class="nav-item" onclick="app.nav('profile')">
            <div class="nav-icon">ğŸ‘¤</div><div class="nav-text">è¿åŠ¨æ¡£æ¡ˆ</div>
        </div>
        <div class="nav-item" onclick="app.nav('library')">
            <div class="nav-icon">ğŸ“š</div><div class="nav-text">åŠ¨ä½œåº“</div>
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="section active">
            <h1>AI æ™ºèƒ½ç”Ÿæˆ</h1>
            <div class="dash-layout">
                <div class="control-panel">
                    <div class="card">
                        <div class="form-group">
                            <span class="form-label">ç›®æ ‡éƒ¨ä½ (æœ€å¤š3é¡¹)</span>
                            <div class="pill-group" id="targetPartsContainer">
                                </div>
                        </div>

                        <div class="form-group">
                            <span class="form-label">è¿åŠ¨æ—¶é•¿</span>
                            <div class="duration-display"><span id="durationVal">20</span> <span class="duration-unit">MIN</span></div>
                            <input type="range" id="durationSlider" min="20" max="60" step="1" value="20">
                        </div>

                        <div class="btn-group" style="flex-direction: column;">
                            <button class="btn" style="width: 100%; justify-content: center;" onclick="app.generateWorkout()">
                                <span>âš¡ ç”Ÿæˆå•èŠ‚è¯¾ç¨‹</span>
                            </button>
                            <button class="btn secondary" style="width: 100%; justify-content: center;" onclick="app.generatePlan()">
                                <span>ğŸ“… ç”Ÿæˆå‘¨è®¡åˆ’</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="result-panel">
                    <div id="emptyState" style="text-align: center; color: var(--text-sub); margin-top: 100px;">
                        <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.2;">ğŸ‹ï¸</div>
                        <p>é…ç½®å·¦ä¾§éœ€æ±‚ï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®<br>AIå°†ä¸ºä½ æ„å»ºä¸“å±è®­ç»ƒæ–¹æ¡ˆ</p>
                    </div>

                    <div id="workoutResult" style="display: none;">
                        <div class="workout-stats" id="workoutStats">
                            </div>
                        <div id="workoutFlow">
                            </div>
                    </div>

                    <div id="planResult" style="display: none;">
                         <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>æœ¬å‘¨è®¡åˆ’æ¦‚è§ˆ</h3>
                                <div class="btn-group" style="margin: 0;">
                                    <button class="btn secondary" style="padding: 5px 15px; font-size: 12px;">ä¸Šä¸€å‘¨</button>
                                    <button class="btn secondary" style="padding: 5px 15px; font-size: 12px;">ä¸‹ä¸€å‘¨</button>
                                </div>
                            </div>
                            <div id="weekStats" style="margin-top: 10px; font-size: 13px; color: var(--text-sub);">
                                </div>
                         </div>
                         <div class="week-grid" id="weekGrid">
                             </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="profile" class="section">
            <h1>è¿åŠ¨æ¡£æ¡ˆ</h1>
            <div class="card" style="max-width: 800px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <span class="form-label">æ€§åˆ«</span>
                        <select id="p_gender"><option value="Male">ç”·</option><option value="Female">å¥³</option></select>
                    </div>
                    <div class="form-group">
                        <span class="form-label">è¿åŠ¨ç›®æ ‡</span>
                        <select id="p_goal"><option value="Hypertrophy">å¢è‚Œ</option><option value="WeightLoss">å‡é‡</option><option value="Health">å¥åº·</option></select>
                    </div>
                    <div class="form-group">
                        <span class="form-label">èº«é«˜ (cm)</span>
                        <input type="number" id="p_height" value="180">
                    </div>
                    <div class="form-group">
                        <span class="form-label">ä½“é‡ (kg)</span>
                        <input type="number" id="p_weight" value="90">
                    </div>
                    <div class="form-group">
                        <span class="form-label">è¿åŠ¨ç­‰çº§</span>
                        <select id="p_level"><option value="Beginner">åˆçº§</option><option value="Intermediate">ä¸­çº§</option><option value="Advanced">é«˜çº§</option></select>
                    </div>
                    <div class="form-group">
                        <span class="form-label">è®­ç»ƒé£æ ¼</span>
                        <select id="p_style"><option value="Traditional">ä¼ ç»Ÿå‹</option><option value="Varied">å¤šå˜å‹</option><option value="Radical">æ¿€è¿›å‹</option></select>
                    </div>
                </div>

                <div class="form-group">
                    <span class="form-label">ç–¼ç—›/å—ä¼¤éƒ¨ä½ (å¤šé€‰)</span>
                    <div class="pill-group" id="p_pain">
                        </div>
                </div>

                <div class="form-group">
                    <span class="form-label">ç¼ºå¤±çš„å™¨æ¢° (å¤šé€‰ï¼Œé»˜è®¤å…¨éƒ½æœ‰)</span>
                    <div class="pill-group" id="p_equipment">
                        </div>
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="app.saveProfile()">ä¿å­˜æ¡£æ¡ˆ</button>
                    <button class="btn secondary" onclick="app.loadProfile()">é‡ç½®</button>
                </div>
            </div>
        </div>

        <div id="library" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>åŠ¨ä½œåº“</h1>
                <div class="btn-group" style="margin:0">
                    <button class="btn secondary" onclick="app.downloadTemplate()">ä¸‹è½½æ¨¡æ¿</button>
                    <button class="btn secondary" onclick="document.getElementById('fileInput').click()">å¯¼å…¥JSON</button>
                    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="app.importLibrary(this)">
                </div>
            </div>
            
            <div class="lib-filters">
                <div class="pill active" onclick="app.filterLibrary('Main')">ä¸»è®­</div>
                <div class="pill" onclick="app.filterLibrary('Warmup')">çƒ­èº«</div>
                <div class="pill" onclick="app.filterLibrary('Cooldown')">æ”¾æ¾</div>
                <div class="pill" onclick="app.filterLibrary('All')">å…¨éƒ¨</div>
            </div>

            <div class="lib-grid" id="libGrid">
                </div>
        </div>

    </div>

    <div id="tooltip" class="tooltip"></div>

<script>
/**
 * AEKE COACH - Core Logic
 * Author: Top Sports Science & AI Expert
 */

// --- Constants & Data Definitions ---

const BODY_PARTS = ['å…¨èº«', 'èƒ¸éƒ¨', 'èƒŒéƒ¨', 'è‚©éƒ¨', 'æ‰‹è‡‚', 'è‡€éƒ¨', 'è…¿éƒ¨', 'æ ¸å¿ƒ'];
const PAIN_POINTS = ['æ— ', 'æ‰‹è…•', 'è‚˜éƒ¨', 'è‚©éƒ¨', 'è…°éƒ¨', 'é«‹éƒ¨', 'è†ç›–', 'è„šè¸'];
const EQUIPMENT_LIST = ['å¥èº«å‡³', 'ç‘œä¼½ç –', 'æ³¡æ²«è½´', 'æ‰‹æŸ„', 'æ¨ªæ†', 'è¸å¸¦', 'ç‘œä¼½å«']; // Assuming generic gym has weights
const MUSCLE_DETAILS = {
    'è‚©éƒ¨': ['ä¸‰è§’è‚Œä¸­æŸ', 'ä¸‰è§’è‚Œå‰æŸ', 'ä¸‰è§’è‚ŒåæŸ', 'è‚©è¢–'],
    'æ‰‹è‡‚': ['è‚±äºŒå¤´è‚Œ', 'è‚±ä¸‰å¤´è‚Œ'],
    'èƒ¸éƒ¨': ['èƒ¸å¤§è‚Œä¸­æŸ', 'èƒ¸å¤§è‚Œä¸ŠæŸ', 'èƒ¸å¤§è‚Œä¸‹æŸ', 'èƒ¸å¤§è‚Œå†…ä¾§'],
    'èƒŒéƒ¨': ['ä¸­èƒŒ', 'ä¸ŠèƒŒ', 'ä¸‹èƒŒ'],
    'æ ¸å¿ƒ': ['è…¹ç›´è‚Œ', 'è…¹æ–œè‚Œ'],
    'è‡€éƒ¨': ['è‡€å¤§è‚Œ', 'è‡€ä¸­è‚Œ'],
    'è…¿éƒ¨': ['è‚¡å››å¤´è‚Œ', 'èƒ­ç»³è‚Œ', 'å†…æ”¶è‚Œ', 'è…“è‚ è‚Œ'],
    'å…¨èº«': ['å…¨èº«ç»¼åˆ']
};

const DIFFICULTY_RATIOS = {
    'Beginner': { low: 0.6, mid: 0.3, high: 0.1 },
    'Intermediate': { low: 0.2, mid: 0.6, high: 0.2 },
    'Advanced': { low: 0.1, mid: 0.3, high: 0.6 }
};

const GOAL_PARAMS = {
    'Hypertrophy': { reps: '8-12', rest: '60-90s', intensity: 'RPE 8' },
    'WeightLoss': { reps: '15-20', rest: '30-45s', intensity: 'RPE 7' },
    'Health': { reps: '12-15', rest: '60s', intensity: 'RPE 6' }
};

// Default User Profile
const defaultProfile = {
    gender: 'Male', height: 180, weight: 90, goal: 'Hypertrophy', level: 'Beginner', 
    style: 'Traditional', pain: ['æ— '], missingEquipment: []
};

// --- State Management ---
const store = {
    user: JSON.parse(localStorage.getItem('aeke_user')) || defaultProfile,
    library: [],
    currentWorkout: null,
    currentPlan: null,
    ui: {
        selectedTargets: ['èƒ¸éƒ¨'],
        duration: 20
    }
};

// --- Procedural Generation of "300 Actions" (To save token space but ensure robust data) ---
function initLibrary() {
    const savedLib = localStorage.getItem('aeke_lib');
    if (savedLib) {
        store.library = JSON.parse(savedLib);
        return;
    }

    const baseActions = [
        // Chest
        { n: 'æ é“ƒå§æ¨', p: 'èƒ¸éƒ¨', m: 'èƒ¸å¤§è‚Œä¸­æŸ', e: ['å¥èº«å‡³', 'æ¨ªæ†'], t: 'Main' },
        { n: 'ä¸Šæ–œå“‘é“ƒæ¨ä¸¾', p: 'èƒ¸éƒ¨', m: 'èƒ¸å¤§è‚Œä¸ŠæŸ', e: ['å¥èº«å‡³', 'æ‰‹æŸ„'], t: 'Main' },
        { n: 'ä¸‹æ–œç»³ç´¢å¤¹èƒ¸', p: 'èƒ¸éƒ¨', m: 'èƒ¸å¤§è‚Œä¸‹æŸ', e: ['æ‰‹æŸ„'], t: 'Main' },
        { n: 'è´è¶æœºå¤¹èƒ¸', p: 'èƒ¸éƒ¨', m: 'èƒ¸å¤§è‚Œå†…ä¾§', e: [], t: 'Main' },
        { n: 'ä¿¯å§æ’‘', p: 'èƒ¸éƒ¨', m: 'èƒ¸å¤§è‚Œä¸­æŸ', e: ['ç‘œä¼½å«'], t: 'Main' },
        // Back
        { n: 'é«˜ä½ä¸‹æ‹‰', p: 'èƒŒéƒ¨', m: 'ä¸ŠèƒŒ', e: ['æ¨ªæ†'], t: 'Main' },
        { n: 'åå§¿åˆ’èˆ¹', p: 'èƒŒéƒ¨', m: 'ä¸­èƒŒ', e: ['æ‰‹æŸ„'], t: 'Main' },
        { n: 'å±±ç¾ŠæŒºèº«', p: 'èƒŒéƒ¨', m: 'ä¸‹èƒŒ', e: ['å¥èº«å‡³'], t: 'Main' },
        // Legs
        { n: 'æ·±è¹²', p: 'è…¿éƒ¨', m: 'è‚¡å››å¤´è‚Œ', e: ['æ¨ªæ†'], t: 'Main' },
        { n: 'è…¿ä¸¾', p: 'è…¿éƒ¨', m: 'è‚¡å››å¤´è‚Œ', e: [], t: 'Main' },
        { n: 'ç½—é©¬å°¼äºšç¡¬æ‹‰', p: 'è…¿éƒ¨', m: 'èƒ­ç»³è‚Œ', e: ['æ¨ªæ†'], t: 'Main' },
        { n: 'åå§¿æè¸µ', p: 'è…¿éƒ¨', m: 'è…“è‚ è‚Œ', e: [], t: 'Main' },
        // Shoulders
        { n: 'å“‘é“ƒæ¨ä¸¾', p: 'è‚©éƒ¨', m: 'ä¸‰è§’è‚Œä¸­æŸ', e: ['æ‰‹æŸ„'], t: 'Main' },
        { n: 'å“‘é“ƒå‰å¹³ä¸¾', p: 'è‚©éƒ¨', m: 'ä¸‰è§’è‚Œå‰æŸ', e: ['æ‰‹æŸ„'], t: 'Main' },
        { n: 'é¢æ‹‰', p: 'è‚©éƒ¨', m: 'ä¸‰è§’è‚ŒåæŸ', e: ['æ‰‹æŸ„'], t: 'Main' },
        { n: 'æ‹›è´¢çŒ«', p: 'è‚©éƒ¨', m: 'è‚©è¢–', e: ['æ‰‹æŸ„'], t: 'Warmup' },
        // Warmup generic
        { n: 'å¼€åˆè·³', p: 'å…¨èº«', m: 'å…¨èº«ç»¼åˆ', e: [], t: 'Warmup' },
        { n: 'è‚©å…³èŠ‚ç¯ç»•', p: 'è‚©éƒ¨', m: 'è‚©è¢–', e: [], t: 'Warmup' },
        { n: 'åŠ¨æ€æ‹‰ä¼¸', p: 'å…¨èº«', m: 'å…¨èº«ç»¼åˆ', e: [], t: 'Warmup' },
        // Cool down
        { n: 'èƒ¸å¤§è‚Œæ‹‰ä¼¸', p: 'èƒ¸éƒ¨', m: 'èƒ¸å¤§è‚Œä¸­æŸ', e: [], t: 'Cooldown' },
        { n: 'èƒŒéƒ¨æ‹‰ä¼¸', p: 'èƒŒéƒ¨', m: 'ä¸ŠèƒŒ', e: [], t: 'Cooldown' },
        { n: 'å©´å„¿å¼', p: 'å…¨èº«', m: 'å…¨èº«ç»¼åˆ', e: ['ç‘œä¼½å«'], t: 'Cooldown' },
        { n: 'æ³¡æ²«è½´æ»šèƒŒ', p: 'èƒŒéƒ¨', m: 'ä¸­èƒŒ', e: ['æ³¡æ²«è½´'], t: 'Cooldown' }
    ];

    const difficulties = ['åˆçº§', 'ä¸­çº§', 'é«˜çº§'];
    const generatedLib = [];

    // Generator logic to expand base actions into variations to hit ~300
    let idCounter = 1000;
    
    // Fill Main (50%)
    for (let i = 0; i < 150; i++) {
        const base = baseActions[Math.floor(Math.random() * baseActions.length)];
        // Force type to Main for this loop if base is capable, otherwise pick random pure main
        let item = JSON.parse(JSON.stringify(base));
        item.t = 'Main';
        item.id = idCounter++;
        item.difficulty = difficulties[Math.floor(Math.random() * 3)];
        item.name = item.n + ([' (æ ‡å‡†)', ' (å˜å¼)', ' (ç¦»å¿ƒ)', ' (çˆ†å‘)'][Math.floor(Math.random()*4)]);
        item.pain = []; // Randomly assign pain exclusions
        if (Math.random() > 0.8) item.pain.push(PAIN_POINTS[Math.floor(Math.random() * PAIN_POINTS.length)]);
        generatedLib.push(item);
    }

    // Fill Warmup (25%)
    for (let i = 0; i < 75; i++) {
        const base = baseActions.filter(x => x.t === 'Warmup')[Math.floor(Math.random() * 3)]; // Pick from warmup bases
        if(!base) continue;
        let item = JSON.parse(JSON.stringify(base));
        item.id = idCounter++;
        item.difficulty = 'åˆçº§';
        item.name = item.n + ' ' + (i+1);
        item.pain = [];
        generatedLib.push(item);
    }

    // Fill Cooldown (25%)
    for (let i = 0; i < 75; i++) {
        const base = baseActions.filter(x => x.t === 'Cooldown')[Math.floor(Math.random() * 3)]; // Pick from cooldown bases
        if(!base) continue;
        let item = JSON.parse(JSON.stringify(base));
        item.id = idCounter++;
        item.difficulty = 'åˆçº§';
        item.name = item.n + ' ' + (i+1);
        item.pain = [];
        generatedLib.push(item);
    }

    store.library = generatedLib;
    localStorage.setItem('aeke_lib', JSON.stringify(generatedLib));
}

// --- APP LOGIC (Controller) ---

const app = {
    init: function() {
        initLibrary();
        this.renderSidebar();
        this.renderDashboard();
        this.renderProfile();
        this.renderLibrary();
        
        // Tooltip logic
        document.addEventListener('mouseover', (e) => {
            const target = e.target.closest('[data-hover-info]');
            if (target) {
                const info = JSON.parse(target.dataset.hoverInfo);
                this.showTooltip(e, info);
            } else {
                document.getElementById('tooltip').style.display = 'none';
            }
        });
        document.addEventListener('mousemove', (e) => {
             const tip = document.getElementById('tooltip');
             if (tip.style.display === 'block') {
                 tip.style.left = e.pageX + 15 + 'px';
                 tip.style.top = e.pageY + 15 + 'px';
             }
        });
    },

    nav: function(pageId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        // Simple highlighting logic for sidebar
        const navs = ['dashboard', 'profile', 'library'];
        document.querySelectorAll('.nav-item')[navs.indexOf(pageId)].classList.add('active');
    },

    // --- DASHBOARD FUNCTIONS ---

    renderDashboard: function() {
        // Target Parts
        const container = document.getElementById('targetPartsContainer');
        container.innerHTML = '';
        BODY_PARTS.forEach(part => {
            const pill = document.createElement('div');
            pill.className = `pill ${store.ui.selectedTargets.includes(part) ? 'active' : ''}`;
            pill.innerText = part;
            pill.onclick = () => {
                const idx = store.ui.selectedTargets.indexOf(part);
                if (idx > -1) {
                    store.ui.selectedTargets.splice(idx, 1);
                } else {
                    if (store.ui.selectedTargets.length < 3) store.ui.selectedTargets.push(part);
                }
                this.renderDashboard(); // Re-render to update state
            };
            container.appendChild(pill);
        });

        // Duration Slider
        const slider = document.getElementById('durationSlider');
        const valDisplay = document.getElementById('durationVal');
        slider.oninput = (e) => {
            store.ui.duration = parseInt(e.target.value);
            valDisplay.innerText = store.ui.duration;
        };
    },

    // --- ALGORITHM: WORKOUT GENERATOR ---
    generateWorkout: function(isPlanContext = false, overrideTarget = null, overrideDuration = null) {
        const user = store.user;
        const targets = overrideTarget ? [overrideTarget] : store.ui.selectedTargets;
        const duration = overrideDuration || store.ui.duration;
        
        if (targets.length === 0) { alert("è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç›®æ ‡éƒ¨ä½"); return; }

        // 1. Calculate Time Allocations
        const warmupCount = Math.ceil(duration / 10);
        const cooldownCount = Math.ceil(duration / 10);
        const warmupTime = warmupCount * 0.5; // 30s per action
        const cooldownTime = cooldownCount * 0.5;
        const mainTime = duration - warmupTime - cooldownTime;

        if (mainTime < 5) { alert("è¿åŠ¨æ—¶é—´å¤ªçŸ­ï¼Œæ— æ³•å®‰æ’ä¸»è®­"); return; }

        // 2. Filter Library (Safety & Equipment)
        const safeLib = store.library.filter(ex => {
            // Exclude if hits pain point
            const hurts = ex.pain && ex.pain.some(p => user.pain.includes(p));
            // Exclude if missing equipment
            const needsEquip = ex.e && ex.e.some(eq => user.missingEquipment.includes(eq));
            return !hurts && !needsEquip;
        });

        // 3. Select Phase Actions
        // Warmup
        const potentialWarmups = safeLib.filter(ex => ex.t === 'Warmup' && (ex.p === 'å…¨èº«' || targets.includes(ex.p)));
        const selectedWarmups = this.sample(potentialWarmups, warmupCount);

        // Cooldown
        const potentialCooldowns = safeLib.filter(ex => ex.t === 'Cooldown' && (ex.p === 'å…¨èº«' || targets.includes(ex.p)));
        const selectedCooldowns = this.sample(potentialCooldowns, cooldownCount);

        // Main Training (The AI Core)
        const difficultyDist = DIFFICULTY_RATIOS[user.level];
        // Calculate target distribution counts (approximate)
        // We estimate 2.5 mins per set (incl rest) -> Sets = mainTime / 2.5. 
        // Let's simplified: 1 Action = 2-3 sets. Approx 4 mins per Action.
        const mainActionCount = Math.max(2, Math.floor(mainTime / 3.5)); // 3.5 min per action avg

        const potentialMains = safeLib.filter(ex => ex.t === 'Main' && targets.includes(ex.p));
        
        // Apply Difficulty Weights & Muscle Balance
        let selectedMains = [];
        // Helper to pick based on difficulty
        const pickByDiff = (arr, diff) => arr.filter(x => x.difficulty === diff);
        
        // Simple Stratified Sampling
        const cBeginner = Math.round(mainActionCount * difficultyDist.low);
        const cInter = Math.round(mainActionCount * difficultyDist.mid);
        const cAdv = mainActionCount - cBeginner - cInter;

        const poolLow = pickByDiff(potentialMains, 'åˆçº§');
        const poolMid = pickByDiff(potentialMains, 'ä¸­çº§');
        const poolHigh = pickByDiff(potentialMains, 'é«˜çº§');

        selectedMains = [
            ...this.sample(poolLow, cBeginner),
            ...this.sample(poolMid, cInter),
            ...this.sample(poolHigh, cAdv)
        ];

        // Fallback if pools are empty
        if (selectedMains.length < mainActionCount) {
            const remainder = mainActionCount - selectedMains.length;
            selectedMains = [...selectedMains, ...this.sample(potentialMains, remainder)];
        }

        // 4. Construct Object
        const workout = {
            id: Date.now(),
            totalDuration: duration,
            calories: Math.round(duration * (user.gender === 'Male' ? 8 : 6.5)),
            volume: selectedMains.length * 3 * 200, // Dummy calc
            phases: {
                warmup: selectedWarmups.map(x => ({ ...x, sets: 1, reps: '30s', weight: 'è‡ªé‡' })),
                main: selectedMains.map(x => ({ 
                    ...x, 
                    sets: 3, 
                    reps: GOAL_PARAMS[user.goal].reps, 
                    rest: GOAL_PARAMS[user.goal].rest,
                    weight: 'é€‚ä¸­' // Would need 1RM logic in full app
                })),
                cooldown: selectedCooldowns.map(x => ({ ...x, sets: 1, reps: '30s', weight: 'è‡ªé‡' }))
            }
        };

        if (isPlanContext) return workout;

        store.currentWorkout = workout;
        this.renderWorkoutResult();
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('workoutResult').style.display = 'block';
        document.getElementById('planResult').style.display = 'none';
    },

    // Helper: Random Sampling without replacement
    sample: function(arr, n) {
        if (!arr || arr.length === 0) return [];
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, n);
    },

    renderWorkoutResult: function() {
        const w = store.currentWorkout;
        const stats = document.getElementById('workoutStats');
        stats.innerHTML = `
            <div class="stat-box"><div class="stat-val">${w.phases.main.length + w.phases.warmup.length + w.phases.cooldown.length}</div><div class="stat-label">åŠ¨ä½œæ€»æ•°</div></div>
            <div class="stat-box"><div class="stat-val">${w.totalDuration}m</div><div class="stat-label">é¢„ä¼°æ—¶é•¿</div></div>
            <div class="stat-box"><div class="stat-val">${w.volume}</div><div class="stat-label">é¢„ä¼°å®¹é‡ (kg)</div></div>
            <div class="stat-box"><div class="stat-val">${w.calories}</div><div class="stat-label">ç‡ƒå¡ (kcal)</div></div>
        `;

        const flow = document.getElementById('workoutFlow');
        flow.innerHTML = '';

        const renderPhase = (title, list, color) => {
            if(list.length === 0) return;
            let html = `<div class="phase-header"><span class="phase-title" style="color:${color}">${title}</span><span>${list.length} åŠ¨ä½œ</span></div>`;
            html += `<div class="action-list">`;
            list.forEach(item => {
                const info = JSON.stringify(item).replace(/"/g, '&quot;');
                html += `
                <div class="action-item" data-hover-info="${info}">
                    <div style="font-weight:500">${item.name}</div>
                    <div style="color:var(--text-sub); font-size:12px">${item.sets}ç»„ x ${item.reps}</div>
                    <div style="color:var(--text-sub); font-size:12px">${item.weight}</div>
                    <div class="tag" style="background:#444; color:#fff; padding:2px 8px; border-radius:4px; font-size:10px">${item.difficulty}</div>
                </div>`;
            });
            html += `</div>`;
            flow.innerHTML += html;
        };

        renderPhase('ğŸ”¥ çƒ­èº«æ¿€æ´»', w.phases.warmup, '#ffcc00');
        renderPhase('ğŸ‹ï¸ æ ¸å¿ƒè®­ç»ƒ', w.phases.main, '#00e5ff');
        renderPhase('ğŸ§˜ å†·èº«æ”¾æ¾', w.phases.cooldown, '#00cc66');
    },

    // --- ALGORITHM: PLAN GENERATOR ---
    generatePlan: function() {
        // Simple periodization logic
        // 4 Weeks. 
        // User preferences dictate split.
        // Assuming "Full Body" for beginner, "Split" for advanced.
        
        const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
        const weekGrid = document.getElementById('weekGrid');
        weekGrid.innerHTML = '';

        const level = store.user.level;
        let schedule = []; // Array of {dayIndex, target}

        if (level === 'Beginner') {
            // Full body 3 days
            schedule = [0, 2, 4].map(d => ({ d, t: 'å…¨èº«' }));
        } else {
            // Split (Push/Pull/Legs or similar simplified)
            schedule = [
                { d: 0, t: 'èƒ¸éƒ¨' }, { d: 1, t: 'èƒŒéƒ¨' }, { d: 3, t: 'è…¿éƒ¨' }, { d: 4, t: 'è‚©éƒ¨' }, { d: 5, t: 'æ‰‹è‡‚' }
            ];
        }

        // Render Grid
        for(let i=0; i<7; i++) {
            const col = document.createElement('div');
            col.className = 'day-col';
            col.innerHTML = `<div class="day-header">${days[i]}</div>`;
            
            const task = schedule.find(s => s.d === i);
            if (task) {
                // Generate a mini workout data
                const w = this.generateWorkout(true, task.t, store.ui.duration);
                const div = document.createElement('div');
                div.className = 'plan-card';
                div.innerHTML = `
                    <div style="font-weight:bold; color:var(--primary)">${task.t}è®­ç»ƒ</div>
                    <div style="margin-top:4px">${w.phases.main.length}ä¸ªåŠ¨ä½œ</div>
                    <div style="color:#888">${w.totalDuration}åˆ†é’Ÿ</div>
                `;
                div.onclick = () => {
                    store.currentWorkout = w;
                    this.renderWorkoutResult();
                    document.getElementById('workoutResult').style.display = 'block';
                    // Need a back button mechanism in real app, here we just show it
                    alert("å·²åŠ è½½è¯¥è¯¾ç¨‹è¯¦æƒ…ï¼Œå‘ä¸‹æ»šåŠ¨æŸ¥çœ‹");
                };
                col.appendChild(div);
            } else {
                col.innerHTML += `<div style="text-align:center; color:#444; margin-top:20px; font-size:11px">ä¼‘æ¯æ—¥</div>`;
            }
            weekGrid.appendChild(col);
        }

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('workoutResult').style.display = 'none';
        document.getElementById('planResult').style.display = 'block';
    },

    // --- PROFILE & UTILS ---

    renderProfile: function() {
        const u = store.user;
        document.getElementById('p_gender').value = u.gender;
        document.getElementById('p_goal').value = u.goal;
        document.getElementById('p_height').value = u.height;
        document.getElementById('p_weight').value = u.weight;
        document.getElementById('p_level').value = u.level;
        document.getElementById('p_style').value = u.style;

        // Render Pain Pills
        const painC = document.getElementById('p_pain');
        painC.innerHTML = '';
        PAIN_POINTS.forEach(p => {
            const pill = document.createElement('div');
            pill.className = `pill ${u.pain.includes(p) ? 'active' : ''}`;
            pill.innerText = p;
            pill.onclick = () => {
                pill.classList.toggle('active');
            }
            painC.appendChild(pill);
        });

        // Render Equipment Pills
        const eqC = document.getElementById('p_equipment');
        eqC.innerHTML = '';
        EQUIPMENT_LIST.forEach(e => {
            const pill = document.createElement('div');
            pill.className = `pill ${u.missingEquipment.includes(e) ? 'active' : ''}`;
            pill.innerText = e;
            pill.onclick = () => pill.classList.toggle('active'); // active means MISSING here for UI simplicity? Or User has it? 
            // PRD says "æ²¡æœ‰çš„å™¨æ¢°". So active means "I don't have it".
            eqC.appendChild(pill);
        });
    },

    saveProfile: function() {
        const getVal = (id) => document.getElementById(id).value;
        const getPills = (id) => Array.from(document.querySelectorAll(`#${id} .pill.active`)).map(e=>e.innerText);

        store.user = {
            gender: getVal('p_gender'),
            goal: getVal('p_goal'),
            height: getVal('p_height'),
            weight: getVal('p_weight'),
            level: getVal('p_level'),
            style: getVal('p_style'),
            pain: getPills('p_pain'),
            missingEquipment: getPills('p_equipment')
        };
        localStorage.setItem('aeke_user', JSON.stringify(store.user));
        alert("æ¡£æ¡ˆå·²ä¿å­˜");
    },

    loadProfile: function() {
        store.user = JSON.parse(localStorage.getItem('aeke_user')) || defaultProfile;
        this.renderProfile();
    },

    // --- LIBRARY ---

    renderLibrary: function(filterType = 'Main') {
        const grid = document.getElementById('libGrid');
        grid.innerHTML = '';
        let list = store.library;
        if (filterType !== 'All') {
            list = list.filter(x => x.t === filterType);
        }

        list.slice(0, 100).forEach(item => { // Limit render for perf
            const el = document.createElement('div');
            el.className = 'lib-item';
            el.innerHTML = `
                <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">${item.name}</div>
                <div style="color:#aaa;">${item.p} | ${item.difficulty}</div>
            `;
            const info = JSON.stringify(item).replace(/"/g, '&quot;');
            el.setAttribute('data-hover-info', info);
            grid.appendChild(el);
        });
    },

    filterLibrary: function(type) {
        document.querySelectorAll('.lib-filters .pill').forEach(p => p.classList.remove('active'));
        event.target.classList.add('active');
        this.renderLibrary(type);
    },

    downloadTemplate: function() {
        const template = [store.library[0]]; // Sample
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(template, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "action_template.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    },

    importLibrary: function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                // Merge logic (Simple append for demo)
                store.library = [...store.library, ...json];
                localStorage.setItem('aeke_lib', JSON.stringify(store.library));
                this.renderLibrary();
                alert(`æˆåŠŸå¯¼å…¥ ${json.length} ä¸ªåŠ¨ä½œ`);
            } catch(err) {
                alert("JSONæ ¼å¼é”™è¯¯");
            }
        };
        reader.readAsText(file);
    },

    showTooltip: function(e, info) {
        const tip = document.getElementById('tooltip');
        tip.innerHTML = `
            <h4>${info.name}</h4>
            <div style="margin-bottom:8px;">
                <span class="tag">${info.difficulty}</span>
                <span class="tag">${info.p}</span>
                <span class="tag">${info.t === 'Main' ? 'ä¸»è®­' : info.t === 'Warmup' ? 'çƒ­èº«' : 'æ”¾æ¾'}</span>
            </div>
            <p><strong>ä¸»è‚Œç¾¤:</strong> ${info.m}</p>
            <p><strong>å™¨æ¢°:</strong> ${info.e && info.e.length ? info.e.join(', ') : 'è‡ªé‡'}</p>
            <p><strong>ç¦å¿Œ:</strong> ${info.pain && info.pain.length ? info.pain.join(', ') : 'æ— '}</p>
        `;
        tip.style.display = 'block';
        tip.style.left = e.pageX + 15 + 'px';
        tip.style.top = e.pageY + 15 + 'px';
    }
};

// Start
app.init();

</script>
</body>
</html>