<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEKE Fit - AI è¿åŠ¨ç”Ÿæˆå™¨</title>
    <style>
        :root {
            --bg-color: #0f1115;
            --card-bg: #1c1f26;
            --primary: #00f2ea;
            --primary-dim: rgba(0, 242, 234, 0.1);
            --accent: #ff0055;
            --text-main: #ffffff;
            --text-sub: #8b9bb4;
            --border: #2d3342;
            --radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
            --font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: var(--font-family); min-height: 100vh; overflow-x: hidden; }
        
        /* Layout */
        .container { max-width: 800px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .brand { font-size: 24px; font-weight: 800; background: linear-gradient(90deg, #fff, var(--text-sub)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px; }
        .action-bar { display: flex; gap: 10px; }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: var(--radius); border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 15px var(--primary-dim); }
        .btn-primary:active { transform: scale(0.96); }
        .btn-secondary { background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-icon { padding: 10px; border-radius: 50%; width: 40px; height: 40px; }

        /* Card System */
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-sub); }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .tag-check { display: none; }
        .tag-label { padding: 8px 16px; background: rgba(255,255,255,0.05); border-radius: 100px; font-size: 13px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .tag-check:checked + .tag-label { background: var(--primary-dim); color: var(--primary); border-color: var(--primary); box-shadow: 0 0 10px var(--primary-dim); }

        .slider-container { display: flex; align-items: center; gap: 15px; }
        .slider-val { font-variant-numeric: tabular-nums; font-weight: 700; color: var(--primary); min-width: 60px; }
        input[type="range"] { flex: 1; -webkit-appearance: none; height: 4px; background: var(--border); border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px var(--primary); margin-top: -8px; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--border); border-radius: 2px; }

        /* Generation Actions */
        .gen-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        .gen-btn { height: 50px; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }

        /* Results Area */
        .result-section { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 18px; font-weight: 700; color: var(--primary); display: block; }
        .stat-key { font-size: 10px; color: var(--text-sub); text-transform: uppercase; }

        .section-header { font-size: 14px; color: var(--primary); margin: 25px 0 10px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .section-header::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, var(--border), transparent); }

        /* List Items (Course/Action) */
        .action-list { list-style: none; }
        .action-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.03); margin-bottom: 8px; border-radius: 8px; border-left: 3px solid transparent; transition: all 0.2s; position: relative; }
        .action-item:hover { background: rgba(255,255,255,0.06); transform: translateX(5px); }
        .action-item.warmup { border-left-color: #ffaa00; }
        .action-item.main { border-left-color: var(--primary); }
        .action-item.cooldown { border-left-color: #00aaff; }

        .ai-info { flex: 1; }
        .ai-name { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
        .ai-meta { font-size: 12px; color: var(--text-sub); display: flex; gap: 10px; }
        .ai-badge { padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 10px; }

        /* Tooltip */
        .tooltip { position: absolute; left: 50%; bottom: 100%; transform: translateX(-50%); background: #000; border: 1px solid var(--border); padding: 10px; border-radius: 8px; width: 250px; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.8); font-size: 12px; line-height: 1.4; }
        .action-item:hover .tooltip { opacity: 1; bottom: 110%; }
        .tooltip h4 { color: var(--primary); margin-bottom: 5px; }
        .tooltip p { color: #ccc; margin-bottom: 3px; }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: var(--radius); padding: 25px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .close-btn { background: none; border: none; color: var(--text-sub); font-size: 24px; cursor: pointer; }

        /* Inputs */
        input[type="text"], input[type="number"], select { width: 100%; background: #111; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 8px; margin-top: 5px; }
        
        /* Plan View */
        .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-card { background: rgba(255,255,255,0.05); padding: 10px 5px; text-align: center; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .day-card.active, .day-card:hover { background: var(--primary); color: #000; }
        .day-name { font-size: 10px; text-transform: uppercase; margin-bottom: 5px; }
        .day-status { width: 6px; height: 6px; background: #555; border-radius: 50%; margin: 0 auto; }
        .day-card.has-workout .day-status { background: #fff; }

        /* Utility */
        .hidden { display: none !important; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 10px 20px; border-radius: 20px; font-weight: 600; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand">AEKE FIT <span style="font-size:12px; color:var(--primary)">AI GEN</span></div>
        <div class="action-bar">
            <button class="btn btn-secondary btn-icon" onclick="openModal('libraryModal')" title="åŠ¨ä½œåº“">ğŸ“š</button>
            <button class="btn btn-secondary btn-icon" onclick="openModal('profileModal')" title="è¿åŠ¨æ¡£æ¡ˆ">ğŸ‘¤</button>
        </div>
    </div>

    <div class="card">
        <div class="card-title">ç›®æ ‡éƒ¨ä½ (æœ€å¤š3é¡¹)</div>
        <div class="tag-container" id="targetMuscles">
            </div>

        <div style="margin-top: 25px;">
            <div class="card-title">è¿åŠ¨æ—¶é•¿: <span id="durationVal" class="slider-val">20</span> åˆ†é’Ÿ</div>
            <div class="slider-container">
                <span style="font-size:12px; color:#666">20</span>
                <input type="range" id="durationSlider" min="20" max="60" step="1" value="20">
                <span style="font-size:12px; color:#666">60</span>
            </div>
        </div>

        <div class="gen-actions">
            <button class="btn btn-primary gen-btn" onclick="generateWorkout()">âš¡ ç”Ÿæˆå•æ¬¡è¯¾ç¨‹</button>
            <button class="btn btn-secondary gen-btn" onclick="generatePlan()">ğŸ“… ç”Ÿæˆå‘¨è®¡åˆ’</button>
        </div>
    </div>

    <div id="courseResult" class="result-section">
        <div class="card">
            <div class="header" style="margin-bottom:15px">
                <div class="card-title" style="margin:0">è¯¾ç¨‹æ¦‚è§ˆ</div>
                <button class="btn btn-secondary" style="padding:5px 10px; font-size:12px;" onclick="closeResult('courseResult')">æ”¶èµ·</button>
            </div>
            <div class="stat-grid">
                <div class="stat-box"><span class="stat-val" id="resCount">0</span><span class="stat-key">åŠ¨ä½œæ•°é‡</span></div>
                <div class="stat-box"><span class="stat-val" id="resTime">0m</span><span class="stat-key">é¢„ä¼°æ—¶é•¿</span></div>
                <div class="stat-box"><span class="stat-val" id="resVol">0</span><span class="stat-key">å®¹é‡(kg)</span></div>
                <div class="stat-box"><span class="stat-val" id="resCal">0</span><span class="stat-key">å¡è·¯é‡Œ</span></div>
            </div>
            
            <div id="workoutList">
                </div>
        </div>
    </div>

    <div id="planResult" class="result-section">
        <div class="card">
            <div class="header">
                <div class="card-title" style="margin:0">æ™ºèƒ½è®­ç»ƒè®¡åˆ’</div>
                <div style="font-size:12px; color:var(--primary)">å‘¨æœŸ: 4å‘¨</div>
            </div>
            <div class="stat-grid">
                <div class="stat-box"><span class="stat-val" id="planTotal">12</span><span class="stat-key">æ€»è¯¾ç¨‹</span></div>
                <div class="stat-box"><span class="stat-val" id="planFreq">3</span><span class="stat-key">æ¯å‘¨é¢‘ç‡</span></div>
            </div>

            <div class="week-nav">
                <button class="btn btn-secondary" style="padding:5px;" onclick="changeWeek(-1)">â—€</button>
                <span id="currentWeekDisplay" style="font-weight:700">ç¬¬ 1 å‘¨</span>
                <button class="btn btn-secondary" style="padding:5px;" onclick="changeWeek(1)">â–¶</button>
            </div>

            <div class="week-grid" id="weekGrid">
                </div>
            
            <div id="dayDetailInfo" style="margin-top:20px; padding-top:20px; border-top:1px dashed var(--border); display:none;">
                <h4 style="color:var(--text-sub); margin-bottom:10px;">æœ¬æ—¥å®‰æ’</h4>
                <div id="planDayWorkoutContainer"></div>
            </div>
        </div>
    </div>
</div>

<div id="profileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">è¿åŠ¨æ¡£æ¡ˆ</div>
            <button class="close-btn" onclick="closeModal('profileModal')">&times;</button>
        </div>
        <div class="form-group">
            <label class="label">æ€§åˆ«</label>
            <div class="tag-container" id="pf_gender">
                <label><input type="radio" name="gender" value="ç”·" checked class="tag-check"><span class="tag-label">ç”·</span></label>
                <label><input type="radio" name="gender" value="å¥³" class="tag-check"><span class="tag-label">å¥³</span></label>
            </div>
        </div>
        <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <label class="label">èº«é«˜ (cm)</label>
                <input type="number" id="pf_height" value="180">
            </div>
            <div>
                <label class="label">ä½“é‡ (kg)</label>
                <input type="number" id="pf_weight" value="90">
            </div>
        </div>
        <div class="form-group">
            <label class="label">è¿åŠ¨ç›®æ ‡</label>
            <select id="pf_goal">
                <option value="å¢è‚Œ">å¢è‚Œ (Hypertrophy)</option>
                <option value="å‡é‡">å‡é‡ (Fat Loss)</option>
                <option value="å¥åº·">å¥åº· (General Health)</option>
            </select>
        </div>
        <div class="form-group">
            <label class="label">å½“å‰ç­‰çº§</label>
            <div class="tag-container" id="pf_level">
                <label><input type="radio" name="level" value="åˆçº§" checked class="tag-check"><span class="tag-label">åˆçº§</span></label>
                <label><input type="radio" name="level" value="ä¸­çº§" class="tag-check"><span class="tag-label">ä¸­çº§</span></label>
                <label><input type="radio" name="level" value="é«˜çº§" class="tag-check"><span class="tag-label">é«˜çº§</span></label>
            </div>
        </div>
        <div class="form-group">
            <label class="label">ç–¼ç—›/æŸä¼¤éƒ¨ä½ (å¤šé€‰)</label>
            <div class="tag-container" id="pf_pain">
                </div>
        </div>
        <div class="form-group">
            <label class="label">ç¼ºå¤±å™¨æ¢°</label>
            <div class="tag-container" id="pf_equip">
                <label><input type="radio" name="equip" value="none" checked class="tag-check"><span class="tag-label">æˆ‘å…¨éƒ½æœ‰</span></label>
                <label><input type="radio" name="equip" value="å¥èº«å‡³" class="tag-check"><span class="tag-label">æ— å¥èº«å‡³</span></label>
                <label><input type="radio" name="equip" value="å“‘é“ƒ" class="tag-check"><span class="tag-label">æ— å“‘é“ƒ</span></label>
            </div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="saveProfile()">ä¿å­˜æ¡£æ¡ˆ</button>
    </div>
</div>

<div id="libraryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">åŠ¨ä½œåº“ç®¡ç†</div>
            <button class="close-btn" onclick="closeModal('libraryModal')">&times;</button>
        </div>
        <div style="margin-bottom:15px; display:flex; gap:10px;">
            <input type="file" id="jsonInput" style="display:none" accept=".json" onchange="importLibrary(this)">
            <button class="btn btn-secondary" onclick="document.getElementById('jsonInput').click()" style="flex:1">ğŸ“¥ å¯¼å…¥ JSON</button>
            <button class="btn btn-secondary" onclick="resetLibrary()" style="flex:1">ğŸ”„ é‡ç½®é»˜è®¤</button>
        </div>
        <div id="libList" style="max-height: 400px; overflow-y: auto;">
            </div>
    </div>
</div>

<div class="toast" id="toast">ä¿å­˜æˆåŠŸ</div>

<script>
/**
 * é¡¶çº§ç¨‹åºå‘˜ä¸è¿åŠ¨ç§‘å­¦ä¸“å®¶çš„ç»“åˆå®ç°
 * * æ ¸å¿ƒé€»è¾‘ï¼š
 * 1. æ•°æ®é©±åŠ¨ï¼šæ‰€æœ‰åŠ¨ä½œåŸºäºJSONç»“æ„ï¼ŒåŒ…å«è§£å‰–å­¦æ ‡ç­¾ã€‚
 * 2. ç®—æ³•ç­›é€‰ï¼šæ ¹æ®ç”¨æˆ·æ¡£æ¡ˆï¼ˆç–¼ç—›ã€å™¨æ¢°ï¼‰è¿‡æ»¤åŠ¨ä½œã€‚
 * 3. æ™ºèƒ½ç¼–æ’ï¼šçƒ­èº«(Warmup) -> ä¸»è®­(Main) -> æ”¾æ¾(Cooldown)ã€‚
 * 4. æƒé‡åˆ†é…ï¼šä¸åŒç­‰çº§ç”¨æˆ·å¯¹ä¸åŒéš¾åº¦åŠ¨ä½œçš„æ¦‚ç‡åˆ†å¸ƒã€‚
 */

// --- 1. åŸºç¡€æ•°æ®ç»“æ„ä¸ç§å­æ•°æ® ---

const TARGET_PARTS = ['å…¨èº«', 'èƒ¸éƒ¨', 'èƒŒéƒ¨', 'è‚©éƒ¨', 'æ‰‹è‡‚', 'è‡€éƒ¨', 'è…¿éƒ¨', 'æ ¸å¿ƒ'];
const PAIN_AREAS = ['æ— ', 'æ‰‹è…•', 'è‚˜éƒ¨', 'è‚©éƒ¨', 'è…°éƒ¨', 'é«‹éƒ¨', 'è†ç›–', 'è„šè¸'];

// é»˜è®¤ç§å­åº“ (ç²¾ç®€ç‰ˆï¼ŒåŒ…å«å…³é”®å…ƒæ•°æ®)
const DEFAULT_LIBRARY = [
    // çƒ­èº«
    {id: 'wu01', name: 'å¼€åˆè·³', type: 'çƒ­èº«', part: 'å…¨èº«', level: 'åˆçº§', equip: ['è‡ªé‡'], muscle: 'å…¨èº«', pain_risk: ['è†ç›–', 'è„šè¸']},
    {id: 'wu02', name: 'è‚©éƒ¨ç¯ç»•', type: 'çƒ­èº«', part: 'è‚©éƒ¨', level: 'åˆçº§', equip: ['è‡ªé‡'], muscle: 'è‚©éƒ¨', pain_risk: []},
    {id: 'wu03', name: 'åŠ¨æ€èƒ¸éƒ¨æ‹‰ä¼¸', type: 'çƒ­èº«', part: 'èƒ¸éƒ¨', level: 'åˆçº§', equip: ['è‡ªé‡'], muscle: 'èƒ¸éƒ¨', pain_risk: []},
    {id: 'wu04', name: 'é«˜æŠ¬è…¿', type: 'çƒ­èº«', part: 'è…¿éƒ¨', level: 'ä¸­çº§', equip: ['è‡ªé‡'], muscle: 'è…¿éƒ¨', pain_risk: ['è†ç›–']},
    
    // èƒ¸éƒ¨
    {id: 'ch01', name: 'å¹³æ¿æ é“ƒå§æ¨', type: 'ä¸»è®­', part: 'èƒ¸éƒ¨', sub_muscle: 'èƒ¸å¤§è‚Œä¸­æŸ', level: 'ä¸­çº§', equip: ['æ¨ªæ†', 'å¥èº«å‡³'], pain_risk: ['è‚©éƒ¨', 'æ‰‹è…•']},
    {id: 'ch02', name: 'å“‘é“ƒä¸Šæ–œå§æ¨', type: 'ä¸»è®­', part: 'èƒ¸éƒ¨', sub_muscle: 'èƒ¸å¤§è‚Œä¸ŠæŸ', level: 'ä¸­çº§', equip: ['æ‰‹æŸ„', 'å¥èº«å‡³'], pain_risk: ['è‚©éƒ¨']},
    {id: 'ch03', name: 'ä¿¯å§æ’‘', type: 'ä¸»è®­', part: 'èƒ¸éƒ¨', sub_muscle: 'èƒ¸å¤§è‚Œä¸­æŸ', level: 'åˆçº§', equip: ['è‡ªé‡'], pain_risk: ['æ‰‹è…•']},
    {id: 'ch04', name: 'ç»³ç´¢å¤¹èƒ¸', type: 'ä¸»è®­', part: 'èƒ¸éƒ¨', sub_muscle: 'èƒ¸å¤§è‚Œå†…ä¾§', level: 'é«˜çº§', equip: ['æ‰‹æŸ„'], pain_risk: []},
    
    // èƒŒéƒ¨
    {id: 'bk01', name: 'å¼•ä½“å‘ä¸Š', type: 'ä¸»è®­', part: 'èƒŒéƒ¨', sub_muscle: 'ä¸ŠèƒŒ', level: 'é«˜çº§', equip: ['æ¨ªæ†'], pain_risk: ['è‚©éƒ¨']},
    {id: 'bk02', name: 'åå§¿åˆ’èˆ¹', type: 'ä¸»è®­', part: 'èƒŒéƒ¨', sub_muscle: 'ä¸­èƒŒ', level: 'åˆçº§', equip: ['æ‰‹æŸ„'], pain_risk: ['è…°éƒ¨']},
    {id: 'bk03', name: 'é«˜ä½ä¸‹æ‹‰', type: 'ä¸»è®­', part: 'èƒŒéƒ¨', sub_muscle: 'ä¸ŠèƒŒ', level: 'åˆçº§', equip: ['æ‰‹æŸ„'], pain_risk: []},
    {id: 'bk04', name: 'ç¡¬æ‹‰', type: 'ä¸»è®­', part: 'èƒŒéƒ¨', sub_muscle: 'ä¸‹èƒŒ', level: 'é«˜çº§', equip: ['æ¨ªæ†'], pain_risk: ['è…°éƒ¨']},

    // è…¿éƒ¨
    {id: 'lg01', name: 'æ é“ƒæ·±è¹²', type: 'ä¸»è®­', part: 'è…¿éƒ¨', sub_muscle: 'è‚¡å››å¤´è‚Œ', level: 'é«˜çº§', equip: ['æ¨ªæ†'], pain_risk: ['è†ç›–', 'è…°éƒ¨']},
    {id: 'lg02', name: 'å¾’æ‰‹æ·±è¹²', type: 'ä¸»è®­', part: 'è…¿éƒ¨', sub_muscle: 'è‚¡å››å¤´è‚Œ', level: 'åˆçº§', equip: ['è‡ªé‡'], pain_risk: ['è†ç›–']},
    {id: 'lg03', name: 'ç½—é©¬å°¼äºšç¡¬æ‹‰', type: 'ä¸»è®­', part: 'è…¿éƒ¨', sub_muscle: 'èƒ­ç»³è‚Œ', level: 'ä¸­çº§', equip: ['æ¨ªæ†'], pain_risk: ['è…°éƒ¨']},
    
    // è‚©éƒ¨
    {id: 'sh01', name: 'å“‘é“ƒæ¨ä¸¾', type: 'ä¸»è®­', part: 'è‚©éƒ¨', sub_muscle: 'ä¸‰è§’è‚Œå‰æŸ', level: 'ä¸­çº§', equip: ['æ‰‹æŸ„'], pain_risk: ['è‚©éƒ¨']},
    {id: 'sh02', name: 'ä¾§å¹³ä¸¾', type: 'ä¸»è®­', part: 'è‚©éƒ¨', sub_muscle: 'ä¸‰è§’è‚Œä¸­æŸ', level: 'åˆçº§', equip: ['æ‰‹æŸ„'], pain_risk: []},
    
    // æ”¾æ¾
    {id: 'cd01', name: 'å©´å„¿å¼', type: 'æ”¾æ¾', part: 'å…¨èº«', level: 'åˆçº§', equip: ['ç‘œä¼½å«'], muscle: 'èƒŒéƒ¨', pain_risk: ['è†ç›–']},
    {id: 'cd02', name: 'æ³¡æ²«è½´æ»šèƒŒ', type: 'æ”¾æ¾', part: 'èƒŒéƒ¨', level: 'åˆçº§', equip: ['æ³¡æ²«è½´'], muscle: 'èƒŒéƒ¨', pain_risk: []},
    {id: 'cd03', name: 'èƒ¸éƒ¨é™æ€æ‹‰ä¼¸', type: 'æ”¾æ¾', part: 'èƒ¸éƒ¨', level: 'åˆçº§', equip: ['è‡ªé‡'], muscle: 'èƒ¸éƒ¨', pain_risk: []}
];

// --- 2. çŠ¶æ€ç®¡ç† ---

let state = {
    profile: {
        gender: 'ç”·',
        height: 180,
        weight: 90,
        goal: 'å¢è‚Œ',
        level: 'åˆçº§',
        pain: [],
        missing_equip: null
    },
    library: [...DEFAULT_LIBRARY],
    currentPlan: null, // Stores the generated plan
    selectedTargets: ['èƒ¸éƒ¨'],
    duration: 20
};

// --- 3. ç®—æ³•æ ¸å¿ƒ (The "AI") ---

// éš¾åº¦åˆ†å¸ƒçŸ©é˜µ
const DIFFICULTY_MATRIX = {
    'åˆçº§': { 'åˆçº§': 0.6, 'ä¸­çº§': 0.3, 'é«˜çº§': 0.1 },
    'ä¸­çº§': { 'åˆçº§': 0.2, 'ä¸­çº§': 0.6, 'é«˜çº§': 0.2 },
    'é«˜çº§': { 'åˆçº§': 0.1, 'ä¸­çº§': 0.3, 'é«˜çº§': 0.6 }
};

// è‚Œç¾¤åˆ†é…æ¯”ä¾‹ (ç®€åŒ–å®ç°ï¼Œæ ¸å¿ƒé€»è¾‘)
const MUSCLE_RATIOS = {
    'èƒ¸éƒ¨': { 'èƒ¸å¤§è‚Œä¸­æŸ': 0.4, 'èƒ¸å¤§è‚Œä¸ŠæŸ': 0.25, 'èƒ¸å¤§è‚Œä¸‹æŸ': 0.2, 'èƒ¸å¤§è‚Œå†…ä¾§': 0.15 },
    'èƒŒéƒ¨': { 'ä¸­èƒŒ': 0.4, 'ä¸ŠèƒŒ': 0.3, 'ä¸‹èƒŒ': 0.3 },
    // ... å…¶ä»–éƒ¨ä½å¯æ‰©å±•
};

function filterExercises(pool, type, targetPart = null) {
    return pool.filter(ex => {
        // 1. ç±»å‹åŒ¹é…
        if (ex.type !== type) return false;
        
        // 2. éƒ¨ä½åŒ¹é… (ä»…ä¸»è®­)
        if (type === 'ä¸»è®­' && targetPart && ex.part !== targetPart && ex.part !== 'å…¨èº«') return false;

        // 3. ç–¼ç—›è¿‡æ»¤ (Safety Guardrail)
        const hasPainRisk = ex.pain_risk && ex.pain_risk.some(risk => state.profile.pain.includes(risk));
        if (hasPainRisk) return false;

        // 4. å™¨æ¢°è¿‡æ»¤
        if (state.profile.missing_equip) {
            if (ex.equip.includes(state.profile.missing_equip) && ex.equip.length === 1) return false;
        }

        return true;
    });
}

function weightedSelect(pool, count) {
    if (pool.length === 0) return [];
    if (pool.length <= count) return pool;

    const selected = [];
    const userLevel = state.profile.level;
    const weights = DIFFICULTY_MATRIX[userLevel];
    
    // ç®€å•çš„åŠ æƒéšæœºç®—æ³•
    // ç»™æ± å­é‡Œçš„æ¯ä¸ªåŠ¨ä½œæ‰“åˆ†
    const scoredPool = pool.map(ex => {
        let score = Math.random() * 10; 
        if (ex.level === 'åˆçº§') score += weights['åˆçº§'] * 10;
        if (ex.level === 'ä¸­çº§') score += weights['ä¸­çº§'] * 10;
        if (ex.level === 'é«˜çº§') score += weights['é«˜çº§'] * 10;
        return { ex, score };
    });

    // æ’åºå¹¶å–å‰Nä¸ª
    scoredPool.sort((a, b) => b.score - a.score);
    return scoredPool.slice(0, count).map(item => item.ex);
}

function calculateVolume(ex, goal) {
    // åŸºäºç›®æ ‡çš„è¿åŠ¨ç§‘å­¦å…¬å¼
    if (goal === 'å¢è‚Œ') return { sets: 4, reps: '8-12æ¬¡', weight: '70% 1RM' };
    if (goal === 'å‡é‡') return { sets: 3, reps: '15-20æ¬¡', weight: '50% 1RM' };
    if (goal === 'å¥åº·') return { sets: 2, reps: '12-15æ¬¡', weight: 'è‡ªé‡/è½»é‡é‡' };
    return { sets: 3, reps: '10æ¬¡', weight: 'é€‚ä¸­' };
}

function generateSession(duration, targets) {
    const wuCount = Math.ceil(duration / 10);
    const cdCount = Math.ceil(duration / 10);
    
    // 1. çƒ­èº«
    let wuPool = filterExercises(state.library, 'çƒ­èº«');
    let warmups = weightedSelect(wuPool, wuCount).map(ex => ({...ex, sets: 1, reps: '30ç§’', weight: 'è‡ªé‡'}));

    // 2. æ”¾æ¾
    let cdPool = filterExercises(state.library, 'æ”¾æ¾');
    let cooldowns = weightedSelect(cdPool, cdCount).map(ex => ({...ex, sets: 1, reps: '30ç§’', weight: 'è‡ªé‡'}));

    // 3. ä¸»è®­
    // è®¡ç®—å‰©ä½™æ—¶é—´: å‡è®¾çƒ­èº«æ”¾æ¾æ¯ä¸ªåŠ¨ä½œè€—æ—¶1åˆ†é’Ÿ(å«åˆ‡æ¢)
    let usedTime = (warmups.length + cooldowns.length) * 1.5; 
    let mainTime = duration - usedTime;
    if (mainTime < 5) mainTime = 5; // å…œåº•

    // å‡è®¾æ¯ä¸ªä¸»è®­åŠ¨ä½œè€—æ—¶3åˆ†é’Ÿ (ç»„é—´ä¼‘æ¯ + æ‰§è¡Œ)
    let mainCount = Math.floor(mainTime / 3);
    if (mainCount < 1) mainCount = 1;

    let mainExercises = [];
    // å¹³å‡åˆ†é…ç»™é€‰ä¸­çš„éƒ¨ä½
    let perTargetCount = Math.ceil(mainCount / targets.length);
    
    targets.forEach(target => {
        let pool = filterExercises(state.library, 'ä¸»è®­', target);
        // å¦‚æœè¯¥éƒ¨ä½æ²¡åŠ¨ä½œï¼Œå°è¯•å…¨èº«åŠ¨ä½œ
        if (pool.length === 0) pool = filterExercises(state.library, 'ä¸»è®­', 'å…¨èº«');
        
        let selected = weightedSelect(pool, perTargetCount);
        let vol = calculateVolume(selected, state.profile.goal);
        
        selected.forEach(ex => {
            mainExercises.push({
                ...ex,
                sets: vol.sets,
                reps: vol.reps,
                weight: vol.weight
            });
        });
    });

    // æˆªæ–­åˆ°æœ€å¤§æ•°é‡ (é˜²æ­¢æº¢å‡º)
    if (mainExercises.length > mainCount + 2) mainExercises = mainExercises.slice(0, mainCount + 2);

    return {
        warmups,
        mainExercises,
        cooldowns,
        totalTime: duration,
        estCal: duration * 6 + (Math.random() * 50).toFixed(0), // ç²—ç•¥ä¼°ç®—
        totalVol: mainExercises.length * 4 * 20 // ç²—ç•¥å®¹é‡
    };
}

// --- 4. äº¤äº’é€»è¾‘ (UI Controllers) ---

function init() {
    renderTargets();
    renderPainTags();
    
    // Slider Listener
    const slider = document.getElementById('durationSlider');
    slider.addEventListener('input', (e) => {
        state.duration = parseInt(e.target.value);
        document.getElementById('durationVal').innerText = state.duration;
    });

    // Profile listeners
    document.querySelectorAll('input[name="gender"]').forEach(el => el.addEventListener('change', e => state.profile.gender = e.target.value));
    document.querySelectorAll('input[name="level"]').forEach(el => el.addEventListener('change', e => state.profile.level = e.target.value));
    document.getElementById('pf_goal').addEventListener('change', e => state.profile.goal = e.target.value);
}

function renderTargets() {
    const container = document.getElementById('targetMuscles');
    container.innerHTML = '';
    TARGET_PARTS.forEach(part => {
        const checked = state.selectedTargets.includes(part) ? 'checked' : '';
        const html = `
            <label>
                <input type="checkbox" class="tag-check" value="${part}" ${checked} onchange="toggleTarget(this)">
                <span class="tag-label">${part}</span>
            </label>
        `;
        container.insertAdjacentHTML('beforeend', html);
    });
}

function toggleTarget(el) {
    const val = el.value;
    if (el.checked) {
        if (state.selectedTargets.length >= 3) {
            el.checked = false;
            showToast('æœ€å¤šé€‰æ‹©3ä¸ªéƒ¨ä½');
            return;
        }
        state.selectedTargets.push(val);
    } else {
        state.selectedTargets = state.selectedTargets.filter(t => t !== val);
    }
}

function renderPainTags() {
    const container = document.getElementById('pf_pain');
    container.innerHTML = '';
    PAIN_AREAS.forEach(area => {
        if (area === 'æ— ') return;
        const html = `
            <label>
                <input type="checkbox" class="tag-check" value="${area}" onchange="togglePain(this)">
                <span class="tag-label">${area}</span>
            </label>
        `;
        container.insertAdjacentHTML('beforeend', html);
    });
}

function togglePain(el) {
    const val = el.value;
    if (el.checked) state.profile.pain.push(val);
    else state.profile.pain = state.profile.pain.filter(p => p !== val);
}

// --- 5. ç”Ÿæˆä¸æ¸²æŸ“ç»“æœ ---

function generateWorkout() {
    if (state.selectedTargets.length === 0) {
        showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç›®æ ‡éƒ¨ä½');
        return;
    }
    
    const session = generateSession(state.duration, state.selectedTargets);
    renderWorkoutResult(session);
    
    document.getElementById('planResult').style.display = 'none';
    document.getElementById('courseResult').style.display = 'block';
}

function renderWorkoutResult(session) {
    document.getElementById('resCount').innerText = session.warmups.length + session.mainExercises.length + session.cooldowns.length;
    document.getElementById('resTime').innerText = session.totalTime + 'm';
    document.getElementById('resVol').innerText = session.totalVol;
    document.getElementById('resCal').innerText = session.estCal;

    const list = document.getElementById('workoutList');
    list.innerHTML = '';

    const renderItem = (ex, cls) => `
        <li class="action-item ${cls}">
            <div class="ai-info">
                <div class="ai-name">${ex.name}</div>
                <div class="ai-meta">
                    <span class="ai-badge">${ex.sets}ç»„</span>
                    <span class="ai-badge">${ex.reps}</span>
                    <span class="ai-badge">${ex.weight}</span>
                </div>
            </div>
            <div class="tooltip">
                <h4>${ex.name}</h4>
                <p>éƒ¨ä½: ${ex.part} ${ex.sub_muscle ? '- '+ex.sub_muscle : ''}</p>
                <p>ç­‰çº§: ${ex.level}</p>
                <p>å™¨æ¢°: ${ex.equip.join(',')}</p>
                <p style="color:#ff5555; margin-top:5px;">${ex.pain_risk.length ? 'æ³¨æ„: '+ex.pain_risk.join(',')+'å—åŠ›' : 'ä½é£é™©'}</p>
            </div>
        </li>
    `;

    if (session.warmups.length) list.insertAdjacentHTML('beforeend', '<div class="section-header">ğŸ”¥ çƒ­èº«æ¿€æ´»</div>');
    session.warmups.forEach(ex => list.insertAdjacentHTML('beforeend', renderItem(ex, 'warmup')));

    if (session.mainExercises.length) list.insertAdjacentHTML('beforeend', '<div class="section-header">ğŸ’ª æ ¸å¿ƒè®­ç»ƒ</div>');
    session.mainExercises.forEach(ex => list.insertAdjacentHTML('beforeend', renderItem(ex, 'main')));

    if (session.cooldowns.length) list.insertAdjacentHTML('beforeend', '<div class="section-header">ğŸ§˜ æ”¾æ¾æ‹‰ä¼¸</div>');
    session.cooldowns.forEach(ex => list.insertAdjacentHTML('beforeend', renderItem(ex, 'cooldown')));
}

// --- 6. è®¡åˆ’ç”Ÿæˆ ---

function generatePlan() {
    // ç®€å•çš„å‘¨è®¡åˆ’é€»è¾‘ï¼šæ¯å‘¨3-5ç»ƒï¼Œéƒ¨ä½å¾ªç¯
    const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
    const pattern = ['èƒ¸éƒ¨', 'ä¼‘æ¯', 'èƒŒéƒ¨', 'ä¼‘æ¯', 'è…¿éƒ¨', 'ä¼‘æ¯', 'å…¨èº«']; // ç®€åŒ–ç‰ˆå¾ªç¯
    
    let planData = [];
    
    // ç”Ÿæˆ4å‘¨æ•°æ®
    for (let w=1; w<=4; w++) {
        let week = [];
        days.forEach((d, idx) => {
            let target = pattern[idx];
            let hasWorkout = target !== 'ä¼‘æ¯';
            let session = hasWorkout ? generateSession(state.duration, target === 'å…¨èº«' ? ['å…¨èº«'] : [target]) : null;
            week.push({ day: d, target: target, session: session });
        });
        planData.push(week);
    }
    
    state.currentPlan = planData;
    currentWeekIdx = 0;
    renderPlan();
    
    document.getElementById('courseResult').style.display = 'none';
    document.getElementById('planResult').style.display = 'block';
}

let currentWeekIdx = 0;
function changeWeek(delta) {
    currentWeekIdx += delta;
    if (currentWeekIdx < 0) currentWeekIdx = 0;
    if (currentWeekIdx > 3) currentWeekIdx = 3;
    renderPlan();
}

function renderPlan() {
    document.getElementById('currentWeekDisplay').innerText = `ç¬¬ ${currentWeekIdx + 1} å‘¨`;
    const weekData = state.currentPlan[currentWeekIdx];
    const grid = document.getElementById('weekGrid');
    grid.innerHTML = '';
    
    weekData.forEach((dayData, idx) => {
        const isActive = dayData.session ? 'has-workout' : '';
        const html = `
            <div class="day-card ${isActive}" onclick="viewPlanDay(${idx})">
                <div class="day-name">${dayData.day}</div>
                <div class="day-status"></div>
                <div style="font-size:9px; margin-top:2px; opacity:0.7">${dayData.target}</div>
            </div>
        `;
        grid.insertAdjacentHTML('beforeend', html);
    });
    
    // Hide details initially
    document.getElementById('dayDetailInfo').style.display = 'none';
}

function viewPlanDay(dayIdx) {
    const dayData = state.currentPlan[currentWeekIdx][dayIdx];
    if (!dayData.session) {
        showToast('ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥');
        return;
    }
    
    const container = document.getElementById('planDayWorkoutContainer');
    // Reuse render logic but simpler
    let html = '';
    dayData.session.mainExercises.forEach(ex => {
        html += `<div style="font-size:12px; margin-bottom:5px; color:#ccc;">â€¢ ${ex.name} (${ex.sets}x${ex.reps})</div>`;
    });
    container.innerHTML = html;
    document.getElementById('dayDetailInfo').style.display = 'block';
}


// --- 7. é€šç”¨åŠŸèƒ½ ---

function openModal(id) {
    document.getElementById(id).classList.add('active');
    if (id === 'libraryModal') renderLibList();
}
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function closeResult(id) { document.getElementById(id).style.display = 'none'; }

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.opacity = 1;
    setTimeout(() => t.style.opacity = 0, 2000);
}

function saveProfile() {
    state.profile.height = document.getElementById('pf_height').value;
    state.profile.weight = document.getElementById('pf_weight').value;
    // ... å…¶ä»–å·²å®æ—¶ç»‘å®š
    closeModal('profileModal');
    showToast('æ¡£æ¡ˆå·²ä¿å­˜');
}

function renderLibList() {
    const list = document.getElementById('libList');
    list.innerHTML = state.library.map(ex => `
        <div style="padding:10px; border-bottom:1px solid #333; font-size:12px; display:flex; justify-content:space-between;">
            <div>
                <strong style="color:var(--primary)">${ex.name}</strong> 
                <span style="color:#666">[${ex.part}]</span>
            </div>
            <button onclick="deleteEx('${ex.id}')" style="background:none; border:none; color:#555; cursor:pointer;">ğŸ—‘</button>
        </div>
    `).join('');
}

function deleteEx(id) {
    state.library = state.library.filter(ex => ex.id !== id);
    renderLibList();
}

function importLibrary(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            // ç®€å•çš„åˆå¹¶ç­–ç•¥ï¼šIDç›¸åŒè¦†ç›–ï¼Œä¸åŒæ–°å¢
            data.forEach(newEx => {
                const idx = state.library.findIndex(ex => ex.id === newEx.id);
                if (idx >= 0) state.library[idx] = newEx;
                else state.library.push(newEx);
            });
            renderLibList();
            showToast('å¯¼å…¥æˆåŠŸ');
        } catch(err) {
            showToast('JSONæ ¼å¼é”™è¯¯');
        }
    };
    reader.readAsText(file);
}

function resetLibrary() {
    state.library = [...DEFAULT_LIBRARY];
    renderLibList();
    showToast('å·²é‡ç½®ä¸ºé»˜è®¤åº“');
}

// å¯åŠ¨
init();

</script>
</body>
</html>