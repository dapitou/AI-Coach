# AI推荐_智能版_功能交互 [PRD]

| 文档版本 | V27.0 |
| :--- | :--- |
| 文档状态 | **已发布** |
| 撰写日期 | 2026-01-26 |
| 密级 | 内部绝密 |

---

## 1. 产品概述
**AEKE Coach** 是一款基于运动科学与 AI 算法的智能健身生成器。它通过多模态交互（语音/触控）收集用户数据与即时需求，利用八层决策模型实时生成个性化的单次课程或周期性训练计划，并提供可视化的推理过程与专业级的执行监控。

---

## 2. 功能架构

### P1. AI教练首页
1.  **虚拟形象**
    *  互动特效：等待、聆听、思考、表达。[新增]
2.  **快捷入口**
    *  给我一节课：点击“给我一节课”。[优化]
    *  给我一份计划：点击“给我一份计划”。[新增]
    *  自定义课程模板：点击“自定义课程模板”。[新增]
3.  **状态概览**
    *  档案信息：展示档案信息（不可编辑），如档案不全引导更新。 [优化]

### P2. 运动档案
1.  **档案更新**
    *  基础信息：性别、身高、体重等。 [优化]
    *  运动偏好：运动水平、每周训练日、训练周频等。 [优化]
    *  目标设置：主要目标、功能目标、目标体重等。 [优化]

### P3. AI教练对话
1.  **对话流交互**
    *   历史记录：展示问答上下文。[新增]
    *   输入状态：AI思考与打字动效。[新增]
2.  **多模态输入**
    *   语音转文字：实时语音识别输入。[新增，1.0不开发]
    *   问答选项：快捷点击选项标签。 [新增]
    *   数值控件：调整输入数值。 [新增]
3.  **推理可视化**
    *   推理演示：展示 AI 的决策逻辑日志。[新增]

### P4. 运动处方
1.  **课程详情**
    *   课程概览：课程名称、难度、时长标签。 [优化]
    *   课程数据：动作数、总容量、卡路里预估。 [优化]
    *   环节流程/导航：热身、主训、放松环节展示与切换。[新增]
    *   动作列表：动作卡片折叠/展开、动作替换、排序。[新增]
    *   动作编辑：组数、重量、次数/时长。[新增]
    *   负荷策略：推荐/恒定/递增/递减/自定义。[新增]
    *   循环模式：常规/循环。[新增]
    *   休息设置：组间休息、轮间休息。[新增]
2.  **计划详情**
    *   计划概览：周期、频率、痛点与效果描述。 [新增]
    *   体重预测图：基于计划效果的趋势预测。[新增]
    *   阶段流程/导航：适应期、进阶期、突破期、减载期阶段展示与切换。[新增]
    *   计划周历：每日训练安排查看与课程详情查看。[新增]

### P5. 训练执行
1.  **课程素材**
    *   动作演示：标准动作循环播放。[已有]
    *   状态遮罩：倒计时、休息中状态。[已有]
2.  **力量模组**
    *   重量表盘：滑块调节、+-按钮调节。[已有]
3.  **可视化数据**
    *   功率图表：实时左右侧功率。[已有]
    *   行程曲线：动作位移曲线。[已有]
4.  **课程交互**
    *   动作列表：课程进度、快速跳转 [已有]、替换动作。 [新增]
    *   课程控制：暂停、结束。[已有]

### P6. 动作库
1.  **筛选与列表**
    *   动作筛选：部位、器械、难度筛选。[已有]
    *   动作列表：动作卡片展示与状态标记。[优化]
2.  **动作详情**
    *   动作概览：动作名称、动作视频、动作标签、参与肌群、动作说明。[优化]
    *   动作教学：教学视频、动作要点、常见错误。[新增]
    *   历史数据：预估1RM、近期变化、训练记录。[已有]

---

## 3. 业务流转

### 3.1 主线 A：生成单节课
> **场景**：用户今天想练一次，目标明确或模糊。

1.  **[P1. AI教练首页]**
    *   点击“给我一节课”。
    *   按钮/语音。
2.  **[P2. AI教练对话]**
    *   确认训练类型、部位、时长。
    *   选择、控件完成输入。
    *   展示“推理演示”过程。
3.  **[P3. 运动处方]**
    *   查看“头部信息”与“动作列表”。
    *   调整负荷或循环模式。
4.  **[P4. 训练执行]**
    *   跟随“动作演示”进行训练。
    *   实时查看“功率图表”数据。
    *   暂停或结束训练。

### 3.2 主线 B：生成计划
> **场景**：用户希望制定长期的训练目标（如4周增肌）。

1.  **[P1. AI教练首页]**
    *   点击“给我一份计划”。
2.  **[P2. AI教练对话]**
    *   确认计划周期与频率。
    *   使用“数值滑块”设定参数。
    *   展示“推理演示”过程。
3.  **[P3. 运动处方]**
    *   预览“计划概览”与“阶段流程”。
    *   在“计划周历”中确认每日安排。
4.  **[P4. 加入日程]**
    *   选择“加入日程”。

---

# 4. 页面详细说明

## P1. AI教练首页
![alt text](111.png)
> **定义**：用户与 AI 教练建立连接的初始触点，承载了“会话激活”、“状态概览”与“业务分流”三大核心职能。
> **页面状态**：分为 **[静默态]** (初始加载) 与 **[激活态]** (点击启动后) 两种视图模式。

### 1. 虚拟形象（此处仅参考，以UI设计为准）
> **场景**：用户首次进入应用，系统处于静默待机状态，等待用户授权与唤醒。

#### 1.1 启动与激活 (静默态)
*   **UI形态**：屏幕正中央的圆形交互区域。
    *   **图标**：麦克风 (🎙️) 图标，默认带有灰度滤镜。
    *   **主文案**：“点击开启麦克风权限”。
    *   **副文案**：“激活 AI 智能教练”。
    *   **版本号**：底部显示当前系统版本 (如 V27.0)。
*   **交互逻辑**：
    *   **点击行为**：用户点击按钮区域。
    *   **响应动作**：
        1.  **权限请求**：请求麦克风录音权限。
        2.  **视图切换**：启动按钮隐藏。
        3.  **内容加载**：
            *   顶部“主动交互区” 执行上滑淡入动画。
            *   底部“档案卡片”执行上滑淡入动画从底部滑出。
        4.  **语音初始化**：
            *   初始化语音识别引擎。
            *   自动开启监听模式。
            *   **主动问候**：延迟 500ms 后，AI 随机播放一条问候语。

#### 1.2 状态机定义 (激活态)
系统根据语音模块的实时状态，驱动容器产生以下视觉变化：

*   **待机态**
    *   **触发条件**：系统初始化完成，或语音播报结束且未开启监听。
    *   **视觉表现**：
        *   **光球**：中心光球进行缓慢的呼吸律动 (缩放 0.8 -> 1.1)。
        *   **轨道**：三层轨道环以不同速率匀速旋转，透明度较低。
*   **聆听态**
    *   **触发条件**：语音识别处于监听中，或检测到声波输入。
    *   **视觉表现**：
        *   **光球**：颜色向强调色偏移，执行高频脉冲动画。
        *   **轨道**：轨道环透明度提升，旋转速度加快，轨道上的粒子放大并高亮。
*   **表达态**
    *   **触发条件**：AI 正在播放 TTS 语音。
    *   **视觉表现**：
        *   **光球**：体积显著放大 (Scale 1.2)，模拟声波震动幅度。
        *   **轨道**：轨道环收缩并高亮，粒子产生拖尾光效。
*   **思考态**
    *   **触发条件**：语音输入结束，正在请求推理或生成结果。
    *   **视觉表现**：光球执行特定的闪烁或脉冲动画。

#### 1.3 字幕回显
*   **位置**：AI 问候语下方。
*   **逻辑**：
    *   当用户说话时，实时显示语音转文字 (STT) 的中间结果。
    *   当识别到特定关键词（如“一节课”、“计划”）时，触发业务跳转，字幕清空。

### 2. 快捷入口
> **场景**：页面处于[激活态]，用户选择训练模式。

#### 2.1 给我一节课程
*   **逻辑**：点击触发单次课程生成流程。
*   **前置校验**：检查用户档案中 `功能目标` 是否存在。
    *   **通过**：进入“AI 教练对话”页面，开始单次课程生成流程。
    *   **失败**：弹出“请更新运动档案”提示，自动打开档案编辑弹窗并定位至“目标”标签页。
#### 2.2 给我一份计划
*   **逻辑**：点击触发周期计划生成流程。
*   **前置校验**：同上。通过后进入“AI 教练对话”页面，开始周期计划生成流程。

#### 2.3 自定义课程模板
*   **逻辑**：点击触发自定义流程。
*   **行为**：跳过 AI 问询，直接生成一个包含 [热身/主训/放松] 的空白课程结构，跳转至“课程结果页”供用户手动编排。

## P2. 运动档案
![alt text](222.png)
> **定义**：常驻页面底部的用户状态看板，支持快速查看与编辑。
卡片包含以下四个关键维度：
*   **主要目标**：直接读取用户档案中的 `主要目标` (如：增肌)。
*   **运动等级**：读取用户等级并进行文本映射。
    *   `L1`, `L2` -> 显示为 **"初级"**。
    *   `L3`, `L4` -> 显示为 **"中级"**。
    *   `L5` -> 显示为 **"高级"**。
*   **当前体重**：读取用户体重，单位固定为 `kg`。
*   **主观疲劳度**：读取用户疲劳度评分 (1-10)，并根据配置计算状态标签与颜色。
    *   **区间映射**：
        *   `85-100` (疲劳度 1-2) -> **"已恢复"** (绿色)。*(注：此处逻辑为反向映射，低疲劳分值对应高身体状态分值)*。
        *   `55-84` (疲劳度 3-5) -> **"恢复中"** (绿色/黄色)。
        *   `30-54` (疲劳度 6-7) -> **"疲劳中"** (黄色)。
        *   `0-29` (疲劳度 8-10) -> **"已力竭"** (红色)。

## P2. 运动档案
![alt text](222.png)
> **定义**：支持快速查看与编辑用户数据。

### 1. 档案更新
点击“更新 >”按钮唤起模态框，包含以下高阶逻辑：

#### A. 疲劳度滑块（1.0不做）
*   **交互**：用户拖动 1-10 的滑块。
*   **实时反馈**：
    *   **数值**：实时更新显示的数值与状态标签。
    *   **说明**：下方动态显示该状态对应的算法系数 (如 "强度系数:0.8, 容量系数:0.8")。
    *   **视觉**：滑块轨道颜色根据状态值在 绿/黄/红 之间渐变。

#### B. 参数自动计算
在“基础”标签页中，输入项变更会触发以下参数的实时重算：
*   **BMI**：`体重(kg) / (身高(cm)/100)²`。
    *   **阈值反馈**：若 BMI > 24，数值颜色变红 (提示超重风险)。
*   **最大心率 (MHR)**：`208 - (0.7 * 年龄)`。
    *   *注：年龄由“生日”字段动态计算得出。*

#### C. 偏好设置 (多选逻辑)
*   **每周训练日**：支持点击星期芯片 (周一至周日) 进行多选。
    *   **选中态**：高亮显示，副标题显示“训练”。
    *   **未选态**：灰度显示，副标题显示“休息”。
*   **疼痛部位/缺失配件**：点击芯片进行选中/取消操作，数据实时写入用户档案对象。



## P3. AI教练对话
生成课程：![alt text](333.png)
生成计划：![alt text](555.png)
> **定义**：模拟真人私教的问诊式交互模块，通过语音与触控的多模态输入，完成用户训练意图的精准捕获与参数确认。
> **核心机制**：对话流引擎 + 多模态意图识别 + 智能风控拦截。

### 1. 对话流交互
> **场景**：用户点击首页“给我一节课”或“给我一份计划”后进入。

#### 1.1 顶部导航栏
*   **退出交互**：左上角显示“✕ 退出”按钮，点击后中断当前会话，清空临时数据并返回首页。
*   **状态指示**：标题旁设有“AI Status Dot”呼吸灯。
    *   **脉冲动画**：表示 AI 正在活跃（监听或思考）。
    *   **常亮/熄灭**：表示 AI 处于待机或离线状态。

#### 1.2 对话流容器 (Chat Stream)
*   **历史记录**：垂直滚动区域，存放 AI 提问气泡（左侧）与用户回答气泡（右侧）。
*   **自动对齐**：
    *   **逻辑**：每当 AI 发出新问题时，系统自动计算气泡位置，平滑滚动容器，使最新气泡的顶部与视线锚点对齐。
    *   **目的**：确保用户始终聚焦于当前交互焦点，避免手动频繁滚动。
*   **底部摘要**：
    *   **位置**：悬浮于输入区上方。
    *   **内容**：实时以标签形式展示已确认的参数（如“增肌 + 胸部 + 30分钟”），随对话进度动态追加。

#### 1.3 底部输入区
*   **麦克风按钮**：底部中央常驻的圆形悬浮按钮。
    *   **状态反馈**：监听时显示高亮光环与脉冲动效。
    *   **交互**：点击切换 监听/停止 状态。
*   **动态面板**：位于麦克风上方，根据当前问题类型动态渲染交互组件（选项芯片或滑块）。

#### 1.4 对话流引擎逻辑
> **配置源**：基于 `CONFIG.FLOWS` 定义的决策树。

*   **流程初始化**
    *   **单课模式**：按序确认 `训练类型` -> `目标部位` -> `训练时长`。
    *   *特殊分支*：若类型选择 HIIT/有氧/搏击，系统自动跳过“部位选择”步骤（默认全身），直接进入时长选择。
    *   **计划模式**：按序确认 `计划周期` -> `每周频次` -> `单次时长`。

*   **提问生成机制**
    *   **打字机效**：AI 气泡内容执行逐字输出动画，模拟真人输入节奏，高度随内容自动撑开。
*   **多变话术**：同一问题（如询问时长）随机调用配置库中的不同文案变体（如“今天有多少时间？”或“打算练多久？”），拒绝机械感。
*   **思考状态**：在生成回复前，短暂展示包含三个跳动圆点的“正在输入”气泡。

### 2. 多模态输入
> **核心逻辑**：语音输入优先，触控输入兜底，两者实时互通。

#### 2.1 触控交互组件
*   **智能芯片**：
    *   **单选逻辑**：点击即选中，并自动触发“确认”操作进入下一步。
    *   **多选逻辑**：点击切换选中/取消状态，需手动点击下方的“确认”按钮提交。
    *   **互斥处理**：在“每周训练日”选择中，若存在“全选”或“清空”类选项，点击时自动处理互斥逻辑。
*   **数值滑块**：
    *   **场景**：用于时长（20-90min）或周期（1-12周）的连续数值选择。
    *   **交互**：支持拖拽滑块或点击轨道，数值实时显示在标题栏，点击“确认”提交。

#### 2.2 语音意图识别
*   **实时听写**：用户说话时，界面生成临时的“绿色半透明”气泡，实时显示语音转文字（STT）的中间结果。
*   **语义解析逻辑**：
    *   **实体提取**：模糊匹配选项关键词。例如用户说“我想练胸和背”，系统自动识别并选中“胸部”和“背部”。
    *   **数值转义**：自动将中文数字（如“三十分钟”、“两周”）转换为阿拉伯数字。
    *   **集合指令**：
        *   识别“周末” -> 自动选中 周六、周日。
        *   识别“工作日” -> 自动选中 周一至周五。
        *   识别“天天练” -> 全选所有日期。
    *   **修正指令**：
        *   “重选/不对” -> 触发“上一步”逻辑。
        *   “退出/取消” -> 触发“退出”逻辑。
*   **容错处理**：若语音无法匹配任何有效选项，AI 播放错误提示语（如“没听清，请再说一遍”），并保留当前选项面板供用户重试。

#### 2.3 智能风控与拦截
> **场景**：当用户试图训练处于疲劳状态的部位时触发。

*   **触发机制**
    *   在“目标部位”选择步骤，系统校验用户选择的部位是否包含在[疲劳部位列表]中。

*   **拦截交互**
    1.  **中断流程**：不直接进入下一步，而是插入一条 AI 警告气泡。
2.  **话术生成**：动态生成提示语，例如：“注意，数据显示你的**胸部**尚未完全恢复。为了安全，建议今天改练**背部**。”
3.  **决策分支**：
    *   **切换推荐**：提供高亮按钮“切换为{推荐部位}”，点击后修改目标并继续。
    *   **坚持原选**：提供次级按钮“坚持练{原部位}”，点击后维持原目标并继续（但在后续生成逻辑中可能会触发降级保护）。

### 3. 推理可视化
*   **完成判定**：当决策树所有步骤均获得有效输入后。
*   **过渡反馈**：
    1.  AI 播放结束语（如“收到，正在为你构建专属方案...”）。
    2.  界面展示最终确认气泡。
*   **视图切换**：延迟 600ms - 2000ms 后，自动跳转至“推理可视化”页面，开始生成计算。
  

## P4. 运动处方

> **定义**：展示 AI 生成的训练方案核心内容的页面，分为 **[单课模式]** (Course Mode) 与 **[计划模式]** (Plan Mode) 两种形态。
> **核心职能**：方案预览、参数微调、逻辑可视化与执行入口。

### 1. 课程详情
![alt text](444.png)
> **场景**：用户通过“给我一节课”生成，或在计划周历中点击单日课程进入。

#### 1.1 头部概览
*   **课程英雄卡 (Hero Card)**
    *   **标题**：展示课程名称（如“胸部增肌入门”），支持点击展开/收起头部以节省空间。
    *   **标签**：展示 `运动等级` (如 L3)、`总时长` (min)、`目标部位` (如 胸部、三头)。
    *   **简介**：展示课程的针对性描述（如“本课程针对胸部设计，旨在通过抗阻训练提升增肌能力”）。
*   **数据统计栏 (Stats Bar)**
    *   **时长**：所有环节（热身+主训+放松）的总耗时（含动作执行与休息时间）。
    *   **动作**：课程包含的动作总数量。
    *   **容量**：所有动作的总组数之和。
    *   **消耗**：预估卡路里消耗，计算公式：`0.075 * 体重(kg) * 时长(min)`。
*   **单位切换**：右上角提供 `KG/LBS` 切换开关，点击后全局重量数值实时换算（1kg ≈ 2.2lbs）。

#### 1.2 环节流程/导航
*   **吸附式导航**
    *   **结构**：展示 [热身]、[主训]、[放松] 三个环节，并显示各环节的预估时长。
    *   **交互**：点击切换下方动作列表内容，页面自动滚动至列表顶部。
*   **微调控制台**
    *   **位置**：位于动作列表顶部。
    *   **全局参数控制**：
        *   **负荷策略**：下拉选择（推荐/恒定/递增/递减/自定义）。修改后触发当前环节所有动作的组间负荷重算。
        *   **循环模式**：下拉选择（常规组/循环组）。影响组间休息与轮间休息的生效逻辑。
        *   **休息时间**：
            *   **组间**：动作内组与组之间的休息时长。
            *   **轮间**：动作与动作之间（或循环大轮次间）的过渡时长。
    *   **添加动作**：提供“+ 添加动作”按钮，点击跳转至动作库，添加新动作至当前环节末尾。

#### 1.3 动作列表与编辑
*   **动作卡片**
    *   **信息区**：展示缩略图、动作名称、部位标签、主动肌标签。
    *   **摘要**：展示 `组数` 及 `关键负荷`（如 "4组 20kg/12次"）。
    *   **快捷工具**：
        *   **排序**：上移/下移按钮，调整动作执行顺序。
        *   **替换**：点击“↻”按钮，进入动作库替换当前动作（保持原槽位属性）。
        *   **删除**：右上角“✕”按钮，移除该动作。
        *   **展开/折叠**：点击卡片主体展开详细组数据。
*   **组详情编辑**
    *   **组列表**：逐行展示每一组的配置。
    *   **步进器**：
        *   **重量/负荷**：支持 `+/-` 微调，KG模式步进0.5，LBS模式步进1。
        *   **次数/时长**：支持 `+/-` 微调，步进为1。
        *   **联动逻辑**：若当前策略为“推荐”，手动修改数值会自动将策略切换为“递增”或“自定义”，并触发插值计算。
    *   **操作**：支持单组删除、底部“+ 加一组”。
    *   **底部栏**：
        *   **强度指标**：显示当前负荷占 1RM 的百分比（如 "75%"）。
        *   **RPE**：显示预估的自觉疲劳度（如 "8"）。
        *   **重置**：点击“↺ 重置”将该动作的所有参数恢复至 AI 初始推荐值。
        *   **详情跳转**：点击“查看动作详情”打开动作教学模态框。

#### 1.4 底部操作
*   **单课模式**：显示“开始训练”按钮，点击进入训练执行页面。
*   **计划内课程**：显示“开始训练”按钮，但左上角提供“← 返回计划”导航。

#### 1.5 负荷策略 (Load Strategy)

> **定义**：控制单个动作在不同组数之间负荷（重量/次数/时长）的变化趋势与联动逻辑。
> **适用范围**：所有训练环节中的动作（热身、主训、放松）。

##### 1. 策略类型定义
系统支持以下五种负荷变化策略，用户可在课程微调控制台进行全局或单动作切换：

*   **推荐**
    *   **逻辑**：完全回滚至 AI 算法初始生成的推荐数值（包含重量、次数及组数安排）。
    *   **场景**：用户希望重置所有手动修改，恢复到系统默认建议状态。
*   **恒定**
    *   **逻辑**：锁定所有组的负荷数值保持一致。
    *   **场景**：适合力量耐力训练或新手入门，无需频繁调整重量。
*   **递增**
    *   **逻辑**：负荷逐组上升（正金字塔结构），最后一组达到最大负荷。
    *   **场景**：适合肌肥大训练，通过预疲劳逐步冲击大重量。
*   **递减**
    *   **逻辑**：负荷逐组下降（倒金字塔结构），第一组即为最大负荷。
    *   **场景**：适合爆发力训练或力竭组后的降重组。
*   **自定义**
    *   **逻辑**：解除组与组之间的数值联动，用户可自由编辑每一组的数据。
    *   **场景**：高级用户进行特定编排（如波浪式负荷）。

##### 2. 策略切换逻辑 (自动计算)
当用户从一种策略切换到另一种策略（非“推荐”和“自定义”）时，系统遵循**“锚点锁定”**原则重新计算所有组的数值，以保证训练强度不掉阶。

###### 2.1 锚点确定
*   系统遍历当前动作的所有组，取**数值最大**的一组作为基准锚点（Target Load）。
*   *注：无论之前是递增还是递减，切换时都以用户设定过的“最重一组”为标准。*

###### 2.2 步进计算
*   **力量动作**：取 `1RM 的 5%` 与 `最小调节单位`（0.5kg 或 1lbs）中的较大值。
*   **自重/计时动作**：取 `锚点值的 10%` 与 `1` 中的较大值。

###### 2.3 序列生成公式
设总组数为 `N`，当前组索引为 `i` (从0开始)：
*   **切换至“恒定”**：
    *   所有组的数值直接等于锚点值。
*   **切换至“递增”**：
    *   以锚点值为**最后一组**的数值，向前逐组减去一个步进值。
    *   公式：`Value(i) = Anchor - (N - 1 - i) * Step`
*   **切换至“递减”**：
    *   以锚点值为**第一组**的数值，向后逐组减去一个步进值。
    *   公式：`Value(i) = Anchor - i * Step`

##### 3. 手动微调与联动逻辑
当用户在界面上直接修改某一组的负荷数值时，系统根据当前策略触发不同的联动反应：

*   **推荐策略下的修改**：
    *   若用户修改了数值，策略状态自动变更为**“递增”**。
    *   系统随即应用“递增”策略的插值逻辑（见下条）。
*   **递增/递减策略下的插值**：
    *   **触发条件**：动作总组数大于 2 组。
    *   **逻辑**：当用户修改了**第一组**或**最后一组**的数值时，系统会自动计算中间组的数值。
    *   **算法**：采用线性插值法，保持首尾数值不变，让中间组的数值在首尾之间均匀平滑过渡。
*   **恒定策略下的修改**：
    *   修改任意一组的数值，系统会自动将其他所有组同步更新为该数值。
*   **自定义策略下的修改**：
    *   仅更新当前组的数值，不触发任何联动。

##### 4. 衍生参数联动 (RM 反推)
针对**抗阻范式**下的非计时动作（即常规力量训练），负荷（重量）与次数存在强关联：

*   **重量 -> 次数**：当上述任何逻辑导致“重量”发生变更时，系统会自动根据用户的 1RM 数据和 Epley 公式，反推该重量下的建议重复次数（Reps）。
*   **逻辑**：确保在重量增加时建议次数减少，重量减少时建议次数增加，以维持相对恒定的训练强度（RPE）。

##### 5. 单位适配
*   **最小精度**：
    *   公斤 (KG) 模式下，重量调整精度为 0.5。
    *   磅 (LBS) 模式下，重量调整精度为 1。
    *   次数/时长调整精度为 1（整数）。

#### 1.6 循环模式 (Loop Mode)

> **定义**：控制环节内动作的执行顺序、组间切换逻辑及休息时间的分配规则。
> **适用范围**：所有训练环节（主要用于主训环节）。
> **配置入口**：课程结果页 -> 环节微调控制台 -> 循环模式下拉框。

##### 1. 模式定义
系统支持以下两种核心循环模式：

*   **常规组 (Regular)**
    *   **逻辑**：顺序执行。完成当前动作的所有组数后，再进入下一个动作。
    *   **场景**：适合肌肥大（增肌）、力量举等需要肌肉充分疲劳与恢复的训练。
*   **循环组 (Circuit)**
    *   **逻辑**：交替执行。依次完成环节内所有动作的第一组，再进行第二组的循环，直至所有动作完成。
    *   **场景**：适合减脂、心肺耐力、HIIT等追求高密度、高心率的训练。
    *   *注：超级组在逻辑上视为包含2个动作的循环组。*

##### 2. 执行序列逻辑
假设当前环节内有 2 个动作 (Action A, Action B)，每个动作计划执行 3 组。

###### 2.1 常规组
*   **执行路径**：纵向深钻。
*   **序列**：
    `A1` -> [组间休息] -> `A2` -> [组间休息] -> `A3` -> **[轮间休息/转场]** -> `B1` -> [组间休息] -> `B2` -> [组间休息] -> `B3`

###### 2.2 循环组
*   **执行路径**：横向扫描。
*   **序列**：
    `A1` -> [组间休息/换项] -> `B1` -> **[轮间休息/大休]** ->
    `A2` -> [组间休息/换项] -> `B2` -> **[轮间休息/大休]** ->
    `A3` -> [组间休息/换项] -> `B3`

##### 3. 休息时间应用规则
系统根据当前模式，动态分配“组间休息”与“轮间休息”的生效时机：

| 时间参数 | 常规模式| 循环模式|
| :--- | :--- | :--- |
| **组间休息 (Rest)** | **同动作内**：组与组之间的恢复时间 (如 A1->A2)。 | **动作切换时**：不同动作间的过渡时间 (如 A1->B1)。 |
| **轮间休息 (RestRound)** | **动作切换时**：完成上一个动作所有组后，切换到下一个动作前的转场时间 (如 A->B)。 | **大轮次结束时**：完成一整轮所有动作后，进入下一轮前的大休息 (如 Round 1 -> Round 2)。 |

##### 4. 异常处理逻辑 (非对等组数)
当环节内不同动作的组数不一致时（例如：动作 A 有 3 组，动作 B 有 4 组），循环模式遵循**“跳过已完成”**原则：

*   **逻辑**：
    1.  **第 1-3 轮**：正常循环执行 (A+B)。
    2.  **第 4 轮**：系统检测到动作 A 的当前组索引 (4) 已超过其总组数 (3)，自动跳过动作 A，仅执行动作 B。
*   **UI表现**：
    *   在训练执行界面，动作 A 在第 4 轮不出现，直接进入动作 B 的执行流程。
    *   进度条与总时长计算需包含这部分逻辑。

### 2. 计划详情
![alt text](666.png)
> **场景**：用户通过“给我一份计划”生成周期性方案。

#### 2.1 计划概览
*   **标题规则**：`{等级}{目标}计划`（如“中级增肌计划”）。
*   **标签**：展示 `等级`、`周期` (周)、`频次` (天/周)。
*   **介绍文案**：结构化展示“适应人群”、“解决痛点”及“预期效果”。

#### 2.2 阶段流程与趋势
*   **体重预测图 (Weight Chart)**
    *   **可视化**：SVG 折线图，展示从当前体重到目标体重的变化趋势。
    *   **节点逻辑**：X轴为周数，Y轴为体重。曲线斜率根据各阶段的训练重点（如“减载期”平缓，“突破期”陡峭）动态计算。
    *   **交互联动**：高亮显示当前选中阶段对应的曲线区间。
*   **阶段导航 (Phase Flow)**
    *   **形态**：箭头流程图形式的 Tab 栏（如 适应期 → 进阶期 → 突破期）。
    *   **信息**：显示每个阶段的名称、持续周数及强度系数。
    *   **交互**：点击切换下方周历视图的内容，并更新预测图高亮区域。
*   **阶段描述**：动态展示当前选中阶段的训练侧重点（如“建立神经适应，激活目标肌群...”）。

#### 2.3 训练周历
*   **视图结构**：展示当前选中阶段的典型一周安排（周一至周日）。
*   **日期卡片**：
    *   **训练日**：高亮显示。
        *   **标题**：`{部位}{阶段后缀}`（如“胸部训练”、“胸部突破”）。
        *   **副标**：显示训练等级。
        *   **交互**：点击卡片**下钻**进入该日的 [课程详情页]，进行内容预览或微调。
    *   **休息日**：置灰显示，仅展示“休息”字样。
*   **数据一致性**：周历中的训练日安排严格遵循用户档案中的“每周训练日”偏好。

#### 2.4 底部操作栏
*   **加入日程**：点击后将生成的计划写入用户日历，并跳转至“日程视图”确认。
*   **重置**：左下角提供重置按钮，返回首页重新生成。


## P6. 动作库

> **定义**：全量动作数据的聚合中心，提供多维度的筛选、检索、预览及决策支持功能。
> **核心职能**：支持“添加动作”与“替换动作”两种业务场景，连接课程编排与底层数据库。

### 1. 筛选与列表

#### 1.1 入口与上下文
动作库根据进入场景的不同，初始化状态会有所差异：

*   **添加模式**
    *   **入口**：课程结果页 -> 环节控制台 -> “+ 添加动作”按钮。
    *   **初始状态**：
        *   **筛选器**：默认选中当前课程的 `首要目标部位`（如课程练胸，默认筛选“胸部”）。
        *   **选中态**：清空所有选中项。
    *   **行为**：支持**多选**。确认后将所有选中动作追加至当前环节的末尾。
*   **替换模式**
    *   **入口**：
        1.  课程结果页 -> 动作卡片 -> “↻” 替换按钮。
        2.  训练执行页 -> 动作列表浮层 -> “↻” 替换按钮。
    *   **初始状态**：
        *   **筛选器**：默认选中被替换动作的 `部位`。
        *   **选中态**：默认选中被替换的动作（作为锚点）。
    *   **行为**：仅限**单选**。确认后用新动作覆盖原动作槽位，并继承原动作的组数设置（若兼容）。

#### 1.2 快捷筛选
*   **维度**：**部位 (Part)**。
*   **选项**：全部、胸部、背部、腿部、臀部、肩部、手臂、核心。
*   **交互**：横向滚动条，点击单选。切换部位后实时刷新列表。

#### 1.3 高级筛选
点击右侧“≡”按钮展开面板，支持多维度交叉筛选：
*   **配件**：自重、横杆、手柄、健身凳、泡沫轴、哑铃等。
*   **难度**：L1 (入门) - L5 (挑战)。
*   **冲击**：无冲击、低冲击、高冲击。
*   **逻辑**：
    *   维度之间为 **AND** 关系（如：胸部 + 哑铃 + L3）。
    *   维度内部为 **OR** 关系（如：哑铃 或 横杆）。
*   **操作**：提供“重置”与“收起”按钮。

#### 1.4 列表展示逻辑
*   系统根据动作的 `主要功能` 字段进行聚合展示。
*   **分组标题**：如 “增肌”、“力量”、“塑形”、“激活” 等。
*   **排序**：组内按匹配度分数降序排列（优先展示高分动作）。

#### 1.5 动作单元
每个列表项包含以下信息：
*   **视觉**：动作缩略图。
*   **标题**：动作名称。若为镜像动作，名称后跟随“镜像”标签。
*   **元数据**：`部位` · `主动肌` · `主要器械` · `难度等级`。
*   **交互状态**：
    *   **未选**：右侧显示空心圆圈。
    *   **选中**：背景色变为浅绿色，右侧显示实心对勾。
    *   **点击区域**：
        *   点击**整体**：打开“动作详情”模态框。
        *   点击**右侧勾选区**：触发选中/取消选中逻辑。

### 2. 动作详情
> **定义**：全屏模态框，提供决策所需的深度信息。
> **结构**：顶部视频区 + 底部 Tab 切换区。

#### 2.1 动作概览 (简介)
*   **内容**：循环播放动作的标准演示视频。
*   **覆盖层**：若为“教学”Tab，则播放详细教学视频（含语音讲解）。
*   **头部**：动作名称、标签墙（部位/构造/难度/镜像）。
*   **基本参数**：
    *   **器械**：如“横杆”。
    *   **冲击**：如“低冲击”。
    *   **范式**：如“抗阻”。
*   **肌群映射**：
    *   **主动肌**：高亮显示，如“胸大肌中束”。
    *   **拮抗肌**：如“背阔肌”。
    *   **辅助肌**：如“肱三头肌”。
    *   **稳定肌**：如“核心肌群”。
*   **动作说明**：基于模板生成的自然语言描述（如“杠铃卧推是一个经典的胸部训练动作...”）。

#### 2.2 动作教学
*   **动作要点**：结构化的关键步骤说明（如“保持核心收紧”、“离心阶段控制2-3秒”）。
*   **常见错误**：高亮显示的易错点（如“手腕折叠”、“腰背过度拱起”）。

#### 2.3 历史数据
*   **1RM 趋势图**：柱状图展示该动作的预估 1RM 变化趋势。
*   **近期变化**：展示近1周、1月、3月的能力值涨跌幅（如“+5%”）。
*   **训练记录**：列表展示最近几次执行该动作的日期与最大负荷。

#### 2.4 底部操作栏
*   **按钮**：显示“+ 添加动作”或“确认替换”。
*   **逻辑**：点击后执行选择逻辑并自动关闭详情页。

#### 2.5 确认与回调逻辑
当用户点击列表页或详情页的“确认”按钮后：

1.  **数据更新**：
    *   **添加**：将选中动作的完整数据模型追加到目标环节数组。
    *   **替换**：将目标索引处的旧动作替换为新动作。
2.  **参数重算**：
    *   **负荷策略**：触发初始化，根据新动作的 1RM 和当前环节强度，重新计算建议负荷（重量/次数）。
    *   **时长估算**：若为自定义课程，重新累加计算环节时长与课程总时长。
3.  **视图路由**：
    *   若来源是“课程结果页”，返回并刷新该页面。
    *   若来源是“训练执行页”，返回训练页，并若被替换的是当前正在执行的动作，则重置当前组状态。

---
