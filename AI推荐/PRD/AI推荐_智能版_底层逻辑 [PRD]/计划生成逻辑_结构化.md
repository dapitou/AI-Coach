# 计划生成逻辑
> **文档用途**：本文档是算法落地的“施工图纸”。
> - **产品经理**：请重点关注“业务导读”和“场景示例”，确认逻辑是否符合业务预期。
> - **开发人员**：请重点关注“输入/输出”和“处理逻辑”，这是代码实现的直接依据。
> **设计原则**：高内聚，低耦合。每个节点仅依赖明确的输入，产出标准化的输出。

## 节点流转总览
```mermaid
graph LR
    N1[输入与上下文] --> N2[计划确认]
    N2 --> N3[阶段确认]
    N3 --> N4[模板匹配与排期]
    N4 --> N5[用户微调]
    N5 --> N6[数据装配]
```

---

## 节点 1: 输入与上下文
> 定义：收集并清洗所有影响计划生成的外部变量，构建统一的“约束上下文”。
> > *业务导读*：就像教练在制定长周期计划前的“摸底访谈”。系统需要收集你的基本信息、目标（增肌还是减脂）、时间预算（练几周、每周练几天），以及当前的身体状态（是否疲劳），把这些信息打包，作为后续生成计划的地基。

### 1. 输入数据
- **用户档案** (来源: 运动档案)：
    -   *基础数据*：`性别`、`生日`、`身高`、`体重`、`BMI`。
    -   *偏好设置*：`运动等级`、`每周运动频率`、`每周训练日`、`每日运动时长`、`没有的器械`、`疼痛部位`。
    -   *目标设定*：`主要目标`、`功能目标`。
- **计划参数** (来源: 用户输入)：
    -   `计划周期` (1-24周)、`单课时长` (20-60分钟)、`计划开始日期` (YYYY-MM-DD)。
- **状态数据** (来源: 疲劳管理)：`综合疲劳度`。

### 2. 处理逻辑
1.  **步骤 1: 数据完整性校验**
    > *目的：确保生成计划所需的基础档案数据完备。*
    -   **完整性检查**：验证核心档案字段是否存在。
        -   *规则*：检查档案中 `性别`、`BMI`、`运动等级`、`主要目标`、`功能目标`、`每周运动频率`、`每周训练日` 是否存在。
    -   **缺失处理**：处理数据缺失情况。
        -   *规则*：若缺失，中断流程并引导用户补全档案。

2.  **步骤 2: 疲劳风控推荐**
    > *目的：基于用户当前的身体状态，智能调整计划的启动时机。*
    -   **状态读取**：获取当前疲劳数据。
        -   *规则*：读取 `综合疲劳度` 数据。
    -   **风险判断**：识别是否处于疲劳状态。
        -   *规则*：若 `综合疲劳度` < 55 (全身疲劳/力竭)。
    -   **干预执行**：给出调整建议。
        -   *规则*：推荐将 `计划开始日期` 推迟 1-2 天。

3.  **步骤 3: 上下文合并**
    > *目的：打包用户输入与档案数据，构建统一的约束对象。*
    -   **对象构建**：整合所有输入信息。
        -   *规则*：打包用户输入与档案数据，构建 `计划约束对象`。

### 3. 输出数据
- **约束对象** (流转至: 节点 2)：
    -   *推荐标签*：`计划目标`、`计划周期`。
    -   *基础信息*：`起始日期`、`可用时间` (频率/时长/训练日)。
    -   *约束条件*：`禁忌部位`。

### 4. 场景示例
> **场景**：用户想练4周增肌，但刚结束高强度深蹲训练（全身疲劳）。
> - **输入**：主要目标="增肌"，功能目标="增肌"，周期=4周，疲劳="全身力竭"。
> - **输出**：
>   - `计划目标`: 增肌 (主要目标)
>   - `计划功能目标`: 增肌
>   - `起始日期`: 推荐推迟
>   - `计划周期`: 4

---

## 节点 2: 计划确认
> 定义：确定计划的宏观元数据，为后续阶段划分定调。
> > *业务导读*：确定大方向。根据你的档案，决定给你生成一个什么样的长线计划。是“增肌”还是“减脂”？是“新手入门”还是“大神进阶”？同时决定是用稳健的线性周期，还是波动的波浪周期。

### 1. 输入数据
- **约束对象** (来源: 节点 1)。
- **用户档案** (来源: 运动档案)：
    -   *目标设定*：`主要目标`、`功能目标`。
    -   *偏好设置*：`运动等级`。

### 2. 处理逻辑
1.  **步骤 1: 目标对齐**
    > *目的：将用户的运动目标映射为计划的属性参数。*
    -   **主目标映射**：设定计划的一级分类目标。
        -   *规则*：`计划.计划目标` = `档案.主要目标` (如 "增肌")。
    -   **功能目标映射**：设定计划的二级生理目标。
        -   *规则*：`计划.计划功能目标` = `档案.功能目标` (如 "力量")。

2.  **步骤 2: 难度定级**
    > *目的：根据用户的运动能力设定计划的基准难度。*
    -   **难度映射**：确定计划的训练强度等级。
        -   *规则*：`计划.计划难度` = `档案.运动等级` (如 L3)。

3.  **步骤 3: 周期确认**
    > *目的：确立计划的总时长。*
    -   **周期设定**：确定计划持续周数。
        -   *规则*：`计划.计划周期` = `约束对象.计划周期`。
    -   **周频设定**：确定计划每周训练天数。
        -   *规则*：`计划.计划周频` = `档案.每周运动频率`。

4.  **步骤 4: 类型设定**
    > *目的：标记计划的来源类型。*
    -   **来源标记**：设定计划的生成类型。
        -   *规则*：`计划.计划类型` = "用户生成"。

### 3. 输出数据
- **计划元数据** (流转至: 节点 3, 节点 6)：
    -   *基础信息*：`计划ID`、`计划类型`、`计划开始日期`。
    -   *推荐标签*：`计划目标`、`计划功能目标`、`计划难度`、`计划周期`、`计划周频`。
    -   *其他*：`单课时长`。

### 4. 场景示例
> **场景**：L4高阶用户，主要目标增肌，想专项提升力量。
> - **输入**：等级=L4，主要目标="增肌"，功能目标="力量"。
> - **输出**：
>   - `计划目标`: 增肌
>   - `计划功能目标`: 力量
>   - `计划难度`: L4
>   - `计划周期`: 4

---

## 节点 3: 阶段确认
> 定义：规划计划的时间轴，切分阶段并设定各阶段策略。
> > *业务导读*：定节奏。把长计划切分成几个阶段。就像打游戏通关，先“适应期”找找感觉，再“进阶期”上强度，最后“突破期”冲刺，中间还要安排“减载期”休息回血。

### 1. 输入数据
- **计划元数据** (来源: 节点 2)：
    -   `计划功能目标`、`计划周期`。
- **用户档案** (来源: 运动档案)：
    -   *偏好设置*：`运动等级` (用于短周期策略判定)。
- **配置表**：`[2.3 阶段周期分配配置]`。

### 2. 处理逻辑
1.  **步骤 1: 阶段划分**
    > *目的：根据计划总时长，选择合适的周期模型（标准/短周期）。*
    -   **策略匹配**：确定周期分配策略。
        -   *规则*：依据 `计划.计划功能目标` && `计划.计划周期` → 匹配 `[2.3 阶段周期分配配置]`。
    -   **模型选择**：选择具体的周期模型。
        -   *规则*：若 `计划.计划周期` < `配置.短周期阈值` → 应用 `短周期模型`。
        -   *规则*：否则 → 应用 `配置.标准模型`。

2.  **步骤 2: 周期分配**
    > *目的：计算每个阶段的具体持续周数。*
    -   **比例分配**：计算各阶段周数。
        -   *规则*：按配置比例计算各阶段周数 (采用最大余额法处理整数余数，确保总周数守恒)。
    -   **兜底修正**：处理周数异常。
        -   *规则*：确保 `阶段.周数` ≥ `配置.阶段最小周数`。若 `Σ阶段周数` > `计划.计划周期` → 扣除 `最大值(持续周数)` 的阶段。

3.  **步骤 3: 属性填充**
    > *目的：为每个阶段设定具体的训练目标和强度系数。*
    -   **目标继承**：设定阶段目标。
        -   *规则*：`阶段.阶段目标` = `计划.计划功能目标`。
    -   **周频继承**：设定阶段周频。
        -   *规则*：`阶段.阶段周频` = `计划.计划周频`。
    -   **系数加载**：初始化训练配置。
        -   *规则*：读取 `强度系数` & `容量系数` (来源: `配置.阶段属性`, 索引: `阶段.阶段类型`)。

### 3. 输出数据
- **阶段列表** (流转至: 节点 4, 节点 6)：
    -   *基础信息*：`阶段类型`、`阶段目标`、`持续周数`、`阶段周频`。
    -   *阶段训练配置*：`强度系数`、`容量系数`。

### 4. 场景示例
> **场景**：12周长周期增肌计划。
> - **输入**：周期=12周，模型=标准。
> - **输出**：
>   - 阶段1: 适应期 (3周), 强度0.8
>   - 阶段2: 进阶期 (5周), 强度1.0
>   - 阶段3: 突破期 (3周), 强度1.1, 容量0.9
>   - 阶段4: 减载期 (1周), 强度0.6, 容量0.6

---

## 节点 4: 模板匹配与排期
> 定义：为每个阶段匹配最佳的周排课逻辑，并生成具体日历。
> > *业务导读*：定日程。决定每周具体怎么练。是“练三休四”，还是“推拉腿循环”？系统会根据你每周练几天的习惯，给每一周找个最合适的“课程表模子”，填进日历里。

### 1. 输入数据
- **阶段列表** (来源: 节点 3)。
- **计划元数据** (来源: 节点 2)：`计划难度`、`计划开始日期`。
- **用户档案** (来源: 运动档案)：
    -   *基础数据*：`性别`。
    -   *偏好设置*：`每周运动频率`、`每周训练日`。
- **配置表**：`[1.5 单周循环模板配置]`。

### 2. 处理逻辑
1.  **步骤 1: 模板匹配**
    > *目的：为每个阶段选择最适合用户频率和目标的周排课模式。*
    -   **筛选**：筛选符合条件的候选模板。
        -   *规则*：遍历阶段，基于 `阶段.阶段目标` && `计划.计划难度` && `档案.性别` && (`模板.模板周频` ≤ `档案.每周运动频率`) → 筛选 `候选模板`。
    -   **决策**：选择最佳匹配模板。
        -   *规则*：选择模板 (条件: `最小值(|模板.模板周频 - 档案.每周运动频率|)`) (同分优先选低频)。

2.  **步骤 2: 日历生成**
    > *目的：将模板中的槽位填充到具体的每周训练日中。*
    -   **槽位映射**：将基础槽位映射到训练日。
        -   *规则*：`模板.基础槽位` → `档案.每周训练日` (按序填充)。
    -   **溢出处理**：处理训练频率高于模板周频的情况。
        -   *规则*：若 `档案.每周运动频率` > `模板.模板周频`，根据 `模板.补充策略` 补全：
            -   `循环` → 循环使用 `模板.基础槽位`。
            -   `补充` → 优先使用 `模板.补充槽位` (若无 → 降级为 `循环`)。
            -   `随机` → 随机抽取(`模板.基础槽位`)。
    -   **休息填充**：安排休息日内容。
        -   *规则*：若 `模板.休息日策略` == "主动恢复" → 填充 `模板.休息槽位`；否则 → 标记 "完全休息"。

3.  **步骤 3: 日期推算**
    > *目的：基于计划开始日期，生成具体的日历日期。*
    -   **日期推算**：计算具体的日历日期。
        -   *规则*：基于 `计划.计划开始日期` → 生成 `每日日期`。

### 3. 输出数据
- **排期表** (流转至: 节点 5)：
    -   *排期信息*：`日期`、`日程类型`、`所属阶段`。
    -   *训练配置*：`槽位定义` (侧重目标/课程类型/模板ID)。

### 4. 场景示例
> **场景**：用户周一/四训练，匹配到“二分化 (上下肢)”模板。
> - **输入**：训练日=[周一, 周四]，模板=[上肢日, 下肢日]。
> - **输出**：
>   - 周一: 上肢日 (胸/背/肩/臂)
>   - 周二: 休息
>   - 周三: 休息
>   - 周四: 下肢日 (臀/腿/核心)
>   - ... (循环4周)

---

## 节点 5: 用户微调
> 定义：处理用户在前端的主动修改请求，实时重算计划参数。
> > *业务导读*：最后的把关。把生成好的计划展示给你。哪天练、练多久，如果不满意可以自己改。改完之后，系统会重新调整排期。

### 1. 输入数据
- **排期表** (来源: 节点 4)。
- **计划元数据** (来源: 节点 2)。
- **用户指令** (来源: 前端交互)：
    -   **结构指令**：`重置生成` (修改目标/周期)、`日程重排` (修改训练日)、`周期平移` (修改开始日期)。
    -   **内容指令**：`模板切换` (如更换分化模式)。
    -   **参数指令**：`修改时长` (单课时长)、`修改难度` (计划难度)。

### 2. 处理逻辑
1.  **步骤 1: 全局重构处理**
    > *目的：响应影响计划整体结构的重大修改。*
    -   **重置生成**：响应核心参数变更。
        -   *规则*：若用户修改 `计划目标` / `计划周期` → 携带新参数重新调用 `[节点 2: 计划确认]` 及后续流程。
    -   **日程重排**：响应训练日变更。
        -   *规则*：用户变更 `档案.每周训练日` → 保持 `槽位序列`，重新映射至 `新日期`。
    -   **周期平移**：响应开始日期变更。
        -   *规则*：用户变更 `计划.计划开始日期` → 平移 `所有课程日期`。

2.  **步骤 2: 内容筛选微调**
    > *目的：在不改变整体结构的前提下，调整具体的排课模式。*
    -   **模板切换**：用户手动更换周循环模板。
        -   *规则*：用户指定新 `模板ID` → 调用 `[节点 4: 模板匹配与排期]` 重新生成排期表。

3.  **步骤 3: 参数覆写**
    > *目的：调整计划的执行参数。*
    -   **参数更新**：响应参数修改。
        -   *规则*：用户变更 `计划.单课时长` 或 `计划.计划难度` → 更新 `计划元数据`，约束后续课程生成。

### 3. 输出数据
- **确认后的排期表** (流转至: 节点 6)：
    -   *排期信息*：`日期`、`日程类型`、`所属阶段`。
    -   *训练配置*：`槽位定义` (含用户修改)。
- **更新后的计划元数据** (流转至: 节点 6)：
    -   *基础信息*：`计划开始日期`。
    -   *推荐标签*：`计划目标`、`计划周期`、`计划难度`。
    -   *其他*：`单课时长`。

### 4. 场景示例
> **场景**：用户临时有事，把计划推迟一周开始。
> - **输入**：开始日期 + 7天。
> - **输出**：所有课程日期 + 7天，内容不变。

---

## 节点 6: 最终产出
> 定义：生成最终的计划详情信息，供前端展示和用户执行。
> > *业务导读*：打包出厂。把算好的计划、阶段、每一天的课表整合起来，生成最终的计划书。

### 1. 输入数据
- **计划元数据** (来源: 节点 2/5)。
- **阶段列表** (来源: 节点 3)。
- **确认后的排期表** (来源: 节点 5)。

### 2. 处理逻辑
1.  **步骤 1: 标识符生成**
    > *目的：为生成的计划和阶段分配唯一ID。*
    -   **ID生成**：创建唯一标识符。
        -   *规则*：生成 计划ID (对象: `计划` & `阶段`)。

2.  **步骤 2: 文案合成**
    > *目的：生成面向用户的计划标题和描述。*
    -   **名称生成**：构建计划显示标题。
        -   *规则*：模板 "{周期}周{目标}突破计划" → `标题`。
    -   **介绍生成**：构建计划详细描述。
        -   *规则*：基于 `目标` & `周期` & `难度` → `描述`。

3.  **步骤 3: 信息整合**
    > *目的：组装最终的计划数据对象。*
    -   **结构组装**：整合各层级数据。
        -   *规则*：`排期表` → `阶段`；`阶段列表` → `计划`。

### 3. 输出数据
- **完整的计划详情对象** (输出给: 前端/数据库)：
    -   *基础信息*：`计划ID`、`计划名称`、`计划介绍`、`计划类型`、`计划开始日期`。
    -   *推荐标签*：`计划目标`、`计划功能目标`、`计划难度`、`计划周期`、`计划周频`。
    -   *阶段配置*：`阶段列表`。
    -   *排期信息*：`每日排期表`。

### 4. 场景示例
> **场景**：生成最终计划详情。
> - **输出**：
>   - **计划信息**：ID=PLN_Gen_001，标题="4周增肌突破计划"
>   - **阶段结构**：
>     - 阶段1：适应期 (1周)，包含对应排期
>     - 阶段2：进阶期 (2周)，包含对应排期

## 需求池
> > *业务导读：未来版本规划的逻辑模块。*
1. **周期模型选择**：支持波浪周期、区块周期等高阶模型。
2. **首周降级策略**：若用户在疲劳状态下坚持开始计划，自动将首周强度系数下调（如 * 0.8）。
3. **生理周期适配**：基于女性生理周期（月经期/卵泡期/排卵期/黄体期）自动调整训练强度、容量及动作禁忌。