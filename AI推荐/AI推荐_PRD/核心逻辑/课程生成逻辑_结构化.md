# 课程生成逻辑
> **文档用途**：本文档是算法落地的“施工图纸”。
> - **产品经理**：请重点关注“业务导读”和“场景示例”，确认逻辑是否符合业务预期。
> - **开发人员**：请重点关注“输入/输出”和“处理逻辑”，这是代码实现的直接依据。
> **设计原则**：高内聚，低耦合。每个节点仅依赖明确的输入，产出标准化的输出。

## 节点流转总览
```mermaid
graph LR
    N1[输入与上下文] --> N2[课程确认]
    N2 --> N3[环节确认]
    N3 --> N4[动作确认]
    N4 --> N5[动作实例化]
    N5 --> N6[用户微调]
    N6 --> N7[数据装配]
    N7 -.-> N8[反馈闭环]
```

---

## 节点 1: 输入与上下文
> 定义：确立课程生成的“主干意图”（来源：用户或计划）与“边界约束”（来源：环境与状态）。
> > *业务导读*：就像教练在开课前进行的“摸底访谈”。系统需要收集你的基本信息、当下的需求（想练哪里、练多久）以及限制条件（有没有受伤、有什么器械），把这些信息打包成一个“上下文包”，传给后面的环节。

### 1. 输入数据
- **用户档案** (来源: 运动档案)：
    -   *基础数据*：`性别`、`生日`、`身高`、`体重`、`BMI`、`静息心率`、`最大心率`、`主观疲劳度`。
    -   *偏好设置*：`运动等级`、`每周训练日`、`每周运动频率`、`每日运动时长`、`喜欢的训练风格`、`疼痛部位`、`没有的器械`。
    -   *目标设定*：`主要目标`、`功能目标`、`目标体型`、`目标体重`。
    -   *扩展数据*：`生理周期`、`昨日睡眠时长`。
    -   *能力数据*：`1RM记录`。
- **场景入口**：
    -   *用户输入* (单课模式)：`目标部位`、`单课时长`、`课程类型`、`单课环节` (热身/主训/放松，默认全选)。
    -   *计划上下文* (计划模式)：`侧重目标`、`课程时长`、`课程类型`、`单课环节`、`环节模板`。
- **状态数据**：`综合疲劳度`、`部位状态值`、`生理周期`。

### 2. 处理逻辑
1.  **明确训练需求**：
    -   **计划模式**：若 `计划上下文` 存在。
        -   `基准目标` = `计划上下文.侧重目标`。
        -   `基准时长` = `计划上下文.课程时长`。
        -   `基准类型` = `计划上下文.课程类型`。
        -   `基准环节` = `计划上下文.单课环节`。
    -   **单课模式**：若不存在 `计划上下文`。
        -   `基准目标` = `用户输入.目标部位` (若空则基于 `部位状态` 智能推荐)。
        -   `基准时长` = `用户输入.单课时长` (若空则取 `档案.每日运动时长`)。
        -   `基准类型` = `用户输入.课程类型` (若空则基于 `档案.功能目标` 映射)。
        -   `基准环节` = `用户输入.单课环节` (若空则默认 ["热身", "主训", "放松"])。
2.  **识别限制条件**：
    -   **疲劳风控**：
        -   `全局`：若 `综合疲劳度` < 55 → 标记 `推荐降级` = True。
        -   `局部`：识别 `力竭部位` (`部位状态值` < 30) 和 `推荐部位` (`部位状态值` > 85)。
    -   **硬件环境**：
        -   `可用器械` = `全量器械库` - `档案.没有的器械`。
    -   **身体限制**：
        -   `禁忌部位` = `档案.疼痛部位` ∪ `力竭部位` (来自疲劳风控)。
3.  **数据完整性校验**：
    -   校验 `基准目标` && `基准时长` && `基准环节` 及核心档案字段。

### 3. 输出数据
- **上下文对象**：
    -   `来源模式` (计划/单课)
    -   `基准目标` (列表)
    -   `基准时长` (整数)
    -   `基准类型` (枚举)
    -   `基准环节` (列表)
    -   `可用器械` (列表)
    -   `禁忌部位` (列表，含伤病与严重疲劳)
    -   `智能推荐部位` (列表)
    -   `推荐降级` (布尔值)
    -   `状态数据` (生理周期/疲劳度)
    -   `计划上下文` (若有)

### 4. 场景示例 
> **场景**：一个膝盖有伤的用户，想练胸，只有哑铃，且时间紧迫只做主训。
> - **输入**：目标="胸部"，环节=["主训"]，档案.疼痛部位="膝盖"，档案.没有的器械=["杠铃", "固定器械"]。
> - **输出**：
>   - `基准目标`: ["胸部"]
>   - `基准时长`: 30 (默认)
>   - `基准环节`: ["主训"]
>   - `可用器械`: ["哑铃", "自重"]
>   - `禁忌部位`: ["膝盖"] (后续会剔除深蹲等动作)
>   - `推荐降级`: False
>   - `状态数据`: 正常
>   - `计划上下文`: Null

---

## 节点 2: 课程确认
> 定义：基于上下文环境，裁决并确立课程的宏观属性。
> > *业务导读*：给这节课定调。确定主题是“增肌”还是“减脂”，难度是“入门”还是“专业”。

### 1. 输入数据
- **上下文对象** (来源: 节点 1)。
- **用户档案** (来源: 运动档案)：
    -   *偏好设置*：`运动等级`。
    -   *目标设定*：`功能目标`。

### 2. 处理逻辑
1.  **裁决训练目标**：
    -   **冲突检测**：若 `上下文.基准目标` ∩ `上下文.禁忌部位` ≠ Ø。
        -   **计划模式**：触发 `部位替换策略` (如：胸部力竭 → 改练三头 或 主动恢复)。
        -   **单课模式**：提示用户风险 → 若用户坚持 → 标记 `推荐降级` = True。
    -   **最终定案**：输出 `最终目标部位`。
2.  **设定课程难度**：
    -   **确立基准**：`课程难度` = `档案.运动等级` (如 L3)。
    -   **执行修正**：若 `上下文.推荐降级` == True → `课程难度` 下调 2级 (最低 L1)。
3.  **设定类型与时长**：
    -   **课程类型**：`上下文.基准类型` (若空 → 映射自 `档案.功能目标`)。
    -   **课程时长**：`上下文.基准时长`。
4.  **解析解剖部位**：
    -   若 `最终目标部位` 为 "动作模式" (如水平推) → 查阅 `[数据映射表]` → 转换为 `解剖部位`。

### 3. 输出数据
- **课程元数据**：
    -   `课程目标` (枚举)
    -   `课程难度` (枚举)
    -   `课程类型` (枚举)
    -   `课程时长` (整数)
    -   `目标部位` (列表)

### 4. 场景示例
> **场景**：L3等级用户，目标增肌，但今天很累（触发降级）。
> - **输入**：等级=L3，推荐降级=True，目标=增肌。
> - **输出**：
>   - `课程难度`: L1 (L3 - 2级)
>   - `课程类型`: 力量
>   - `课程目标`: 增肌
>   - `课程时长`: 30 (继承)
>   - `目标部位`: ["胸部"] (继承)

---

## 节点 3: 环节确认
> 定义：规划课程的时间结构，并加载各环节的基准训练参数。
> > *业务导读*：切分时间蛋糕。把总时长切分为“热身、主训、放松”三块。同时，根据你的等级查阅“配方表”，确定主训要做几组、休息多久、强度多大。

### 1. 输入数据
- **课程元数据** (来源: 节点 2)。
- **上下文对象** (来源: 节点 1)。
- **用户档案** (来源: 运动档案)：
    -   *偏好设置*：`运动等级`。
    -   *基础数据*：`性别`。
- **配置表**：
    -   `[1.3 结构配置]`、`[1.1 策略矩阵]`、`[1.2 环节模板]`。

### 2. 处理逻辑
1.  **规划时间结构**：
    -   **切分计算**：依据 `[1.3 结构配置]`。
    -   `热身/放松时长` = Min(`课程时长` * `推荐占比`, `最大时长`)。
    -   `主训时长` = `课程时长` - `热身时长` - `放松时长`。
2.  **加载策略与规划容量**：
    -   **遍历环节**：对 `热身`、`主训`、`放松` 分别执行：
        -   **确定策略键**：
            -   `热身` → Key="激活" (默认) 或 "心肺" (若主训为减脂)。
            -   `主训` → Key=`课程目标`。
            -   `放松` → Key="柔韧" (默认) 或 "恢复"。
        -   **加载参数**：查阅 `[1.1 策略矩阵]` 获取 `基准组数`, `组间休息`, `负荷策略` 等。
        -   **计算单动作耗时**：
            -   若 `负荷策略` == "计时" (热身/放松通常为此) → `耗时` = `[强度指标换算表].计时时长`。
            -   若 `负荷策略` == "推荐/递增" (主训通常为此) → `耗时` = `基准组数` * 60s (估算)。
            -   `完整周期耗时` = `耗时` + `组间休息` (配置值)。
        -   **计算目标数量**：
            -   `目标数量` = Min(`环节时长` / `完整周期耗时`, `配置.动作数量限制`)。
            -   *注*：因热身/放松配置中 `组间休息`=0，此处自动实现无间歇流式计算。
4.  **加载内容配方 (仅主训)**：
    -   **查表**：`[1.2 环节模板]` (Key: `目标部位` && `课程目标` && `运动等级` && `性别`)。
    -   **匹配逻辑**：`计划上下文` 指定 > 精确匹配 > 降级匹配 > 通用匹配。
    -   **分配**：将 `主训总数量` 按模板比例分配给各 `槽位` (如：复合槽位x3, 孤立槽位x2)。

### 3. 输出数据
- **环节列表 (列表<环节对象>)**，每个环节包含：
    -   `环节类型` (热身/主训/放松)
    -   `环节时长` (整数)
    -   `目标动作数` (整数)
    -   `基准参数` (强度/组数/RPE/休息/策略)
    -   `槽位列表` (列表<槽位>) [仅主训，含 `槽位名称` 与 `分配数量`]

### 4. 场景示例
> **场景**：60分钟胸部训练，L3等级（高容量）。
> - **输入**：时长=60min，部位=胸部，等级=L3。
> - **输出**：
>   - `热身环节`: 5分钟 (目标动作: 6个) [L3基准45s+0s休息=45s/个, 300/45≈6]
>   - `主训环节`: 50分钟 (目标动作: 5个)
>     - `基准参数`: 4组, 强度75%, 组间休90s
>     - `槽位`: [复合推类(3个), 孤立夹类(2个)]
>   - `放松环节`: 5分钟 (目标动作: 6个) [L3基准45s+0s休息=45s/个, 300/45≈6]

---

## 节点 4: 动作确认
> 定义：从动作库中筛选最佳动作，填充到规划好的槽位中。
> > *业务导读*：选品上架。从动作库里挑选动作填入槽位。第一步是“安检”，剔除受伤不能做、没器械做不了的动作；第二步是“选秀”，按新鲜感、匹配度给动作打分，分高的入选。

### 1. 输入数据
- **环节列表** (来源: 节点 3)。
- **上下文对象** (来源: 节点 1)。
- **动作库** (来源: 数据库)。
- **配置表**：
    -   `[3.1 推荐因子]`、`[2.2 难度兼容策略]`。

### 2. 处理逻辑
1.  **构建安全动作池**：
    -   **伤病过滤**：`动作.疼痛部位` ∩ `上下文.禁忌部位` ≠ Ø → 剔除。
    -   **器械过滤**：`动作.动作器械` ⊈ `上下文.可用器械` → 剔除。
    -   **产出**：`安全动作池`。
2.  **执行筛选与排序**：
    -   **遍历**：`环节列表` → `槽位列表` (针对每个待填充的空缺)。
    -   **步骤1：匹配目标 (Matching)**：
        -   **热身/放松**：
            -   **热身 (RAMP)**：`动作功能` ∈ {心肺, 激活, 协调, 平衡, 柔韧} && `关联部位` ≈ `主训.目标部位`。
            -   **放松 (静态恢复)**：`动作功能` ∈ {柔韧, 恢复, 体态, 呼吸} && `关联部位` ≈ `主训.目标部位`。
        -   **主训**：`动作属性` ⊆ `槽位定义` (部位/模式/功能) && `难度` 兼容。
    -   **步骤2：影响因子权重选择 (Scoring)**：
        -   **计算总分**：引用 `[3.1 推荐因子]`。
        -   **加分项**：`新鲜奖励` (近期未练) + `匹配奖励` (完全符合骨架) + `收藏奖励`。
        -   **减分项**：`厌倦惩罚` (近期频繁) + `疲劳惩罚` (辅助肌疲劳)。
        -   **一票否决**：若 `上下文.推荐降级` == True → 剔除 `冲击等级`="高冲击" || `动作构造`="复合动作" (强制降阶)。
    -   **步骤3：条件排序 (Sorting)**：
        -   **排序**：按 `推荐总分` 降序排列。
        -   **截取**：选取 Top N (N = `槽位.目标数量`)。
        -   **兜底**：若候选不足 → 降难度 → 扩范围 → 改性质 → 保骨架。
3.  **优化动作序列**：
    -   **动作流 (Flow)**：调整顺序，使 `体位变换成本` 最低 (如：站姿->站姿->坐姿->仰卧)。
    -   **器械聚合**：聚合 `相同器械` (减少换器械时间)。
    -   **超级组配对**：若 `模式` == "超级组" → 配对 (`主动肌`, `拮抗肌`)。
    -   **安全风控**：若 `连续高冲击` > 3 → 插入低冲击动作。

### 3. 输出数据
- **填充后的环节列表**：
    -   新增 `动作序列 (列表<动作实例>)`。
    -   *注*：动作仅包含 ID 和基础属性，尚未计算重量次数。

### 4. 场景示例
> **场景**：填充“复合推类”槽位，用户有哑铃。
> - **输入**：槽位=复合推类，安全池包含[杠铃卧推, 哑铃卧推, 俯卧撑]。
> - **过程**：
>   - 杠铃卧推 → 剔除 (没杠铃)。
>   - 哑铃卧推 → +100分 (匹配), +60分 (新鲜)。
>   - 俯卧撑 → +100分 (匹配), -80分 (刚练过)。
> - **输出**：选中 [哑铃卧推]。

---

## 节点 5: 动作实例化
> 定义：计算每个动作的具体执行参数（重量/次数/组数）。
> > *业务导读*：精算负荷。给选出来的动作算具体的重量和次数。如果是新动作，就根据你的测评数据推算；如果是老动作，就根据历史记录调整。还会安排每一组的变化，比如第一组轻点，第二组重点。

### 1. 输入数据
- **动作序列** (来源: 节点 4)。
- **用户能力** (来源: 运动档案)：`1RM记录`、`部位测评1RM`。
- **基准参数** (来源: 节点 3)：`强度`、`RPE`、`负荷策略`。
- **逻辑库**：`[重量推荐逻辑]`。
- **配置表**：`[2.1 负荷与组间策略配置]`、`[3.1 RM表]`、`[强度表]`。

### 2. 处理逻辑
1.  **判定计算模式**：
    -   **负荷优先模式** (力量/增肌)：确定重量 → 次数随重量变化 (基于 `1RM`)。
    -   **容量优先模式** (有氧/HIIT)：确定时长/次数 → 重量为辅助 (基于 `强度表`)。
2.  **计算核心参数**：
    -   **若为 [负荷优先模式]**：
        -   **定重量**：调用 `[重量推荐逻辑]` (输入: `1RM记录` || `测评数据`) → `推荐重量`。
        -   **定次数**：查阅 `[RM表]` → `理论最大次数` → 结合 `目标RPE` → `推荐次数`。
        -   **定组数**：`环节.动作组数`。
    -   **若为 [容量优先模式]**：
        -   **定容量**：查阅 `[强度表]` → `推荐时长` (计时) || `推荐次数` (计次)。
        -   **定重量**：若 `有电机` → 调用 `[重量推荐逻辑]`；否则 `0`。
        -   **定组数**：`环节.动作组数`。
3.  **生成组间策略**：
    -   **应用策略**：`[2.1 负荷与组间策略配置]` (如 "正金字塔")。
    -   **序列生成**：生成每组参数 (如：Set 1 (85%) → Set 2 (90%) → Set 3 (100%))。
4.  **估算执行时长**：
    -   **TUT计算**：若 `环节.动作节奏` 存在 (如 "2-0-2-0") → `单次耗时` = Sum(节奏) (4s)；否则 `单次耗时` = `动作.单次动作时长`。
    -   `单组耗时` = (`推荐次数` * `单次耗时`) + `组间休息`。
    -   `总耗时` = Σ `单组耗时`。

### 3. 输出数据
- **实例化动作列表**：
    -   `组序列 (列表<组>)`。
    -   每组包含：`重量` (kg), `次数` (reps), `时长` (s), `休息时间` (s)。

### 4. 场景示例
> **场景**：计算“哑铃卧推”的参数，用户1RM=20kg，强度=75%，策略=递增。
> - **输入**：1RM=20kg, 强度=0.75, 策略=递增。
> - **输出**：
>   - 第1组: 12.5kg (20*0.75*0.85), 12次
>   - 第2组: 13.5kg (20*0.75*0.90), 11次
>   - 第3组: 15.0kg (20*0.75*1.00), 10次

---

## 节点 6: 用户微调
> 定义：响应用户在前端的主动修改请求，实时重算课程参数。
> > *业务导读*：最后的把关。把生成好的课程展示给用户，用户如果不喜欢某个动作可以换，觉得太难可以调。系统根据用户的修改指令，实时重新计算参数。

### 1. 输入数据
- **实例化课程** (来源: 节点 5)。
- **用户指令**：`替换动作`、`修改参数`、`调整难度`。

### 2. 处理逻辑
1.  **处理动作替换**：
    -   **操作**：`原动作` → 加入 `黑名单`。
    -   **重筛选**：调用 `节点 4` → 获取 `新候选动作`。
    -   **重计算**：调用 `节点 5` → 计算 `新动作负荷`。
2.  **处理参数修改**：
    -   **操作**：用户修改 `重量` || `次数`。
    -   **执行**：覆盖原数值 → 标记 `用户自定义` = True。
3.  **处理难度调整**：
    -   **操作**：用户点击 "太难" || "太易"。
    -   **执行**：`全局强度系数` ± 0.05。
    -   **重计算**：调用 `节点 5` → 更新所有动作负荷。

### 3. 输出数据
- **用户确认后的课程对象**。

### 4. 场景示例
> **场景**：用户觉得“哑铃卧推”肩膀不舒服，换成“俯卧撑”。
> - **输入**：指令=替换(哑铃卧推)。
> - **处理**：黑名单=[哑铃卧推]，重跑筛选 → 选中[俯卧撑]。
> - **输出**：更新后的动作列表，其中哑铃卧推变成了俯卧撑。

---

## 节点 7: 最终产出
> 定义：生成最终的课程详情对象，供前端展示和用户执行。
> > *业务导读*：打包出厂。把所有算好的数据整合起来，算出这节课的总卡路里和难度分，生成一句贴心的推荐语，准备上架。

### 1. 输入数据
- **确认后的课程对象** (来源: 节点 6)。

### 2. 处理逻辑
1.  **生成基础信息**：
    -   生成 `课程ID` (UUID)。
    -   生成 `推荐理由` (基于 `Top 1 推荐因子` 生成文案)。
2.  **计算统计数据**：
    -   `预估卡路里` = Σ (`动作.动作MET值` * `动作总时长` * `体重系数`)。
    -   `预估RPE` = Σ (`环节.目标RPE` * `环节.时长`) / `课程.总时长`。
3.  **聚合展示标签**：
    -   提取并去重：`配件要求`、`疼痛部位`、`冲击等级`。

### 3. 输出数据
- **完整的课程详情对象** (符合《课程属性》定义)。

### 4. 场景示例
> **场景**：生成最终课程详情。
> - **输出**：
>   - **课程信息**：ID=CRS_Gen_001，标题="30分钟胸部增肌"
>   - **统计指标**：卡路里=150kcal，标签=["哑铃", "低冲击"]
>   - **推荐理由**："根据您的恢复状态推荐"

---

## 节点 8: 反馈闭环
> 定义：处理训练后的反馈数据，更新用户档案，实现算法进化。
> > *业务导读*：课后复盘。练完之后，系统会根据你反馈的“累不累”（RPE）来调整你的能力值，根据你“换动作”的行为来调整你的偏好。越练越懂你。

### 1. 输入数据
- **执行数据**：实际完成的 `重量`、`次数`。
- **用户反馈**：`课后RPE`、`替换行为`、`收藏行为`。

### 2. 处理逻辑
1.  **校准能力基准**：
    -   **RPE校验**：若 |`反馈RPE` - `预估RPE`| > 2 → 调整 `档案.1RM记录` (反向修正)。
    -   **1RM更新**：若 `实际最大负荷` > `当前1RM记录` → 更新 `1RM记录` (仅当 RPE < 10 时有效，防止借力/代偿数据污染)。
2.  **更新偏好权重**：
    -   **冷宫逻辑**：若 `主动替换` > 3次 → 加入 `冷宫池` (降权)。
    -   **收藏逻辑**：若 `收藏` == True → 加入 `加分池` (提权)。
3.  **识别训练瓶颈**：
    -   **平台期判定**：若 `连续无提升次数` ≥ 5 → 标记 `平台期` = True。
    -   **策略调整**：下次生成 → 推荐 `负荷策略` = "递减" || "波浪"。

### 3. 输出数据
- **更新后的用户档案**。

### 4. 场景示例
> **场景**：用户反馈RPE=9（太累），预估RPE=7。
> - **输入**：反馈RPE=9, 预估RPE=7。
> - **处理**：偏差=2，触发下调逻辑。
> - **输出**：更新档案，胸部强度系数 1.0 → 0.95。

## 需求池
> > *业务导读：未来版本规划的逻辑模块。*
1. **波浪负荷策略**：在平台期干预中引入波浪周期策略。
2. **修正系数逻辑**：基于计划阶段（如减载期）和生理状态（如疲劳/生理期）自动调整强度和容量系数。