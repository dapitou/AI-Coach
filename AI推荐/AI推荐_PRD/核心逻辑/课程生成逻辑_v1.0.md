# 课程生成逻辑 v1.0
> > *业务导读：第一版课程生成算法，侧重于安全性和基础的动作组合。*
> 定义：基于“穿透架构”的简化版实现，聚焦安全与基础可用性。

## 核心架构
> > *业务导读：生成一节课的完整流水线。*
> 架构：`用户输入` -> `课程确认` -> `环节确认` -> `动作确认` -> `动作实例化` -> `用户微调` -> `数据装配` -> 反馈闭环（迭代优化）

## 第一层：用户输入 (对应架构：输入层)
> 任务：收集生成课程所需的关键约束条件。
> > *业务导读：搞清楚今天练哪里（比如胸部），练多久，身体累不累，有没有受伤，确保生成的课是安全且符合当下的。*

### 课程参数设定
> **目标部位**：全身｜胸部｜背部｜肩部｜手臂｜臀部｜腿部｜核心 [必填，多选，最多4项，默认：基于“部位疲劳状态”推荐]
> 来源：用户手动选择 (单课生成) 或 计划传入 (计划生成)。
> **单课时长**：20-60（min） [必填，滑动条，默认：档案“每日运动时长”]
> 来源：用户选择 或 计划继承。
> **单课环节**：热身 | 主训 | 放松 [必填，多选，默认：全选]

### 疲劳干预 (一级)
> > *业务导读：如果身体疲劳，强制降低课程难度或建议换部位，防止受伤。*
> 引用：[4.1状态适配配置]
> **疲劳提示**：若用户选择的部位定性为[疲劳部位]（`部位状态值`处于`已力竭`或`疲劳中`状态），并提示推荐选择[恢复部位]（`已恢复`状态）。
> **策略降级**：若用户忽略提示坚持训练该部位，强制将 课程`课程难度` 降2级（如 L3 -> L1），以保障安全。

### 档案校验与读取
> > *业务导读：检查生成课程所需的用户数据是否齐全。*
> 用途：为完成推荐生成，检查 [运动档案] 完整性，若缺失引导补全。
> **基础**：`性别`、`生日`、`身高`、`体重`、`BMI`、、、`每日运动时长`、`喜欢的训练风格`、`主观疲劳度`
> **目标**：`主要目标`、`功能目标`、`目标体型`、`目标体重`
> **偏好**：`运动等级`、`每周训练日`、`每周运动频率`、`每周运动时长`、`喜欢的训练风格`、`疼痛部位`、`没有的器械`

### 计划上下文读取（计划课程生成）
> > *业务导读：如果是计划里的课，要继承计划的规定（如今天必须练腿）。*
> 定义：当生成属于某个训练计划的课程时，从上游计划引擎传入的约束参数。
> 来源：[计划生成逻辑] (当前执行的`计划` -> `阶段` -> `单周循环模板` -> 当日`基础槽位`/`填充槽位`/`休息槽位`)。
> **继承参数**：
> - 上下文`课程类型` (对应 课程`课程类型`)。
> - 上下文`侧重目标` (对应 课程`目标部位` 或 动作`动作模式`)。
> - 上下文`课程时长` (继承自 计划`单课时长`)。
> - 上下文`环节列表` (继承自 计划`单课环节`)。

## 第二层：课程确认 (对应架构：第4层 课程)
> 任务：确定课程维度的核心属性。
> > *业务导读：给这节课定个调子。是增肌课还是减脂课？难度是L1入门还是L5专业？把基本属性定死。*

### 属性初始化
> **课程目标**：
> - 单课生成：课程`课程目标` = 档案`功能目标`。
> - 计划生成：课程`课程目标` = 阶段`阶段目标`。
> **课程类型**：
> - 单课生成：课程`课程类型` = 用户输入`课程类型`。
> - 计划生成：课程`课程类型` = 上下文`课程类型`。
> **目标部位**：
> - 单课生成：课程`目标部位` = 用户输入`目标部位`。
> - 计划生成：课程`目标部位` = 上下文`侧重目标` (若为`动作模式`则映射为解剖部位)。
> **课程时长**：
> - 单课生成：课程`课程时长` = 用户输入`运动时长`。
> - 计划生成：课程`课程时长` = 上下文`课程时长`。
> **课程难度**：
> - 课程`课程难度` = 档案`运动等级`。


## 第三层：环节确认 (对应架构：第5层 环节)
> 任务：切分时间蛋糕，加载基准参数。
> > *业务导读：切分时间蛋糕（热身/主训/放松），再根据你的等级查表，确定要做几组、休息多久、强度多大。*

### 环节实例化与时长分配
> 引用：[1.3结构与组装配置]
> 逻辑：基于 课程`课程类型` 获取分配比例。
> **热身**：按配置比例分配 (默认范围 10%-15%)。
> - 筛选标签：动作`动作功能` ∈ [心肺, 激活, 协调, 平衡]。
> **主训**：按配置比例分配 (默认范围 70%-80%)。
> **放松**：按配置比例分配 (默认范围 10%-15%)。
> - 筛选标签：动作`动作功能` ∈ [柔韧, 恢复, 体态]。

### 训练参数加载
> 引用：[1.1策略矩阵配置]
> **查询键**：[档案`运动等级`] (v1.0简化：不区分目标)
> **赋值映射**：
> - 环节`动作组数` = 策略`动作组数`。
> - 环节`组间休息` = 策略`组间休息`。
> - 环节`训练强度` = 策略`训练强度`。
> - 环节`目标RPE` = 策略`目标RPE`。

## 第四层：动作确认 (对应架构：第6层 容量与筛选)
> 任务：从动作库中捞出符合条件的动作 (核心风控层)。
> > *业务导读：从动作库里捞动作。先把不能做的（受伤/没器械）剔除，再按新鲜感和匹配度打分，最后选出最合适的动作填进去。*

### 智能筛选
> **初筛**：
> - **主训**：选取 动作`主要部位` == 课程`目标部位` 的动作。
> - **热身/放松**：选取 动作`动作功能` 符合环节定义的动作。
> **剔除**：
> - 伤病规避：动作`疼痛部位` ∩ 档案`疼痛部位` == Ø。
> - 器械拦截：动作`动作器械` ∩ 档案`没有的器械` == Ø。
> - 难度截断：档案`运动等级` L1/L2 -> 剔除 动作`动作难度` L4/L5 的动作。
> **加权**：
> 引用：[3.1推荐影响因子配置]
> 逻辑：计算动作匹配分。
> - **基础分**：动作`动作权重` (归一化处理)。
> - **动态加分**：应用配置中的 `新鲜奖励`、`探索奖励` 等规则。
> - **动态扣分**：应用配置中的 `厌恶惩罚`、`难度偏离惩罚` 等规则。
> - **执行**：计算最终得分 (最低为1分)，按得分作为权重进行**加权随机抽取**。
> - **去重策略**：抽取时检查动作名称前缀，若已存在同类动作（如已选“深蹲”），则跳过其他含“深蹲”的变体，优先选不同类动作。

### 结构组装
> > *业务导读：把选出来的动作填进时间槽里，先做难的复合动作，再做简单的孤立动作。*
#### 主训环节
> > *业务导读：课程的核心部分，根据模板填充动作，并进行排序优化。*
> **容量预算**：
   > 公式：`目标组数` = 环节`训练时长` / (`单组耗时` + 环节`组间休息`)。
   > 说明：`单组耗时`含动作执行时间 (若 动作`单边独立性`=是，则 x2)；`组间休息`取自环节配置。
   > 兜底：若计算结果 < 1，强制设为 1。
> **填充策略**：
> - 优先填充 动作`主要部位` 符合的动作。
> - 随机抽取直至填满时长。
> **排序优化**：
> - **能量管理**：生成列表后，强制按 动作`动作构造` (复合 > 孤立) 降序排列，确保先做大重量复合动作。

## 第五层：动作实例化 (对应架构：第7层 动作实例化)
> 任务：计算每个动作的具体执行参数。
> > *业务导读：给每个动作算具体的重量和次数。新动作靠推算，旧动作看历史，组间还能根据你累不累动态调整。*

### 执行参数计算
> **负荷计算**：
> 引用：[重量推荐逻辑.md]
> - **逻辑分支**：
>   1. **旧动作 (有1RM)**：应用 [重量推荐逻辑].`1.2 旧动作推荐逻辑`。
>      - 考虑 `遗忘曲线` (上次训练时间) 进行衰减。
>   2. **新动作 (无1RM)**：应用 [重量推荐逻辑].`1.1 新动作推荐逻辑`。
>      - **优先**：基于 `部位测评1RM` × `肌肉系数` × `动作系数` 推算。
>      - **兜底**：若无测评，基于 `默认重量` 或 `记忆重量` 进行冷启动推荐。
> - **边界控制**：
>   - 结果需限制在 [推荐系数下限, 推荐系数上限] 范围内。
>   - 绝对值下限：2kg / 4lbs。
> - **输出**：
>   - 动作`推荐重量` (正式组第一组)。
> - 动作`推荐组数` = 环节`动作组数`。
> - 动作`推荐次数` = 基于 环节`训练强度` 反查 [重量推荐逻辑].`RM百分比表`。
> **组间策略**：
> - **动态调整**：应用 [重量推荐逻辑].`二、过程负荷调节`。
> - **逻辑**：组间休息时，根据上一组的 `向心速度(VBT)` 或 `RPE` 及 `完成度`，动态计算下一组重量 (+/- 5%~10%)。
> - **安全风控**：应用 [重量推荐逻辑].`2.4 安全熔断机制`，对计算结果进行最终裁剪。

## 第六层：用户微调 (对应架构：交互层)
> 任务：赋予用户最终决定权。
> > *业务导读：不喜欢的动作可以换，觉得太难可以调，把最终决定权交给你。*

> **动作替换**：点击动作 -> 选择替换 [选填，交互] -> 系统在**同部位、同器械**的备选池中随机推荐一个新动作进行替换。
> **环节调整**：删除环节 [选填，交互] -> 支持删除热身/放松环节 (时长归零，主训时长不变)。

## 第七层：数据装配 (对应架构：输出层)
> > *业务导读：数据格式化与打包，准备输出给前端。*

### 字段填充
> > *业务导读：把算好的数据打包成前端能看懂的格式，算出卡路里和难度分。*
> **基础信息**：生成 `课程ID`、`课程名称`。
> **数值计算**：计算 `预估卡路里`、`预估RPE`。

### 输出
> > *业务导读：最终生成的课程数据包。*
> *结果*：完整的 JSON 课程对象。

---

## 异常处理
> > *业务导读：当动作不够用或者规则冲突时，系统的兜底方案。*
### 动作池枯竭
> > *业务导读：如果筛选后没有动作可选，系统如何补救。*
> 若经过硬规则剔除后，可用动作不足以填满时长。
> **处理**：
> 1. 增加已选动作的组数 (如从3组加到5组)。
> 2. 引入“辅助部位”动作 (如练胸不够，补一点三头肌动作)。
> 3. 若仍不足，弹窗提示用户“可用器械过少，建议补充器械或选择自重训练”。

---

## 迭代规划
> > *业务导读：课程生成算法的进化路线。*

### v1.0 (当前 - 数字化教练)
> > *业务导读：当前版本保证生成的课程安全、结构完整。*
> **核心能力**：基于“硬规则”的安全筛选 + 基于“等级系数”的静态负荷。
> **数据积累**：开始积累用户训练容量、动作偏好数据，为算法进化提供燃料。
> **局限性**：缺乏对用户实时状态（如昨日疲劳）的动态响应。

### v2.0 (进阶 - 智能助理)
> > *业务导读：引入更多个性化打分和动态负荷调整。*
> **能力升级**：
> - **动态筛选**：引入 [3.1推荐影响因子配置]，实现“新鲜度”、“体位连贯性”打分。
> - **负荷闭环**：引入 1RM 动态估算，基于 RPE 反馈自动修正下一次负荷。
> - **疲劳干预**：引入 [4.1状态适配配置]，基于部位疲劳度自动降阶课程。

### v3.0 (完整 - 专家系统)
> > *业务导读：引入深度生理学模型，支持复杂的训练模式。*
> **能力升级**：
> - **深度生理学**：引入 CNS (中枢神经) 疲劳计算与生物力学热身匹配。
> - **高级排课**：支持“超级组”、“巨型组”等复杂训练模式。
> - **全生命周期**：实现“平台期”自动识别与“缺勤回归”智能调整。