# 课程生成逻辑
> 定义：基于用户状态、训练目标和场景约束，动态生成个性化训练课程的核心算法。
> 架构：输入层 -> 课程确认 -> 环节确认 -> 动作确认 -> 动作实例化 -> 用户微调 -> 数据装配 -> 反馈闭环

## 第一层：用户输入 (对应架构：输入层)
> 任务：收集生成课程所需的关键约束条件。

### 课程参数设定
> **目标部位**：全身｜胸部｜背部｜肩部｜手臂｜臀部｜腿部｜核心 [必填，多选，最多4项，默认：基于“部位疲劳状态”推荐]
> 来源：用户手动选择 (单次生成) 或 计划传入 (计划生成)。
> **运动时长**：20-60分钟 [必填，滑动条，默认：档案“每日运动时长”]
> 来源：用户选择 或 计划继承。
> **包含环节**：热身 | 主训 | 放松 [必填，多选，默认：全选]

### 档案校验与读取
> 逻辑：检查《运动档案》完整性，若缺失强制引导补全。
> 关键字段：`性别`、`生日`、`身高`、`体重`、`BMI`、`主要目标`、`功能目标`、`运动等级`、`疼痛部位`、`没有的器械`。
> 状态读取：
> - **运动等级**：L1 - L5 [必填] -> 决定基准负荷。
> - **安全约束**：`疼痛部位`、`没有的器械` -> 硬规则剔除。
> - **疲劳状态**：0-100 [自动读取] -> 疲劳干预。
> - **训练风格**：传统型｜多变型｜激进型 [自动读取] -> 风格匹配。

### 计划上下文
> **定义**：当生成属于某个训练计划的课程时，从上游计划引擎传入的约束参数。
> **来源**：`计划引擎` (当前执行的`计划` -> `阶段` -> `动态循环模板` -> 当日`基础槽位`)。
> **继承参数**：
> - 上下文`侧重目标` (对应 课程`目标部位` 或 动作`动作模式`)。
> - 上下文`课程类型` (对应 课程`课程类型`)。
> - 上下文`课程时长` (继承自 计划`单课时长`)。
> - 上下文`环节列表` (继承自 计划`包含环节`)。

## 第二层：课程确认 (对应架构：第4层 课程)
> 任务：确定课程维度的核心属性。

### 属性初始化
> **课程目标**：
> - 单次生成：课程`课程目标` = 档案`功能目标`。
> - 计划生成：课程`课程目标` = 阶段`阶段目标`。
> **课程类型**：
> - 单次生成：课程`课程类型` = 用户输入`课程类型`。
> - 计划生成：课程`课程类型` = 上下文`课程类型`。
> **目标部位**：
> - 单次生成：课程`目标部位` = 用户输入`目标部位`。
> - 计划生成：课程`目标部位` = 上下文`侧重目标` (若为`动作模式`则映射为解剖部位)。
> **课程时长**：
> - 单次生成：课程`课程时长` = 用户输入`运动时长`。
> - 计划生成：课程`课程时长` = 上下文`课程时长`。
> **课程难度**：
> - 课程`课程难度` = 档案`运动等级`。

### 疲劳干预 (一级)
> 引用：[4.1状态适配配置]
> 条件：课程`目标部位` 对应的 疲劳状态`状态值` 命中配置中的 `力竭` 区间。
> 决策：
> - 推荐调整（不是自动调整） 课程`课程目标` = 恢复。
> - 推荐调整（不是自动调整）  课程`课程类型` = 拉伸 或 康复。

## 第三层：环节确认 (对应架构：第5层 环节)
> 任务：规划课程内部结构及各环节参数。

### 环节实例化与时长分配
> 引用：[1.3结构与组装配置]
> **逻辑**：基于 课程`课程类型` 读取各环节的时长占比范围。
> **热身**：按配置分配 (如 10% - 15%)。
> - 筛选标签：动作`动作功能` ∈ [心肺, 激活, 协调, 平衡]。
> **主训**：按配置分配 (如 70% - 80%)。
> **放松**：按配置分配 (如 10% - 15%)。
> - 筛选标签：动作`动作功能` ∈ [柔韧, 恢复, 体态]。

### 训练参数加载
> 引用：[1.1策略矩阵配置]
> **通用参数加载**：
> - **查询键**：[课程`课程目标`, 档案`运动等级`]
> - **赋值映射**：
>   - 环节`动作组数` = 策略`动作组数`。
>   - 环节`动作间歇` = 策略`动作间歇`。
>   - 环节`训练强度` = 策略`训练强度`。
>   - 环节`目标RPE` = 策略`目标RPE`。
>   - 环节`循环模式` = 策略`循环模式`。
>   - 环节`负荷策略` = 策略`负荷策略`。
>   - 环节`难度策略` = 策略`难度策略`。
> 引用：[1.2动作模式配比]
> **模式骨架**：
> - 逻辑：若 课程`目标部位` 映射为 `动作模式`，则加载对应的骨架分布 (如：水平推80% + 辅助20%)。

### 参数修正
> 引用：[4.1状态适配配置]
> 引用：[3.2风格策略配置]
> **疲劳修正**：匹配当前状态值区间，应用对应的 `参数修正` 系数。
> **生理周期修正**：匹配 档案`生理周期` 当前阶段，应用对应的 `强度系数` 和 `容量系数`。
> **周期修正**：应用 阶段`强度修正系数`（如减载期`训练强度`*0.6）。
> **风格修正**：根据用户偏好覆盖默认策略。

## 第四层：动作确认 (对应架构：第6层 容量与筛选)
> 任务：从动作库中筛选并填充具体动作。

### 智能筛选
> **初筛**：
> - **主训**：选取 动作`主要部位` == 课程`目标部位` (或 动作`动作模式` 匹配) 的动作。
> - **热身/放松**：选取 动作`动作功能` 符合环节定义的动作。
> **剔除 (硬规则)**：
> - 伤病规避：动作`疼痛部位` ∩ 档案`疼痛部位` == Ø (无交集)。
> - 器械拦截：动作`动作器械` ∩ 档案`没有的器械` == Ø (无交集)。
> **打分 (软规则)**：
> 引用：[3.1推荐影响因子配置]
> - 逻辑：初始分=0，满足条件累加分值，最终按总分排序。
> - **加分项**：核心匹配奖励、功能热身奖励(基于数据映射)、风格契合奖励、难度适宜奖励、新鲜奖励、探索奖励(新动作)、高效奖励、连贯性奖励。
> - **扣分项**：疲劳惩罚、厌倦惩罚、难度偏离惩罚、安全风控惩罚 (基于 动作`冲击等级` vs 档案`BMI`)。
> - **互斥逻辑**：若已选动作列表中存在同名动作，后续同名变体强制扣分 (-500)。

### 结构组装
#### 热身/放松
> **策略**：加权随机。
> **逻辑**：从 `得分` Top 5 的动作池中，按权重随机抽取，直至填满 环节`训练时长`。
#### 主训 (力量类)
> **容量预算**：`目标组数` = `环节时长` / `单组耗时` (约2-3min)。
> 引用：[1.3结构与组装配置]
> **核心槽位** (占比读取配置，默认约 60%)：
> - `池子`：得分 Top 3 的 动作`动作构造`="复合动作"。
> - `策略`：权重随机抽取
> **辅助槽位** (占比读取配置，默认约 40%)：
> - `池子`：得分 Top 5 的 动作`动作构造`="孤立动作"。
> - `策略`：权重随机抽取。
> **兜底策略**：
> - 若 `核心槽位` 动作不足，使用 `辅助槽位` 动作填充。
> - 若 课程`目标部位` 动作不足，引入 `拮抗肌` 或 `协同肌` 动作填充 (如练胸不足补三头)。
#### 主训 (有氧/HIIT类)
> **策略**：基于 环节`循环模式` (如循环组) 按时长切片填充。
#### 动态平衡
> **校验**：`预估总时长` > `课程时长` + `时长容差`。
> **修正**：停止填充辅助动作 -> 减少核心动作组数 (底线：`最小核心组数`)。

### 排序优化
> **能量管理**：按 动作`动作构造` (复合 > 孤立) 降序排列。
> **流畅度**：同 动作`动作器械` / 动作`动作体位` 的动作尽可能相邻。
> **超级组配对** (若 环节`循环模式` == 超级组):
> 逻辑：将 动作`主动肌` 与 动作`拮抗肌` 动作两两配对 (如 卧推 + 划船)。
> 约束：检查 动作`动作器械` 冲突 (如用户只有一对哑铃，则不能配对两个都需要哑铃的动作，除非是自重+哑铃)。
> **安全校验**：
> - **冲击分散**：检查是否存在连续 N 个 动作`冲击等级`="高冲击" 动作 -> 打散排序。

## 第五层：动作实例化 (对应架构：第7层 动作实例化)
> 任务：计算每个动作的具体执行参数（重量/次数/组数）。

### 执行参数计算
> **负荷计算**：
> - 动作`推荐重量` = 档案`1RM` × 动作`关联部位系数` × 环节`训练强度`。
> **兜底**：若无1RM，动作`推荐重量` = 动作`默认重量`。
> **边界**：动作`推荐系数下限` ≤ 动作`推荐重量` ≤ 动作`推荐系数上限`。
> 引用：[4.强度指标换算映射]
> - **常规/波浪**：动作`推荐次数` = 基于 环节`训练强度` 反查映射表。
> - **计时策略**：动作`推荐次数` = 0 (不计次)；动作`基础时长` = 环节`训练强度` 映射的固定时长 (如 L3=45s)。
> - 动作`基础时长` = 动作`动作视频时长` × 动作`教学次数`。
> - 动作`单组时长` = (动作`单边独立性` == 是) ? (动作`基础时长` × 2 + 5s) : 动作`基础时长`。
> **组间策略**：
> 引用：[2.1负荷与组间策略配置]
> - 逻辑：基于 环节`负荷策略` (如递增/恒定)，生成每组的具体参数序列。

## 第六层：用户微调 (对应架构：交互层)
> 任务：赋予用户最终决定权。

> **动作替换**：点击动作 -> 选择替换 [选填，交互] -> 解决用户不喜欢特定动作的问题。
> **参数调整**：修改组数/重量/次数 [选填，数字输入，默认：当前值] -> 调整训练负荷，系统记录并学习。
> **难度调整**：降低难度 | 提升难度 [选填，单选] -> 整体调整课程难度系数，适配当日状态。
> **环节调整**：排序 | 删除 [选填，交互] -> 自定义课程结构。

## 第七层：数据装配 (对应架构：输出层)
> 任务：实例化为标准的课程数据对象。
> 目标：确保数据与《课程属性》定义完美对应。


### 字段填充
> **基础信息**：生成 `课程ID`、`课程名称`、`课程介绍`。
> **数值计算**：计算 `预估卡路里`、`课程MET值`、`预估RPE`。
> **标签聚合**：聚合 `配件要求`、`冲击等级`、`疼痛部位`。
### 输出
> 结果：完整的 JSON 课程对象。

## 第八层：反馈闭环 (对应架构：数据层)
> 任务：基于训练数据反哺算法，实现自我进化。

### 强度校准
> 引用：[4.2反馈与自适应配置]
> 逻辑：若 |`用户反馈RPE` - 课程`预估RPE`| > 配置.`RPE偏差阈值` -> 调整该用户该部位的 档案`1RM` 或 `强度修正系数`。
> **平台期识别**：
> - 条件：(连续 N 次训练 动作`推荐重量` 未提升) ≥ 配置.`平台期判定次数` && (课程`完成度` > 配置.`有效训练完成度`)。
> - 决策：
>   1. 标记该用户该部位进入“平台期”。
>   2. 下次生成课程时，强制切换 `负荷策略` (如：从“推荐”切换为“波浪”或“递减”)，或建议“减载周”。

### 偏好学习
> 引用：[4.2反馈与自适应配置]
> 逻辑：若某动作被用户 **主动替换** 次数 ≥ 配置.`厌恶判定次数` -> 加入“冷宫名单”（应用 [3.1推荐影响因子配置].`冷宫惩罚`）。
> 逻辑：若某动作被用户 **收藏** -> 应用 [3.1推荐影响因子配置].`收藏奖励`。
