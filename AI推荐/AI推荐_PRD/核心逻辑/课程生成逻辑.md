# 课程生成逻辑
> 定义：基于用户状态、训练目标和场景约束，动态生成个性化训练课程的核心算法。
> 架构：输入层 -> 课程确认 -> 环节确认 -> 动作确认 -> 动作实例化 -> 用户微调 -> 数据装配 -> 反馈闭环

## 第一层：用户输入 (对应架构：输入层)
> 任务：收集生成课程所需的关键约束条件。

1. **档案校验**：
   - 检查《运动档案》完整性，若缺失强制引导补全。
   - 关键字段：`性别`、`BMI`、`运动等级`、`疼痛部位`、`没有的器械`。

2. **课程参数设定**：
   - **目标部位**：全身｜胸部｜背部｜肩部｜手臂｜臀部｜腿部｜核心 [必填，多选，最多4项，默认：基于疲劳状态推荐]
     > 用途：决定课程“目标部位”。
   - **运动时长**：20-60分钟 [必填，滑动条，默认：档案“每日运动时长”]
     > 用途：作为容量计算的时间约束上限。
   - **包含环节**：热身 | 主训 | 放松 [必填，多选，默认：全选]
     > 用途：定义课程结构。

3. **状态参数读取**：
   - **疲劳状态**：0-100 [自动读取，无需输入]
     > 用途：用于疲劳干预和风险控制。
   - **训练风格**：传统型｜多变型｜激进型 [自动读取，默认：传统型]
     > 用途：用于风格匹配和个性化推荐。

4. **场景上下文** (仅计划课)：
   - **来源**：当前`计划` -> `阶段` -> `动态循环模板` -> 当日`基础槽位`。
   - **继承参数**：`侧重目标`（对应`目标部位`）、`课程模式`、`课程类型`。
   - **参数继承**：`课程时长`、`环节列表` 继承`计划属性`设置。

## 第二层：课程确认 (对应架构：第4层 课程)
> 任务：确定课程维度的核心属性。

1. **属性初始化**：
   - **课程目标**：单课继承档案`功能目标`；计划课继承阶段`阶段目标`。
   - **课程类型**：单课由用户选择；计划课继承模板`课程类型`。
   - **目标部位**：单课由用户选择；计划课继承槽位`侧重目标`（若为`课程模式`则自动映射为解剖部位）。
   - **课程时长**：用户设定或计划设定。

2. **疲劳干预 (一级)**：
   - 若 `目标部位`的`状态值` < 30（力竭）：
     - 自动调整 `课程目标` = 恢复。
     - 自动调整 `课程类型` = 拉伸 或 康复。

## 第三层：环节确认 (对应架构：第5层 环节)
> 任务：规划课程内部结构及各环节参数。

1. **环节实例化与时长分配**：
   - **输入**：`课程属性`.`课程时长` 和 `课程属性`.`环节列表`。
   - **操作**：实例化`环节属性`对象列表。
   - **赋值**：
     - `环节类型`：对应`环节列表`中的项（热身/主训/放松）。
     - `训练时长`：基于 [1.3环节时长分配配置]进行分配。
     - `环节名称`：默认同`环节类型`。

2. **训练参数加载**：
   - **来源**：基于 `课程属性`.`课程目标` × `运动档案`.`运动等级`，从[1.1策略矩阵配置]加载基准参数。
   - **赋值**：
     - `动作组数`：加载基准值。
     - `休息配置`：加载基准值（映射至`动作间歇`，`轮间休息`默认=2*`动作间歇`）。
     - `训练强度`：加载基准值。
     - `目标RPE`：加载基准值。
     - `循环模式`：加载基准值。
     - `负荷策略`：加载基准值。
     - `难度策略`：加载基准值。
     - `动作节奏`：默认置空。

3. **参数修正**：
   - **疲劳修正 (二级)**：
     - **恢复中 (55 ≤ 状态值 < 85)**：`训练强度` * 0.9。
     - **疲劳 (30 ≤ 状态值 < 55)**：`训练强度` * 0.8，`动作组数` * 0.8，推荐 `循环模式` = 常规组，避免 `冲击等级` = 高冲击（降低推荐权重）。
   - **生理周期修正**：
     - **月经期**：`训练强度` * 0.6，`动作组数` * 0.6，强制 `冲击等级` = 无冲击。
     - **黄体期**：`训练强度` * 0.9 (体温升高，耐热性差)。
     - **卵泡期/排卵期**：`训练强度` * 1.05 (力量峰值期，鼓励突破)。
   - **周期修正**：若为计划课，应用`阶段属性`中的系数（如减载期`训练强度`*0.6）。
   - **风格修正**：若档案`喜欢的训练风格` = 激进型，升级 `难度策略`。

4. **模式骨架规划**：
   - 引用[1.2课程模式配比]，确定主训环节的`动作模式`分布（如：水平推40% + 垂直推40%）。

## 第四层：动作确认 (对应架构：第6层 容量与筛选)
> 任务：从动作库中筛选并填充具体动作。

1. **智能筛选**：
   - **硬规则剔除**（一票否决）：
     - **环节匹配**：`动作属性`.`动作环节` = 当前`环节属性`.`环节类型`。
     - **伤病规避**：`动作属性`.`疼痛部位` 包含 档案`疼痛部位`。
     - **器械限制**：`动作属性`.`动作器械` 包含 档案`没有的器械`。
   - **软规则加权**（打分排序）：
     > 逻辑：遍历[3.1动作筛选规则配置]列表，逐项评估动作是否满足条件，满足则累加对应分值。
     - **核心匹配**：校验 `动作属性`.`主要部位` 与 `动作属性`.`动作模式` 是否符合骨架。
     - **风格契合**：引用 [2.2风格策略配置] 获取当前风格的加分条件进行校验。
     - **难度适宜**：校验 `动作属性`.`动作难度` 是否符合 [2.1难度策略配置]。
     - **新鲜度**：校验动作的历史训练记录（如：过去7天未练）。
     - **高效加分**：校验 `动作属性`.`动作构造`（复合动作优先）。
     - **体位一致**：若当前非首个动作，校验 `动作属性`.`动作体位` 是否与上一动作相同。
     - **器械一致**：若当前非首个动作，校验 `动作属性`.`动作器械` 是否与上一动作相同。
     - **难度偏离**：校验 `动作属性`.`动作难度` 是否超出兼容范围。
     - **疲劳惩罚**：校验 `动作属性`.`辅助肌` 的疲劳状态。
     - **厌倦惩罚**：校验动作在近期同部位训练中的出现频率。
     - **安全风控**：校验 `用户档案` 与 `动作属性`.`冲击等级` 的冲突风险。

2. **结构组装**：
   - **热身/放松**：按时长填充，采用**贪心算法**优先选取得分最高的动作（针对主训部位 + 体位一致）。
   - **主训**：
     - **力量类**：基于容量预算（`动作组数` = 时长/单组耗时）。
       - **核心槽位填充**：从得分 Top 3 的 **复合动作**（`动作构造`=复合动作）中，按权重概率随机抽取。
       - **辅助槽位填充**：从得分 Top 5 的 **孤立动作**（`动作构造`=孤立动作）中，按权重概率随机抽取。
       - **探索槽位（可选）**：若剩余容量允许，尝试插入 1 个“低频/新动作”，用于拓展用户动作库。
     - **有氧/HIIT**：基于时长切片，按`循环模式`填充。
     - **动态平衡**：实时校验总时长，若超出 `课程时长` + [3.4生成约束配置].`时长容差`，立即停止填充辅助动作，并尝试减少核心动作的组数（最低减至 [3.4生成约束配置].`最小核心组数` 组）。

3. **排序优化**：
   - **能量管理**：大重量复合动作前置。
   - **流畅度**：同`动作器械`动作相邻。
   - **超级组**：若`循环模式` = 超级组，自动配对`主动肌` - `拮抗肌` 动作。
   - **安全校验**：
     - 检查是否存在连续 [3.4生成约束配置].`最大连续高冲击` 个以上的`冲击等级` = 高冲击动作（若有则尝试打散）。
     - 检查总时长是否严重偏离用户预期（允许 ±[3.4生成约束配置].`时长容差` 误差）。

## 第五层：动作实例化 (对应架构：第7层 动作实例化)
> 任务：计算每个动作的具体执行参数（重量/次数/组数）。

1. **负荷计算**：
   - **重量**：
     - 公式：`用户1RM` × `动作关联部位系数` × `环节属性`.`训练强度`。
     - 兜底：若无1RM数据，使用`动作属性`.`默认重量`。
     - 边界：`动作属性`.`推荐系数下限` ≤ 推荐重量 ≤ `动作属性`.`推荐系数上限`。
   - **次数**：
     - 逻辑：基于 `环节属性`.`训练强度` 反查[数据映射]中的[4.强度指标换算映射]。
   - **时长**：
     - 逻辑：基础时长 = `动作属性`.`动作视频时长` × `教学次数`。
     - 修正：若 `动作属性`.`单边独立性` = 是，则 单组时长 = (基础时长 × 2) + 换边缓冲(5s)。

2. **组间策略应用**：
   - 基于 `环节属性`.`负荷策略`，引用[3.3组间策略配置]，生成每组的具体参数序列。
   - 示例：若策略为“递增”，则应用配置中的序列逻辑（如：[负荷0.85, 次数+2], [负荷0.90, 次数+1], [负荷1.00, 次数0]）。

## 第六层：用户微调 (对应架构：交互层)
> 任务：赋予用户最终决定权。

1. **动作替换**：点击动作 -> 选择替换 [选填，交互，默认：无]
   > 定义：用户从备选池中选择其他动作替换当前动作。
   > 用途：解决用户不喜欢特定动作的问题。

2. **参数调整**：修改组数/重量/次数 [选填，数字输入，默认：当前值]
   > 定义：用户手动修改动作的执行参数。
   > 用途：调整训练负荷，系统记录并学习。

3. **难度调整**：降低难度 | 提升难度 [选填，单选，默认：无]
   > 定义：整体调整课程的难度系数。
   > 用途：快速适配用户当日状态。

4. **环节调整**：排序 | 删除 [选填，交互，默认：无]
   > 定义：调整环节的顺序或移除环节。
   > 用途：自定义课程结构。

## 第七层：数据装配 (对应架构：输出层)
> 任务：实例化为标准的课程数据对象。
> 目标：确保数据与《课程属性》定义完美对应。


1. **字段填充**：
   - 生成 `课程ID`、`课程名称`、`课程介绍`。
   - 计算 `预估卡路里`、`课程MET值`、`预估RPE`。
   - 聚合 `配件要求`、`冲击等级`、`疼痛部位`。
2. **输出**：完整的 JSON 课程对象。

## 第八层：反馈闭环 (对应架构：数据层)
> 任务：基于训练数据反哺算法，实现自我进化。

1. **强度校准**：
   - 逻辑：若 `用户反馈RPE` 与 `目标RPE` 偏差 > 2，调整该用户该部位的 `1RM估算值` 或 `强度修正系数`。
   - **平台期识别**：
     - 逻辑：若某动作在连续 3 次训练中 `推荐重量` 未提升 且 `完成度` > 90%。
     - 决策：
       1. 标记该用户该部位进入“平台期”。
       2. 下次生成课程时，强制切换 `负荷策略` (如：从“推荐”切换为“波浪”或“递减”)，或建议“减载周”。
2. **偏好学习**：
   - 逻辑：若某动作被用户 **主动替换** 超过 3 次，将该动作加入“冷宫名单”（降低推荐权重 -50）。
   - 逻辑：若某动作被用户 **收藏**，推荐权重 +50。
