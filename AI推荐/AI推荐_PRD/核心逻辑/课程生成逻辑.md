# 课程生成逻辑
> 定义：基于用户状态、训练目标和场景约束，动态生成个性化训练课程的核心算法。
> 架构：状态感知 -> 目标规划 -> 动态排课 -> 优化校验 -> 反馈闭环 -> **属性装配**

## 用户操作（生成前）
1. **选择目标部位**：全身｜胸部｜背部｜肩部｜手臂｜臀部｜腿部｜核心 [必填，多选，最多4项，默认：根据疲劳状态推荐]
   > 用途：决定课程“目标部位”
   > 推荐逻辑：优先推荐“状态值 > 85”的部位，自动置灰“状态值 < 30”的部位。
2. **选择运动时长**：20-60分钟 [必填，滑动条，默认：档案“每日运动时长”]
   > 用途：作为容量计算的时间约束上限。
3. **选择环节**：热身 | 主训 | 放松 [必填，勾选，默认：全勾选]
   > 用途：决定课程结构。
4. **档案校验**：若用户档案未完整填写，强制引导补全。

## 第一层：输入层（状态感知）
> 任务：收集并标准化所有影响决策的变量，构建“用户当前状态快照”。

1. **静态画像读取**
   - **生理特征**：性别、BMI（用于冲击等级判断）。
   - **训练水平**：运动等级（L1-L5）、1RM估算值。
   - **硬件环境**：拥有器械、没有的器械。
   - **伤病记录**：疼痛部位。

2. **动态状态读取**
   - **疲劳状态**：读取《疲劳管理系统》，获取各部位肌群的实时状态值（0-100）。
   - **周期位置**：当前处于计划的哪个阶段（适应/进阶/突破/减载）。
   - **即时意图**：用户本次选择的时长、部位。

## 第二层：策略层（目标规划）
> 任务：将用户的“模糊意图”转化为可执行的“精确训练参数”。
> 核心逻辑：f(用户状态, 训练目标) = 训练参数对象

1. **参数初始化**
   - **课程目标**：
     - 单课模式：继承档案“功能目标”。
     - 计划模式：继承阶段“阶段目标”。
   - **课程类型**：
     - 单课模式：用户选择。
     - 计划模式：继承动态模板配置。

2. **容量与强度规划**
   > 基于“策略矩阵”获取基准值，并根据状态进行修正。

   - **基准参数获取** (引用《AI推荐配置》- 1. 策略矩阵)：
     - 查询条件：目标 × 等级
     - 获取参数：动作组数、组间休息、训练强度、目标RPE、循环模式、负荷策略、难度策略。
   - **状态修正（疲劳干预）**：
     - **恢复中 (55 ≤ 状态值 < 85)**：
       - `训练强度` * 0.9（微调保护）。
     - **疲劳 (30 ≤ 状态值 < 55)**：
       - `训练强度` * 0.8，`动作组数` * 0.8。
       - 强制 `循环模式` = 常规组。
       - 剔除 `冲击等级` = 高冲击动作。
     - 若 `目标部位状态值` < 30（力竭）：
       - 强制 `课程目标` = 恢复
       - 仅推荐拉伸/筋膜放松动作
   - **周期修正（计划模式）**：
     - 若处于“减载期”：`动作组数` * 0.6，`训练强度` * 0.6。
     - 若处于“突破期”：`训练强度` * 1.1。
   - **风格修正** (引用《AI推荐配置》- 3. 风格策略配置)：
     - 若用户偏好“激进型”，升级 `难度策略`。
     - 若用户偏好“多变型”，调整 `循环模式`。

3. **动作模式配比**
   > 引用《AI推荐配置》- 4. 动作模式配比范例。
   > 根据当前模板（如推拉腿、全身、HIIT）获取对应的模式骨架。

4. **难度分布规划**
   > 目的：打开动作池子，避免死板的“向下兼容”。
   > 来源：基于 `难度策略` 读取《AI推荐配置》- 2. 难度策略配置。
   
   - **难度兼容范围**（硬边界）：
     - 例：用户等级 L3 -> 允许动作范围 [L2, L4]。
   - **难度概率配比**（软分布）：
     - 例：标准策略 -> L3(60%) + L2(20%) + L4(20%)。

## 第三层：执行层（动态排课）
> 任务：根据策略层的参数，从动作库中筛选并组装动作。

1. **智能筛选器（Smart Filter）**
   - **硬规则剔除**（一票否决）：
     - **环节匹配**：动作`动作环节` = 当前填充环节（热身/主训/放松）。
     - **难度范围**：动作`动作难度` ∈ 策略层规划的 `难度兼容范围`（如 [L2, L4]）。
     - **伤病规避**：动作`疼痛部位` 包含 档案`疼痛部位`。
     - **器械限制**：动作`动作器械` 包含 档案`没有的器械`。
     - **安全风控**：若档案`BMI` ≥ 28 且 `运动等级` < L3，剔除 `冲击等级` = 高冲击。
   - **软规则加权**（打分排序）：
     - **匹配度**：动作`主要部位` = 课程`目标部位` (+10分)。
     - **模式匹配**：动作`动作模式` = 策略层规划的模式 (+10分)。
     - **多样性**：近期未训练过的动作 (+3分)。
     - **权重**：动作`动作权重` (+权重值)。

2. **结构组装器（Structure Assembler）**
   - **热身环节填充**：
     - 策略：时长驱动。
     - 逻辑：选取 `动作环节`=热身 的动作，直至总时长达到 `课程时长` * 10-15%。优先选取 `主要部位` = 全身 或 课程`目标部位` 的动态拉伸/激活动作。
   
   - **主训环节填充**：
     - **力量类课程**（容量驱动）：
       - `目标总组数` = (用户选定时长 - 热身放松时长) / (单组耗时 + 组间休息)。
       - *注：单组耗时预估 = 动作时长 + 换项损耗。*
       - **骨架构建**：优先填入 **复合动作**（如深蹲、卧推），占据 60-70% 容量。
       - **血肉填充**：填入 **辅助/孤立动作**（如二头弯举），补齐剩余容量。
       - **难度配比执行**：在填充过程中，尽量使入选动作的难度分布符合策略层的 `难度概率配比`。
     - **有氧/HIIT类课程**（时长驱动）：
       - 策略：时间切片。
       - 逻辑：选取 `动作模式`=步态/全身 或 高 `MET值` 的动作。
       - 循环：按 `循环模式`（引用《AI推荐配置》中的间歇参数，如 30s动/30s休）填充动作，直至填满主训时长。
   
   - **放松环节填充**：
     - 策略：时长驱动。
     - 逻辑：选取 `动作环节`=放松 的动作，直至总时长达到 `课程时长` * 10-15%。优先选取针对主训部位的静态拉伸动作。

   - **动态调整**：
     - 若时长溢出：优先削减辅助动作组数（力量）或减少循环轮数（有氧）。
     - 若时长不足：增加核心动作或有氧动作填充。

## 第四层：优化层（排序与校验）
> 任务：对生成的课程草稿进行“精修”，确保体验流畅且科学。

1. **排序逻辑**
   - **能量管理原则**：
     - 高神经消耗动作（大重量复合）前置。
     - 低消耗动作（孤立/器械）后置。
     - 核心/腹肌动作排在主训最后。
   - **流畅度优化**：
     - 减少器械切换频率（同器械动作相邻）。
     - 避免频繁体位切换（站/卧交替）。
   - **超级组匹配**（若开启）：
     - 自动寻找相邻的 `主动肌` - `拮抗肌` 动作进行配对（如卧推+划船）。

2. **安全校验**
   - 检查是否存在连续 3 个以上的高冲击动作。
   - 检查总时长是否严重偏离用户预期（允许 ±5% 误差）。

## 第五层：反馈闭环（自进化）
> 任务：让系统越用越聪明。

1. **即时反馈收集**
   - 课后收集 `RPE`（自觉费力程度）。
   - 收集 `疼痛反馈`（是否有不适）。

2. **参数修正**
   - **强度校准**：若 `实际RPE` > `目标RPE`，下调下一次同类课程的容量系数。
   - **偏好学习**：若用户频繁替换某动作，降低该动作的推荐权重。

## 第六层：课程属性装配（数据落地）
> 任务：基于上述逻辑生成的结构，填充《课程属性》中定义的所有字段，确保输出完整的课程数据对象。

1. **基础信息填充**
   - **关联产品/销售套餐**：继承自当前用户设备及权益信息。
   - **课程形态**：固定为 "AI推荐课程"。
   - **课程ID**：系统自动生成唯一UUID。
   - **课程运营ID**：系统自动生成或留空。
   - **课程名称**：
     - 规则：`{目标部位}{课程目标}训练` (如 "胸部增肌训练") 或 继承模板名称。
   - **课程介绍**：
     - 规则：自动生成文案，包含 "本课程针对{目标部位}进行{课程目标}训练，预计消耗{预估卡路里}kcal..."。
   - **PK课程**：默认 "否"。

2. **推荐标签填充**
   - **推荐权重**：算法实时计算值（基于匹配度打分）。
   - **课程类型**：继承自 策略层规划的 `课程类型`。
   - **课程目标**：继承自 策略层规划的 `课程目标`。
   - **目标部位**：继承自 用户选择 或 模板定义的 `目标部位`。
   - **课程难度**：继承自 档案 `运动等级`。
   - **课程时长**：
     - 计算：Σ(环节时长)。
     - 校验：应接近用户选择的 `运动时长`。
   - **配件要求**：
     - 逻辑：遍历所有入选动作的 `动作器械`，去重取并集。
   - **课程教练**：默认 "AI教练"。
   - **疼痛部位**：
     - 逻辑：遍历所有入选动作的 `疼痛部位`，去重取并集（理论上应为空或低风险）。
   - **冲击等级**：
     - 逻辑：若入选动作中包含 "高冲击"，则为 "高冲击"；否则取最高等级。
   - **课程风格**：继承自 档案 `喜欢的训练风格`。
   - **预估RPE**：
     - 计算：加权平均 (各环节 `目标RPE` × 环节时长占比)。
   - **课程MET值**：
     - 计算：加权平均 (各动作 `动作MET值` × 动作时长占比)。
   - **预估卡路里**：
     - 计算：Σ(动作MET值 × 用户体重 × 动作时长 / 60) + 基础代谢消耗。

3. **素材与环节填充**
   - **课程封面图/缩略图**：
     - 逻辑：取主训环节第一个动作的 `封面图`/`缩略图`。
   - **预览视频/课程视频**：
     - 逻辑：置空（由端侧播放器根据动作列表动态渲染）。
   - **环节列表**：
     - 逻辑：将生成的 热身、主训、放松 环节对象填入。每个环节对象包含对应的 `动作列表`、`训练配置`（组数/休息/强度等）。
