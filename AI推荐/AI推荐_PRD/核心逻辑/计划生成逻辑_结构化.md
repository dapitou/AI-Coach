# 计划生成逻辑
> **文档用途**：本文档是算法落地的“施工图纸”。
> - **产品经理**：请重点关注“业务导读”和“场景示例”，确认逻辑是否符合业务预期。
> - **开发人员**：请重点关注“输入/输出”和“处理逻辑”，这是代码实现的直接依据。
> **设计原则**：高内聚，低耦合。每个节点仅依赖明确的输入，产出标准化的输出。

## 节点流转总览
```mermaid
graph LR
    N1[输入与上下文] --> N2[计划确认]
    N2 --> N3[阶段确认]
    N3 --> N4[模板匹配与排期]
    N4 --> N5[用户微调]
    N5 --> N6[数据装配]
```

---

## 节点 1: 输入与上下文
> **定义**：收集并清洗所有影响计划生成的外部变量，构建统一的“约束上下文”。
> **业务导读**：
> 就像教练在制定长周期计划前的“摸底访谈”。系统需要收集你的基本信息、目标（增肌还是减脂）、时间预算（练几周、每周练几天），以及当前的身体状态（是否疲劳），把这些信息打包，作为后续生成计划的地基。

### 1. 输入数据
- **用户档案**：基础信息(性别/BMI)、能力数据(运动等级)、目标设定(主要目标/功能目标)、偏好设置(周频/训练日/器械/伤病)。
- **计划参数**：
  - `计划周期` (1-24周)
  - `单课时长` (20-60分钟)
  - `计划开始日期` (YYYY-MM-DD)
- **状态数据**：`部位疲劳度`。

### 2. 处理逻辑
1.  **数据完整性校验**：
    -   检查档案中 `性别`、`BMI`、`运动等级`、`主要目标`、`每周运动频率` 是否存在。
    -   若缺失，中断流程并返回错误码，引导用户补全档案。
2.  **疲劳风控拦截**：
    -   读取 `部位疲劳度` 数据。
    -   **判断**：若用户当前处于“全身疲劳”或“核心肌群力竭”状态。
    -   **执行**：
        -   **提示**：建议将 `计划开始日期` 推迟 1-2 天。
        -   **强制**：若用户坚持今日开始，标记 `首周降级` 信号（首周强度系数强制 * 0.8）。
3.  **上下文合并**：
    -   打包用户输入与档案数据，构建 `计划约束对象`。

### 3. 输出数据
- **约束对象**：
    -   `计划目标` (枚举)
    -   `计划周期` (整数，周)
    -   `可用时间` (周频, 单课时长)
    -   `起始日期` (日期对象)
    -   `首周降级` (布尔值)
    -   `禁忌部位` (列表)

### 4. 场景示例 (Data Snapshot)
> **场景**：用户想练4周增肌，但刚跑完马拉松（全身疲劳）。
> - **输入**：目标="增肌"，周期=4周，疲劳="全身力竭"。
> - **输出**：
>   - `计划目标`: 增肌
>   - `起始日期`: 建议推迟 (或 标记 `首周降级`=True)
>   - `计划周期`: 4

---

## 节点 2: 计划确认
> **定义**：确定计划的宏观元数据，为后续阶段划分定调。
> **业务导读**：
> 确定大方向。根据你的档案，决定给你生成一个什么样的长线计划。是“增肌”还是“减脂”？是“新手入门”还是“大神进阶”？同时决定是用稳健的线性周期，还是波动的波浪周期。

### 1. 输入数据
- **约束对象** (来自 节点 1)
- **用户档案** (`主要目标`, `功能目标`, `运动等级`)
- **配置表**：`[2.3 阶段周期分配配置]`

### 2. 处理逻辑
1.  **目标对齐**：
    -   `计划目标` = 档案 `主要目标` (如 "增肌")。
    -   `计划功能目标` = 档案 `功能目标` (如 "力量")。
2.  **难度定级**：
    -   `计划难度` = 档案 `运动等级` (如 L3)。

### 3. 输出数据
- **计划元数据**：
    -   `计划ID` (预生成)
    -   `计划目标` (枚举)
    -   `计划难度` (枚举)

### 4. 场景示例 (Data Snapshot)
> **场景**：L4高阶用户，目标力量举。
> - **输入**：等级=L4，目标=力量。
> - **输出**：
>   - `计划目标`: 力量
>   - `计划难度`: L4

---

## 节点 3: 阶段确认
> **定义**：规划计划的时间轴，切分阶段并设定各阶段策略。
> **业务导读**：
> 定节奏。把长计划切分成几个阶段。就像打游戏通关，先“适应期”找找感觉，再“进阶期”上强度，最后“突破期”冲刺，中间还要安排“减载期”休息回血。

### 1. 输入数据
- **计划元数据** (来自 节点 2)
- **约束对象** (`计划周期`)
- **配置表**：`[2.3 阶段周期分配配置]`, `[1.1 策略矩阵]`

### 2. 处理逻辑
1.  **阶段划分**：
    -   读取 `[2.3 阶段周期分配配置]`。
    -   **判断**：若 `计划周期` < 短周期阈值 (如4周)，应用 `短周期策略` (如仅保留 适应期+进阶期)。
    -   **否则**：应用 `标准模型` (适应期 -> 进阶期 -> 突破期 -> 减载期)。
2.  **周期分配**：
    -   按配置比例 (如 1:1:1:1) 分配各阶段周数。
    -   **兜底**：确保每个阶段 ≥ `阶段最小周数` (1周)。若总周数溢出，优先扣除最长阶段。
3.  **属性填充**：
    -   遍历生成的阶段列表：
        -   `阶段目标` = 计划 `计划功能目标`。
        -   `修正系数`：根据 `阶段类型` (如 "减载期") 读取 `[1.1 策略矩阵]` 中的强度/容量系数 (如 强度0.6)。
        -   *注*：若 `首周降级`=True，强制修正第一阶段的系数。

### 3. 输出数据
- **阶段列表 (列表<阶段对象>)**，每个阶段包含：
    -   `阶段类型` (适应/进阶...)
    -   `持续周数` (整数)
    -   `阶段目标`
    -   `强度系数` (浮点数)
    -   `容量系数` (浮点数)

### 4. 场景示例 (Data Snapshot)
> **场景**：4周标准增肌计划。
> - **输入**：周期=4周，模型=标准。
> - **输出**：
>   - 阶段1: 适应期 (1周), 强度0.8
>   - 阶段2: 进阶期 (1周), 强度1.0
>   - 阶段3: 突破期 (1周), 强度1.1
>   - 阶段4: 减载期 (1周), 强度0.6

---

## 节点 4: 模板匹配与排期
> **定义**：为每个阶段匹配最佳的周排课逻辑，并生成具体日历。
> **业务导读**：
> 定日程。决定每周具体怎么练。是“练三休四”，还是“推拉腿循环”？系统会根据你每周练几天的习惯，给每一周找个最合适的“课程表模子”，填进日历里。

### 1. 输入数据
- **阶段列表** (来自 节点 3)
- **用户档案** (`每周运动频率`, `每周训练日`)
- **配置表**：`[1.5 单周循环模板配置]`

### 2. 处理逻辑
1.  **模板选择 (逐阶段)**：
    -   遍历每个阶段：
        -   **筛选**：在 `[1.5 单周循环模板配置]` 中查找。
        -   **条件**：`模板目标` == `阶段目标` AND `模板难度` == `计划难度`。
        -   **决策**：优先选择 `模板周频` 最接近用户 `每周运动频率` 的模板。
        -   *示例*：用户练3天 -> 匹配 "三分化(推拉腿)" 或 "全身循环(3天)"。
2.  **日历实例化**：
    -   **训练日映射**：将模板的 `基础槽位` 按顺序填入用户的 `每周训练日` (如 周一/周三/周五)。
    -   **溢出处理**：
        -   若 用户频率 > 模板频率 (如 模版3天，用户练5天)：
        -   应用模板的 `填充策略` (循环/填充/随机) 生成额外槽位填入剩余训练日。
    -   **休息日处理**：
        -   非训练日填充 `休息槽位` (如 "主动恢复" 或 "完全休息")。
3.  **日期计算**：
    -   根据 `计划开始日期`，推算每一节课的具体 `执行日期` (YYYY-MM-DD)。

### 3. 输出数据
- **排期表 (Schedule)**：
    -   包含每日的 `日期`, `槽位定义` (侧重目标/课程类型), `所属阶段`。

### 4. 场景示例 (Data Snapshot)
> **场景**：用户周一/三/五训练，匹配到“推拉腿”模板。
> - **输入**：训练日=[1,3,5]，模板=[推, 拉, 腿]。
> - **输出**：
>   - 周一: 推力日 (胸/肩/三头)
>   - 周二: 休息
>   - 周三: 拉力日 (背/二头)
>   - 周四: 休息
>   - 周五: 腿部日 (臀/腿)
>   - ... (循环4周)

---

## 节点 5: 用户微调
> **定义**：处理用户在前端的主动修改请求。
> **业务导读**：
> 最后的把关。把生成好的计划展示给你。哪天练、练多久，如果不满意可以自己改。改完之后，系统会重新调整排期。

### 1. 输入数据
- **排期表** (来自 节点 4)
- **用户指令** (调整训练日 / 调整时长 / 调整开始日期)

### 2. 处理逻辑
1.  **调整训练日**：
    -   **输入**：用户修改了 `每周训练日` (如 从 1/3/5 改为 2/4/6)。
    -   **执行**：保持 `槽位` 顺序不变，将其重新映射到新的日期上。
2.  **调整时长**：
    -   **输入**：用户修改 `单课时长`。
    -   **执行**：更新计划元数据，作为后续生成具体课程时的约束。
3.  **调整开始日期**：
    -   **输入**：用户修改 `开始日期`。
    -   **执行**：整体平移所有课程的 `执行日期`。

### 3. 输出数据
- **确认后的排期表**。

### 4. 场景示例 (Data Snapshot)
> **场景**：用户临时有事，把计划推迟一周开始。
> - **输入**：开始日期 + 7天。
> - **输出**：所有课程日期 + 7天，内容不变。

---

## 节点 6: 数据装配
> **定义**：将内部对象转换为前端可渲染的标准 JSON 格式。
> **业务导读**：
> 打包出厂。把算好的计划、阶段、每一天的课表打包成标准格式，存入数据库，准备执行。

### 1. 输入数据
- **计划元数据** (来自 节点 2)
- **阶段列表** (来自 节点 3)
- **确认后的排期表** (来自 节点 5)

### 2. 处理逻辑
1.  **ID生成**：生成 `计划ID`，`阶段ID`。
2.  **文案生成**：
    -   `计划名称`："{周期}周{目标}突破计划"。
    -   `计划介绍`：基于目标和周期生成描述。
3.  **结构组装**：
    -   将 `排期表` 嵌套入对应的 `阶段`。
    -   将 `阶段` 嵌套入 `计划`。

### 3. 输出数据
- **标准计划 JSON** (符合《计划属性》定义)。

### 4. 场景示例 (Data Snapshot)
> **场景**：生成最终JSON。
> - **输出**：
>   ```json
>   {
>     "planId": "PLN_Gen_001",
>     "title": "4周增肌突破计划",
>     "phases": [
>       {"name": "适应期", "weeks": 1, "schedule": [...]},
>       {"name": "进阶期", "weeks": 2, "schedule": [...]}
>     ]
>   }
>   ```

## 需求池
> > *业务导读：未来版本规划的逻辑模块。*
1. **周期模型选择**：支持波浪周期、区块周期等高阶模型。