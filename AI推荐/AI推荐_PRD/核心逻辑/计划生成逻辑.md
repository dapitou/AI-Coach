# 计划生成逻辑
> 定义：基于用户长期目标，生成多阶段、周期化的训练计划核心算法。
> 架构：用户输入 -> 计划确认 -> 阶段确认 -> 动态循环模板匹配 -> 用户微调

## 第一层：用户输入 (对应架构：输入层)
> 任务：收集生成计划所需的关键约束条件。

### 计划参数设定
> **计划周期**：1-24 [必填，数字输入，默认：4] -> 用途：决定计划的时间跨度，单位为周。
> **单课时长**：20-60 [必填，滑动条，默认：档案`每日运动时长`] -> 用途：作为后续生成课程的时间约束，单位为分钟。
> **包含环节**：热身 | 主训 | 放松 [必填，多选，默认：全选] -> 用途：定义课程结构，至少包含主训。

### 档案校验与读取
> **逻辑**：检查《运动档案》完整性，若缺失强制引导补全。
> **关键字段**：`性别`、`生日`、`身高`、`体重`、`BMI`、`运动等级`、`主要目标`、`功能目标`、`运动等级`、`每周运动频率`、`每周训练日`、`疼痛部位`、`没有的器械`。

## 第二层：计划确认 (对应架构：第1层 计划)
> 任务：生成计划维度的基础属性。

### 计划初始化
> **目标匹配**：
> - 计划`计划目标` = 档案`主要目标`。
> - 计划`计划功能目标` = 档案`功能目标`。
> - 计划`计划难度` = 档案`运动等级`。
> **周期模型**：
> 引用：[3.4生成约束配置]
> - 默认：线性周期。
> - 规则：若 档案`运动等级` ≥ `波浪周期准入`，可升级为“波浪周期”。

## 第三层：阶段确认 (对应架构：第2层 阶段)
> 任务：规划计划的时间轴和阶段策略。

### 阶段划分逻辑
> 引用：[2.3阶段周期分配配置]
> **标准模型**：适应期 → 进阶期 → 突破期 → 减载期。
> **短周期处理**：
> - **判断**：若 计划`计划周期` < `短周期阈值`。
> - **逻辑**：根据 档案`运动等级` 匹配 `短周期策略` 中的阶段组合。

### 阶段周期分配
> 引用：[2.3阶段周期分配配置]
> 引用：[3.4生成约束配置]
> **规则**：按 `标准比例` 分配周数（四舍五入取整，且 ≥ 阶段最小周数）。
> **兜底**：若总周数溢出，优先扣除最长阶段（通常为进阶期）。
> *注：此为初始规划，实际执行中应根据用户RPE反馈动态调整阶段长度（如提前进入平台期则提前结束进阶期）。*

### 阶段属性填充
> 引用：[1.1策略矩阵配置]
> **属性赋值**：
> - 阶段`阶段目标` = 计划`计划功能目标`。
> - 阶段`阶段类型` = 策略`阶段类型`。
> **训练配置初始化** (周期化修正)：
> - **逻辑**：根据 阶段`阶段类型` 获取对应的修正系数。
> - **执行**：应用配置中的 `强度系数` (乘法叠加) 和 `容量系数` 对基准参数进行修正。

## 第四层：动态循环模板匹配 (对应架构：第3层 动态循环模板)
> 任务：为每个阶段匹配最佳的周排课逻辑。
> 引用：[1.5动态循环模板配置]

### 模板选择
> **筛选条件**：
> - 目标一致：模板`模板目标` = 计划`计划功能目标`。
> - 难度适配：模板`模板难度` = 计划`计划难度`。
> - 频率兼容：模板`模板周频` ≤ 档案`每周运动频率`。
> **决策策略**：
> - 最优解：优先选 模板`模板周频` 最接近 档案`每周运动频率` 的模板。
> - 兜底：若无匹配，降级匹配同目标下的最低频模板（通常为全身循环）。

### 排课实例化（周循环生成）
> **训练日填充**：
> - 排期`训练日` = 档案`每周训练日`。
> - 排期`课程槽位` = 模板`基础槽位` (按序填充)。
> - **溢出处理** (当 档案`每周运动频率` > 模板`模板周频`)：
>   - 依据 模板`填充策略` (循环/填充/随机) 生成额外槽位。
> **休息日填充**：
> - 若 模板`休息日策略` == "主动恢复"：排期`休息日内容` = 模板`休息槽位`。

## 第五层：用户微调 (对应架构：交互层)
> 任务：允许用户对生成的计划进行个性化修改。

> **调整训练日**：周一 | ... | 周日 [选填，多选，默认：当前生成结果] -> 若天数不变，仅平移槽位；若天数改变，触发模板重新匹配。
> **调整单课时长**：20-60分钟 [选填，滑动条，默认：当前生成结果] -> 更新 计划`单课时长`，作为后续生成具体课程时的约束条件。
> **调整开始日期**：YYYY-MM-DD [选填，日期选择，默认：今日] -> 整体平移计划的时间轴，重新计算各阶段的起止日期。
> **重置计划**：点击触发 [选填，交互] -> 返回“第一层：用户输入”，允许修改约束条件后重新生成。