# 计划生成逻辑
> 定义：基于用户长期目标，生成多阶段、周期化的训练计划核心算法。
> 架构：用户输入 -> 计划确认 -> 阶段确认 -> 动态循环模板匹配 -> 用户微调

## 第一层：用户输入 (对应架构：输入层)
> 任务：收集生成计划所需的关键约束条件。

1. **档案校验**：
   - 检查《运动档案》完整性，若缺失强制引导补全。
   - 关键字段：`功能目标`、`运动等级`、`每周运动频率`、`每周训练日`。

2. **计划参数设定**：
   - **计划周期**：1-24 [必填，数字输入，默认：4]
     > 用途：决定计划的时间跨度，单位为周。
   - **单课时长**：20-60 [必填，滑动条，默认：档案`每日运动时长`]
     > 用途：作为后续生成课程的时间约束，单位为分钟。
   - **包含环节**：热身 | 主训 | 放松 [必填，多选，默认：全选]
     > 用途：定义课程结构，至少包含主训。

## 第二层：计划确认 (对应架构：第1层 计划)
> 任务：生成计划维度的基础属性。

1. **目标匹配**：
   - 计划`计划目标` = 档案`主要目标`。
   - 计划`计划功能目标` = 档案`功能目标`。

2. **难度匹配**：
   - 计划`计划难度` = 档案`运动等级`。

3. **周期模型选择**：
   - 默认：线性周期。
   - 规则：若 `运动等级` ≥ [3.4生成约束配置].`波浪周期准入`，可升级为“波浪周期”。

## 第三层：阶段确认 (对应架构：第2层 阶段)
> 任务：规划计划的时间轴和阶段策略。

1. **阶段划分逻辑**：
   - **标准模型**：适应期 → 进阶期 → 突破期 → 减载期。
   - **短周期处理**：
     - 判断：若 `计划周期` < [2.5阶段周期分配配置].`短周期阈值`。
     - 逻辑：根据用户`运动等级`匹配 [2.5阶段周期分配配置].`短周期策略` 中的阶段组合。

2. **阶段周期分配**：
   - **规则**：按 [2.5阶段周期分配配置].`标准比例` 分配周数（四舍五入取整）。
   - **兜底**：若某阶段计算结果 < [3.4生成约束配置].`阶段最小周数`，强制设为最小值，优先扣除最长阶段。
   - *注：此为初始规划，实际执行中应根据用户RPE反馈动态调整阶段长度（如提前进入平台期则提前结束进阶期）。*

3. **阶段属性填充**：
   - 遍历每个阶段，填充 `阶段目标`、`阶段类型`。
   - **训练配置初始化**：基于[1.1策略矩阵配置]读取基准参数，并根据 `阶段类型` 引用[2.4阶段周期策略配置]进行**周期化修正**：
     - **适应期**：`训练强度` * 0.8，`动作组数` * 1.2（高容量低强度，建立耐受）。
     - **进阶期**：`训练强度` * 1.0，`动作组数` * 1.0（基准负荷，渐进超负荷）。
     - **突破期**：`训练强度` * 1.1，`动作组数` * 0.8（高强度低容量，冲击神经）。
     - **减载期**：`训练强度` * 0.6，`动作组数` * 0.6（全面降阶，超量恢复）。
     > *注：此逻辑实现了从“计划”到“阶段”再到“课程”的**强度穿透**。*

## 第四层：动态循环模板匹配 (对应架构：第3层 动态循环模板)
> 任务：为每个阶段匹配最佳的周排课逻辑。

1. **模板筛选**：
   - **目标一致**：模板`模板目标` = 计划`计划功能目标`。
   - **难度适配**：模板`模板难度` = 计划`计划难度`。
   - **频率兼容**：模板`模板周频` ≤ 档案`每周运动频率`。

2. **决策策略**：
   - **最优解**：优先选 `模板周频` 最接近用户周频的模板。
   - **兜底**：若无匹配，降级匹配同目标下的最低频模板（通常为全身循环）。

3. **排课实例化（周循环生成）**：
   - **确定训练日**：根据档案`每周训练日`（如周一/三/五）。
   - **槽位填充**：
     - 按顺序将模板的 `基础槽位` 填入训练日。
     - **溢出处理**：若用户周频 > 模板周频，根据模板 `填充策略`（循环/填充/随机）补足剩余训练日。
   - **休息日填充**：
     - 若模板 `休息日策略` = 主动恢复，在非训练日安排恢复课程。

## 第五层：用户微调 (对应架构：交互层)
> 任务：允许用户对生成的计划进行个性化修改。

1. **调整训练日**：周一 | ... | 周日 [选填，多选，默认：当前生成结果]
   > 定义：修改每周的具体训练日期。
   > 用途：适配用户的时间安排变化。
   > 逻辑：若天数不变，仅平移槽位；若天数改变，触发“第四层：动态循环模板匹配”重新筛选模板。

2. **调整单课时长**：20-60分钟 [选填，滑动条，默认：当前生成结果]
   > 定义：修改计划中单节课程的目标时长。
   > 用途：适配用户的碎片化时间。
   > 逻辑：更新计划属性中的`单课时长`，作为后续生成具体课程时的约束条件。

3. **调整开始日期**：YYYY-MM-DD [选填，日期选择，默认：今日]
   > 定义：设置计划的正式开始时间。
   > 用途：规划未来的训练周期。
   > 逻辑：整体平移计划的时间轴，重新计算各阶段的起止日期。

4. **重置计划**：点击触发 [选填，交互]
   > 定义：放弃当前方案，重新生成。
   > 用途：用户对整体方案不满意时重试。
   > 逻辑：返回“第一层：用户输入”，允许修改约束条件（如目标、难度）后重新生成。

---

## 附录：动态模板配置范例
> 说明：以下为标准模板配置示例，实际运营中可灵活扩展。

### 1. 一分化 [全身循环]
- **基础信息**：ID: TPL_001 | 目标: 增肌 | 难度: L1 | 周频: 1
- **结构配置**：
  - 基础槽位：[全身综合] (力量/课程模式:全身循环)
  - 填充策略：循环

### 2. 二分化 [上下肢循环]
- **基础信息**：ID: TPL_002 | 目标: 增肌 | 难度: L2 | 周频: 2
- **结构配置**：
  - 基础槽位：[上肢日] (力量/课程模式:上肢日), [下肢日] (力量/课程模式:下肢日)
  - 填充策略：循环

### 3. 三分化 [推拉腿循环]
- **基础信息**：ID: TPL_003 | 目标: 增肌 | 难度: L3 | 周频: 3
- **结构配置**：
  - 基础槽位：[推力日] (力量/课程模式:推力日), [拉力日] (力量/课程模式:拉力日), [腿部日] (力量/课程模式:腿部日)
  - 填充策略：循环

### 4. 四分化 [非线性/专项]
- **基础信息**：ID: TPL_004 | 目标: 增肌 | 难度: L4 | 周频: 4
- **结构配置**：
  - 基础槽位：[上肢力量] (力量/课程模式:上肢日), [下肢力量] (力量/课程模式:下肢日), [上肢肥大] (力量/课程模式:上肢日), [下肢肥大] (力量/课程模式:下肢日)
  - 填充策略：循环

### 5. 五分化 [单部位循环]
- **基础信息**：ID: TPL_005 | 目标: 增肌 | 难度: L3 | 周频: 5
- **结构配置**：
  - 基础槽位：[胸], [背], [肩], [腿], [臂]
  - 填充策略：循环