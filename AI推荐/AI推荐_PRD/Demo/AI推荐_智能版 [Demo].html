<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AEKE AI Coach - Smart Edition</title>
    <style>
        :root {
            --bg-dark: #000000;
            --bg-card: #141414;
            --primary: #32C48C;
            --primary-glow: rgba(50, 196, 140, 0.4);
            --text-main: #ffffff;
            --text-sub: #888;
            --accent: #0a84ff;
            --danger: #ff453a;
            --font: "PingFang SC", -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font); background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        /* CONTAINER (Vertical Screen Layout) */
        #app { width: 100%; max-width: 540px; height: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; background: #000; margin: 0 auto; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* --- VIEWS --- */
        .view { position: absolute; inset: 0; display: flex; flex-direction: column; transition: transform 0.5s var(--ease-out), opacity 0.5s var(--ease-out); opacity: 0; pointer-events: none; transform: scale(0.95); z-index: 0; }
        .view.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 10; }
        .view.exit { opacity: 0; transform: scale(1.05); pointer-events: none; }

        /* GLOBAL BACKGROUND LAYER (For Home) */
        #home-bg-layer { position: absolute; inset: 0; background: radial-gradient(circle at 50% 40%, #1a2a25 0%, #000 70%); z-index: 1; transition: opacity 0.5s; pointer-events: none; }
        #home-bg-layer.hidden { opacity: 0; }

        /* --- HOME VIEW --- */
        .home-top { flex: 1.4; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding-bottom: 40px; z-index: 1; overflow: visible; }
        
        /* Siri-like Animation */
        .siri-container { position: absolute; top: 12%; left: 50%; transform: translateX(-50%); z-index: 5; width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; pointer-events: none; transition: all 0.8s var(--ease-out); }
        /* Chat State for Siri */
        #app.state-chat .siri-container { top: 6%; transform: translateX(-50%) scale(0.8); }

        .siri-blob { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: var(--primary); filter: blur(20px); opacity: 0.6; animation: pulse 4s infinite ease-in-out; mix-blend-mode: screen; }
        .siri-blob:nth-child(2) { width: 90%; height: 90%; background: #00ffcc; animation-delay: -1s; filter: blur(25px); animation-duration: 5s; }
        .siri-blob:nth-child(3) { width: 70%; height: 70%; background: #0a84ff; animation-delay: -2s; filter: blur(15px); opacity: 0.5; animation-duration: 3s; }
        
        /* Orbiting Dots Effect */
        .orbit-ring { position: absolute; top: 50%; left: 50%; border-radius: 50%; border: 1px solid rgba(255,255,255,0.05); pointer-events: none; transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; opacity: 0.3; }
        .orbit-dot { position: absolute; top: 0; left: 50%; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px #fff; transition: all 0.5s; }
        
        /* 3D Orbits */
        .orbit-ring.r1 { width: 100px; height: 100px; animation: orbit-1 20s linear infinite; }
        .orbit-ring.r1 .orbit-dot { width: 3px; height: 3px; }
        
        .orbit-ring.r2 { width: 160px; height: 160px; animation: orbit-2 25s linear infinite; }
        .orbit-ring.r2 .orbit-dot { width: 5px; height: 5px; }
        
        .orbit-ring.r3 { width: 220px; height: 220px; animation: orbit-3 18s linear infinite; }
        .orbit-ring.r3 .orbit-dot { width: 4px; height: 4px; }

        @keyframes orbit-1 {
            from { transform: translate(-50%, -50%) rotate3d(1, 1, 1, 0deg); } to { transform: translate(-50%, -50%) rotate3d(1, 1, 1, 360deg); }
        }
        @keyframes orbit-2 {
            from { transform: translate(-50%, -50%) rotate3d(1, -1, 0, 0deg); } to { transform: translate(-50%, -50%) rotate3d(1, -1, 0, 360deg); }
        }
        @keyframes orbit-3 {
            from { transform: translate(-50%, -50%) rotate3d(0, 1, -1, 0deg); } to { transform: translate(-50%, -50%) rotate3d(0, 1, -1, 360deg); }
        }

        /* Orbit States */
        /* Listening: Expand & Faster */
        .siri-container.listening .orbit-ring { 
            border-color: rgba(50, 196, 140, 0.2); 
            opacity: 0.8;
        }
        .siri-container.listening .orbit-ring.r1 { animation-duration: 8s; width: 140px; height: 140px; }
        .siri-container.listening .orbit-ring.r2 { animation-duration: 10s; width: 200px; height: 200px; }
        .siri-container.listening .orbit-ring.r3 { animation-duration: 12s; width: 260px; height: 260px; }
        .siri-container.listening .orbit-dot { background: var(--primary); box-shadow: 0 0 10px var(--primary); transform: translate(-50%, -50%) scale(1.2); }
        
        /* Speaking: Max Expand & Super Fast */
        .siri-container.speaking .orbit-ring { 
            border-color: rgba(50, 196, 140, 0.4); 
            opacity: 1;
        }
        .siri-container.speaking .orbit-ring.r1 { animation-duration: 4s; width: 160px; height: 160px; }
        .siri-container.speaking .orbit-ring.r2 { animation-duration: 5s; width: 220px; height: 220px; }
        .siri-container.speaking .orbit-ring.r3 { animation-duration: 6s; width: 280px; height: 280px; }
        .siri-container.speaking .orbit-dot { 
            background: #fff; 
            box-shadow: 0 0 15px #fff; 
            transform: translate(-50%, -50%) scale(1.5); 
        }

        /* Siri States */
        .siri-container.listening .siri-blob { animation: pulse-listen 0.8s infinite alternate; background: var(--accent); opacity: 0.8; }
        .siri-container.speaking .siri-blob { animation: pulse-speak 1.5s infinite ease-in-out; background: var(--primary); opacity: 0.9; transform: scale(1.2); }
        
        @keyframes pulse-listen { 0% { transform: scale(0.9); opacity: 0.6; } 100% { transform: scale(1.1); opacity: 0.9; } }
        @keyframes pulse-speak { 0% { transform: scale(0.8); } 50% { transform: scale(1.3); } 100% { transform: scale(0.8); } }
        @keyframes pulse { 0%, 100% { transform: scale(0.8) translate(0,0); opacity: 0.5; } 33% { transform: scale(1.1) translate(10px, -10px); opacity: 0.7; } 66% { transform: scale(0.9) translate(-10px, 10px); opacity: 0.6; } }

        /* Reasoning State for Siri */
        #app.state-reasoning .siri-container { top: 20%; transform: translateX(-50%) scale(1.3); }
        .siri-container.thinking .siri-blob { animation: pulse-think 1.5s infinite ease-in-out; background: var(--accent); opacity: 0.8; }
        .siri-container.thinking .orbit-ring { border-color: rgba(41, 121, 255, 0.3); animation-duration: 2s; }
        @keyframes pulse-think { 0%, 100% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.9; } }

        .ai-greeting { font-size: 24px; font-weight: 700; text-align: center; line-height: 1.4; background: linear-gradient(135deg, #fff, #ccc); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; }
        
        #home-subtitle { font-size: 16px; color: var(--primary); text-align: center; min-height: 24px; margin-bottom: 20px; opacity: 0; transition: opacity 0.3s; font-weight: 500; text-shadow: 0 0 10px rgba(50, 196, 140, 0.3); }
        
        .action-buttons { display: flex; gap: 15px; width: 100%; padding: 0 30px; }
        .big-btn { flex: 1; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .big-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.15); }
        .big-btn i { font-size: 24px; color: var(--primary); }
        .big-btn span { font-size: 14px; font-weight: 500; letter-spacing: 0.5px; }

        .home-bottom { flex: 1; background: rgba(20,20,20,0.85); backdrop-filter: blur(40px); border-top: 1px solid rgba(255,255,255,0.1); border-radius: 32px 32px 0 0; padding: 30px; transform: translateY(0); transition: transform 0.4s var(--ease-out); display: flex; flex-direction: column; box-shadow: 0 -20px 60px rgba(0,0,0,0.9); z-index: 10; margin-top: -40px; }
        .home-bottom.hidden { transform: translateY(100%); }
        
        .profile-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .profile-title { font-size: 16px; font-weight: 700; }
        .edit-btn { color: var(--primary); font-size: 13px; font-weight: 600; cursor: pointer; }
        
        .profile-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; overflow-y: auto; padding-bottom: 20px; }
        .info-item { background: rgba(255,255,255,0.03); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .info-label { font-size: 11px; color: var(--text-sub); margin-bottom: 4px; }
        .info-val { font-size: 14px; font-weight: 600; color: #fff; }

        /* --- CHAT VIEW --- */
        .chat-header { position: absolute; top: 0; left: 0; width: 100%; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 20; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%); pointer-events: none; }
        .chat-header > * { pointer-events: auto; }
        .chat-back { color: #fff; font-size: 14px; display: flex; align-items: center; gap: 5px; cursor: pointer; opacity: 0.8; }
        /* AI Status Indicator in Chat Header */
        .ai-status-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); animation: pulse 2s infinite; margin-right: 8px; display: inline-block; }
        .chat-title { font-size: 14px; font-weight: 600; color: #fff; display: flex; align-items: center; pointer-events: none; opacity: 1; transition: opacity 0.3s; }
        .view.active .chat-title { opacity: 1; }
        .chat-back:hover { opacity: 1; }
        .chat-container { flex: 1; padding: 0 20px; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-end; gap: 20px; padding-top: 20vh; padding-bottom: 45vh; scroll-behavior: smooth; mask-image: linear-gradient(to bottom, transparent 0%, transparent 15%, black 30%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, transparent 15%, black 30%); }
        .chat-summary { position: absolute; bottom: 140px; left: 0; width: 100%; padding: 0 20px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; z-index: 25; pointer-events: none; }
        .summary-tag { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 11px; color: #ccc; backdrop-filter: blur(5px); animation: fadeIn 0.5s; }
        .chat-bubble { max-width: 85%; padding: 14px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; animation: slideUp 0.4s var(--ease-out); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        /* PRO ACTION CARD */
        .action-card-pro { background: #1a1a1a; border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; border: 1px solid #333; display: flex; flex-direction: column; gap: 0; transition: 0.2s; position: relative; }
        .action-card-pro:active { background: #222; }
        .ac-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; cursor: pointer; }
        .ac-thumb { width: 40px; height: 40px; background: #2a2a2a; border-radius: 6px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #555; overflow: hidden; }
        .ac-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .ac-title { font-size: 14px; font-weight: 600; color: #fff; }
        .ac-meta { font-size: 11px; color: #888; display: flex; gap: 8px; }
        .ac-tag { background: rgba(255,255,255,0.08); padding: 1px 5px; border-radius: 3px; color: #ccc; }
        
        .ac-body-exp { display: none; margin-top: 10px; border-top: 1px solid #2a2a2a; padding-top: 10px; animation: fadeIn 0.2s; }
        .set-list { display: flex; flex-direction: column; gap: 6px; }
        .set-row { display: flex; align-items: center; gap: 8px; font-size: 12px; background: #111; padding: 6px 10px; border-radius: 6px; }
        .set-idx { width: 15px; color: #555; font-size: 10px; font-weight: 700; }
        .set-input { background: transparent; border: none; border-bottom: 1px solid #333; color: #fff; width: 40px; text-align: center; padding: 2px; font-weight: 600; font-family: var(--font); }
        .set-input:focus { border-color: var(--primary); }
        .set-del { color: #444; cursor: pointer; margin-left: auto; padding: 4px; font-size: 14px; }
        .set-del:hover { color: var(--danger); }
        .add-set-btn { width: 100%; padding: 8px; background: rgba(255,255,255,0.03); border: 1px dashed #333; color: #666; font-size: 11px; cursor: pointer; border-radius: 6px; text-align: center; margin-top: 8px; transition: 0.2s; }
        .add-set-btn:hover { color: var(--primary); border-color: var(--primary); background: rgba(50, 196, 140, 0.05); }
        .ac-footer { display: flex; justify-content: space-between; font-size: 10px; color: #555; margin-top: 10px; padding-top: 5px; border-top: 1px solid #222; }

        .chat-ai { background: #1a1a1a; color: #eee; border-bottom-left-radius: 4px; align-self: flex-start; border: 1px solid #333; }
        .chat-user { background: var(--primary); color: #000; border-bottom-right-radius: 4px; align-self: flex-end; font-weight: 600; }
        .chat-user.interim { background: rgba(50, 196, 140, 0.2); color: #fff; border: 1px solid var(--primary); }
        .keyword-highlight { color: #fff; background: rgba(0,0,0,0.2); padding: 0 4px; border-radius: 4px; }
        
        /* Typing Indicator */
        .chat-typing { padding: 15px 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 18px; border-bottom-left-radius: 4px; align-self: flex-start; display: flex; gap: 4px; align-items: center; height: 46px; width: 70px; animation: slideUp 0.3s var(--ease-out); margin-bottom: 10px; margin-top: auto; }
        .typing-dot { width: 6px; height: 6px; background: #666; border-radius: 50%; animation: typingBounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .input-area { position: absolute; bottom: 0; left: 0; width: 100%; padding: 0 20px 40px 20px; background: linear-gradient(to top, #000 0%, transparent 100%); pointer-events: none; display: flex; justify-content: center; z-index: 30; }
        .input-area > * { pointer-events: auto; }
        .options-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .opt-chip { padding: 8px 16px; background: rgba(50, 196, 140, 0.1); border: 1px solid rgba(50, 196, 140, 0.3); border-radius: 20px; font-size: 13px; color: #fff; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 60px; }
        .opt-chip:hover { background: rgba(50, 196, 140, 0.2); }
        .opt-chip.active { background: var(--primary); color: #000; font-weight: 600; border-color: var(--primary); }
        .opt-chip:active { transform: scale(0.95); }
        .active-voice-click { transform: scale(0.95); box-shadow: 0 0 15px var(--primary); border-color: var(--primary); }
        
        .mic-btn { width: 64px; height: 64px; border-radius: 50%; background: rgba(30,30,30,0.8); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid #444; transition: 0.2s; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 50; }
        .mic-btn.listening { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 30px var(--primary-glow); animation: pulse-mic 1.5s infinite; }
        @keyframes pulse-mic { 0% { box-shadow: 0 0 0 0 rgba(50, 196, 140, 0.7); transform: scale(1); } 50% { box-shadow: 0 0 0 15px rgba(50, 196, 140, 0); transform: scale(1.05); } 100% { box-shadow: 0 0 0 0 rgba(50, 196, 140, 0); transform: scale(1); } }
        .chat-slider-box { background: var(--bg-card); padding: 15px; border-radius: 12px; width: 100%; margin-top: 10px; border: 1px solid #333; animation: slideUp 0.3s; align-self: flex-end; }
        .chat-sub-text { font-size: 10px; margin-top: 2px; opacity: 0.8; }
        .chat-history-dim { opacity: 0.4; transition: opacity 0.5s; }
        /* --- REASONING VIEW --- */
        .reasoning-center { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 45vh; justify-content: flex-start; }
        .log-container { width: 280px; display: flex; flex-direction: column; gap: 12px; }
        .log-item { font-size: 13px; color: #666; display: flex; align-items: center; gap: 12px; opacity: 0; animation: slideInUp 0.4s forwards; }
        .log-item.active { color: #fff; font-weight: 600; transform: scale(1.02); transition: 0.3s; }
        .log-item.done { color: var(--primary); opacity: 0.8; }
        .log-icon { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- RESULT VIEW --- */
        .result-header { padding: 24px; background: rgba(18,18,18,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 5; flex-shrink: 0; display: flex; justify-content: space-between; align-items: flex-start; }
        .result-title { font-size: 20px; font-weight: 800; margin-bottom: 5px; }
        .result-sub { font-size: 12px; color: var(--text-sub); display: flex; gap: 10px; }
        .result-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 40px; }
        .unit-toggle { font-size: 11px; font-weight: 700; color: var(--text-sub); border: 1px solid #333; padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .unit-toggle:hover { color: #fff; border-color: #666; }
        
        .card { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        .card-name { font-size: 14px; font-weight: 600; color: #fff; }
        .card-tag { background: rgba(255,255,255,0.05); color: #aaa; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }

        .phase-header-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; }
        .phase-title { font-size: 12px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .phase-select { background: #1a1a1a; border: 1px solid #333; color: #888; font-size: 10px; padding: 2px 6px; border-radius: 4px; outline: none; }
        
        .bottom-bar { padding: 20px; background: #111; border-top: 1px solid #222; display: flex; gap: 15px; flex-shrink: 0; }
        .btn-full { flex: 1; background: var(--primary); color: #000; font-weight: 700; padding: 14px; border-radius: 12px; border: none; font-size: 16px; cursor: pointer; }
        .btn-icon { width: 50px; background: #333; color: #fff; border-radius: 12px; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .ft-mini-bar { display: flex; gap: 10px; margin-bottom: 10px; justify-content: flex-end; }
        .ft-mini-sel { background: transparent; border: 1px solid #333; color: #666; font-size: 10px; padding: 2px 5px; border-radius: 4px; outline: none; }

        /* LIBRARY VIEW */
        .lib-filters { padding: 10px 20px; overflow-x: auto; white-space: nowrap; display: flex; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .lib-filter-tag { padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 20px; font-size: 12px; color: #888; cursor: pointer; border: 1px solid transparent; }
        .lib-filter-tag.active { background: var(--primary); color: #000; font-weight: 600; }
        .lib-body { flex: 1; overflow-y: auto; padding: 20px; }
        .lib-item { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; cursor: pointer; }
        .lib-item.selected { border-color: var(--primary); background: rgba(50, 196, 140, 0.1); }
        .lib-info { flex: 1; }
        .lib-name { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .lib-meta { font-size: 10px; color: #666; }
        .lib-check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #444; display: flex; align-items: center; justify-content: center; }
        .lib-item.selected .lib-check { border-color: var(--primary); background: var(--primary); }
        .lib-item.selected .lib-check::after { content: 'âœ“'; color: #000; font-size: 12px; font-weight: 700; }

        /* FINE TUNING CONTROLS */
        .ft-controls { background: #161616; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #222; }
        .ft-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .ft-row:last-child { margin-bottom: 0; }
        .ft-label { font-size: 11px; color: #888; width: 60px; }
        .ft-select { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 6px; border-radius: 4px; font-size: 12px; }
        
        /* ACTION EDITOR (Accordion) */
        .action-editor { background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .action-editor.expanded { border-color: #444; background: #1a1a1a; }
        
        .ae-header { padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .ae-thumb { width: 40px; height: 40px; background: #222; border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #444; font-size: 10px; }
        .ae-info { flex: 1; }
        .ae-title { font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .ae-meta { display: flex; gap: 6px; }
        .ae-tag { font-size: 9px; color: #888; background: #000; padding: 1px 4px; border-radius: 2px; border: 1px solid #333; }
        .ae-summary { font-size: 12px; color: var(--primary); font-weight: 600; }
        
        .ae-tools { display: flex; gap: 5px; }
        .ae-btn { width: 24px; height: 24px; background: #222; border: 1px solid #333; color: #888; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .ae-btn:hover { color: #fff; border-color: #555; }
        
        .add-action-btn { width: 100%; padding: 12px; border: 1px dashed #333; border-radius: 8px; color: #666; font-size: 12px; text-align: center; cursor: pointer; transition: 0.2s; margin-top: 8px; }
        .add-action-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(50, 196, 140, 0.05); }

        .stats-bar { background: #111; padding: 12px 20px; border-top: 1px solid #222; display: flex; justify-content: space-between; font-size: 10px; color: #666; z-index: 20; flex-shrink: 0; }
        .stat-val { font-size: 14px; font-weight: 700; color: var(--primary); display: block; }
        
        .ae-tools { display: flex; gap: 5px; }

        /* --- PROFILE EDIT MODAL --- */
        .modal { position: absolute; inset: 0; background: #000; z-index: 100; transform: translateY(100%); transition: transform 0.3s var(--ease-out); display: flex; flex-direction: column; }
        .modal.active { transform: translateY(0); }
        .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 8px; }
        .form-input { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; font-size: 14px; }
        .form-input:focus { border-color: var(--primary); }
        
        /* TABS */
        .tabs { display: flex; border-bottom: 1px solid #222; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 12px; font-size: 13px; color: var(--text-sub); cursor: pointer; position: relative; }
        .tab.active { color: var(--primary); font-weight: 700; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 20%; right: 20%; height: 2px; background: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        /* PLAN PHASE BLOCK */
        .plan-phase-block { margin-bottom: 25px; }
        .plan-phase-header { font-size: 14px; font-weight: 800; color: #fff; margin-bottom: 15px; padding-left: 10px; border-left: 3px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .plan-phase-meta { font-size: 10px; color: var(--text-sub); font-weight: normal; }
        
        /* Vertical Plan Layout */
        .plan-week-list { display: flex; flex-direction: column; gap: 10px; }
        .plan-day-row { display: flex; align-items: center; background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px 15px; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .plan-day-row.training { cursor: pointer; }
        .plan-day-row.training:hover { border-color: var(--primary); background: rgba(50, 196, 140, 0.05); }
        .plan-day-row.rest { opacity: 0.5; border-style: dashed; }
        
        .pdr-date { width: 50px; font-size: 12px; color: #666; font-weight: 600; display: flex; flex-direction: column; align-items: center; line-height: 1.2; }
        .pdr-date span { font-size: 10px; font-weight: 400; }
        .pdr-content { flex: 1; padding-left: 15px; border-left: 1px solid #333; }
        .pdr-title { font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .pdr-meta { font-size: 11px; color: #888; display: flex; gap: 8px; align-items: center; }
        .pdr-action { color: var(--primary); font-size: 18px; opacity: 0.5; }
        .plan-day-row.training:hover .pdr-action { opacity: 1; transform: translateX(3px); transition: 0.2s; }
        
        /* TOAST */
        #toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,69,58,0.9); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 13px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; }
        
        /* DIALOG MODAL */
        .dialog-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 300; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
        .dialog-overlay.active { opacity: 1; pointer-events: auto; }
        .dialog-box { width: 80%; max-width: 320px; background: #1a1a1a; border: 1px solid #333; border-radius: 16px; padding: 24px; transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 50px rgba(0,0,0,0.6); display: flex; flex-direction: column; align-items: center; text-align: center; }
        .dialog-overlay.active .dialog-box { transform: scale(1); }
        .dialog-title { font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 8px; }
        .dialog-msg { font-size: 13px; color: #888; margin-bottom: 24px; line-height: 1.5; }
        .dialog-btns { display: flex; gap: 12px; width: 100%; }
        .dialog-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; }
        .dialog-btn.cancel { background: #2a2a2a; color: #ccc; }
        .dialog-btn.cancel:hover { background: #333; color: #fff; }
        .dialog-btn.confirm { background: var(--primary); color: #000; }
        .dialog-btn.confirm:hover { background: #00e676; }

        /* START BUTTON FIXED POSITION */
        #home-start-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; cursor: pointer; z-index: 200; pointer-events: auto; width: 200px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #home-start-btn:active { transform: translate(-50%, -50%) scale(0.95); opacity: 0.8; }
        #home-start-btn > * { pointer-events: none; }

        /* UTILS */
        .hidden { display: none !important; }

        /* ACTION CARD DELETE BTN */
        .ac-del-corner { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background: transparent; border: none; color: #666; display: flex; align-items: center; justify-content: center; font-size: 10px; line-height: 1; cursor: pointer; z-index: 100; transition: 0.2s; opacity: 0.6; }
        .ac-del-corner:hover { color: var(--danger); opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>

<div id="app">
    
    <div id="home-bg-layer"></div>

    <!-- GLOBAL AI AVATAR (Seamless Transition) -->
    <div class="siri-container">
        <div class="siri-blob"></div>
        <div class="siri-blob"></div>
        <div class="siri-blob"></div>
        <div class="orbit-ring r1">
            <div class="orbit-dot"></div>
        </div>
        <div class="orbit-ring r2">
            <div class="orbit-dot"></div>
        </div>
        <div class="orbit-ring r3">
            <div class="orbit-dot"></div>
        </div>
    </div>

    <!-- MOVED: Start Trigger (Global Layer) -->
    <div id="home-start-btn" onclick="window.App.startSession()">
        <i style="font-size:40px; font-style:normal; display:block; margin-bottom:10px; filter:grayscale(1);">ğŸ™ï¸</i>
        <div style="font-size:16px; font-weight:600; color:var(--primary);">ç‚¹å‡»å¼€å¯éº¦å…‹é£æƒé™</div>
        <div style="font-size:12px; color:#666; margin-top:5px;">æ¿€æ´» AI æ™ºèƒ½æ•™ç»ƒ</div>
    </div>

    <!-- VIEW 1: HOME -->
    <div id="view-home" class="view active">
        <div class="home-top" style="justify-content: flex-end; padding-bottom: 120px;">            
            <!-- Active Content (Hidden Initially) -->
            <div id="home-active-content" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center; animation: slideUp 0.5s; z-index: 10;">
                <div class="ai-greeting">Hiï¼Œæˆ‘æ˜¯AEKE ç§äººæ•™ç»ƒ<br><span style="font-size:16px; font-weight:400; color:#888; margin-top:10px; display:block;">å¸®ä½ å®šåˆ¶ä¸“å±è¿åŠ¨æ–¹æ¡ˆ</span></div>
                <div id="home-subtitle"></div>
                
                <div class="action-buttons">
                    <div class="big-btn" onclick="App.startFlow('course')">
                        <i>âš¡ï¸</i>
                        <span>ç»™æˆ‘ä¸€èŠ‚è¯¾</span>
                    </div>
                    <div class="big-btn" onclick="App.startFlow('plan')">
                        <i>ğŸ“…</i>
                        <span>ç»™æˆ‘ä¸€ä»½è®¡åˆ’</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="home-bottom hidden" id="profile-card">
            <div class="profile-header">
                <div class="profile-title">æˆ‘çš„è¿åŠ¨æ¡£æ¡ˆ</div>
                <div class="edit-btn" onclick="App.openProfile()">ä¿®æ”¹ ></div>
            </div>
            <div class="profile-grid" id="profile-display">
                <!-- Rendered by JS -->
            </div>
        </div>
    </div>

    <!-- VIEW 2: CHAT WIZARD -->
    <div id="view-chat" class="view">
        <div class="chat-header">
            <div class="chat-back" onclick="App.reset()">âœ• é€€å‡º</div>
            <div class="chat-title"><div class="ai-status-dot"></div>AI Coach</div>
            <div style="width: 60px;"></div>
        </div>
        <div class="chat-container" id="chat-history">
            <!-- Chat bubbles -->
        </div>
        <div class="chat-summary" id="chat-summary"></div>
        <div class="input-area">
            <div class="mic-btn" id="mic-btn" onclick="App.toggleMicState()">
                <i style="font-style:normal; font-size:24px;">ğŸ™ï¸</i>
            </div>
        </div>
    </div>

    <!-- VIEW 3: REASONING -->
    <div id="view-reasoning" class="view">
        <div class="reasoning-center">
            <div class="log-container" id="reasoning-log">
                <!-- Logs -->
            </div>
        </div>
    </div>

    <!-- VIEW 4: RESULT (COURSE/PLAN) -->
    <div id="view-result" class="view">
        <div class="result-header">
            <div id="btn-back-plan" style="display:none; margin-right:10px; cursor:pointer; color:var(--primary);" onclick="App.showResult()">â†</div>
            <div>
                <div class="result-title" id="res-title">--</div>
                <div class="result-sub" id="res-sub">--</div>
            </div>
            <div class="unit-toggle" onclick="App.switchUnit(window.store.unit==='kg'?'lbs':'kg')">UNIT: <span id="unit-disp">KG</span></div>
        </div>
        <div class="result-body" id="res-body">
            <!-- Content -->
        </div>
        <div class="stats-bar" id="res-stats">
            <div>æ—¶é•¿ <span class="stat-val" id="st-time">--</span></div>
            <div>åŠ¨ä½œ <span class="stat-val" id="st-count">--</span></div>
            <div>å®¹é‡ <span class="stat-val" id="st-vol">--</span></div>
            <div>æ¶ˆè€— <span class="stat-val" id="st-cal">--</span></div>
        </div>
        <div class="bottom-bar">
            <button class="btn-icon" onclick="App.reset()">â†º</button>
            <button class="btn-full" id="btn-main-action">å¼€å§‹è®­ç»ƒ</button>
        </div>
    </div>

    <!-- VIEW 5: ACTION LIBRARY -->
    <div id="view-library" class="view">
        <div class="result-header">
            <div class="chat-back" onclick="App.closeLibrary()">âœ• å–æ¶ˆ</div>
            <div class="result-title" style="font-size:16px;">åŠ¨ä½œåº“</div>
            <div style="color:var(--primary); font-weight:600; cursor:pointer;" onclick="App.confirmReplace()">ç¡®è®¤</div>
        </div>
        <div class="lib-filters" id="lib-parts">
            <!-- Rendered JS -->
        </div>
        <div class="lib-body" id="lib-list">
            <!-- Rendered JS -->
        </div>
    </div>

    <!-- VIEW 6: SCHEDULE -->
    <div id="view-schedule" class="view">
        <div class="chat-header">
            <div class="chat-back" onclick="App.switchView('view-home')">âœ• å…³é—­</div>
            <div class="chat-title">è®­ç»ƒæ—¥ç¨‹</div>
            <div style="width: 60px;"></div>
        </div>
        <div class="result-body" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
            <i style="font-size:64px; margin-bottom:20px; font-style:normal;">ğŸ“…</i>
            <div style="font-size:18px; font-weight:700; margin-bottom:10px;">æ—¥ç¨‹å·²åˆ›å»º</div>
            <div style="font-size:13px; color:#888;">æ‚¨çš„è®­ç»ƒè®¡åˆ’å·²åŠ å…¥æ—¥ç¨‹è¡¨</div>
        </div>
    </div>

    <!-- MODAL: PROFILE EDIT -->
    <div id="modal-profile" class="modal">
        <div class="modal-header">
            <div style="font-size:16px; font-weight:700;">ä¿®æ”¹æ¡£æ¡ˆ</div>
            <div style="color:var(--primary); cursor:pointer;" onclick="App.saveProfile()">ä¿å­˜</div>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="App.switchTab('basic')">åŸºç¡€</div>
            <div class="tab" onclick="App.switchTab('pref')">åå¥½</div>
            <div class="tab" onclick="App.switchTab('goal')">ç›®æ ‡</div>
        </div>
        <div class="modal-body" id="profile-form">
        </div>
    </div>

    <!-- MODAL: SCHEDULE CONFIRM -->
    <div id="modal-schedule" class="modal">
        <div class="modal-header">
            <div style="font-size:16px; font-weight:700;">ç¡®è®¤è®­ç»ƒæ—¥</div>
            <div style="color:var(--primary); cursor:pointer;" onclick="App.confirmSchedule()">ç¡®è®¤</div>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:15px; font-size:13px; color:#888;">è¯·ç¡®è®¤æ‚¨çš„æ¯å‘¨è®­ç»ƒå®‰æ’ï¼š</div>
            <div class="options-grid" id="schedule-days-list"></div>
        </div>
    </div>
    
    <!-- DIALOG: CONFIRM -->
    <div id="dialog-confirm" class="dialog-overlay">
        <div class="dialog-box">
            <div class="dialog-title">æç¤º</div>
            <div class="dialog-msg" id="dialog-msg">--</div>
            <div class="dialog-btns">
                <button class="dialog-btn cancel" onclick="App.closeConfirmModal()">å–æ¶ˆ</button>
                <button class="dialog-btn confirm" id="dialog-confirm-btn">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

</div>

<script>
// ==========================================
// 0. DATA & LOGIC ENGINE (Ported from Demo 11.0)
// ==========================================

const CONSTANTS = {
    PARTS: ['å…¨èº«', 'èƒ¸éƒ¨', 'èƒŒéƒ¨', 'è‚©éƒ¨', 'æ‰‹è‡‚', 'è‡€éƒ¨', 'è…¿éƒ¨', 'æ ¸å¿ƒ'],
    RATIOS: { 
        'èƒ¸éƒ¨': {'èƒ¸å¤§è‚Œä¸­æŸ':0.4, 'èƒ¸å¤§è‚Œä¸ŠæŸ':0.4, 'èƒ¸å¤§è‚Œä¸‹æŸ':0.1, 'èƒ¸å¤§è‚Œå†…ä¾§':0.1},
        'èƒŒéƒ¨': {'ä¸­èƒŒ':0.4, 'ä¸ŠèƒŒ':0.4, 'ä¸‹èƒŒ':0.2},
        'è‚©éƒ¨': {'ä¸‰è§’è‚Œä¸­æŸ':0.5, 'ä¸‰è§’è‚Œå‰æŸ':0.1, 'ä¸‰è§’è‚ŒåæŸ':0.3, 'è‚©è¢–':0.1},
        'æ‰‹è‡‚': {'è‚±äºŒå¤´è‚Œ':0.4, 'è‚±ä¸‰å¤´è‚Œ':0.6},
        'è…¿éƒ¨': {'è‚¡å››å¤´è‚Œ':0.4, 'èƒ­ç»³è‚Œ':0.4, 'å†…æ”¶è‚Œ':0.1, 'è…“è‚ è‚Œ':0.1},
        'æ ¸å¿ƒ': {'è…¹ç›´è‚Œ':0.7, 'è…¹æ–œè‚Œ':0.3},
        'å…¨èº«': 'AVG'
    },
    DIFF_WEIGHTS: {
        'L1': {'L1':0.6, 'L2':0.3, 'L3':0.1, 'L4':0, 'L5':0},
        'L3': {'L1':0.2, 'L2':0.3, 'L3':0.3, 'L4':0.1, 'L5':0.1},
        'L5': {'L1':0.1, 'L2':0.2, 'L3':0.3, 'L4':0.2, 'L5':0.2}
    },
    LEVEL_MAP: { 'L1':1, 'L2':2, 'L3':3, 'L4':4, 'L5':5 },
    PAIRS: { 
        'èƒ¸å¤§è‚Œ': 'èƒŒé˜”è‚Œ', 'èƒŒé˜”è‚Œ': 'èƒ¸å¤§è‚Œ',
        'è‚±äºŒå¤´è‚Œ': 'è‚±ä¸‰å¤´è‚Œ', 'è‚±ä¸‰å¤´è‚Œ': 'è‚±äºŒå¤´è‚Œ',
        'è‚¡å››å¤´è‚Œ': 'èƒ­ç»³è‚Œ', 'èƒ­ç»³è‚Œ': 'è‚¡å››å¤´è‚Œ',
        'è…¹ç›´è‚Œ': 'ä¸‹èƒŒ'
    },
    COURSE_TYPES: {
        'åŠ›é‡': 'æŠ—é˜»èŒƒå¼', 'åº·å¤': 'æŠ—é˜»èŒƒå¼', 'é«˜å°”å¤«': 'æŠ—é˜»èŒƒå¼',
        'HIIT': 'é—´æ­‡èŒƒå¼', 'æœ‰æ°§': 'é—´æ­‡èŒƒå¼', 'æå‡»': 'é—´æ­‡èŒƒå¼',
        'ç‘œä¼½': 'æµå¼èŒƒå¼', 'æ™®æ‹‰æ': 'æµå¼èŒƒå¼', 'æ‹‰ä¼¸': 'æµå¼èŒƒå¼', 'å†¥æƒ³': 'æµå¼èŒƒå¼', 'æ°”åŠŸ': 'æµå¼èŒƒå¼',
        'æŠ—é˜»èŒƒå¼': 'æŠ—é˜»èŒƒå¼'
    }, 
    ENUMS: {
        ONE_RM: { 'èƒ¸éƒ¨': 60, 'èƒŒéƒ¨': 70, 'è…¿éƒ¨': 100, 'è‡€éƒ¨': 90, 'è‚©éƒ¨': 30, 'æ‰‹è‡‚': 25, 'æ ¸å¿ƒ': 0 },
        GENDER: ['ç”·', 'å¥³'],
        LEVEL: ['L1', 'L2', 'L3', 'L4', 'L5'],
        GOAL: ['å¢è‚Œ', 'å‡é‡', 'å¥åº·'],
        FUNC_GOAL: ['å¢è‚Œ', 'åŠ›é‡', 'è€åŠ›', 'çˆ†å‘', 'å‡è„‚', 'å¿ƒè‚º', 'æ¢å¤', 'æŸ”éŸ§', 'åè°ƒ', 'ä½“æ€', 'ä¸“é¡¹', 'æ¿€æ´»', 'å¹³è¡¡'],
        STYLE: ['ä¼ ç»Ÿå‹', 'å¤šå˜å‹', 'æ¿€è¿›å‹'],
        BODY_TYPE: ['å‡è¡¡æ ‡å‡†å‹', 'æ ‡å‡†è‚Œè‚‰å‹', 'ç´§è‡´ç²¾ç˜¦å‹', 'å¥ç¾è‚Œè‚‰å‹'],
        LOOP_MODE: ['å¸¸è§„ç»„', 'å¾ªç¯ç»„', 'è¶…çº§ç»„', 'å¤åˆç»„', 'å·¨å‹ç»„'],
        LOAD_STRATEGY: ['æ¨è', 'æ’å®š', 'é€’å¢', 'é€’å‡', 'æ³¢æµª', 'è®¡æ—¶', 'è‡ªå®šä¹‰'],
        COURSE_TYPES: ['åŠ›é‡', 'æœ‰æ°§', 'HIIT', 'æå‡»', 'æ™®æ‹‰æ', 'ç‘œä¼½', 'æ‹‰ä¼¸', 'æ°”åŠŸ', 'åº·å¤', 'å†¥æƒ³', 'é«˜å°”å¤«'],
        PAIN_AREAS: ['æ— ', 'æ‰‹è…•', 'è‚˜éƒ¨', 'è‚©éƒ¨', 'è…°éƒ¨', 'é«‹éƒ¨', 'è†ç›–', 'è„šè¸'],
        MISSING_EQUIP: ['å¥èº«å‡³', 'ç‘œä¼½ç –', 'æ³¡æ²«è½´', 'æ¨ªæ†', 'æ‰‹æŸ„'],
        MENSTRUAL_CYCLE: ['åµæ³¡æœŸ', 'æ’åµæœŸ', 'é»„ä½“æœŸ', 'æœˆç»æœŸ']
    }
};

const CONFIG = {
    STRATEGY: {
        'å¢è‚Œ': { sets: 4, rest: 90, intensity: 0.75, mode: 'å¸¸è§„ç»„', strategy: 'æ¨è', diff: 'æ ‡å‡†', rpe: 8 },
        'åŠ›é‡': { sets: 5, rest: 180, intensity: 0.85, mode: 'å¸¸è§„ç»„', strategy: 'æ’å®š', diff: 'è¿›é˜¶', rpe: 9 },
        'å‡è„‚': { sets: 4, rest: 30, intensity: 0.65, mode: 'å¾ªç¯ç»„', strategy: 'è®¡æ—¶', diff: 'æ ‡å‡†', rpe: 7 },
        'è€åŠ›': { sets: 3, rest: 45, intensity: 0.50, mode: 'è¶…çº§ç»„', strategy: 'è®¡æ—¶', diff: 'æ ‡å‡†', rpe: 6 },
        'çˆ†å‘': { sets: 4, rest: 150, intensity: 0.70, mode: 'å¸¸è§„ç»„', strategy: 'é€’å¢', diff: 'è¿›é˜¶', rpe: 9 },
        'å¿ƒè‚º': { sets: 4, rest: 20, intensity: 0.65, mode: 'å¾ªç¯ç»„', strategy: 'è®¡æ—¶', diff: 'æ ‡å‡†', rpe: 7 },
        'æ¿€æ´»': { sets: 2, rest: 0, intensity: 0.40, mode: 'å¸¸è§„ç»„', strategy: 'æ’å®š', diff: 'æ ‡å‡†', rpe: 4 },
        'æŸ”éŸ§': { sets: 2, rest: 0, intensity: 0.30, mode: 'å¸¸è§„ç»„', strategy: 'è®¡æ—¶', diff: 'æ ‡å‡†', rpe: 3 },
        'HIIT': { sets: 6, rest: 30, intensity: 0.75, mode: 'å¾ªç¯ç»„', strategy: 'è®¡æ—¶', diff: 'æ ‡å‡†', rpe: 8 },
        'æœ‰æ°§': { sets: 4, rest: 15, intensity: 0.60, mode: 'å¾ªç¯ç»„', strategy: 'è®¡æ—¶', diff: 'æ ‡å‡†', rpe: 6 },
        'ç‘œä¼½': { sets: 1, rest: 0, intensity: 0.40, mode: 'å¸¸è§„ç»„', strategy: 'è®¡æ—¶', diff: 'æ ‡å‡†', rpe: 4 },
        'æ™®æ‹‰æ': { sets: 3, rest: 30, intensity: 0.50, mode: 'å¸¸è§„ç»„', strategy: 'æ’å®š', diff: 'æ ‡å‡†', rpe: 5 },
        'æ‹‰ä¼¸': { sets: 1, rest: 0, intensity: 0.20, mode: 'å¸¸è§„ç»„', strategy: 'è®¡æ—¶', diff: 'ä¿å®ˆ', rpe: 2 },
        'æ¢å¤': { sets: 2, rest: 0, intensity: 0.30, mode: 'å¸¸è§„ç»„', strategy: 'æ’å®š', diff: 'ä¿å®ˆ', rpe: 2 },
        'åè°ƒ': { sets: 3, rest: 60, intensity: 0.50, mode: 'å¸¸è§„ç»„', strategy: 'æ’å®š', diff: 'æ ‡å‡†', rpe: 6 },
        'ä½“æ€': { sets: 3, rest: 45, intensity: 0.50, mode: 'å¸¸è§„ç»„', strategy: 'è®¡æ—¶', diff: 'æ ‡å‡†', rpe: 5 },
        'å¹³è¡¡': { sets: 3, rest: 60, intensity: 0.50, mode: 'å¸¸è§„ç»„', strategy: 'æ’å®š', diff: 'æ ‡å‡†', rpe: 6 },
        'ä¸“é¡¹': { sets: 3, rest: 90, intensity: 0.70, mode: 'å¸¸è§„ç»„', strategy: 'æ¨è', diff: 'æ ‡å‡†', rpe: 8 }
    },
    LEVEL_COEFF: { 'L1': 0.5, 'L2': 0.8, 'L3': 1.0, 'L4': 1.2, 'L5': 1.5 },
    LEVEL_SCALING: {
        'L1': { vol: 0.7, int: 0.85, rest: 1.2 }, // æ–°æ‰‹: ä½å®¹é‡, ä½å¼ºåº¦, é•¿ä¼‘æ¯
        'L2': { vol: 0.85, int: 0.9, rest: 1.1 },
        'L3': { vol: 1.0, int: 1.0, rest: 1.0 },  // æ ‡å‡†
        'L4': { vol: 1.2, int: 1.05, rest: 0.9 },
        'L5': { vol: 1.4, int: 1.1, rest: 0.8 }   // å¤§ç¥: é«˜å®¹é‡, é«˜å¼ºåº¦, çŸ­ä¼‘æ¯(é«˜å¯†åº¦)
    },
    PHASES: {
        'é€‚åº”æœŸ': { intensity: 0.8, volume: 0.8, name: 'é€‚åº”æ¿€æ´»æœŸ' },
        'è¿›é˜¶æœŸ': { intensity: 1.0, volume: 1.0, name: 'è‚Œè‚¥å¤§å¢é•¿æœŸ' },
        'çªç ´æœŸ': { intensity: 1.1, volume: 0.9, name: 'åŠ›é‡çªç ´æœŸ' },
        'å‡è½½æœŸ': { intensity: 0.6, volume: 0.6, name: 'å‡è½½æ¢å¤æœŸ' }
    },
    TEMPLATES: [
        { id: 'TPL_001', name: 'ä¸€åˆ†åŒ– (å…¨èº«)', goal: 'å¢è‚Œ', level: 'All', freq: 1, slots: [{n:'å…¨èº«ç»¼åˆ', t:['å…¨èº«']}] },
        { id: 'TPL_002', name: 'äºŒåˆ†åŒ– (ä¸Šä¸‹è‚¢)', goal: 'å¢è‚Œ', level: 'All', freq: 2, slots: [{n:'ä¸Šè‚¢åŠ›é‡', t:['èƒ¸éƒ¨','èƒŒéƒ¨','è‚©éƒ¨','æ‰‹è‡‚']}, {n:'ä¸‹è‚¢åŠ›é‡', t:['è‡€éƒ¨','è…¿éƒ¨','æ ¸å¿ƒ']}] },
        { id: 'TPL_003', name: 'ä¸‰åˆ†åŒ– (æ¨æ‹‰è…¿)', goal: 'å¢è‚Œ', level: 'All', gender: 'ç”·', freq: 3, slots: [{n:'æ¨ç±»åŠ›é‡', t:['èƒ¸éƒ¨','è‚©éƒ¨','æ‰‹è‡‚']}, {n:'æ‹‰ç±»åŠ›é‡', t:['èƒŒéƒ¨','æ ¸å¿ƒ']}, {n:'è…¿éƒ¨é©±åŠ¨', t:['è‡€éƒ¨','è…¿éƒ¨']}] },
        { id: 'TPL_004', name: 'ä¸‰åˆ†åŒ– (è‡€è…¿ä¾§é‡)', goal: 'å¢è‚Œ', level: 'All', gender: 'å¥³', freq: 3, slots: [{n:'è‡€è…¿å¡‘å½¢', t:['è‡€éƒ¨','è…¿éƒ¨']}, {n:'ä¸Šè‚¢å¡‘å½¢', t:['èƒ¸éƒ¨','èƒŒéƒ¨','è‚©éƒ¨','æ‰‹è‡‚']}, {n:'è‡€è…¿å¼ºåŒ–', t:['è‡€éƒ¨','è…¿éƒ¨']}] },
        { id: 'TPL_005', name: 'å››åˆ†åŒ– (éçº¿æ€§)', goal: 'å¢è‚Œ', level: 'All', freq: 4, slots: [{n:'èƒ¸è‡‚é›•åˆ»', t:['èƒ¸éƒ¨','æ‰‹è‡‚']}, {n:'è‡€è…¿è½°ç‚¸', t:['è‡€éƒ¨','è…¿éƒ¨']}, {n:'èƒŒè‚©å¼ºåŒ–', t:['èƒŒéƒ¨','è‚©éƒ¨']}, {n:'æ ¸å¿ƒå…¨èº«', t:['æ ¸å¿ƒ','å…¨èº«']}] },
        { id: 'TPL_006', name: 'äº”åˆ†åŒ– (å•éƒ¨ä½)', goal: 'å¢è‚Œ', level: 'All', freq: 5, slots: [{n:'èƒ¸éƒ¨ä¸“é¡¹', t:['èƒ¸éƒ¨']}, {n:'èƒŒéƒ¨ä¸“é¡¹', t:['èƒŒéƒ¨']}, {n:'è‚©éƒ¨ä¸“é¡¹', t:['è‚©éƒ¨']}, {n:'æ‰‹è‡‚ä¸“é¡¹', t:['æ‰‹è‡‚']}, {n:'è‡€è…¿ä¸“é¡¹', t:['è‡€éƒ¨','è…¿éƒ¨']}] },
        { id: 'TPL_FAT', name: 'å‡è„‚å¾ªç¯', goal: 'å‡è„‚', level: 'All', freq: 3, slots: [{n:'å…¨èº«ç‡ƒè„‚', t:['å…¨èº«']}, {n:'æ ¸å¿ƒç‡ƒè„‚', t:['æ ¸å¿ƒ','å…¨èº«']}, {n:'å…¨èº«ç‡ƒè„‚', t:['å…¨èº«']}] }
    ],
    paradigms: [
        { name: 'æŠ—é˜»èŒƒå¼', types: 'åŠ›é‡, åº·å¤, é«˜å°”å¤«', sets: '3-5', strategy: 'æ¨è' },
        { name: 'é—´æ­‡èŒƒå¼', types: 'HIIT, æœ‰æ°§, æå‡»', sets: '3-5', strategy: 'è®¡æ—¶' },
        { name: 'æµå¼èŒƒå¼', types: 'ç‘œä¼½, æ™®æ‹‰æ, æ‹‰ä¼¸, å†¥æƒ³, æ°”åŠŸ', sets: '1', strategy: 'è®¡æ—¶' }
    ],
    load: [
        { name: 'æ’å®š', index: 'All', coeff: 1.0, inc: 0 },
        { name: 'é€’å¢', index: '1', coeff: 0.85, inc: '+2' },
        { name: 'é€’å¢', index: '2', coeff: 0.90, inc: '+1' },
        { name: 'é€’å¢', index: '3+', coeff: 1.00, inc: 0 },
        { name: 'é€’å‡', index: '1', coeff: 1.0, inc: 0 },
        { name: 'é€’å‡', index: '2', coeff: 0.90, inc: '+2' },
        { name: 'é€’å‡', index: '3+', coeff: 0.80, inc: '+4' }
    ],
    factors: [
        { key: 'æ–°é²œå¥–åŠ±', weight: 60, rule: 'æœªç»ƒå¤©æ•° > 7' },
        { key: 'æ”¶è—å¥–åŠ±', weight: 50, rule: 'æ˜¯å¦æ”¶è— = True' },
        { key: 'åŒå€¦æƒ©ç½š', weight: -80, rule: 'è¿ç»­å‡ºç°æ¬¡æ•° â‰¥ 3' },
        { key: 'ç–²åŠ³æƒ©ç½š', weight: -50, rule: 'è¾…åŠ©è‚ŒçŠ¶æ€ < 55' }
    ]
};

const FALLBACK_DB = [
    { id: 'FB01', name: 'æ ‡å‡†ä¿¯å§æ’‘', part: 'èƒ¸éƒ¨', muscle: 'èƒ¸å¤§è‚Œ', equip: ['è‡ªé‡'], difficulty: 'L1', impact: 'ä½å†²å‡»', paradigm: 'æŠ—é˜»èŒƒå¼', func: ['å¢è‚Œ','åŠ›é‡'], pain: [], construct: 'å¤åˆåŠ¨ä½œ' },
    { id: 'FB02', name: 'è‡ªé‡æ·±è¹²', part: 'è…¿éƒ¨', muscle: 'è‚¡å››å¤´è‚Œ', equip: ['è‡ªé‡'], difficulty: 'L1', impact: 'ä½å†²å‡»', paradigm: 'æŠ—é˜»èŒƒå¼', func: ['å¢è‚Œ','åŠ›é‡'], pain: [], construct: 'å¤åˆåŠ¨ä½œ' },
    { id: 'FB03', name: 'å¼€åˆè·³', part: 'å…¨èº«', muscle: 'å…¨èº«', equip: ['è‡ªé‡'], difficulty: 'L1', impact: 'é«˜å†²å‡»', paradigm: 'é—´æ­‡èŒƒå¼', func: ['å¿ƒè‚º','å‡è„‚'], pain: [], construct: 'å¤åˆåŠ¨ä½œ' },
    { id: 'FB04', name: 'å¹³æ¿æ”¯æ’‘', part: 'æ ¸å¿ƒ', muscle: 'è…¹ç›´è‚Œ', equip: ['è‡ªé‡'], difficulty: 'L1', impact: 'ä½å†²å‡»', paradigm: 'æŠ—é˜»èŒƒå¼', func: ['æ ¸å¿ƒ','ç¨³å®š'], pain: [], construct: 'å­¤ç«‹åŠ¨ä½œ' },
    { id: 'FB05', name: 'çŒ«ç‰›å¼', part: 'èƒŒéƒ¨', muscle: 'ç«–è„Šè‚Œ', equip: ['è‡ªé‡'], difficulty: 'L1', impact: 'ä½å†²å‡»', paradigm: 'æµå¼èŒƒå¼', func: ['æ”¾æ¾','æŸ”éŸ§'], pain: [], construct: 'å¤åˆåŠ¨ä½œ' },
    { id: 'FB06', name: 'æ¨¡æ‹Ÿåˆ’èˆ¹', part: 'èƒŒéƒ¨', muscle: 'èƒŒé˜”è‚Œ', equip: ['è‡ªé‡'], difficulty: 'L1', impact: 'ä½å†²å‡»', paradigm: 'æŠ—é˜»èŒƒå¼', func: ['å¢è‚Œ','åŠ›é‡'], pain: [], construct: 'å¤åˆåŠ¨ä½œ' },
    { id: 'FB07', name: 'å©´å„¿å¼', part: 'å…¨èº«', muscle: 'å…¨èº«', equip: ['è‡ªé‡'], difficulty: 'L1', impact: 'ä½å†²å‡»', paradigm: 'æµå¼èŒƒå¼', func: ['æ”¾æ¾','æ¢å¤'], pain: [], construct: 'å­¤ç«‹åŠ¨ä½œ' }
];

let DB = [];

// Async Load Action Library
(async function initDB() {
    try {
        const response = await fetch('åŠ¨ä½œåº“.json');
        const data = await response.json();
        processData(data);
        console.log(`[ActionLibrary] Loaded ${DB.length} actions from JSON.`);
    } catch (error) {
        console.warn("Failed to load Action Library, using Fallback Data:", error);
        processData(FALLBACK_DB);
    }

    function processData(data) {
        DB = data.map(a => ({
            ...a,
            lastTrained: new Date(Date.now() - Math.random() * 1000000000),
            isFav: Math.random() > 0.8
        }));
    }
})();

window.PhaseEngine = {
    generateSchedule: (totalWeeks) => {
        const phases = [];
        const P = CONFIG.PHASES;
        
        if (totalWeeks < 4) {
            if(totalWeeks === 1) phases.push({...P['è¿›é˜¶æœŸ'], weeks:1});
            else if(totalWeeks === 2) { phases.push({...P['é€‚åº”æœŸ'], weeks:1}); phases.push({...P['è¿›é˜¶æœŸ'], weeks:1}); }
            else { phases.push({...P['é€‚åº”æœŸ'], weeks:1}); phases.push({...P['è¿›é˜¶æœŸ'], weeks:1}); phases.push({...P['çªç ´æœŸ'], weeks:1}); }
        } else {
            const w1 = Math.max(1, Math.round(totalWeeks * 0.25));
            const w2 = Math.max(1, Math.round(totalWeeks * 0.40));
            const w4 = Math.max(1, Math.round(totalWeeks * 0.10));
            const w3 = totalWeeks - w1 - w2 - w4;
            phases.push({...P['é€‚åº”æœŸ'], weeks:w1});
            phases.push({...P['è¿›é˜¶æœŸ'], weeks:w2});
            phases.push({...P['çªç ´æœŸ'], weeks:w3});
            phases.push({...P['å‡è½½æœŸ'], weeks:w4});
        }
        
        let schedule = [];
        phases.forEach(p => {
            for(let i=0; i<p.weeks; i++) schedule.push(p);
        });
        return schedule.slice(0, totalWeeks);
    }
};

// æ¨¡æ‹Ÿæ•°æ®åº“ï¼šç”¨æˆ·èƒ½åŠ›æ¡£æ¡ˆ (1RM) - æ”¯æŒåé¦ˆé—­ç¯æ›´æ–°
window.UserAbility = {
    oneRM: {}, 
    init: () => {
        const level = window.store.user.level || 'L3';
        const coeff = CONFIG.LEVEL_COEFF[level] || 1.0;
        for(let k in CONSTANTS.ENUMS.ONE_RM) {
            window.UserAbility.oneRM[k] = Math.round(CONSTANTS.ENUMS.ONE_RM[k] * coeff);
        }
    },
    update: (part, load, reps) => {
        // Epley Formula: 1RM = Weight * (1 + Reps/30)
        const est1RM = Math.round(load * (1 + reps/30));
        if (est1RM > (window.UserAbility.oneRM[part] || 0)) {
            window.UserAbility.oneRM[part] = est1RM;
            console.log(`[Feedback] New PR for ${part}: ${est1RM}kg`);
            return true;
        }
        return false;
    }
};

window.Logic = {
    createContext: (input, planContext = null) => {
        const user = window.store.user;
        // Calculate bodyStatus from fatigue (1-10) if not present
        const bodyStatus = Math.max(0, 100 - (user.fatigue * 8));
        
        // Normalize targets to Array
        const rawTargets = input ? input.targets : null;
        const targets = (Array.isArray(rawTargets) && rawTargets.length > 0) ? rawTargets : (rawTargets ? [rawTargets] : ['å…¨èº«']);

        return {
            source: planContext ? 'Plan' : 'Single',
            planContext: planContext,
            meta: {
                type: planContext ? planContext.type : (input.type || 'åŠ›é‡'),
                targets: planContext ? planContext.targets : targets,
                duration: planContext ? planContext.duration : (input ? (parseInt(input.duration) || 30) : 30), // Default 30
                level: user.level,
                goal: user.goal
            },
            constraints: { 
                availableEquip: ['è‡ªé‡', 'æ¨ªæ†', 'æ‰‹æŸ„', 'å¥èº«å‡³', 'æ³¡æ²«è½´'].filter(e => !user.missing.includes(e)),
                forbiddenParts: [...user.pain],
                downgrade: bodyStatus < 55
            },
            phases: [],
            status: { fatigue: bodyStatus }
        };
    },

    confirmCourse: (ctx) => {
        const user = window.store.user;
        let finalTargets = [...ctx.meta.targets];
        const conflict = finalTargets.some(t => ctx.constraints.forbiddenParts.includes(t));
        
        if (conflict) {
            if (ctx.source === 'Plan') finalTargets = ['å…¨èº«']; 
            else ctx.constraints.downgrade = true;
        }

        let levelStr = user.level;
        if (ctx.constraints.downgrade) {
            const currentLvl = CONSTANTS.LEVEL_MAP[levelStr];
            const newLvl = Math.max(1, currentLvl - 2);
            levelStr = `L${newLvl}`;
        }

        return {
            ...ctx,
            meta: {
                ...ctx.meta,
                level: levelStr,
                targets: finalTargets
            }
        };
    },

    planPhases: (ctx) => {
        const { duration, type } = ctx.meta;
        const maxWarmup = 5;
        const wuTime = Math.min(Math.round(duration * 0.15), maxWarmup);
        const cdTime = Math.min(Math.round(duration * 0.15), maxWarmup);
        const mainTime = duration - wuTime - cdTime;
        
        // Strategy Resolution: Type (Strong) > Goal (Weak)
        let strategyKey = ctx.meta.goal; // Default to goal (e.g. å¢è‚Œ)
        
        // Type Config Mapping
        const typeConfig = {
            'HIIT': { strategy: 'HIIT', filter: 'å¿ƒè‚º' },
            'æœ‰æ°§': { strategy: 'æœ‰æ°§', filter: 'å¿ƒè‚º' },
            'ç‘œä¼½': { strategy: 'ç‘œä¼½', filter: 'æŸ”éŸ§' },
            'æ™®æ‹‰æ': { strategy: 'æ™®æ‹‰æ', filter: 'ä½“æ€' },
            'æ‹‰ä¼¸': { strategy: 'æ‹‰ä¼¸', filter: 'æ¢å¤' }
        };

        if (typeConfig[type]) {
            strategyKey = typeConfig[type].strategy;
        }

        const mainStrategy = CONFIG.STRATEGY[strategyKey] || CONFIG.STRATEGY['å¢è‚Œ'];
        const wuStrategy = CONFIG.STRATEGY['æ¿€æ´»'];
        const cdStrategy = CONFIG.STRATEGY['æŸ”éŸ§'];
        const paradigm = CONSTANTS.COURSE_TYPES[type] || 'æŠ—é˜»èŒƒå¼';

        // 1. Level Adaptation (Sports Science Core)
        // åŸºäºè¿åŠ¨ç§‘å­¦è°ƒæ•´ï¼šå®¹é‡(Volume)ã€å¼ºåº¦(Intensity)ã€å¯†åº¦(Density/Rest)
        const level = ctx.meta.level || 'L3';
        const scaling = CONFIG.LEVEL_SCALING[level] || CONFIG.LEVEL_SCALING['L3'];
        let adjustedSets = Math.max(1, Math.round(mainStrategy.sets * scaling.vol));
        let adjustedIntensity = Math.min(1.0, Math.max(0.1, mainStrategy.intensity * scaling.int));
        let adjustedRest = Math.max(10, Math.round(mainStrategy.rest * scaling.rest));

        // Time-Constraint Adaptation
        if (duration <= 30) {
            if (['åŠ›é‡', 'çˆ†å‘'].includes(ctx.meta.goal)) adjustedRest = Math.min(adjustedRest, 120);
            else if (['å¢è‚Œ'].includes(ctx.meta.goal)) adjustedRest = Math.min(adjustedRest, 60);
            else adjustedRest = Math.min(adjustedRest, 45);
        }
        
        let singleDuration = paradigm === 'æŠ—é˜»èŒƒå¼' ? (45 + adjustedRest) : (60 + adjustedRest);
        let count = Math.floor((mainTime * 60) / (adjustedSets * singleDuration));
        
        if (count < 3 && adjustedSets > 2) {
            adjustedSets = Math.max(2, Math.min(adjustedSets, Math.floor((mainTime * 60) / 3 / singleDuration)));
            count = Math.floor((mainTime * 60) / (adjustedSets * singleDuration));
        }

        const phaseStrategy = { ...mainStrategy, sets: adjustedSets, rest: adjustedRest, intensity: adjustedIntensity };
        const phaseCoeffs = ctx.planContext ? ctx.planContext.phase : { intensity:1.0, volume:1.0 };

        ctx.phases = [
            { type: 'çƒ­èº«', duration: wuTime, paradigm: 'æµå¼èŒƒå¼', func: 'æ¿€æ´»', targetCount: Math.ceil(wuTime/1.5), strategy: wuStrategy },
            { type: 'ä¸»è®­', duration: mainTime, paradigm: paradigm, func: ctx.meta.goal, targetCount: Math.max(1, count), strategy: phaseStrategy, coeffs: phaseCoeffs },
            { type: 'æ”¾æ¾', duration: cdTime, paradigm: 'æµå¼èŒƒå¼', func: 'æ”¾æ¾', targetCount: Math.ceil(cdTime/1.5), strategy: cdStrategy }
        ];
        return ctx;
    },

    selectActions: (ctx) => {
        const { constraints, meta } = ctx;
        const user = window.store.user;
        const isHeavy = (user.bmi >= 28 && user.level !== 'L5');
        const isMain = (p) => p.type === 'ä¸»è®­';

        // Ensure DB is populated
        if (DB.length === 0) DB = FALLBACK_DB;

        const calculateScore = (a) => {
            let score = 100 + Math.random() * 15;
            const daysSince = (new Date() - a.lastTrained) / (1000 * 3600 * 24);
            if (daysSince > 7) score += 60;
            if (a.isFav) score += 50;
            if (a.difficulty === meta.level) score += 30;
            else if (Math.abs(CONSTANTS.LEVEL_MAP[a.difficulty] - CONSTANTS.LEVEL_MAP[meta.level]) === 1) score += 10;
            else score -= 20;
            return { ...a, score };
        };
        
        ctx.phases.forEach(p => {
            // 0. Safety Filter (Global Constraint - Always Active)
            let pool = DB.filter(a => {
                if (a.equip.some(e => !constraints.availableEquip.includes(e))) return false;
                if (a.pain.some(pt => constraints.forbiddenParts.includes(pt))) return false;
                if (isHeavy && a.impact === 'é«˜å†²å‡»') return false;
                if (constraints.downgrade && a.impact === 'é«˜å†²å‡»') return false;
                return true;
            });

            // Helper: Search with criteria (Supports Relaxation)
            const search = (criteria) => {
                return pool.filter(a => {
                    // Paradigm Check (Strict)
                    if (a.paradigm !== p.paradigm) return false;
                    
                    // Part Check
                    if (isMain(p)) {
                        // Main: Must match target parts (or Full Body)
                        // Fallback Level 4 (Keep Skeleton) implies we stick to this.
                        const matchPart = ctx.meta.targets.includes('å…¨èº«') || ctx.meta.targets.includes(a.part);
                        if (!matchPart) return false;
                    }
                    
                    // Function Check (Relaxable)
                    if (criteria.checkFunc) {
                        if (isMain(p)) {
                            // For main, usually we don't strictly filter by func unless specified, 
                            // but let's assume we prefer the phase function (e.g. Hypertrophy)
                            if (p.func && !a.func.includes(p.func)) return false;
                        } else {
                            // Warmup/Cooldown: Strict function
                            if (!a.func.includes(p.func)) return false;
                        }
                    }

                    // Difficulty Check (Relaxable)
                    if (criteria.checkDiff) {
                        const diffVal = CONSTANTS.LEVEL_MAP[a.difficulty];
                        const userVal = CONSTANTS.LEVEL_MAP[meta.level];
                        if (Math.abs(diffVal - userVal) > 1) return false;
                    }

                    return true;
                }).map(calculateScore).sort((a,b) => b.score - a.score);
            };

            let selected = [];
            const usedIds = new Set();
            const needed = p.targetCount;

            // 1. Level 0: Strict Search
            let candidates = search({ checkFunc: true, checkDiff: true });

            // Selection Loop (Top-K Random)
            const pick = (sourceList) => {
                while(selected.length < needed && sourceList.length > 0) {
                    const pickRange = Math.min(sourceList.length, 3);
                    const randomIdx = Math.floor(Math.random() * pickRange);
                    const picked = sourceList[randomIdx];
                    if (!usedIds.has(picked.id)) {
                        selected.push(picked);
                        usedIds.add(picked.id);
                    }
                    sourceList.splice(randomIdx, 1);
                }
            };
            pick(candidates);

            // 2. Level 2: Relax Difficulty (Skip L1 Expand Scope as we use Part directly)
            if (selected.length < needed) {
                candidates = search({ checkFunc: true, checkDiff: false }).filter(a => !usedIds.has(a.id));
                pick(candidates);
            }

            // 3. Level 3: Change Nature (Relax Function)
            if (selected.length < needed) {
                candidates = search({ checkFunc: false, checkDiff: false }).filter(a => !usedIds.has(a.id));
                pick(candidates);
            }

            // 2. ç¼ºå£å¡«å…… (Gap Filling) - æ ¸å¿ƒé€»è¾‘ä¼˜åŒ–
            // è‹¥ç­›é€‰å‡ºçš„åŠ¨ä½œä¸è¶³ä»¥å¡«æ»¡æ—¶é•¿ï¼Œè‡ªåŠ¨å¢åŠ å·²é€‰åŠ¨ä½œçš„ç»„æ•°
            if (selected.length > 0 && selected.length < needed) {
                let missingSlots = needed - selected.length;
                let fillIdx = 0;
                // ç†”æ–­é™åˆ¶ï¼šå•ä¸ªåŠ¨ä½œæœ€å¤§ç»„æ•° â‰¤ 6
                const MAX_SETS = 6; 
                
                while(missingSlots > 0) {
                    // è½®è¯¢å¢åŠ ç»„æ•°
                    if (selected[fillIdx].sets === undefined) selected[fillIdx].sets = p.strategy.sets; // Init if needed
                    
                    if (selected[fillIdx].sets < MAX_SETS) {
                        selected[fillIdx].sets = (selected[fillIdx].sets || p.strategy.sets) + 1;
                        missingSlots--;
                    }
                    fillIdx = (fillIdx + 1) % selected.length;
                    
                    // é˜²æ­¢æ­»å¾ªç¯ï¼šå¦‚æœæ‰€æœ‰åŠ¨ä½œéƒ½è¾¾åˆ°ä¸Šé™ä»æœ‰ç¼ºå£ï¼Œåˆ™åœæ­¢å¡«å……
                    if (selected.every(a => (a.sets || p.strategy.sets) >= MAX_SETS)) break;
                }
            }

            // 3. åºåˆ—ç¼–æ’ (Sequence Arrangement) - æ ¸å¿ƒé€»è¾‘ä¼˜åŒ–
            // ä½“èƒ½åˆ†é…ï¼šå¤åˆåŠ¨ä½œ > å­¤ç«‹åŠ¨ä½œ (ä»…é’ˆå¯¹æŠ—é˜»ä¸»è®­)
            if (p.type === 'ä¸»è®­' && p.paradigm === 'æŠ—é˜»èŒƒå¼') {
                selected.sort((a, b) => {
                    const scoreA = (a.construct === 'å¤åˆåŠ¨ä½œ' ? 1 : 0);
                    const scoreB = (b.construct === 'å¤åˆåŠ¨ä½œ' ? 1 : 0);
                    return scoreB - scoreA; // å¤åˆåŠ¨ä½œæ’å‰é¢
                });
            }

            p.actions = selected;
        });
        return ctx;
    },

    instantiate: (ctx) => {
        const globalStrategy = window.store.courseSettings.loadStrategy;
        
        ctx.phases.forEach(phase => {
            const { strategy, coeffs } = phase;
            const iCoeff = coeffs ? coeffs.intensity : 1.0;
            const vCoeff = coeffs ? coeffs.volume : 1.0;

            phase.actions = phase.actions.map(a => {
                // 1. è®¡ç®—æ¨¡å¼åˆ¤å®š (Calculation Mode Judgment)
                // è´Ÿè·ä¼˜å…ˆæ¨¡å¼ï¼šæŠ—é˜»èŒƒå¼ (å…³æ³¨é‡é‡)
                // å®¹é‡ä¼˜å…ˆæ¨¡å¼ï¼šé—´æ­‡/æµå¼èŒƒå¼ (å…³æ³¨æ—¶é•¿/æ¬¡æ•°)
                const isCapacityPriority = (phase.paradigm === 'é—´æ­‡èŒƒå¼' || phase.paradigm === 'æµå¼èŒƒå¼' || globalStrategy === 'è®¡æ—¶');
                const isLoadPriority = !isCapacityPriority;

                // 2. åŸºå‡†å‚æ•°è®¡ç®—
                // ç»„æ•°ï¼šä¼˜å…ˆä½¿ç”¨ selectActions ä¸­ Gap Filling è°ƒæ•´åçš„ç»„æ•°ï¼Œå¦åˆ™ä½¿ç”¨ç­–ç•¥åŸºå‡†
                let sets = a.sets || Math.round(strategy.sets * vCoeff);
                if (phase.type === 'çƒ­èº«' || phase.type === 'æ”¾æ¾') sets = 1;
                
                let intensity = strategy.intensity * iCoeff;
                let load = 0;
                let reps = '12';
                let rpe = strategy.rpe || 8;

                if (isLoadPriority) {
                    // æ¨¡å¼ Aï¼šè´Ÿè·ä¼˜å…ˆ (å®šé‡é‡ -> å®šæ¬¡æ•°)
                    const base1RM = window.UserAbility.oneRM[a.part] || 20; // Use dynamic 1RM
                    load = Math.round(base1RM * intensity);
                    
                    // åŸºäºå¼ºåº¦åæ¨æ¬¡æ•° (ç®€å•æŸ¥è¡¨æ¨¡æ‹Ÿ)
                    let theoReps = 12;
                    if (intensity >= 0.9) theoReps = 4;
                    else if (intensity >= 0.8) theoReps = 8;
                    else if (intensity >= 0.7) theoReps = 12;
                    // RPE ä¿®æ­£
                    reps = Math.max(1, theoReps - (10 - rpe)).toString();
                } else {
                    // æ¨¡å¼ Bï¼šå®¹é‡ä¼˜å…ˆ (å®šå®¹é‡ -> å®šé‡é‡)
                    // å¼ºåº¦ç³»æ•°ä½œç”¨äºé€Ÿåº¦/é¢‘ç‡(ç”±æ•™ç»ƒå£ä»¤æ§åˆ¶)ï¼Œæ—¶é•¿ä¿æŒä¸è§„åˆ’å±‚ä¸€è‡´(60s)ä»¥ç¡®ä¿æ€»æ—¶é•¿å‡†ç¡®
                    reps = (phase.paradigm === 'é—´æ­‡èŒƒå¼') ? '60' : '30';
                    if (phase.type === 'çƒ­èº«') reps = '60';
                }

                // Apply Load Strategy (Pyramid etc)
                let setDetails = [];
                let activeStrategy = globalStrategy === 'æ¨è' ? strategy.strategy : globalStrategy;
                if (activeStrategy === 'è‡ªå®šä¹‰') activeStrategy = 'æ’å®š';

                for(let i=0; i<sets; i++) {
                    let sLoad = load;
                    let sReps = parseInt(reps);
                    // ä»…åœ¨è´Ÿè·ä¼˜å…ˆæ¨¡å¼ä¸‹åº”ç”¨é‡‘å­—å¡”ç­–ç•¥
                    if (isLoadPriority) {
                        if (activeStrategy === 'é€’å¢') {
                            if (i === 0) { sLoad = Math.round(load * 0.85); sReps += 2; }
                            else if (i === 1) { sLoad = Math.round(load * 0.90); sReps += 1; }
                        } else if (activeStrategy === 'é€’å‡') {
                            if (i === 1) { sLoad = Math.round(load * 0.90); sReps += 2; }
                            else if (i >= 2) { sLoad = Math.round(load * 0.80); sReps += 4; }
                        }
                    }
                    setDetails.push({ load: sLoad, reps: sReps });
                }

                return {
                    ...a,
                    sets,
                    reps,
                    load,
                    setDetails,
                    intensity: Math.round(intensity*100)+'%',
                    rpe
                };
            });
        });
        return ctx;
    },

    runPipeline: (input, planContext) => {
        let ctx = window.Logic.createContext(input, planContext);
        ctx = window.Logic.confirmCourse(ctx);
        ctx = window.Logic.planPhases(ctx);
        ctx = window.Logic.selectActions(ctx);
        ctx = window.Logic.instantiate(ctx);
        return ctx;
    },

    genCourse: (input) => {
        const ctx = window.Logic.runPipeline(input, null);
        return ctx;
    },

    genPlan: (input) => {
        const weeks = parseInt(input.cycle) || 4;
        const userDays = input.days || [];
        const dayMap = {'å‘¨ä¸€':1, 'å‘¨äºŒ':2, 'å‘¨ä¸‰':3, 'å‘¨å››':4, 'å‘¨äº”':5, 'å‘¨å…­':6, 'å‘¨æ—¥':7};
        const dayNums = userDays.map(d => dayMap[d]).sort();
        const freq = Math.min(Math.max(userDays.length, 1), 7); // Ensure freq is within 1-7
        
        // 1. Select Template based on Frequency & Goal
        // Match Goal AND Gender if specified (e.g. TPL_003 vs TPL_004)
        let template = CONFIG.TEMPLATES.find(t => 
            t.freq === freq && 
            t.goal === window.store.user.goal &&
            (!t.gender || t.gender === window.store.user.gender)
        );
        // Fallback to frequency match only if specific goal/gender match fails
        if (!template) template = CONFIG.TEMPLATES.find(t => t.freq === freq) || CONFIG.TEMPLATES[0]; // Default to first if no freq match (unlikely with 1-5 covered)

        const phaseSchedule = window.PhaseEngine.generateSchedule(weeks);
        const schedule = [];
        
        // Map template slots to days
        let slotIdx = 0;
        const dayStrategy = {};
        dayNums.forEach(d => {
            const slotObj = template.slots[slotIdx % template.slots.length];
            // Slot is array of targets e.g. ['å…¨èº«']
            dayStrategy[d] = { f: slotObj.t, t: slotObj.n }; 
            slotIdx++;
        });
        
        for(let w=1; w<=weeks; w++) {
            const pParams = phaseSchedule[w-1];
            const weekData = {
                week: w,
                phase: pParams.name,
                intensity: pParams.intensity,
                days: []
            };
            
            for(let d=1; d<=7; d++) {
                const s = dayStrategy[d];
                const dayName = ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'][d-1];
                if(s) {
                    weekData.days.push({ dayName, isTraining: true, targets: s.f, title: s.t });
                } else {
                    weekData.days.push({ dayName, isTraining: false });
                }
            }
            schedule.push(weekData);
        }
        return { meta: input, schedule };
    },

    // Node 8: åé¦ˆé—­ç¯ (Feedback Loop)
    completeTraining: (ctx) => {
        // 1. Update Fatigue (Mock: Reduce status)
        window.store.user.fatigue = Math.min(10, window.store.user.fatigue + 2);
        window.store.calcMetrics(); // Update UI

        // 2. Update 1RM (Mock: Based on last set of main actions)
        let prCount = 0;
        ctx.phases.forEach(p => {
            if (p.type === 'ä¸»è®­' && p.paradigm === 'æŠ—é˜»èŒƒå¼') {
                p.actions.forEach(a => {
                    // Assume user completed the last set successfully
                    const lastSet = a.setDetails[a.setDetails.length-1];
                    if (lastSet && lastSet.load > 0) {
                        if (window.UserAbility.update(a.part, lastSet.load, lastSet.reps)) prCount++;
                    }
                });
            }
        });

        return { prCount };
    }
};

// ==========================================
// 1. STATE & STORE
// ==========================================
window.store = {
    user: {
        gender: 'ç”·', age: 28, height: 178, weight: 72, targetWeight: 70,
        goal: 'å¢è‚Œ', funcGoal: 'å¢è‚Œ', level: 'L3', style: 'ä¼ ç»Ÿå‹', days: ['å‘¨ä¸€','å‘¨ä¸‰','å‘¨äº”'],
        pain: [], missing: [], bodyType: 'å‡è¡¡æ ‡å‡†å‹', dob: '1995-01-01', fatiguedParts: ['è…¿éƒ¨'], duration: 30,
        rhr: 60, fatigue: 3
    },
    activeTab: 'basic',
    courseSettings: { loopMode: 'å¸¸è§„ç»„', loadStrategy: 'æ¨è' },
    flow: null, // 'course' | 'plan'
    step: 0,
    inputs: {},
    replaceState: null, // {pIdx, aIdx}
    libFilter: { part: 'å…¨éƒ¨', tag: 'å…¨éƒ¨' }
};

// ==========================================
// 2. APP CONTROLLER
// ==========================================

// Voice Engine
const TEXT_VARIANTS = {
    greeting: [
        "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ AEKE æ™ºèƒ½æ•™ç»ƒã€‚ä»Šå¤©å’±ä»¬æ€ä¹ˆå®‰æ’ï¼Ÿæ˜¯æƒ³å•ç»ƒä¸€èŠ‚è¯¾ï¼Œè¿˜æ˜¯åˆ¶å®šä¸ªé•¿æœŸçš„è®­ç»ƒè®¡åˆ’ï¼Ÿ",
        "å‡†å¤‡å¥½å¼€å§‹äº†å—ï¼Ÿæˆ‘æ˜¯ä½ çš„ä¸“å±æ•™ç»ƒã€‚å‘Šè¯‰æˆ‘ä½ çš„ç›®æ ‡ï¼Œå‰©ä¸‹çš„äº¤ç»™æˆ‘ã€‚",
        "æ¬¢è¿å›æ¥ã€‚ä»Šå¤©çŠ¶æ€çœ‹èµ·æ¥ä¸é”™ã€‚å’±ä»¬æ˜¯é’ˆå¯¹æ€§ç»ƒç»ƒéƒ¨ä½ï¼Œè¿˜æ˜¯åšä¸ªå…¨èº«çš„ç»¼åˆè®­ç»ƒï¼Ÿ",
        "ä½ å¥½ã€‚æˆ‘æ˜¯ AEKE AIã€‚æ— è®ºæ˜¯å¢è‚Œå¡‘å½¢è¿˜æ˜¯å‡è„‚å¿ƒè‚ºï¼Œæˆ‘éƒ½èƒ½å¸®ä½ è§„åˆ’ã€‚ä»Šå¤©æƒ³åšä»€ä¹ˆï¼Ÿ",
        "éšæ—¶å¾…å‘½ã€‚ä½ æ˜¯æƒ³å¿«é€Ÿæµæ±—ç»ƒä¸€èŠ‚ï¼Œè¿˜æ˜¯æƒ³æ²‰ä¸‹å¿ƒæ¥å®šä¸ªå‘¨æœŸè®¡åˆ’ï¼Ÿ",
        "ä½ å¥½ï¼Œæ•™ç»ƒå°±ä½ã€‚ä»Šå¤©å’±ä»¬ç»ƒç‚¹ä»€ä¹ˆï¼Ÿç›´æ¥å‘Šè¯‰æˆ‘ä½ çš„æƒ³æ³•ã€‚",
        "å‡†å¤‡å¥½æ”¹å˜äº†å—ï¼Ÿæˆ‘æ˜¯ä½ çš„æ™ºèƒ½æ•™ç»ƒã€‚å’±ä»¬æ˜¯å¼€å§‹ä¸€èŠ‚æ–°è¯¾ï¼Œè¿˜æ˜¯è§„åˆ’æœªæ¥çš„è®­ç»ƒæ—¥ç¨‹ï¼Ÿ",
        "Hiï¼Œä»Šå¤©æƒ³æ€ä¹ˆåŠ¨ï¼Ÿæ˜¯æƒ³æ¥ç‚¹åŠ›é‡æŒ‘æˆ˜ï¼Œè¿˜æ˜¯åšä¸ªæœ‰æ°§æ¢å¤ï¼Ÿ",
        "ä½ å¥½ã€‚æˆ‘æ˜¯ä½ çš„è¿åŠ¨ä¼™ä¼´ã€‚ä»Šå¤©æœ‰ä»€ä¹ˆè®­ç»ƒå®‰æ’ï¼Ÿ",
        "æ•™ç»ƒå·²å°±ä½ã€‚å’±ä»¬æ˜¯ç›´æ¥å¼€ç»ƒï¼Œè¿˜æ˜¯å…ˆèŠèŠä½ çš„é•¿æœŸç›®æ ‡ï¼Ÿ"
    ],
    askType: [
        "æ²¡é—®é¢˜ã€‚ä»Šå¤©çš„ä¸»é¢˜æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯æƒ³åšåŠ›é‡æŠ—é˜»ï¼Œè¿˜æ˜¯æ¥ç‚¹ HIIT ç‡ƒè„‚ï¼Ÿ",
        "æ”¶åˆ°ã€‚è¯·é€‰æ‹©ä»Šå¤©çš„è®­ç»ƒç±»å‹ã€‚æ¯”å¦‚â€˜åŠ›é‡è®­ç»ƒâ€™ã€â€˜ç‘œä¼½â€™æˆ–è€…â€˜æœ‰æ°§â€™ã€‚",
        "å¥½çš„ã€‚ä»Šå¤©æƒ³æ€ä¹ˆç»ƒï¼Ÿæ˜¯æƒ³æ¥ç‚¹ç¡¬æ ¸çš„ä¸¾é“ï¼Œè¿˜æ˜¯è½»æ¾ç‚¹çš„æ‹‰ä¼¸æ¢å¤ï¼Ÿ",
        "äº†è§£ã€‚ä½ æ˜¯æƒ³ä¸“æ³¨äºåŠ›é‡æå‡ï¼Œè¿˜æ˜¯æƒ³åšå¿ƒè‚ºè€åŠ›è®­ç»ƒï¼Ÿ",
        "OKã€‚ä»Šå¤©æƒ³æŒ‘æˆ˜ä¸€ä¸‹æ¿€çƒˆçš„ HIITï¼Œè¿˜æ˜¯åšä¸ªæ™®æ‹‰ææ§åˆ¶ä¸€ä¸‹èº«ä½“ï¼Ÿ",
        "æ˜ç™½ã€‚è¯·å‘Šè¯‰æˆ‘ä½ ä»Šå¤©åå¥½çš„è®­ç»ƒç§ç±»ã€‚",
        "å¥½çš„ã€‚ä»Šå¤©æƒ³è¿›è¡Œå“ªç§ç±»å‹çš„è¿åŠ¨ï¼ŸåŠ›é‡ã€åº·å¤ï¼Œè¿˜æ˜¯å…¶ä»–ï¼Ÿ",
        "æ²¡é—®é¢˜ã€‚è¯·ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªä½ æ„Ÿå…´è¶£çš„è®­ç»ƒæ¨¡å¼ã€‚",
        "è¯·é€‰æ‹©ä½ çš„è®­ç»ƒç±»å‹ã€‚æ˜¯æƒ³è¿½æ±‚æ³µæ„Ÿï¼Œè¿˜æ˜¯æƒ³å¤§é‡å‡ºæ±—ï¼Ÿ",
        "ä»Šå¤©çš„ä¸»é¢˜æ˜¯åŠ›é‡è¿˜æ˜¯è€åŠ›ï¼Ÿè¯·æ˜ç¡®ä¸€ä¸‹ã€‚"
    ],
    askTarget: [
        "äº†è§£ã€‚ä»Šå¤©æƒ³é‡ç‚¹å¼ºåŒ–å“ªä¸ªéƒ¨ä½ï¼Ÿæ˜¯ç»ƒèƒ¸ã€ç»ƒèƒŒï¼Œè¿˜æ˜¯ç»ƒå…¨èº«ï¼Ÿ",
        "OKã€‚è¯·æ˜ç¡®ä»Šå¤©çš„ç›®æ ‡è‚Œç¾¤ã€‚æ¯”å¦‚â€˜è…¹éƒ¨æ ¸å¿ƒâ€™æˆ–è€…â€˜ä¸‹è‚¢è…¿éƒ¨â€™ã€‚",
        "æ²¡é—®é¢˜ã€‚ä»Šå¤©æƒ³ç»ƒå“ªé‡Œï¼Ÿæ˜¯æƒ³é›•åˆ»ä¸Šè‚¢çº¿æ¡ï¼Œè¿˜æ˜¯è½°ç‚¸ä¸‹è‚¢ï¼Ÿ",
        "æ”¶åˆ°ã€‚ä»Šå¤©çš„ä¸»æ”»æ–¹å‘æ˜¯å“ªé‡Œï¼Ÿè¯·é€‰æ‹©ï¼Œæ¯”å¦‚â€˜è‚©éƒ¨â€™æˆ–â€˜æ‰‹è‡‚â€™ã€‚",
        "å¥½çš„ã€‚æƒ³é’ˆå¯¹å“ªé‡Œè¿›è¡Œç‰¹è®­ï¼Ÿæ˜¯æƒ³ç»ƒå‡ºå€’ä¸‰è§’ï¼Œè¿˜æ˜¯ç»ƒå‡ºèœœæ¡ƒè‡€ï¼Ÿ",
        "æ˜ç™½ã€‚ä½ æ˜¯æƒ³åšåˆ†åŒ–è®­ç»ƒç»ƒå±€éƒ¨ï¼Œè¿˜æ˜¯åšå…¨èº«ç»¼åˆè®­ç»ƒï¼Ÿ",
        "äº†è§£ã€‚è¯·é€‰æ‹©ä½ ä»Šå¤©æœ€æƒ³æå‡çš„éƒ¨ä½ã€‚",
        "å¥½çš„ã€‚ä»Šå¤©çš„è®­ç»ƒé‡ç‚¹æ”¾åœ¨å“ªé‡Œï¼Ÿ",
        "ä»Šå¤©æƒ³åˆºæ¿€å“ªå—è‚Œè‚‰ï¼Ÿå‘Šè¯‰æˆ‘ä½ çš„ç›®æ ‡ã€‚",
        "è¯·é€‰æ‹©ä»Šå¤©çš„è®­ç»ƒéƒ¨ä½ã€‚æ˜¯æƒ³ç»ƒå¤§è‚Œç¾¤ï¼Œè¿˜æ˜¯å°è‚Œç¾¤ï¼Ÿ"
    ],
    askDuration: [
        "ä¸ºäº†ä¿è¯è®¡åˆ’çš„å¯æ‰§è¡Œæ€§ï¼Œè¯·å‘Šè¯‰æˆ‘ä½ æ¯å¤©å¹³å‡èƒ½æŠ½å‡ºå¤šå°‘æ—¶é—´è®­ç»ƒï¼Ÿ",
        "ä½ æ¯å¤©å¤§æ¦‚èƒ½ç»ƒå¤šä¹…ï¼Ÿ20åˆ†é’Ÿè¿˜æ˜¯40åˆ†é’Ÿï¼Ÿè¯·æ ¹æ®å®é™…æƒ…å†µè®¾å®šã€‚",
        "OKã€‚æ¯å¤©å¹³å‡çš„è®­ç»ƒæ—¶é•¿æ˜¯å¤šå°‘ï¼Ÿ",
        "äº†è§£ã€‚è¯·è®¾ç½®ä½ æ¯å¤©çš„è®­ç»ƒæ—¶é•¿é¢„ç®—ï¼Œæˆ‘ä¼šæ®æ­¤å®‰æ’è¯¾ç¨‹å®¹é‡ã€‚",
        "æ²¡é—®é¢˜ã€‚æ¯å¤©æ‰“ç®—æŠ•å…¥å‡ åˆ†é’Ÿï¼Ÿè¯·é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ—¶é•¿ã€‚",
        "æ”¶åˆ°ã€‚ä¸ºäº†ä¸å½±å“ä½ çš„æ—¥å¸¸ç”Ÿæ´»ï¼Œæ¯å¤©é¢„è®¡è®­ç»ƒå¤šä¹…æ¯”è¾ƒåˆé€‚ï¼Ÿ",
        "å¥½çš„ã€‚ä½ æ˜¯å–œæ¬¢çŸ­æ—¶é«˜æ•ˆçš„è®­ç»ƒï¼Œè¿˜æ˜¯æ—¶é—´å……è£•çš„é•¿è¯¾ï¼Ÿæ¯å¤©å¤§æ¦‚å¤šä¹…ï¼Ÿ",
        "è¯·å‘Šè¯‰æˆ‘ä½ çš„æ—¶é—´å®‰æ’ã€‚æ¯å¤©èƒ½ä¿è¯å¤šå°‘åˆ†é’Ÿçš„è®­ç»ƒæ—¶é—´ï¼Ÿ",
        "æ¯å¤©æœ‰å¤šå°‘æ—¶é—´å¯ä»¥ç”¨æ¥è¿åŠ¨ï¼Ÿè¯·è®¾å®šä¸€ä¸ªå¹³å‡å€¼ã€‚",
        "ä¸ºäº†è¾¾åˆ°æœ€ä½³æ•ˆæœï¼Œæ¯å¤©å»ºè®®è®­ç»ƒå¤šä¹…ï¼Ÿè¯·é€‰æ‹©ã€‚"
    ],
    askCycle: [
        "è¿™ä¸ªè®­ç»ƒè®¡åˆ’ä½ æƒ³åšæŒå‡ å‘¨ï¼Ÿå»ºè®®è‡³å°‘4å‘¨ä»¥çœ‹åˆ°æ˜æ˜¾æ•ˆæœã€‚",
        "æˆ‘ä»¬è¦åˆ¶å®šä¸€ä¸ªå¤šé•¿çš„å‘¨æœŸï¼Ÿæ˜¯æƒ³åšä¸ªçŸ­æœŸçªå‡»ï¼Œè¿˜æ˜¯é•¿æœŸè§„åˆ’ï¼Ÿ",
        "ä½ æ‰“ç®—è¿›è¡Œå‡ å‘¨çš„ç‰¹è®­ï¼Ÿ4å‘¨ã€8å‘¨è¿˜æ˜¯12å‘¨ï¼Ÿ",
        "OKã€‚è®¡åˆ’å‘¨æœŸè®¾å®šä¸ºå‡ å‘¨ï¼Ÿè¯·é€‰æ‹©ã€‚",
        "äº†è§£ã€‚è¿™ä¸ªè®¡åˆ’çš„è·¨åº¦æ˜¯å¤šä¹…ï¼Ÿ",
        "æ²¡é—®é¢˜ã€‚è¯·é€‰æ‹©è®¡åˆ’çš„æŒç»­å‘¨æ•°ã€‚",
        "æ”¶åˆ°ã€‚æˆ‘ä»¬è¦è§„åˆ’å‡ å‘¨çš„è®­ç»ƒï¼ŸåšæŒè¶Šä¹…ï¼Œæ•ˆæœè¶Šå¥½ã€‚",
        "å¥½çš„ã€‚è¯·å‘Šè¯‰æˆ‘è®¡åˆ’çš„æ€»æ—¶é•¿ã€‚æˆ‘ä¼šä¸ºä½ å®‰æ’å¥½æ¯ä¸ªé˜¶æ®µã€‚",
        "æƒ³åˆ¶å®šå‡ å‘¨çš„è®¡åˆ’ï¼Ÿè¯·æ ¹æ®ä½ çš„æ¯…åŠ›æ¥é€‰æ‹©ã€‚",
        "è¿™ä¸ªå‘¨æœŸå¤§æ¦‚å¤šé•¿ï¼Ÿè¯·è®¾å®šã€‚"
    ],
    askFreq: [
        "æ¯å‘¨å“ªå‡ å¤©æ–¹ä¾¿è®­ç»ƒï¼Ÿè¯·å…·ä½“å‘Šè¯‰æˆ‘ï¼Œæ¯”å¦‚â€˜å‘¨ä¸€ã€å‘¨ä¸‰å’Œå‘¨äº”â€™ã€‚",
        "è¯·é€‰æ‹©ä½ çš„å›ºå®šè®­ç»ƒæ—¥ã€‚ä¸€å‘¨ç»ƒå‡ å¤©ï¼Ÿå…·ä½“æ˜¯å“ªå‡ å¤©ï¼Ÿ",
        "å¥½çš„ã€‚æ¯å‘¨çš„è®­ç»ƒå®‰æ’æ˜¯æ€æ ·çš„ï¼Ÿè¯·å‹¾é€‰ä½ æœ‰ç©ºçš„æ—¥å­ã€‚",
        "äº†è§£ã€‚è¯·é€‰æ‹©æ¯å‘¨çš„è®­ç»ƒæ—¥ã€‚æˆ‘ä¼šæ ¹æ®ä½ çš„é€‰æ‹©å®‰æ’ä¼‘æ¯æ—¥ã€‚",
        "æ²¡é—®é¢˜ã€‚å“ªå‡ å¤©èƒ½ä¿è¯è®­ç»ƒï¼Ÿå‘¨ä¸€åˆ°å‘¨æ—¥é€‰ä¸€ä¸‹ã€‚",
        "æ”¶åˆ°ã€‚æ¯å‘¨çš„å‡ºå‹¤æ—¥æ˜¯å“ªå‡ å¤©ï¼Ÿè¯·ç¡®è®¤ã€‚",
        "OKã€‚ä½ å¸Œæœ›æ¯å‘¨å“ªå‡ å¤©ç»ƒï¼Ÿè¯·é€‰æ‹©ã€‚",
        "å¥½çš„ã€‚è¯·é€‰æ‹©æ¯å‘¨çš„è®­ç»ƒå¤©æ•°å’Œå…·ä½“æ—¥æœŸï¼Œè¿™å¾ˆé‡è¦ã€‚",
        "æ˜ç™½ã€‚ä¸€å‘¨å¤§æ¦‚èƒ½æ¥å‡ å¤©ï¼Ÿå…·ä½“æ˜¯å‘¨å‡ ï¼Ÿè¯·å‘Šè¯‰æˆ‘ã€‚",
        "è¯·è®¾å®šä½ çš„å‘¨è®­ç»ƒæ—¥ç¨‹ã€‚è§„å¾‹çš„è®­ç»ƒæ˜¯æˆåŠŸçš„å…³é”®ã€‚"
    ],
    error: [
        "æŠ±æ­‰ï¼Œåˆšæ‰æ²¡å¬æ¸…ã€‚èƒ½éº»çƒ¦ä½ å†è¯´ä¸€éå—ï¼Ÿ",
        "æˆ‘æ²¡å¬æ‡‚ï¼Œè¯·å¤§å£°ä¸€ç‚¹ï¼Œæˆ–è€…ç›´æ¥ç‚¹å‡»å±å¹•ä¸Šçš„é€‰é¡¹ã€‚",
        "å¥½åƒæœ‰ç‚¹å¹²æ‰°ï¼Œè¯·æ¢ä¸ªè¯´æ³•è¯•è¯•ï¼Œæˆ–è€…ç›´æ¥æ“ä½œã€‚",
        "ä¸å¥½æ„æ€ï¼Œèƒ½å†è¯´ä¸€éå—ï¼Ÿæˆ‘æ­£åœ¨è®¤çœŸå¬ã€‚",
        "æŠ±æ­‰ï¼Œè¯·æ¸…æ™°åœ°è¯´å‡ºä½ çš„é€‰æ‹©ï¼Œæˆ–è€…ç›´æ¥ç‚¹å‡»ç¡®è®¤ã€‚",
        "è¯·å†è¯´ä¸€æ¬¡ï¼Œåˆšæ‰ä¿¡å·ä¸å¤ªå¥½ã€‚",
        "æ²¡å¬æ¸…ï¼Œè¯·é‡å¤ä¸€éä½ çš„é€‰æ‹©ã€‚",
        "æŠ±æ­‰ï¼Œè¯·ç¡®è®¤ä½ çš„é€‰æ‹©ï¼Œæˆ–è€…é‡æ–°å‘Šè¯‰æˆ‘ã€‚",
        "ä¸å¥½æ„æ€ï¼Œè¯·é‡è¯•ä¸€ä¸‹ã€‚",
        "èƒ½å†è¯´ä¸€æ¬¡å—ï¼Ÿæˆ‘éœ€è¦ç¡®è®¤ä¸€ä¸‹ã€‚"
    ],
    fatigueWarn: [
        "æ³¨æ„ï¼Œæ•°æ®æ˜¾ç¤ºä½ çš„{part}å°šæœªå®Œå…¨æ¢å¤ã€‚ä¸ºäº†å®‰å…¨å’Œè®­ç»ƒæ•ˆæœï¼Œå»ºè®®ä»Šå¤©æ”¹ç»ƒ{rec}ã€‚ä½ è§‰å¾—å‘¢ï¼Ÿ",
        "æ£€æµ‹åˆ°{part}å¤„äºç–²åŠ³çŠ¶æ€ã€‚å¼ºè¡Œè®­ç»ƒå®¹æ˜“å—ä¼¤ï¼Œæ¢æˆ{rec}æ€ä¹ˆæ ·ï¼Ÿ",
        "ä½ çš„{part}çŠ¶æ€ä¸€èˆ¬ï¼Œæ¨èæ–¹æ¡ˆå·²è°ƒæ•´ä¸º{rec}ã€‚æ˜¯å¦ç¡®è®¤åˆ‡æ¢ï¼Ÿ",
        "ä¸ºäº†é˜²æ­¢è¿‡åº¦è®­ç»ƒï¼Œå»ºè®®ä»Šå¤©é¿å¼€{part}ï¼Œæ”¹ç»ƒ{rec}ã€‚åŒæ„å—ï¼Ÿ",
        "ä½ çš„{part}éœ€è¦ä¼‘æ¯ã€‚ä¸å¦‚ä»Šå¤©ç»ƒ{rec}ï¼Œæ•ˆæœä¼šæ›´å¥½ã€‚",
        "æ£€æµ‹åˆ°{part}ç–²åŠ³åº¦è¾ƒé«˜ï¼Œç»ƒ{rec}æ›´åˆé€‚ã€‚æ˜¯å¦åˆ‡æ¢ï¼Ÿ",
        "å»ºè®®è®©{part}ä¼‘æ¯ä¸€ä¸‹ï¼Œä»Šå¤©ä¸“æ³¨ç»ƒ{rec}å§ã€‚æ€ä¹ˆæ ·ï¼Ÿ",
        "æ³¨æ„ï¼Œ{part}çŠ¶æ€ä¸ä½³ã€‚ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå»ºè®®æ¢æˆ{rec}ã€‚æ¥å—å»ºè®®å—ï¼Ÿ",
        "æ£€æµ‹åˆ°{part}ç–²åŠ³ã€‚æ¢æˆ{rec}è®­ç»ƒå¦‚ä½•ï¼Ÿ",
        "ä½ çš„{part}è¿˜æ²¡æ¢å¤ï¼Œå»ºè®®ç»ƒ{rec}ã€‚"
    ]
};

const Voice = {
    synth: window.speechSynthesis,
    rec: null,
    isListening: false,
    selfSpeaking: false,
    voice: null,
    init: () => {
        if (Voice.rec) return; // Prevent multiple inits
        if (window.SpeechRecognition || window.webkitSpeechRecognition) {
            try { Voice.rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)(); } catch(e) { console.error("Voice Init Failed:", e); return; }
            Voice.rec.lang = 'zh-CN';
            Voice.rec.continuous = true; // Continuous Mode for better sensitivity
            Voice.rec.interimResults = true; // Real-time
            
            Voice.rec.onresult = (event) => {
                if (Voice.selfSpeaking) return; // Ignore self
                let interim = '';
                let final = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) final += event.results[i][0].transcript;
                    else interim += event.results[i][0].transcript;
                }
                if (final) App.handleVoiceInput(final, true);
                else if (interim) App.handleVoiceInput(interim, false);
            };
            
            Voice.rec.onerror = (event) => {
                console.log('Voice Error:', event.error);
                if (event.error === 'no-speech' || event.error === 'aborted') {
                    // Silent ignore, onend will handle restart
                } else {
                    App.showToast("è¯­éŸ³è¯†åˆ«å¼‚å¸¸: " + event.error);
                    App.setListeningUI(false);
                }
            };

            // Sound detection for immediate feedback
            Voice.rec.onsoundstart = () => {
                document.querySelector('.siri-container').classList.add('listening');
            };
            
            Voice.rec.onend = () => { 
                if (Voice.isListening && !Voice.selfSpeaking) {
                    try { Voice.rec.start(); } catch(e){} // Auto-restart
                } else if (!Voice.selfSpeaking) {
                    App.setListeningUI(false);
                }
            };
            
            // Load voices
            window.speechSynthesis.onvoiceschanged = () => {
                const voices = window.speechSynthesis.getVoices();
                // Try to find a natural sounding voice
                Voice.voice = voices.find(v => v.lang === 'zh-CN' && (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Apple'))) || voices.find(v => v.lang === 'zh-CN');
            };
        }
    },
    
    speak: (text) => {
        if (!window.SpeechSynthesisUtterance || !Voice.synth) return;
        Voice.selfSpeaking = true;
        if (Voice.rec) try { Voice.rec.abort(); } catch(e) {} // Use abort to discard current buffer
        App.setListeningUI(false);
        
        if (Voice.synth && Voice.synth.speaking) Voice.synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        document.querySelector('.siri-container').classList.add('speaking');
        utter.lang = 'zh-CN';
        utter.rate = 1.1;
        if (Voice.voice) utter.voice = Voice.voice;
        
        utter.onend = () => {
            // Add safety delay to prevent self-hearing echo
            setTimeout(() => {
                document.querySelector('.siri-container').classList.remove('speaking');
                Voice.selfSpeaking = false;
                Voice.startListening(); // Always listen (Home or Chat)
            }, 1500); // Increased safety delay for anti-self-hearing
        };
        if (Voice.synth) Voice.synth.speak(utter);
    },
    
    startListening: () => {
        if (!Voice.rec || Voice.selfSpeaking) return;
        try {
            Voice.isListening = true; 
            Voice.rec.start();
            App.setListeningUI(true);
            document.querySelector('.siri-container').classList.add('listening');
        } catch(e) { console.error("Start Listening Failed:", e); }
    },
    
    stopListening: () => {
        if (!Voice.rec) return;
        Voice.isListening = false;
        Voice.rec.stop();
        App.setListeningUI(false);
        document.querySelector('.siri-container').classList.remove('listening');
    }
};

const App = {
    init: () => {
        window.UserAbility.init();
        App.renderProfile();
        App.renderProfileForm();
        // Force bind click event to ensure it works
        const btn = document.getElementById('home-start-btn');
        if(btn) btn.onclick = App.startSession;
    },
    
    startSession: () => {
        // 1. UI Update MUST happen immediately
        const btn = document.getElementById('home-start-btn');
        if(btn) btn.style.display = 'none'; // Hide immediately
        
        const content = document.getElementById('home-active-content');
        if(content) content.classList.remove('hidden');
        
        const profile = document.getElementById('profile-card');
        if(profile) profile.classList.remove('hidden');

        // 2. Synchronous Voice Activation (Critical for iOS/Android Permissions)
        try {
            Voice.init();
            Voice.startListening(); // Must be direct response to user gesture
            
            // Speak greeting after a tiny delay to allow mic to activate first
            setTimeout(() => {
                const greeting = TEXT_VARIANTS.greeting[Math.floor(Math.random() * TEXT_VARIANTS.greeting.length)];
                Voice.speak(greeting);
            }, 500);
        } catch (e) {
            console.error("Voice Error:", e);
            // Even if voice fails, we allow entry
            alert("è¯­éŸ³æœåŠ¡å¯åŠ¨å¼‚å¸¸ï¼Œå·²åˆ‡æ¢è‡³è§¦æ§æ¨¡å¼");
        }
    },

    // --- NAVIGATION ---
    switchView: (viewId) => {
        document.querySelectorAll('.view').forEach(v => {
            v.classList.remove('active');
            if(v.id === viewId) v.classList.add('active');
        });

        // Auto-start listening if returning to interactive views
        if (viewId === 'view-home' || viewId === 'view-chat') {
            if (!Voice.selfSpeaking) Voice.startListening();
        } else {
            Voice.stopListening();
        }
        
        // Handle Home Background
        const bg = document.getElementById('home-bg-layer');
        if (viewId === 'view-home') bg.classList.remove('hidden');
        else bg.classList.add('hidden');
    },

    // --- HOME ---
    openProfile: () => {
        document.getElementById('modal-profile').classList.add('active');
    },
    saveProfile: () => {
        // Data is already updated reactively via onchange/onclick handlers
        App.renderProfile();
        document.getElementById('modal-profile').classList.remove('active');
    },
    renderProfile: () => {
        const u = window.store.user;
        const fInfo = App.getFatigueInfo(u.fatigue);
        const html = `
            <div class="info-item"><div class="info-label">ä¸»è¦ç›®æ ‡</div><div class="info-val" style="color:var(--primary)">${u.goal}</div></div>
            <div class="info-item"><div class="info-label">è¿åŠ¨ç­‰çº§</div><div class="info-val">${u.level}</div></div>
            <div class="info-item"><div class="info-label">å½“å‰ä½“é‡</div><div class="info-val">${u.weight} kg</div></div>
            <div class="info-item"><div class="info-label">ä¸»è§‚ç–²åŠ³åº¦</div><div class="info-val" style="color:${fInfo.color}">${u.fatigue} - ${fInfo.label}</div></div>
        `;
        document.getElementById('profile-display').innerHTML = html;
    },
    
    getFatigueInfo: (val) => {
        if (val <= 2) return { label: 'è¶…é‡æ¢å¤', desc: 'ç¥ç»ç³»ç»Ÿä¸è‚Œç³–åŸå®Œå…¨å¡«å……ï¼Œé€‚åˆå†²å‡» PR (1RM) æˆ–é«˜å¼ºåº¦çˆ†å‘åŠ›è®­ç»ƒã€‚', color: '#32C48C' };
        if (val <= 4) return { label: 'å®Œå…¨æ¢å¤', desc: 'èº«ä½“æœºèƒ½å¤„äºåŸºå‡†æ°´å¹³ï¼Œé€‚åˆè¿›è¡Œå¸¸è§„å®¹é‡çš„æŠ—é˜»æˆ–ä»£è°¢è®­ç»ƒã€‚', color: '#32C48C' };
        if (val <= 6) return { label: 'åŠŸèƒ½æ€§ç–²åŠ³', desc: 'å­˜åœ¨è½»å¾® DOMS æˆ–ç¥ç»ç–²åŠ³ï¼Œå»ºè®®ç»´æŒä¸­ç­‰å¼ºåº¦ï¼Œé¿å…åŠ›ç«­ç»„ã€‚', color: '#FFC107' };
        if (val <= 8) return { label: 'éåŠŸèƒ½æ€§ç–²åŠ³', desc: 'æ˜¾è‘—çš„è‚Œè‚‰é…¸ç—›æˆ–å¿ƒç‡å˜å¼‚æ€§ (HRV) ä¸‹é™ï¼Œå»ºè®®æ‰§è¡Œå‡è½½å‘¨ (Deload) æˆ–ä¸»åŠ¨æ¢å¤ã€‚', color: '#FF9800' };
        return { label: 'è¿‡åº¦è®­ç»ƒ', desc: 'æåº¦ç–²åŠ³ã€å…ç–«åŠ›ä¸‹é™æˆ–æœ‰ä¼¤ç—›é£é™©ï¼Œå¿…é¡»å®Œå…¨ä¼‘æ¯ã€‚', color: '#FF5252' };
    },
    
    updateFatigueDisplay: (val) => {
        const info = App.getFatigueInfo(val);
        const valEl = document.getElementById('fatigue-val');
        const descEl = document.getElementById('fatigue-desc');
        if(valEl) {
            valEl.innerText = `${val} - ${info.label}`;
            valEl.style.color = info.color;
        }
        if(descEl) descEl.innerText = info.desc;
    },

    renderProfileForm: () => {
        const u = window.store.user; 
        const activeTab = window.store.activeTab || 'basic';
        const opts = (arr, val) => arr.map(o => `<option ${o===val?'selected':''}>${o}</option>`).join('');
        const fInfo = App.getFatigueInfo(u.fatigue);
        
        // Calc metrics
        const age = new Date().getFullYear() - new Date(u.dob).getFullYear();
        const bmi = (u.weight / ((u.height/100)**2)).toFixed(1);
        const mhr = Math.round(208 - 0.7 * age);
        
        const basicHtml = `
            <div class="tab-content ${activeTab==='basic'?'active':''}" id="tab-basic">
                <div class="form-group"><label class="form-label">æ€§åˆ«</label><select id="in-gender" class="form-input" onchange="window.store.user.gender=this.value; App.renderProfileForm()">${opts(CONSTANTS.ENUMS.GENDER, u.gender)}</select></div>
                <div class="form-group"><label class="form-label">ç”Ÿæ—¥</label><input type="date" id="in-dob" class="form-input" value="${u.dob}" onchange="window.store.user.dob=this.value; App.renderProfileForm()"></div>
                <div class="form-group"><label class="form-label">èº«é«˜ (cm)</label><input type="number" id="in-height" class="form-input" value="${u.height}" onchange="window.store.user.height=parseFloat(this.value); App.renderProfileForm()"></div>
                <div class="form-group"><label class="form-label">ä½“é‡ (kg)</label><input type="number" id="in-weight" class="form-input" value="${u.weight}" onchange="window.store.user.weight=parseFloat(this.value); App.renderProfileForm()"></div>
                
                <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                    <div><label class="form-label" style="font-size:10px;">BMI</label><div style="font-weight:700; color:${bmi>24?'var(--danger)':'#fff'}">${bmi}</div></div>
                    <div><label class="form-label" style="font-size:10px;">é™æ¯å¿ƒç‡</label><input type="number" id="in-rhr" value="${u.rhr||60}" style="width:100%;background:transparent;border:none;border-bottom:1px solid #444;color:#fff;font-weight:700;padding:0;" onchange="window.store.user.rhr=this.value"></div>
                    <div><label class="form-label" style="font-size:10px;">æœ€å¤§å¿ƒç‡</label><div style="font-weight:700;">${mhr}</div></div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="display:flex;justify-content:space-between;">
                        <span>ä¸»è§‚ç–²åŠ³ (1-10)</span>
                        <span id="fatigue-val" style="color:${fInfo.color}">${u.fatigue} - ${fInfo.label}</span>
                    </label>
                    <input type="range" id="in-fatigue" min="1" max="10" class="form-input" value="${u.fatigue}" oninput="window.store.user.fatigue=this.value; App.updateFatigueDisplay(this.value)">
                    <div id="fatigue-desc" style="font-size:11px; color:#888; margin-top:8px; padding:8px; background:rgba(255,255,255,0.05); border-radius:4px;">${fInfo.desc}</div>
                </div>
            </div>
        `;
        
        const prefHtml = `
            <div class="tab-content ${activeTab==='pref'?'active':''}" id="tab-pref">
                <div class="form-group"><label class="form-label">è¿åŠ¨ç­‰çº§</label><select id="in-level" class="form-input" onchange="window.store.user.level=this.value; App.renderProfileForm()">${opts(CONSTANTS.ENUMS.LEVEL, u.level)}</select></div>
                <div class="form-group"><label class="form-label">æ¯æ—¥è¿åŠ¨æ—¶é•¿ (min)</label><input type="number" class="form-input" value="${u.duration}" onchange="window.store.user.duration=parseInt(this.value); App.renderProfileForm()"></div>
                <div class="form-group">
                    <label class="form-label">ç–¼ç—›éƒ¨ä½</label>
                    <div class="options-grid" id="pref-pain" style="gap:8px;">
                        ${CONSTANTS.ENUMS.PAIN_AREAS.map(p => `<div class="opt-chip ${u.pain.includes(p)?'active':''}" onclick="App.toggleArrayItem('pain', '${p}')" style="padding:8px;min-width:40px;">${p}</div>`).join('')}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ²¡æœ‰çš„å™¨æ¢°</label>
                    <div class="options-grid" id="pref-missing" style="gap:8px;">
                        ${CONSTANTS.ENUMS.MISSING_EQUIP.map(m => `<div class="opt-chip ${u.missing.includes(m)?'active':''}" onclick="App.toggleArrayItem('missing', '${m}')" style="padding:8px;min-width:40px;">${m}</div>`).join('')}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¯å‘¨è®­ç»ƒæ—¥</label>
                    <div class="options-grid" id="pref-days" style="gap:8px;">
                        ${['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'].map(d => `<div class="opt-chip ${u.days.includes(d)?'active':''}" onclick="App.toggleArrayItem('days', '${d}')" style="padding:8px;min-width:40px;">${d}</div>`).join('')}
                    </div>
                </div>
                <div class="form-group"><label class="form-label">å–œæ¬¢çš„è®­ç»ƒé£æ ¼</label><select class="form-input" onchange="window.store.user.style=this.value; App.renderProfileForm()">${opts(CONSTANTS.ENUMS.STYLE, u.style)}</select></div>
            </div>
        `;
        
        const goalHtml = `
            <div class="tab-content ${activeTab==='goal'?'active':''}" id="tab-goal">
                <div class="form-group"><label class="form-label">ä¸»è¦ç›®æ ‡</label><select id="in-goal" class="form-input" onchange="window.store.user.goal=this.value; App.renderProfileForm()">${opts(CONSTANTS.ENUMS.GOAL, u.goal)}</select></div>
                <div class="form-group"><label class="form-label">åŠŸèƒ½ç›®æ ‡</label><select id="in-func-goal" class="form-input" onchange="window.store.user.funcGoal=this.value; App.renderProfileForm()">${opts(CONSTANTS.ENUMS.FUNC_GOAL, u.funcGoal)}</select></div>
                <div class="form-group"><label class="form-label">ç›®æ ‡ä½“å‹</label><select id="in-body-type" class="form-input" onchange="window.store.user.bodyType=this.value; App.renderProfileForm()">${opts(CONSTANTS.ENUMS.BODY_TYPE, u.bodyType)}</select></div>
                <div class="form-group"><label class="form-label">ç›®æ ‡ä½“é‡ (kg)</label><input type="number" id="in-target-weight" class="form-input" value="${u.targetWeight}" onchange="window.store.user.targetWeight=parseFloat(this.value); App.renderProfileForm()"></div>
            </div>
        `;

        document.getElementById('profile-form').innerHTML = basicHtml + prefHtml + goalHtml;
    },
    
    switchTab: (tabId) => {
        window.store.activeTab = tabId;
        App.renderProfileForm();
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const map = {'basic':0, 'pref':1, 'goal':2};
        document.querySelectorAll('.tab')[map[tabId]].classList.add('active');
    },

    toggleArrayItem: (key, val) => {
        const arr = window.store.user[key];
        const idx = arr.indexOf(val);
        if(idx > -1) arr.splice(idx, 1);
        else arr.push(val);
        App.renderProfileForm();
    },

    // --- FLOW START ---
    startFlow: (type) => {
        // Check profile completeness (Mock check)
        if (!window.store.user.goal) return alert('è¯·å…ˆå®Œå–„è¿åŠ¨æ¡£æ¡ˆ');
        
        window.store.flow = type;
        window.store.step = 0;
        window.store.inputs = {};
        
        // Hide profile card first
        document.getElementById('profile-card').classList.add('hidden');
        
        setTimeout(() => {
            App.switchView('view-chat');
            document.getElementById('app').classList.add('state-chat');
            App.nextStep();
        }, 400);
    },

    prevStep: () => {
        if (window.store.step > 0) {
            window.store.step--;
            // Remove last input key logic is complex with map, simplified:
            // Just remove visual elements and re-ask previous question
            const history = document.getElementById('chat-history');
            // Remove: Current AI Question (if any), Previous User Answer, Previous AI Question
            // Actually, nextStep adds AI question. recordInput adds User answer.
            // We need to remove the last User Answer and the last AI Question (current one)
            // And then nextStep will re-add the AI Question for the previous step.
            
            // Remove options container (if any) - Check for generic div or specific content
            if(history.lastElementChild && !history.lastElementChild.classList.contains('chat-bubble')) history.removeChild(history.lastElementChild);
            
            // Remove current AI question
            if(history.lastElementChild && history.lastElementChild.classList.contains('chat-ai')) history.removeChild(history.lastElementChild);
            
            // Remove user answer (previous step)
            if(history.lastElementChild && history.lastElementChild.classList.contains('chat-user')) history.removeChild(history.lastElementChild);
            // Remove previous AI question (to be re-added)
            if(history.lastElementChild && history.lastElementChild.classList.contains('chat-ai')) history.removeChild(history.lastElementChild);
            
            App.updateSummary();
            App.nextStep();
        } else {
            App.reset();
        }
    },

    // --- CHAT LOGIC ---
    nextStep: () => {
        const flow = window.store.flow;
        const step = window.store.step;
        const chatHistory = document.getElementById('chat-history');

        // Dim previous messages
        const bubbles = chatHistory.querySelectorAll('.chat-bubble');
        bubbles.forEach(b => b.classList.add('chat-history-dim'));
        
        // Define Flows
        const flows = {
            'course': [
                { q: "æƒ³ç»ƒç‚¹ä»€ä¹ˆï¼Ÿ", key: 'type', opts: CONSTANTS.ENUMS.COURSE_TYPES },
                { q: "é‡ç‚¹æƒ³ç»ƒå“ªä¸ªéƒ¨ä½ï¼Ÿ", key: 'targets', opts: CONSTANTS.PARTS, multi: true },
                { q: "ä»Šå¤©æœ‰å¤šå°‘æ—¶é—´ï¼Ÿ", key: 'duration', type: 'slider', min: 20, max: 90, step: 5, unit: 'åˆ†é’Ÿ' }
            ],
            'plan': [
                { q: "è¿™ä¸ªè®¡åˆ’æƒ³æŒç»­å¤šä¹…ï¼Ÿ", key: 'cycle', type: 'slider', min: 1, max: 24, step: 1, unit: 'å‘¨', default: 8 },
                { q: "è¯·é€‰æ‹©æ¯å‘¨çš„è®­ç»ƒæ—¥ã€‚", key: 'days', opts: ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'], multi: true },
                { q: "æ¯å¤©å¹³å‡è®­ç»ƒå¤šé•¿æ—¶é—´ï¼Ÿ", key: 'duration', type: 'slider', min: 20, max: 60, step: 5, unit: 'åˆ†é’Ÿ', default: 30 }
            ]
        };

        // 1. è‡ªåŠ¨è·³è¿‡éƒ¨ä½é€‰æ‹© (Auto-skip Targets for Cardio/HIIT)
        if (flow === 'course' && step === 1) {
             const type = window.store.inputs['type'];
             const lockTypes = ['HIIT', 'æœ‰æ°§', 'æå‡»'];
             if (lockTypes.includes(type)) {
                 window.store.inputs['targets'] = ['å…¨èº«'];
                 window.store.step++;
                 App.nextStep();
                 return;
             }
        }

        const currentFlow = flows[flow];
        
        if (step >= currentFlow.length) {
            App.startReasoning();
            return;
        }

        const config = currentFlow[step];
        
        // FIX: Inject User Defaults for Duration
        if (config.key === 'duration') {
            config.default = window.store.user.duration;
        }

        // Pick random text variant if available
        let variants = [config.q];
        if (config.key === 'type') variants = TEXT_VARIANTS.askType;
        else if (config.key === 'targets') variants = TEXT_VARIANTS.askTarget;
        else if (config.key === 'duration') variants = TEXT_VARIANTS.askDuration;
        else if (config.key === 'cycle') variants = TEXT_VARIANTS.askCycle;
        else if (config.key === 'days') variants = TEXT_VARIANTS.askFreq;
        
        const qText = variants[Math.floor(Math.random() * variants.length)];
        
        // Show typing indicator first
        App.showTyping();

        // Add AI Message
        setTimeout(() => {
            App.hideTyping();
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble chat-ai';
            chatHistory.appendChild(bubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Render Options
            let optionsHtml = '';
            if (config.type === 'slider') {
                optionsHtml = `
                    <div class="chat-slider-box">
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;color:#fff;font-weight:700;">
                            <span>æ—¶é•¿</span><span id="slider-val">${config.default || config.min} ${config.unit}</span>
                        </div>
                        <input type="range" min="${config.min}" max="${config.max}" step="${config.step}" value="${config.default || config.min}" style="width:100%" oninput="document.getElementById('slider-val').innerText = this.value + ' ${config.unit}'">
                        <div class="opt-chip active" style="margin-top:15px;text-align:center;" onclick="App.handleInput('${config.key}', this.previousElementSibling.value, false)">ç¡®è®¤</div>
                    </div>`;
            } else {
                optionsHtml = `<div class="options-grid">` + config.opts.map(o => {
                    const isActive = (config.key === 'days' && window.store.user.days && window.store.user.days.includes(o)) ? 'active' : '';
                    let subText = '';
                    if (config.key === 'days') {
                        subText = `<span class="chat-sub-text">${isActive ? 'è®­ç»ƒ' : 'ä¼‘æ¯'}</span>`; 
                    }
                    return `<div class="opt-chip ${isActive}" onclick="App.handleInput('${config.key}', '${o}', ${config.multi}, this); App.toggleDayText(this)"><span>${o}</span>${subText}</div>`;
                }).join('') + `</div>`;
            }

            if(config.multi) {
                optionsHtml += `<div class="options-grid" style="margin-top:10px"><div class="opt-chip" style="background:var(--accent); border-color:var(--accent);" onclick="App.confirmMulti('${config.key}', this)">ç¡®è®¤é€‰æ‹©</div></div>`;
            }
            
            // Add Back Button (Small)
            if (step > 0) {
                optionsHtml += `<div style="margin-top:15px; text-align:center;"><span onclick="App.prevStep()" style="font-size:12px; color:#666; cursor:pointer; padding:5px 10px;">â†© ä¸Šä¸€æ­¥</span></div>`;
            }
            
            // Append options to history instead of fixed area
            const optContainer = document.createElement('div');
            optContainer.innerHTML = optionsHtml;
            chatHistory.appendChild(optContainer);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Use the newly implemented typeWriter
            App.typeWriter(bubble, qText, 30); 
            Voice.speak(qText); // Speak output

            // Scroll to center the new interaction
            // Simple approach: scroll to bottom, then adjust if needed
            // Or use scrollIntoView on the new bubble
        }, 500);
    },
    
    toggleDayText: (el) => {
        const sub = el.querySelector('.chat-sub-text');
        if(sub) {
            sub.innerText = el.classList.contains('active') ? 'è®­ç»ƒ' : 'ä¼‘æ¯';
        }
    },

    // --- ENHANCED VOICE LOGIC FOR DAYS ---
    handleDaysVoiceInput: (text, container) => {

        const dayMap = {
            'ä¸€': 'å‘¨ä¸€', 'äºŒ': 'å‘¨äºŒ', 'ä¸‰': 'å‘¨ä¸‰', 'å››': 'å‘¨å››', 'äº”': 'å‘¨äº”', 'å…­': 'å‘¨å…­', 'æ—¥': 'å‘¨æ—¥', 'å¤©': 'å‘¨æ—¥', 'ä¸ƒ': 'å‘¨æ—¥',
            '1': 'å‘¨ä¸€', '2': 'å‘¨äºŒ', '3': 'å‘¨ä¸‰', '4': 'å‘¨å››', '5': 'å‘¨äº”', '6': 'å‘¨å…­', '7': 'å‘¨æ—¥'
        };
        
        // Split text into segments to handle mixed intents (e.g. "å‘¨ä¸€è®­ç»ƒï¼Œå‘¨äºŒä¼‘æ¯")
        const segments = text.split(/[ï¼Œã€‚,.;ï¼›\s]+/);
        // Filter out confirm button from chips to avoid errors
        const chips = Array.from(container.querySelectorAll('.opt-chip')).filter(c => !c.getAttribute('onclick').includes('confirmMulti'));
        let hasAction = false;
        
        segments.forEach(seg => {
            if (!seg.trim()) return;
            
            let targets = [];
            // Robust Regex: Match any day character (supports "ä¸€ä¸‰äº”", "å‘¨ä¸€", "135")
            const regex = /[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©ä¸ƒ1-7]/g;
            let match;
            while ((match = regex.exec(seg)) !== null) {
                if (dayMap[match[0]]) targets.push(dayMap[match[0]]);
            }
            
            if (seg.includes('å‘¨æœ«')) targets.push('å‘¨å…­', 'å‘¨æ—¥');
            if (seg.includes('å·¥ä½œæ—¥')) targets.push('å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”');
            if (seg.includes('æ¯å¤©') || seg.includes('å¤©å¤©') || seg.includes('å…¨é€‰') || seg.includes('æ‰€æœ‰')) {
                targets = ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];
            }
            
            targets = [...new Set(targets)];
            if (targets.length === 0) return; // No days in this segment

            const negKeywords = ['ä¸ç»ƒ', 'å–æ¶ˆ', 'ä¼‘æ¯', 'å»æ‰', 'åˆ é™¤', 'ä¸ç”¨', 'æ’é™¤', 'å…³æ‰'];
            const modKeywords = ['æ”¹æˆ', 'æ¢æˆ', 'ä¿®æ”¹ä¸º', 'åªæœ‰', 'åªè¦', 'é‡é€‰', 'å˜æ›´ä¸º', 'å…¨éƒ¨å–æ¶ˆ', 'åªç»ƒ'];
            
            const isNeg = negKeywords.some(k => seg.includes(k));
            const isMod = modKeywords.some(k => seg.includes(k));
            
            // Determine Action: Add (Train) or Remove (Rest)
            // Default to Add if no negative keyword is present
            
            if (isMod) {
                // Replace Mode: Clear all first (Global effect, but triggered by segment)
                chips.forEach(c => {
                    if(c.classList.contains('active')) {
                        c.classList.remove('active');
                        App.toggleDayText(c);
                    }
                });
                // Select targets
                targets.forEach(t => {
                    const chip = chips.find(c => c.innerText.includes(t));
                    if(chip) {
                        chip.classList.add('active');
                        App.toggleDayText(chip);
                        hasAction = true;
                    }
                });
            } else if (isNeg) {
                // Negative Mode: Deselect targets
                targets.forEach(t => {
                    const chip = chips.find(c => c.innerText.includes(t));
                    if(chip && chip.classList.contains('active')) {
                        chip.classList.remove('active');
                        App.toggleDayText(chip);
                        hasAction = true;
                    }
                });
            } else {
                // Add Mode: Select targets
                targets.forEach(t => {
                    const chip = chips.find(c => c.innerText.includes(t));
                    if(chip && !chip.classList.contains('active')) {
                        chip.classList.add('active');
                        App.toggleDayText(chip);
                        hasAction = true;
                    }
                });
            }
        });
        
        // Global Clear Command
        if (text.includes('å…¨éƒ¨å–æ¶ˆ') || text.includes('å…¨ä¸é€‰') || text.includes('æ¸…ç©º')) {
            chips.forEach(c => {
                c.classList.remove('active');
                App.toggleDayText(c);
            });
            hasAction = true;
        }
        
        // Confirmation
        if (['ç¡®è®¤', 'å¥½äº†', 'å®Œæˆ', 'ä¸‹ä¸€æ­¥', 'æ˜¯çš„', 'OK', 'æ²¡é—®é¢˜'].some(k => text.toLowerCase().includes(k.toLowerCase()))) {
            if (container.id === 'schedule-days-list') {
                App.confirmSchedule();
            } else {
                App.confirmMulti('days', null);
            }
        }
    },

    // --- MISSING FUNCTIONS IMPLEMENTATION ---
    
    showTyping: () => {
        const history = document.getElementById('chat-history');
        // Prevent duplicate typing indicators
        if (document.getElementById('typing-indicator')) return;
        
        const typing = document.createElement('div');
        typing.id = 'typing-indicator';
        typing.className = 'chat-typing';
        typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
        history.appendChild(typing);
        history.scrollTop = history.scrollHeight;
    },

    hideTyping: () => {
        const typing = document.getElementById('typing-indicator');
        if (typing) typing.remove();
    },

    typeWriter: (element, text, speed = 30) => {
        element.innerHTML = ''; // Clear first
        let i = 0;
        function type() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, speed);
            }
        }
        type();
    },

    cnToInt: (text) => {
        const map = { 'ä¸€':1, 'äºŒ':2, 'ä¸¤':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9, 'å':10, '0':0, '1':1, '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9 };
        let numStr = text.match(/[0-9]+|[ä¸€äºŒä¸¤ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+/);
        if (!numStr) return null;
        let str = numStr[0];
        if (/\d/.test(str)) return parseInt(str);
        
        if (str.length === 1) return map[str];
        if (str.length === 2) {
            if (str[0] === 'å') return 10 + map[str[1]];
            if (str[1] === 'å') return map[str[0]] * 10;
        }
        if (str.length === 3) {
            if (str[1] === 'å') return map[str[0]] * 10 + map[str[2]];
        }
        return null;
    },

    animateSlider: (slider, targetVal, callback) => {
        let current = parseInt(slider.value);
        const step = (targetVal - current) / 10;
        let count = 0;
        const interval = setInterval(() => {
            current += step;
            slider.value = current;
            const display = document.getElementById('slider-val');
            if(display) {
                 const unit = display.innerText.replace(/[0-9\.]+/g, '').trim();
                 display.innerText = Math.round(current) + ' ' + unit;
            }
            count++;
            if (count >= 10) {
                clearInterval(interval);
                slider.value = targetVal;
                if(callback) callback();
            }
        }, 30);
    },

    toggleMicState: () => {
        if (Voice.isListening) {
            Voice.stopListening();
        } else {
            Voice.startListening();
        }
    },

    setListeningUI: (state) => {
        const btn = document.getElementById('mic-btn');
        if(state) btn.classList.add('listening');
        else btn.classList.remove('listening');
    },

    handleVoiceInput: (text, isFinal) => {
        const flow = window.store.flow;
        
        // --- 0. MODAL INTERCEPTION ---
        if (document.getElementById('modal-schedule').classList.contains('active')) {
            App.handleDaysVoiceInput(text, document.getElementById('schedule-days-list'));
            return;
        }

        // --- HOME PAGE LOGIC ---
        if (!flow) {
            // 1. Real-time subtitle
            const subtitle = document.getElementById('home-subtitle');
            if (subtitle) {
                subtitle.innerText = text;
                subtitle.style.opacity = 1;
            }

            // 2. Keyword Matching (Interim or Final)
            const keywords = {
                'course': ['ä¸€èŠ‚è¯¾', 'è¯¾ç¨‹', 'å•è¯¾', 'ç»ƒä¸€ç»ƒ', 'å®¢ç¨‹', 'åˆ»æˆ', 'ä¸€æ°å…‹'],
                'plan': ['è®¡åˆ’', 'å‘¨æœŸ', 'é•¿çº¿', 'æ¿€åŒ–', 'æ€¥åŒ–', 'æåŒ–', 'é›†ç”»', 'æµåŒ–', 'è§„åˆ’']
            };
            
            let matchedType = null;
            for (const [type, words] of Object.entries(keywords)) {
                if (words.some(w => text.includes(w))) {
                    matchedType = type;
                    break;
                }
            }

            if (matchedType) {
                if (subtitle) subtitle.innerText = ''; // Clear subtitle
                // Create a user bubble in chat history to show what was spoken
                const chatHistory = document.getElementById('chat-history');
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble chat-user';
                bubble.innerText = text;
                chatHistory.appendChild(bubble);
                
                App.startFlow(matchedType);
                return; 
            }
            return;
        }

        // Update UI
        let userBubble = document.getElementById('temp-user-bubble');
        // Only show bubble in chat view
        if (!userBubble && document.getElementById('view-chat').classList.contains('active')) {
            userBubble = document.createElement('div');
            userBubble.id = 'temp-user-bubble';
            userBubble.className = 'chat-bubble chat-user interim';
            document.getElementById('chat-history').appendChild(userBubble);
        }
        
        // Global Commands
        if (isFinal) {
            if (['é€€å‡º', 'ç»“æŸ', 'è¿”å›é¦–é¡µ', 'å–æ¶ˆ'].some(k => text.includes(k))) {
                Voice.speak("å¥½çš„ï¼Œå·²é€€å‡ºã€‚");
                App.reset();
                return;
            }
            if (['ä¸Šä¸€æ­¥', 'è¿”å›', 'é‡é€‰', 'ä¸å¯¹', 'ä¿®æ”¹'].some(k => text.includes(k))) {
                if (document.getElementById('view-chat').classList.contains('active')) {
                    Voice.speak("å¥½çš„ï¼Œé‡æ–°é€‰æ‹©ã€‚");
                    if (userBubble) userBubble.remove();
                    App.prevStep();
                    return;
                }
            }
        }

        // Highlight keywords
        const step = window.store.step;
        
        // Define Flows Context (Moved up for config access)
        const flows = {
            'course': [{key:'type', opts:CONSTANTS.ENUMS.COURSE_TYPES}, {key:'targets', opts:CONSTANTS.PARTS}, {key:'duration', type:'slider', min:20, max:90}],
            'plan': [{key:'cycle', type:'slider', min:1, max:12}, {key:'days', opts:['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'], multi:true}, {key:'duration', opts:['30','45','60']}]
        };

        // Determine context options
        let currentOpts = [];
        if (!flow) {
            // Home Context
            currentOpts = ['ä¸€èŠ‚è¯¾', 'è¯¾ç¨‹', 'è®¡åˆ’', 'å‘¨æœŸ'];
        } else {
            if (flows[flow] && flows[flow][step]) {
                currentOpts = flows[flow][step].opts || [];
            }
            // Handle Fatigue State Context
            if (window.store.pendingFatigue) {
                const p = window.store.pendingFatigue;
                currentOpts = ['åˆ‡æ¢', 'ä¸åˆ‡æ¢', 'ç¡®è®¤', 'å–æ¶ˆ', 'æ˜¯', 'å¦'];
                if (p.recommended && p.recommended.length) currentOpts.push(p.recommended[0]);
                if (p.hit) currentOpts.push(p.hit);
            }
        }
        
        let html = text;
        let matched = null;
        
        // Try to match number first ONLY if it's a number-related step
        let allowNumber = false;
        if (flow && flows[flow] && flows[flow][step]) {
            const cfg = flows[flow][step];
            if (cfg.type === 'slider' || ['duration', 'cycle', 'freq'].includes(cfg.key)) allowNumber = true;
        }
        
        const numVal = allowNumber ? App.cnToInt(text) : null;
        
        if (numVal !== null) {
            matched = numVal.toString();
            const matchStr = text.match(/[0-9]+|[ä¸€äºŒä¸¤ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+/);
            if(matchStr) html = html.replace(matchStr[0], `<span class="keyword-highlight">${matched}</span>`);
        } else {
            if (currentOpts.length) {
                // Multi-select Voice Logic
                if (flow && flows[flow][step].multi) {
                    const matches = [];
                    currentOpts.forEach(opt => {
                        if (text.includes(opt)) matches.push(opt);
                    });
                    if (matches.length > 0) {
                        // Highlight all matches
                        matches.forEach(m => {
                            html = html.replace(m, `<span class="keyword-highlight">${m}</span>`);
                        });
                    }
                }
                
                currentOpts.forEach(opt => {
                    // Fuzzy match: Include single char match for body parts (e.g. "è…¿" -> "è…¿éƒ¨")
                    if (text.includes(opt) || (opt.length > 1 && text.includes(opt[0]))) {
                        html = html.replace(opt, `<span class="keyword-highlight">${opt}</span>`);
                        matched = opt;
                    }
                });
            }
        }
        
        if (userBubble) {
            userBubble.innerHTML = html;
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
        }

        if (isFinal) {
            if (userBubble) {
                userBubble.removeAttribute('id');
                userBubble.classList.remove('interim');
            }
            
            if (matched) {
                if (flow) {
                    // Chat Logic
                    const config = flows[flow][step];
                    if(config) {
                        // Multi-select Handling
                        if (config.multi) {
                            // Special handling for Days
                            if (config.key === 'days') {
                                // Fix: Find the correct container (last one with options-grid)
                                const history = document.getElementById('chat-history');
                                let optContainer = null;
                                for (let i = history.children.length - 1; i >= 0; i--) {
                                    if (history.children[i].querySelector('.options-grid')) {
                                        optContainer = history.children[i];
                                        break;
                                    }
                                }
                                if (optContainer) {
                                    App.handleDaysVoiceInput(text, optContainer);
                                }
                                return;
                            }

                            // Fuzzy match for targets (single char) but strict for others
                            const matches = currentOpts.filter(opt => {
                                if (text.includes(opt)) return true;
                                if (config.key === 'targets' && opt.length > 1 && text.includes(opt[0])) return true;
                                return false;
                            });
                            
                            // Modification detection
                            const modKeywords = ['æ”¹æˆ', 'æ¢æˆ', 'ä¿®æ”¹ä¸º', 'åªæœ‰', 'åªè¦', 'é‡é€‰', 'å˜æ›´ä¸º', 'å…¨éƒ¨å–æ¶ˆ'];
                            const isMod = modKeywords.some(k => text.includes(k));

                            if (matches.length > 0) {
                                if (isMod) {
                                    // Clear existing selections for current options
                                    const allChips = Array.from(document.querySelectorAll('.opt-chip'));
                                    allChips.forEach(chip => {
                                        const chipText = chip.querySelector('span') ? chip.querySelector('span').innerText : chip.innerText;
                                        if (currentOpts.includes(chipText) && chip.classList.contains('active')) {
                                            chip.classList.remove('active');
                                            App.toggleDayText(chip);
                                        }
                                    });
                                }

                                matches.forEach(m => {
                                    // Find chip and ensure active
                                    const chips = Array.from(document.querySelectorAll('.opt-chip'));
                                    const target = chips.find(c => (c.querySelector('span') ? c.querySelector('span').innerText : c.innerText) === m);
                                    if (target && !target.classList.contains('active')) {
                                        target.classList.add('active');
                                        App.toggleDayText(target);
                                    }
                                });
                            }
                            // Check for confirmation keywords
                            if (['ç¡®è®¤', 'å¥½äº†', 'å®Œæˆ', 'ä¸‹ä¸€æ­¥', 'æ˜¯çš„', 'OK'].some(k => text.toLowerCase().includes(k.toLowerCase()))) {
                                App.confirmMulti(config.key, null);
                            }
                            return;
                        }

                        // Handle number parsing for sliders
                        if (window.store.pendingFatigue) {
                            // Fatigue Dialogue Logic
                            const p = window.store.pendingFatigue;
                            // Match "Switch" keywords OR the Recommended Part Name (e.g. "èƒŒ")
                            if (['åˆ‡æ¢', 'ç¡®è®¤', 'æ˜¯'].some(k => matched.includes(k)) || text.includes(p.recommended[0]) || text.includes(p.recommended[0][0])) App.handleInput('fatigue_resolution', 'switch', false);
                            else if (['ä¸åˆ‡æ¢', 'å–æ¶ˆ', 'å¦'].some(k => matched.includes(k)) || text.includes(p.hit) || text.includes(p.hit[0])) App.handleInput('fatigue_resolution', 'keep', false);
                            return;
                        }

                        if (config.type === 'slider') {
                            let targetVal = parseInt(matched);
                            // Find slider
                            const slider = document.querySelector('.chat-slider-box input[type=range]');
                            if (slider && !isNaN(targetVal)) {
                                // Animate
                                App.animateSlider(slider, targetVal, () => {
                                     App.handleInput(config.key, targetVal, false);
                                });
                                return; // Skip immediate handleInput
                            }
                        } else if (config.key === 'duration' || config.key === 'cycle' || config.key === 'freq') {
                            matched = parseInt(matched);
                        }
                        App.handleInput(config.key, matched, false);
                    }
                }
            } else {
                // No match feedback
                if (flow) {
                    const errText = TEXT_VARIANTS.error[Math.floor(Math.random() * TEXT_VARIANTS.error.length)];
                    Voice.speak(errText);
                    if (userBubble) userBubble.style.opacity = '0.5'; // Dim invalid input
                }

                // Global Button Click Logic (Fuzzy Match)
                const clickables = Array.from(document.querySelectorAll('.opt-chip, .btn-full, .chat-back, .big-btn, .edit-btn, .ae-btn, .mic-btn, .unit-toggle, .result-header div[onclick]'));
                const visibleClickables = clickables.filter(el => el.offsetParent !== null);
                
                const matchedBtn = visibleClickables.find(el => {
                    let btnText = el.innerText.replace(/\s/g, '').replace(/[><â†âœ•â†ºâš™]/g, '');
                    const voiceText = text.replace(/\s/g, '');
                    if (!btnText) return false;
                    // Fuzzy match: voice includes button text OR button text includes voice (if long enough)
                    return (voiceText.includes(btnText) && btnText.length >= 2) || (btnText.includes(voiceText) && voiceText.length >= 2);
                });

                if (matchedBtn) {
                    matchedBtn.click();
                    matchedBtn.classList.add('active-voice-click');
                    setTimeout(() => matchedBtn.classList.remove('active-voice-click'), 300);
                    return;
                }
            }
        }
    },

    handleInput: (key, val, isMulti, el) => {
        if (isMulti) {
            // Toggle visual state
            if (el) {
                el.classList.toggle('active');
            } else {
                // Voice input fallback
                const chips = Array.from(document.querySelectorAll('.opt-chip'));
                const target = chips.find(c => c.innerText.includes(val));
                if(target) { target.classList.toggle('active'); App.toggleDayText(target); }
            }
            return;
        }
        
        // Fatigue Logic Interception
        if (key === 'targets' && !window.store.pendingFatigue) {
            // Ensure val is array for multi-select
            if (isMulti && !Array.isArray(val)) {
                 // handled by confirmMulti usually, but if voice input single target
            }
            // Check fatigue
            const fatigued = window.store.user.fatiguedParts; // e.g. ['è…¿éƒ¨']
            const selected = Array.isArray(val) ? val : [val];
            const hit = selected.find(p => fatigued.includes(p));
            
            if (hit) {
                // Trigger Fatigue Dialogue
                const rec = 'èƒŒéƒ¨'; // Mock recommendation logic
                window.store.pendingFatigue = { original: val, recommended: [rec], hit: hit };
                
                // AI Speak & Show
                const template = TEXT_VARIANTS.fatigueWarn[Math.floor(Math.random() * TEXT_VARIANTS.fatigueWarn.length)];
                const text = template.replace('{part}', hit).replace('{rec}', rec);
                
                App.showTyping();
                
                // Dim previous
                const bubbles = document.getElementById('chat-history').querySelectorAll('.chat-bubble');
                bubbles.forEach(b => b.classList.add('chat-history-dim'));

                // Append AI Bubble manually
                setTimeout(() => {
                    App.hideTyping();
                    const chatHistory = document.getElementById('chat-history');
                    const bubble = document.createElement('div');
                    bubble.className = 'chat-bubble chat-ai';
                    chatHistory.appendChild(bubble);
                    App.typeWriter(bubble, text, 30);
                // Render Options manually
                const optContainer = document.createElement('div');
                optContainer.innerHTML = `<div class="options-grid">
                    <div class="opt-chip" onclick="App.handleInput('fatigue_resolution', 'switch', false)">åˆ‡æ¢ä¸º${rec}</div>
                    <div class="opt-chip" onclick="App.handleInput('fatigue_resolution', 'keep', false)">åšæŒç»ƒ${hit}</div>
                </div>`;
                chatHistory.appendChild(optContainer);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                Voice.speak(text);
                }, 600);
                return; // Stop flow, wait for fatigue input
            }
        }
        
        // Handle Fatigue Decision
        if (key === 'fatigue_resolution') {
            const pending = window.store.pendingFatigue;
            window.store.pendingFatigue = null;
            if (val === 'switch') {
                App.recordInput('targets', pending.recommended);
            } else {
                App.recordInput('targets', pending.original);
            }
            return;
        }

        App.recordInput(key, val);
    },

    confirmMulti: (key, el) => {
        let optContainer;
        if (el) {
            // el is the button. Parent is .options-grid. Parent of that is the wrapper.
            optContainer = el.closest('.options-grid').parentElement;
        } else {
            // Fallback (e.g. voice command)
            const history = document.getElementById('chat-history');
            for (let i = history.children.length - 1; i >= 0; i--) {
                if (history.children[i].querySelector('.options-grid')) {
                    optContainer = history.children[i];
                    break;
                }
            }
        }
        if (!optContainer) return;
        
        // Query chips inside this container, excluding the confirm button itself
        const activeChips = Array.from(optContainer.querySelectorAll('.opt-chip.active')).filter(c => !c.getAttribute('onclick').includes('confirmMulti'));
        
        let active = activeChips.map(e => e.querySelector('span') ? e.querySelector('span').innerText : e.innerText);
        if(!active.length) return App.showToast("è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹");
        
        App.handleInput(key, active, false); // Route through handleInput for fatigue check
    },

    recordInput: (key, val) => {
        // Save input
        window.store.inputs[key] = val;
        
        // Add User Message
        const chatHistory = document.getElementById('chat-history');
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble chat-user';
        bubble.innerText = Array.isArray(val) ? val.join('ã€') : val;
        chatHistory.appendChild(bubble);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        
        App.updateSummary();
        
        // Next
        window.store.step++;
        App.nextStep();
    },
    
    updateSummary: () => {
        const inputs = window.store.inputs;
        const summary = document.getElementById('chat-summary');
        summary.innerHTML = '';
        Object.values(inputs).forEach(val => {
            const txt = Array.isArray(val) ? val.join('+') : val;
            summary.innerHTML += `<div class="summary-tag">${txt}</div>`;
        });
    },

    // --- REASONING ---
    startReasoning: () => {
        App.switchView('view-reasoning');
        document.getElementById('app').classList.add('state-reasoning');
        document.querySelector('.siri-container').classList.add('thinking');
        
        const user = window.store.user;
        const inputs = window.store.inputs;
        const flow = window.store.flow;
        
        // Dynamic Logs
        const logs = [];
        logs.push(`è¯»å–æ¡£æ¡ˆ: ${user.gender} / ${user.level} / ${user.goal}`);
        
        if (flow === 'course') {
            const targets = Array.isArray(inputs.targets) ? inputs.targets.join(',') : inputs.targets;
            logs.push(`è§£æéœ€æ±‚: ${inputs.type} / ${targets}`);
        } else {
            const daysCount = (inputs.days || []).length;
            logs.push(`è§£æè®¡åˆ’: ${inputs.cycle}å‘¨ / ${daysCount}å¤©é¢‘æ¬¡`);
        }
        
        if (user.pain && user.pain.length) logs.push(`é£æ§è¿‡æ»¤: é¿å¼€${user.pain.join('ã€')}`);
        else logs.push(`é£æ§æ‰«æ: æ— ç¦å¿Œéƒ¨ä½`);
        
        logs.push(`åŒ¹é…ç­–ç•¥: ${CONFIG.STRATEGY[user.goal]?.strategy || 'æ™ºèƒ½æ¨è'}æ¨¡å‹`);
        logs.push(`æ„å»ºè¯¾ç¨‹: åŠ¨ä½œåº“ Top-K ç­›é€‰`);
        logs.push(`ç”Ÿæˆæ–¹æ¡ˆ: è®¡ç®—å®¹é‡ä¸è´Ÿè·...`);

        const logContainer = document.getElementById('reasoning-log');
        logContainer.innerHTML = '';
        
        let i = 0; 
        
        function nextLog() {
            if (i >= logs.length) {
                setTimeout(() => {
                    document.getElementById('app').classList.remove('state-reasoning');
                    document.querySelector('.siri-container').classList.remove('thinking');
                    App.showResult();
                }, 800);
                return;
            }
            
            // Create Item
            const div = document.createElement('div');
            div.className = 'log-item';
            div.innerHTML = `<div class="log-icon"><div class="typing-dot" style="width:4px;height:4px;background:#fff;animation:none;opacity:0.5;"></div></div><span>${logs[i]}</span>`;
            logContainer.appendChild(div);
            
            // Mark previous as done
            if (i > 0) {
                const prev = logContainer.children[i-1];
                prev.classList.remove('active');
                prev.classList.add('done');
                prev.querySelector('.log-icon').innerHTML = 'âœ“';
            }
            
            div.classList.add('active');
            
            i++;
            setTimeout(nextLog, 800); // Delay between steps
        }
        
        nextLog();
    },

    // --- RESULT ---
    showResult: () => {
        const flow = window.store.flow;
        const inputs = window.store.inputs;
        const resBody = document.getElementById('res-body');
        const btnMain = document.getElementById('btn-main-action');
        
        document.getElementById('btn-back-plan').style.display = 'none'; // Hide back button initially
        App.switchView('view-result');
        
        if (flow === 'course') {
            btnMain.innerText = 'å¼€å§‹è®­ç»ƒ';
            btnMain.onclick = () => {
                const res = window.Logic.completeTraining(window.currentCtx);
                let msg = "è®­ç»ƒå®Œæˆï¼èº«ä½“çŠ¶æ€å·²æ›´æ–°ã€‚";
                if (res.prCount > 0) msg += ` æ­å–œï¼æ‰“ç ´äº† ${res.prCount} é¡¹åŠ›é‡çºªå½•ï¼`;
                App.showToast(msg);
                App.reset();
            };
            const ctx = window.Logic.genCourse(inputs);
            document.getElementById('res-title').innerText = `${inputs.type}è®­ç»ƒ`;
            document.getElementById('res-sub').innerText = `${inputs.duration} | ${inputs.targets} | ${window.store.user.level}`;
            window.store.courseSettings = { loopMode: 'å¸¸è§„ç»„', loadStrategy: 'æ¨è' }; // Reset settings
            window.currentCtx = ctx; // Save context for fine-tuning
            
            App.renderFineTuning(ctx);
            
        } else {
            btnMain.innerText = 'åŠ å…¥æ—¥ç¨‹';
            btnMain.onclick = () => App.openScheduleModal();
            const plan = window.Logic.genPlan(inputs);
            document.getElementById('res-title').innerText = `${inputs.cycle}å‘¨æœŸè®¡åˆ’`;
            document.getElementById('res-sub').innerText = `ç›®æ ‡: ${window.store.user.goal} | é¢‘ç‡: ${inputs.days.length}å¤©/å‘¨`;
            
            // Group by Phase
            const phases = {};
            plan.schedule.forEach(w => {
                if(!phases[w.phase]) phases[w.phase] = [];
                phases[w.phase].push(w);
            });

            let html = '';
            Object.keys(phases).forEach(pName => {
                const weeks = phases[pName];
                html += `
                <div class="plan-phase-block">
                    <div class="plan-phase-header">
                        <span>${pName}</span>
                        <span class="plan-phase-meta">${weeks.length}å‘¨ Â· å¼ºåº¦ç³»æ•° ${weeks[0].intensity}</span>
                    </div>
                    ${weeks.map(w => App.renderPlanWeek(w)).join('')}
                </div>`;
            });
            resBody.innerHTML = html;
            document.getElementById('res-stats').style.display = 'none'; // Hide stats for plan
        }
    },

    renderPlanWeek: (w) => {
        let daysHtml = '';
        
        w.days.forEach((day, idx) => {
            const d = idx + 1;
            const cls = day.isTraining ? 'training' : 'rest';
            // Pass targets as string to function
            const targetsStr = day.targets ? day.targets.join(',') : '';
            const click = day.isTraining ? `onclick="App.enterPlanDay(${w.week}, ${d}, '${day.dayName}', '${targetsStr}')"` : '';
            
            const title = day.isTraining ? (day.title || (day.targets.length > 2 ? (day.targets.includes('å…¨èº«')?'å…¨èº«ç»¼åˆè®­ç»ƒ':'ç»¼åˆåˆ†åŒ–è®­ç»ƒ') : day.targets.join('+') + 'è®­ç»ƒ')) : 'ä¼‘æ¯æ—¥';
            
            const content = day.isTraining 
                ? `<div class="pdr-content"><div class="pdr-title">${title}</div><div class="pdr-meta"><span>${window.store.inputs.duration}</span><span>â€¢</span><span>${day.targets.join(' ')}</span></div></div><div class="pdr-action">â†’</div>`
                : `<div class="pdr-content"><div class="pdr-title" style="color:#666">ä¼‘æ¯æ—¥</div><div class="pdr-meta">æ¢å¤èº«ä½“</div></div>`;

            daysHtml += `
            <div class="plan-day-row ${cls}" ${click}>
                <div class="pdr-date">Day<span>${d}</span></div>
                ${content}
            </div>`;
        });
        return `<div style="margin-bottom:10px;"><div style="font-size:11px;color:#666;margin-bottom:4px;">ç¬¬ ${w.week} å‘¨</div><div class="plan-week-list">${daysHtml}</div></div>`;
    },

    enterPlanDay: (week, day, dayName, targetsStr) => {
        // Generate specific course for this plan day
        const inputs = window.store.inputs;
        const targets = targetsStr.split(',');
        
        // Construct Plan Context for Logic
        const planContext = {
            type: 'åŠ›é‡',
            targets: targets,
            duration: parseInt(inputs.duration),
            title: `${dayName}è®­ç»ƒ`,
            phase: { intensity: 1.0, volume: 1.0 }, // Simplified for demo
            goal: window.store.user.goal
        };
        
        const ctx = window.Logic.runPipeline(null, planContext);
        
        document.getElementById('res-title').innerText = `W${week} | ${dayName}`;
        document.getElementById('res-sub').innerText = "è®¡åˆ’è¯¾ç¨‹";
        window.store.courseSettings = { loopMode: 'å¸¸è§„ç»„', loadStrategy: 'æ¨è' }; // Reset settings
        window.currentCtx = ctx;
        
        App.renderFineTuning(ctx);
        document.getElementById('res-stats').style.display = 'flex';
        
        // Show back button
        document.getElementById('btn-back-plan').style.display = 'block';
    },

    recalculateLoadStrategy: () => {
        if(!window.currentCtx) return;
        window.currentCtx = window.Logic.instantiate(window.currentCtx);
    },

    renderFineTuning: (ctx) => {
        const resBody = document.getElementById('res-body');
        const settings = window.store.courseSettings;
        const opts = (arr, val) => arr.map(o => `<option ${o===val?'selected':''}>${o}</option>`).join('');
        const unit = window.store.unit || 'kg';

        // Top mini bar for Load Strategy (Global)
        let html = `
            <div class="ft-mini-bar">
                <select class="ft-mini-sel" onchange="App.updateGlobalSetting('loadStrategy', this.value)">
                    ${opts(CONSTANTS.ENUMS.LOAD_STRATEGY, settings.loadStrategy)}
                </select>
            </div>
        `;

        ctx.phases.forEach((p, pIdx) => {
            // Phase Header with Loop Mode for Main
            let extra = '';
            if (p.type === 'ä¸»è®­') {
                const rest = p.strategy?.rest || 60;
                const roundRest = 120; // Mock round rest
                extra = `
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:10px; color:#888;">ç»„é—´ ${rest}s</span>
                        ${settings.loopMode.includes('å¾ªç¯') ? `<span style="font-size:10px; color:#888;">è½®é—´ ${roundRest}s</span>` : ''}
                        <select class="phase-select" onchange="App.updateGlobalSetting('loopMode', this.value)">${opts(CONSTANTS.ENUMS.LOOP_MODE, settings.loopMode)}</select>
                    </div>`;
            }
            
            html += `<div class="phase-header-row">
                <div class="phase-title">â— ${p.type} (${p.duration}min)</div>
                ${extra}
            </div>`;
            
            p.actions.forEach((a, aIdx) => {
                // Ensure setDetails exists (Safe check)
                if (!a.setDetails || a.setDetails.length !== a.sets) {
                    a.setDetails = [];
                    for(let i=0; i<a.sets; i++) {
                        a.setDetails.push({ load: a.load, reps: a.reps });
                    }
                }

                const isResistance = a.paradigm === 'æŠ—é˜»èŒƒå¼';
                const isWarmup = p.type === 'çƒ­èº«' || p.type === 'æ”¾æ¾';
                const isTimeBased = a.paradigm === 'é—´æ­‡èŒƒå¼' || a.paradigm === 'æµå¼èŒƒå¼' || settings.loadStrategy === 'è®¡æ—¶';
                const repUnit = isTimeBased ? 's' : '';

                const expanded = a.expanded ? 'block' : 'none';
                const arrow = a.expanded ? 'â–²' : 'â–¼';
                
                // Thumbnail
                const thumb = `<div class="ac-thumb"><i style="font-style:normal; font-size:16px;">ğŸ“·</i></div>`;
                
                // Summary
                let summary = '';
                if (isResistance && !isWarmup && !isTimeBased) {
                    summary = `<span class="ac-tag" style="color:var(--primary)">${a.sets}ç»„ x ${a.reps}</span> <span class="ac-tag">${a.load}${unit}</span>`;
                } else {
                    summary = `<span class="ac-tag" style="color:var(--primary)">${a.sets}ç»„</span> <span class="ac-tag">${a.reps}${repUnit}</span>`;
                }

                // Expanded Body (Sets)
                let setsHtml = '';
                a.setDetails.forEach((s, sIdx) => {
                    let inputs = '';
                    if (isResistance && !isWarmup && !isTimeBased) {
                        // Weight & Reps
                        inputs = `
                            <input class="set-input" type="number" value="${s.load}" onchange="App.updateSetData(${pIdx}, ${aIdx}, ${sIdx}, 'load', this.value)"> <span style="color:#666;font-size:10px;">${unit}</span>
                            <span style="color:#444; margin:0 5px;">x</span>
                            <input class="set-input" type="text" value="${s.reps}" onchange="App.updateSetData(${pIdx}, ${aIdx}, ${sIdx}, 'reps', this.value)">
                        `;
                    } else {
                        // Duration/Reps only
                        inputs = `
                            <input class="set-input" style="width:80px" type="text" value="${s.reps}" onchange="App.updateSetData(${pIdx}, ${aIdx}, ${sIdx}, 'reps', this.value)"> <span style="color:#666;font-size:10px;">${repUnit}</span>
                        `;
                    }
                    
                    setsHtml += `
                        <div class="set-row">
                            <div class="set-idx">${sIdx+1}</div>
                            ${inputs}
                            <div class="set-del" onclick="App.removeSet(${pIdx}, ${aIdx}, ${sIdx})">Ã—</div>
                        </div>
                    `;
                });

                // Add Set Button
                setsHtml += `<div class="add-set-btn" onclick="App.addSet(${pIdx}, ${aIdx})">+ åŠ ä¸€ç»„</div>`;
                
                // Professional Action Card Layout
                html += `
                <div class="action-card-pro">
                    <div class="ac-del-corner" onclick="event.stopPropagation(); App.deleteAction(${pIdx}, ${aIdx})">âœ•</div>
                    <div class="ac-header" onclick="App.toggleAction(${pIdx}, ${aIdx})">
                        ${thumb}
                        <div class="ac-info">
                            <div class="ac-title">${a.name}</div>
                            <div class="ac-meta">
                                <span class="ac-tag">${a.part}</span>
                                <span class="ac-tag">${a.muscle}</span>
                                ${summary}
                            </div>
                        </div>
                        <div class="ae-tools" onclick="event.stopPropagation()">
                            <div class="ae-btn" onclick="App.moveAction(${pIdx}, ${aIdx}, -1)">â†‘</div>
                            <div class="ae-btn" onclick="App.moveAction(${pIdx}, ${aIdx}, 1)">â†“</div>
                            <div class="ae-btn" onclick="App.openLibrary(${pIdx}, ${aIdx})">â†»</div>
                            <div class="ae-btn" style="border:none; background:transparent;">${arrow}</div>
                        </div>
                    </div>
                    
                    <div class="ac-body-exp" style="display:${expanded};">
                        <div class="set-list">
                            ${setsHtml}
                        </div>
                        <div class="ac-footer">
                            <span>å¼ºåº¦: ${(a.load > 0 && CONSTANTS.ENUMS.ONE_RM[a.part]) ? Math.round(a.load / CONSTANTS.ENUMS.ONE_RM[a.part] * 100) : '-'}%</span>
                            <span>RPE: ${a.rpe || 8}</span>
                            <span>ä¼‘æ¯: ${p.strategy?.rest || 60}s</span>
                        </div>
                    </div>
                </div>`;
            });
            html += `<div class="add-action-btn" onclick="App.addAction(${pIdx})">+ æ·»åŠ åŠ¨ä½œ</div>`;
        });
        resBody.innerHTML = html;
        App.updateStats();
    },
    
    updateSetData: (pIdx, aIdx, sIdx, field, val) => {
        const action = window.currentCtx.phases[pIdx].actions[aIdx];
        if (action.setDetails && action.setDetails[sIdx]) {
            action.setDetails[sIdx][field] = val;
            if (sIdx === 0) action[field] = val; // Sync summary with first set
        }
        App.renderFineTuning(window.currentCtx);
    },

    toggleAction: (pIdx, aIdx) => {
        const action = window.currentCtx.phases[pIdx].actions[aIdx];
        action.expanded = !action.expanded;
        App.renderFineTuning(window.currentCtx);
    },

    switchUnit: (unit) => {
        window.store.unit = unit;
        document.getElementById('unit-disp').innerText = unit.toUpperCase();
        App.renderFineTuning(window.currentCtx);
    },
    
    showToast: (msg) => {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 3000);
    },

    updateGlobalSetting: (key, val) => {
        window.store.courseSettings[key] = val;
        if (key === 'loadStrategy') App.recalculateLoadStrategy();
        App.renderFineTuning(window.currentCtx);
    },

    addSet: (pIdx, aIdx) => {
        const action = window.currentCtx.phases[pIdx].actions[aIdx];
        action.sets++;
        // Copy last set config
        const lastSet = action.setDetails[action.setDetails.length-1] || { load: action.load, reps: action.reps };
        action.setDetails.push({ ...lastSet });
        App.renderFineTuning(window.currentCtx);
    },

    removeSet: (pIdx, aIdx, sIdx) => {
        const action = window.currentCtx.phases[pIdx].actions[aIdx];
        if (action.sets > 1) {
            action.sets--;
            action.setDetails.splice(sIdx, 1);
            App.renderFineTuning(window.currentCtx);
        }
    },

    moveAction: (pIdx, aIdx, dir) => {
        const actions = window.currentCtx.phases[pIdx].actions;
        if (aIdx + dir >= 0 && aIdx + dir < actions.length) {
            const temp = actions[aIdx];
            actions[aIdx] = actions[aIdx + dir];
            actions[aIdx + dir] = temp;
            App.renderFineTuning(window.currentCtx);
        }
    },

    // --- ACTION LIBRARY & REPLACE ---
    addAction: (pIdx) => {
        window.store.replaceState = { pIdx, mode: 'add' };
        // Init Filters: Default to current context target part if available
        let defaultPart = 'å…¨éƒ¨';
        if (window.currentCtx && window.currentCtx.meta && window.currentCtx.meta.targets && window.currentCtx.meta.targets.length > 0) {
            defaultPart = window.currentCtx.meta.targets[0];
        }
        window.store.libFilter = { part: defaultPart, tag: 'å…¨éƒ¨' };
        App.renderLibraryFilters();
        App.renderLibraryList();
        App.switchView('view-library');
    },

    openLibrary: (pIdx, aIdx) => {
        window.store.replaceState = { pIdx, aIdx, mode: 'replace' };
        const currentAction = window.currentCtx.phases[pIdx].actions[aIdx];
        
        // Init Filters
        window.store.libFilter = { part: currentAction.part, tag: 'å…¨éƒ¨' };
        App.renderLibraryFilters();
        App.renderLibraryList();
        
        App.switchView('view-library');
    },

    closeLibrary: () => {
        App.switchView('view-result');
        window.store.replaceState = null;
    },

    renderLibraryFilters: () => {
        const parts = ['å…¨éƒ¨', ...CONSTANTS.PARTS];
        const html = parts.map(p => 
            `<div class="lib-filter-tag ${p === window.store.libFilter.part ? 'active' : ''}" onclick="App.setLibFilter('part', '${p}')">${p}</div>`
        ).join('');
        document.getElementById('lib-parts').innerHTML = html;
    },

    setLibFilter: (key, val) => {
        window.store.libFilter[key] = val;
        App.renderLibraryFilters();
        App.renderLibraryList();
    },

    renderLibraryList: () => {
        const { part } = window.store.libFilter;
        let list = DB;
        
        if (part !== 'å…¨éƒ¨') {
            list = list.filter(a => a.part === part);
        }
        
        // Simple scoring/sorting could go here
        
        const html = list.map(a => {
            const isSelected = (window.store.replaceState.selectedIds || []).includes(a.id);
            return `
            <div class="lib-item ${isSelected ? 'selected' : ''}" onclick="App.selectLibAction('${a.id}')">
                <div class="lib-info">
                    <div class="lib-name">${a.name}</div>
                    <div class="lib-meta">${a.part} Â· ${a.muscle} Â· ${a.equip[0]} Â· ${a.difficulty}</div>
                </div>
                <div class="lib-check"></div>
            </div>`;
        }).join('');
        document.getElementById('lib-list').innerHTML = html;
    },

    selectLibAction: (id) => {
        const state = window.store.replaceState;
        if (!state.selectedIds) state.selectedIds = [];
        
        if (state.mode === 'replace') {
            // Single select for replace
            state.selectedIds = [id];
        } else {
            // Multi select for add
            const idx = state.selectedIds.indexOf(id);
            if (idx > -1) state.selectedIds.splice(idx, 1);
            else state.selectedIds.push(id);
        }
        App.renderLibraryList();
    },

    confirmReplace: () => {
        const { pIdx, aIdx, selectedIds, mode } = window.store.replaceState;
        if (!selectedIds || selectedIds.length === 0) return App.closeLibrary();
        
        if (mode === 'add') {
            // Add multiple
            selectedIds.forEach(id => {
                const newAction = DB.find(a => a.id === id);
                if (newAction) {
                    const rawAction = JSON.parse(JSON.stringify(newAction));
                    window.currentCtx.phases[pIdx].actions.push(rawAction);
                }
            });
        } else {
            // Replace single (take first)
            const newAction = DB.find(a => a.id === selectedIds[0]);
            if (newAction) {
                const rawAction = JSON.parse(JSON.stringify(newAction));
                window.currentCtx.phases[pIdx].actions[aIdx] = rawAction;
            }
        }
        
        // Re-calculate load strategy for the whole context to apply correct weights/reps
        App.recalculateLoadStrategy();
        App.renderFineTuning(window.currentCtx);
        App.closeLibrary();
    },

    deleteAction: (pIdx, aIdx) => {
        if (!window.currentCtx) {
            console.error("Delete failed: No active context");
            return;
        }
        App.openConfirmModal('ç¡®å®šè¦åˆ é™¤è¯¥åŠ¨ä½œå—ï¼Ÿ', () => {
            try {
                const p = window.currentCtx.phases[pIdx];
                if (p && p.actions) {
                    p.actions.splice(aIdx, 1);
                    App.renderFineTuning(window.currentCtx);
                }
            } catch (e) {
                console.error("Delete operation error:", e);
            }
            App.closeConfirmModal();
        });
    },

    openConfirmModal: (msg, onConfirm) => {
        document.getElementById('dialog-msg').innerText = msg;
        document.getElementById('dialog-confirm-btn').onclick = onConfirm;
        document.getElementById('dialog-confirm').classList.add('active');
    },

    closeConfirmModal: () => {
        document.getElementById('dialog-confirm').classList.remove('active');
    },

    openScheduleModal: () => {
        const days = ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];
        // Default to profile days if inputs.days is empty (though it should be set from chat)
        const selected = window.store.inputs.days || window.store.user.days || [];
        
        const html = days.map(d => {
            const isActive = selected.includes(d);
            const subText = isActive ? 'è®­ç»ƒ' : 'ä¼‘æ¯';
            return `<div class="opt-chip ${isActive?'active':''}" onclick="this.classList.toggle('active'); App.toggleDayText(this)"><span>${d}</span><span class="chat-sub-text">${subText}</span></div>`;
        }).join('');
        
        document.getElementById('schedule-days-list').innerHTML = html;
        document.getElementById('modal-schedule').classList.add('active');
    },

    confirmSchedule: () => {
        const activeChips = document.querySelectorAll('#schedule-days-list .opt-chip.active');
        const days = Array.from(activeChips).map(c => c.innerText);
        if (days.length === 0) return App.showToast("è¯·è‡³å°‘é€‰æ‹©ä¸€å¤©");
        window.store.inputs.days = days;
        document.getElementById('modal-schedule').classList.remove('active');
        App.switchView('view-schedule');
    },

    updateStats: () => {
        const ctx = window.currentCtx;
        let totalSets = 0, totalActions = 0;
        ctx.phases.forEach(p => {
            totalActions += p.actions.length;
            p.actions.forEach(a => totalSets += a.sets);
        });
        
        document.getElementById('st-time').innerText = ctx.meta.duration + 'min';
        document.getElementById('st-count').innerText = totalActions + 'ä¸ª';
        document.getElementById('st-vol').innerText = totalSets + 'ç»„';
        document.getElementById('st-cal').innerText = Math.floor(4.5 * window.store.user.weight * (ctx.meta.duration/60)) + 'kcal';
    },

    reset: () => {
        // Reset State to ensure Home logic works
        window.store.flow = null;
        window.store.step = 0;
        window.store.inputs = {};
        window.store.pendingFatigue = null;

        App.switchView('view-home');
        document.getElementById('profile-card').classList.remove('hidden');
        document.getElementById('chat-history').innerHTML = '';
        document.getElementById('app').classList.remove('state-chat');
        document.getElementById('home-bg-layer').classList.remove('hidden');
    }
};

// Init
window.App = App;
App.init();

</script>